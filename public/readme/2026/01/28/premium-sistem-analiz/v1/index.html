<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium KullanÄ±cÄ± Sistemi Analizi - Muzibu.com</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
        .badge-premium { background: #f59e0b; color: white; }
        .badge-free { background: #6b7280; color: white; }
        .badge-trial { background: #3b82f6; color: white; }
        .section-card { background: #1e293b; border-left: 4px solid #f093fb; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ’ Premium KullanÄ±cÄ± Sistemi</h1>
            <p class="text-slate-100">Muzibu.com Multi-Tenant SaaS - Abonelik ve Cihaz YÃ¶netim Sistemi</p>
            <div class="flex gap-3 mt-4">
                <span class="badge badge-premium">PREMIUM</span>
                <span class="badge badge-trial">TRIAL</span>
                <span class="badge badge-free">FREE</span>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-12">

        <!-- Ã–zet BÃ¶lÃ¼mÃ¼ -->
        <div class="bg-slate-800 rounded-lg p-8 mb-8 border-l-4 border-purple-500">
            <h2 class="text-2xl font-bold mb-4 text-purple-400">ğŸ“‹ Sistem Ã–zeti</h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-amber-400">1</div>
                    <div class="text-slate-300">Single Source of Truth</div>
                    <div class="text-sm text-slate-400 mt-1">subscription_expires_at</div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-blue-400">7</div>
                    <div class="text-slate-300">Subscription Durumu</div>
                    <div class="text-sm text-slate-400 mt-1">active, trial, pending...</div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-green-400">3</div>
                    <div class="text-slate-300">Device Limit KatmanÄ±</div>
                    <div class="text-sm text-slate-400 mt-1">User â†’ Plan â†’ Setting</div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-pink-400">âˆ</div>
                    <div class="text-slate-300">Subscription Chain</div>
                    <div class="text-sm text-slate-400 mt-1">SÄ±nÄ±rsÄ±z uzatma</div>
                </div>
            </div>
        </div>

        <!-- BÃ–LÃœM 1: PREMIUM KONTROLÃœ -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">1ï¸âƒ£ Premium KontrolÃ¼ - Single Source of Truth</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Sistemde bir kullanÄ±cÄ±nÄ±n premium Ã¼ye olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in <strong>tek bir kaynak</strong> vardÄ±r:
                        <code class="bg-slate-800 px-2 py-1 rounded">users.subscription_expires_at</code> alanÄ±.
                    </p>

                    <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded mb-4">
                        <div class="font-bold text-amber-400 mb-2">ğŸ¯ TEK KURAL</div>
                        <div class="text-slate-300 space-y-2">
                            <div>âœ… <strong>subscription_expires_at</strong> gelecekte bir tarih â†’ <strong>PREMIUM</strong></div>
                            <div>âŒ <strong>subscription_expires_at</strong> NULL veya geÃ§miÅŸ tarih â†’ <strong>ÃœCRETSÄ°Z</strong></div>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Ã–rnek Senaryo</h4>
                        <div class="space-y-3">
                            <div class="border-l-4 border-green-500 pl-4">
                                <div class="text-green-400 font-semibold">Ahmet - Premium KullanÄ±cÄ±</div>
                                <div class="text-sm text-slate-400">subscription_expires_at: 2026-12-31</div>
                                <div class="text-sm text-slate-300">â†’ 2026 yÄ±lÄ±nÄ±n sonuna kadar mÃ¼zik dinleyebilir, cihaz limiti yÃ¼ksek</div>
                            </div>

                            <div class="border-l-4 border-blue-500 pl-4">
                                <div class="text-blue-400 font-semibold">AyÅŸe - Trial KullanÄ±cÄ±</div>
                                <div class="text-sm text-slate-400">subscription_expires_at: 2026-02-04 (7 gÃ¼n sonra)</div>
                                <div class="text-sm text-slate-300">â†’ Deneme sÃ¼resi devam ediyor, premium Ã¶zellikler kullanÄ±labilir</div>
                            </div>

                            <div class="border-l-4 border-red-500 pl-4">
                                <div class="text-red-400 font-semibold">Mehmet - Ãœcretsiz KullanÄ±cÄ±</div>
                                <div class="text-sm text-slate-400">subscription_expires_at: NULL</div>
                                <div class="text-sm text-slate-300">â†’ MÃ¼zik dinlemek iÃ§in abonelik satÄ±n almasÄ± gerekiyor</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Tek bir alan (<strong>subscription_expires_at</strong>) Ã¼zerinden kontrol yapmak, sistem performansÄ±nÄ±
                            artÄ±rÄ±r ve karmaÅŸÄ±klÄ±ÄŸÄ± azaltÄ±r. Her seferinde <strong>subscriptions</strong> tablosunu sorgulamaya
                            gerek kalmaz. KullanÄ±cÄ± tablosundan tek bir date kontrolÃ¼ yeterlidir.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">User::isPremium() Metodu</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Models/User.php (lines 463-481)

/**
 * Premium Ã¼ye mi?
 * ğŸ”´ TEK KAYNAK: users.subscription_expires_at
 */
public function isPremium(): bool {
    // Tenant yoksa false
    if (!$this->isMuzibuTenant()) {
        return false;
    }

    // 1. Model deÄŸeri (hÄ±zlÄ±)
    if ($this->subscription_expires_at && $this->subscription_expires_at->isFuture()) {
        return true;
    }

    // 2. Fresh DB kontrolÃ¼ (model stale olabilir)
    $freshExpiry = \DB::table('users')
        ->where('id', $this->id)
        ->value('subscription_expires_at');

    return $freshExpiry && \Carbon\Carbon::parse($freshExpiry)->isFuture();
}

ğŸ“Œ KullanÄ±m:
@if(auth()->user()->isPremium())
    &lt;span class="badge-premium"&gt;Premium Ãœye&lt;/span&gt;
@else
    &lt;a href="{{ route('subscription.plans') }}"&gt;Premium Ol&lt;/a&gt;
@endif</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">SubscriptionService::checkUserAccess()</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Subscription/App/Services/SubscriptionService.php (lines 314-356)

/**
 * KullanÄ±cÄ± eriÅŸim kontrolÃ¼ (request-level cache ile)
 */
public function checkUserAccess(User $user): array {
    $cacheKey = 'user_' . $user->id;

    // Request cache'den al (3 query â†’ 1 query optimizasyonu)
    if (isset(self::$accessCache[$cacheKey])) {
        return self::$accessCache[$cacheKey];
    }

    // ğŸ”´ SINGLE SOURCE OF TRUTH
    $expiresAt = $user->subscription_expires_at;

    if ($expiresAt && $expiresAt->isFuture()) {
        $daysRemaining = (int) now()->diffInDays($expiresAt, false);

        // Trial mi yoksa normal premium mi?
        $isTrial = Subscription::where('user_id', $user->id)
            ->where('status', 'trial')
            ->whereNotNull('trial_ends_at')
            ->where('trial_ends_at', '>', now())
            ->exists();

        $result = [
            'status' => 'unlimited',
            'is_trial' => $isTrial,
            'expires_at' => $expiresAt,
            'days_remaining' => max(0, $daysRemaining),
        ];
    } else {
        $result = [
            'status' => 'subscription_required',
            'message' => 'MÃ¼zik dinlemek iÃ§in premium Ã¼yelik gereklidir',
            'expires_at' => null,
            'days_remaining' => 0,
        ];
    }

    // Request cache'e kaydet
    self::$accessCache[$cacheKey] = $result;
    return $result;
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Database Schema</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š users tablosu (Tenant DB)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon                    â”‚ Tip       â”‚ AÃ§Ä±klama             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                       â”‚ bigint    â”‚ PK                   â”‚
â”‚ email                    â”‚ varchar   â”‚ Unique               â”‚
â”‚ subscription_expires_at  â”‚ timestamp â”‚ ğŸ”´ SINGLE SOURCE     â”‚
â”‚ device_limit             â”‚ int       â”‚ Override (nullable)  â”‚
â”‚ has_used_trial           â”‚ boolean   â”‚ Trial kullanÄ±ldÄ± mÄ±  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ KRITIK:
- subscription_expires_at NULL = Abonelik yok
- subscription_expires_at > NOW() = Premium
- subscription_expires_at < NOW() = SÃ¼resi dolmuÅŸ</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 2: SUBSCRIPTION MODEL ve PLAN -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">2ï¸âƒ£ Subscription Model ve Plan YapÄ±sÄ±</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Her kullanÄ±cÄ±nÄ±n bir veya birden fazla <strong>abonelik kaydÄ±</strong> (subscription) olabilir.
                        Her abonelik bir <strong>plana</strong> (SubscriptionPlan) baÄŸlÄ±dÄ±r ve bir <strong>durum</strong> iÃ§erir.
                    </p>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/30 border-l-4 border-green-500 p-4 rounded">
                            <div class="font-bold text-green-400 mb-1">âœ… ACTIVE (Aktif)</div>
                            <p class="text-sm text-slate-300">Abonelik devam ediyor, premium Ã¶zellikler kullanÄ±labilir</p>
                        </div>
                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="font-bold text-blue-400 mb-1">ğŸ TRIAL (Deneme)</div>
                            <p class="text-sm text-slate-300">Ãœcretsiz deneme sÃ¼resi, premium Ã¶zellikler kullanÄ±labilir</p>
                        </div>
                        <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded">
                            <div class="font-bold text-amber-400 mb-1">â³ PENDING (Beklemede)</div>
                            <p class="text-sm text-slate-300">Gelecekte baÅŸlayacak (chain sistemi), henÃ¼z aktif deÄŸil</p>
                        </div>
                        <div class="bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded">
                            <div class="font-bold text-purple-400 mb-1">ğŸ’³ PENDING_PAYMENT (Ã–deme Bekleniyor)</div>
                            <p class="text-sm text-slate-300">SipariÅŸ oluÅŸturuldu, Ã¶deme henÃ¼z tamamlanmadÄ±</p>
                        </div>
                        <div class="bg-red-900/30 border-l-4 border-red-500 p-4 rounded">
                            <div class="font-bold text-red-400 mb-1">âŒ EXPIRED (SÃ¼resi DolmuÅŸ)</div>
                            <p class="text-sm text-slate-300">Abonelik sÃ¼resi bitmiÅŸ, yenileme gerekli</p>
                        </div>
                        <div class="bg-slate-900/30 border-l-4 border-slate-500 p-4 rounded">
                            <div class="font-bold text-slate-400 mb-1">ğŸš« CANCELLED (Ä°ptal EdilmiÅŸ)</div>
                            <p class="text-sm text-slate-300">KullanÄ±cÄ± tarafÄ±ndan iptal edildi</p>
                        </div>
                        <div class="bg-orange-900/30 border-l-4 border-orange-500 p-4 rounded">
                            <div class="font-bold text-orange-400 mb-1">â¸ï¸ PAUSED (DuraklatÄ±lmÄ±ÅŸ)</div>
                            <p class="text-sm text-slate-300">GeÃ§ici olarak durdurulmuÅŸ</p>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“¦ Subscription Plan Nedir?</h4>
                        <p class="text-slate-300 mb-2">
                            Plan, bir abonelik paketinin ÅŸablonudur. Ã–rneÄŸin: <strong>"Premium YÄ±llÄ±k"</strong> adÄ±nda bir plan:
                        </p>
                        <ul class="list-disc list-inside text-slate-300 space-y-1 text-sm">
                            <li>Fiyat: 240 TL/yÄ±l (veya birden fazla dÃ¶nem seÃ§eneÄŸi)</li>
                            <li>Cihaz limiti: 5 cihaz</li>
                            <li>Deneme sÃ¼resi: 7 gÃ¼n</li>
                            <li>Ã–zellikler: ReklamsÄ±z dinleme, offline mod, yÃ¼ksek kalite</li>
                        </ul>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Plan ve subscription ayrÄ±mÄ± sayesinde sistem Ã§ok esnek Ã§alÄ±ÅŸÄ±r. AynÄ± plan binlerce kullanÄ±cÄ±
                            tarafÄ±ndan kullanÄ±labilir. Plan fiyatÄ± deÄŸiÅŸtiÄŸinde yeni abonelikler yeni fiyatÄ± kullanÄ±r ama
                            mevcut abonelikler etkilenmez. Her kullanÄ±cÄ±nÄ±n kendi subscription kaydÄ± kendi sÃ¼resini tutar.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Subscription Model</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Subscription/App/Models/Subscription.php

class Subscription extends BaseModel {
    protected $fillable = [
        'user_id',
        'subscription_plan_id',
        'subscription_number',      // Unique: SUB-XXXXX
        'status',                   // active, trial, pending, expired, cancelled, paused
        'cycle_key',                // '1-month', '1-year' (dinamik)
        'cycle_metadata',           // Cycle bilgileri (label, duration_days, price)
        'price_per_cycle',
        'currency',
        'has_trial',
        'trial_days',
        'trial_ends_at',
        'current_period_start',     // Bu dÃ¶nemin baÅŸlangÄ±cÄ±
        'current_period_end',       // Bu dÃ¶nemin bitiÅŸi (Ã–NEMLÄ°!)
        'next_billing_date',
        'auto_renew',
        'metadata',                 // Extra bilgiler (order_id, vb.)
    ];

    // Ä°liÅŸkiler
    public function user() { return $this->belongsTo(User::class); }
    public function plan() { return $this->belongsTo(SubscriptionPlan::class); }

    // Scope'lar
    public function scopeActive($query) {
        return $query->where('status', 'active')
            ->where(function($q) {
                $q->whereNull('current_period_end')
                  ->orWhere('current_period_end', '>', now());
            });
    }

    // Status Checks
    public function isActive(): bool {
        return $this->status === 'active' &&
               ($this->current_period_end === null || $this->current_period_end->isFuture());
    }

    public function isTrial(): bool {
        return $this->status === 'trial' &&
               $this->trial_ends_at !== null &&
               $this->trial_ends_at->isFuture();
    }

    public function daysRemaining(): int {
        if ($this->isTrial() && $this->trial_ends_at) {
            return max(0, (int) floor(now()->diffInDays($this->trial_ends_at, false)));
        }
        if ($this->current_period_end) {
            return max(0, (int) floor(now()->diffInDays($this->current_period_end, false)));
        }
        return 0;
    }

    // Cache temizleme (subscription deÄŸiÅŸince otomatik)
    protected static function boot() {
        parent::boot();

        $clearPremiumCache = function ($subscription) {
            if ($subscription->user_id) {
                \Cache::forget('user_' . $subscription->user_id . '_is_premium_tenant_1001');
            }
        };

        static::created($clearPremiumCache);
        static::updated($clearPremiumCache);
        static::deleted($clearPremiumCache);
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">SubscriptionPlan Model</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Subscription/App/Models/SubscriptionPlan.php

class SubscriptionPlan extends BaseModel {
    protected $fillable = [
        'title',                // ['tr' => 'Premium YÄ±llÄ±k', 'en' => 'Premium Yearly']
        'slug',                 // premium-yearly
        'description',          // Ã‡oklu dil aÃ§Ä±klama
        'features',             // ['ReklamsÄ±z', 'Offline', 'HD Kalite']
        'billing_cycles',       // ğŸ”¥ DÄ°NAMÄ°K CYCLES
        'device_limit',         // Bu planÄ±n cihaz limiti
        'trial_days',           // Deneme sÃ¼resi (gÃ¼n)
        'is_trial',             // Trial planÄ± mÄ±?
        'is_featured',          // Ã–ne Ã§Ä±kan plan mÄ±?
        'is_active',
        'is_public',
    ];

    // Dinamik Billing Cycles Ã–rneÄŸi:
    'billing_cycles' => [
        '1-month' => [
            'label' => ['tr' => '1 Ay', 'en' => '1 Month'],
            'duration_days' => 30,
            'price' => 29.90,
            'price_type' => 'without_tax', // KDV hariÃ§
            'sort_order' => 1,
        ],
        '1-year' => [
            'label' => ['tr' => '1 YÄ±l', 'en' => '1 Year'],
            'duration_days' => 365,
            'price' => 240.00,
            'price_type' => 'without_tax',
            'sort_order' => 2,
        ],
        '2-year' => [
            'label' => ['tr' => '2 YÄ±l', 'en' => '2 Years'],
            'duration_days' => 730,
            'price' => 400.00,
            'price_type' => 'without_tax',
            'sort_order' => 3,
        ],
    ]

    // Cycle metodlarÄ±
    public function getCyclePrice(string $cycleKey): ?float {
        $cycles = $this->billing_cycles ?? [];
        return isset($cycles[$cycleKey]['price']) ? (float) $cycles[$cycleKey]['price'] : null;
    }

    public function getCycleBasePrice(string $cycleKey): ?float {
        // KDV hariÃ§ fiyat (Cart iÃ§in)
        $cycle = $this->getCycle($cycleKey);
        $price = (float) $cycle['price'];
        $priceType = $cycle['price_type'] ?? 'without_tax';

        if ($priceType === 'with_tax') {
            // KDV'yi ayrÄ±ÅŸtÄ±r
            return $price / (1 + ($this->tax_rate ?? 20.0) / 100);
        }

        return $price; // Zaten KDV hariÃ§
    }

    public function getCyclePriceWithTax(string $cycleKey): ?float {
        // KDV dahil fiyat (gÃ¶sterim iÃ§in)
        $basePrice = $this->getCycleBasePrice($cycleKey);
        return $basePrice * (1 + ($this->tax_rate ?? 20.0) / 100);
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Database Schema</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š subscriptions tablosu (Tenant DB)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon                    â”‚ Tip       â”‚ AÃ§Ä±klama                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ subscription_id          â”‚ bigint    â”‚ PK                       â”‚
â”‚ user_id                  â”‚ bigint    â”‚ FK users                 â”‚
â”‚ subscription_plan_id     â”‚ bigint    â”‚ FK subscription_plans    â”‚
â”‚ subscription_number      â”‚ varchar   â”‚ Unique: SUB-678ABCD      â”‚
â”‚ status                   â”‚ varchar   â”‚ active/trial/pending...  â”‚
â”‚ cycle_key                â”‚ varchar   â”‚ '1-month', '1-year'      â”‚
â”‚ cycle_metadata           â”‚ json      â”‚ {label, duration, price} â”‚
â”‚ price_per_cycle          â”‚ decimal   â”‚ Bu abonelik iÃ§in fiyat   â”‚
â”‚ current_period_start     â”‚ timestamp â”‚ DÃ¶nem baÅŸlangÄ±cÄ±         â”‚
â”‚ current_period_end       â”‚ timestamp â”‚ DÃ¶nem bitiÅŸi (Ã–NEMLÄ°)    â”‚
â”‚ trial_ends_at            â”‚ timestamp â”‚ Deneme bitiÅŸi            â”‚
â”‚ has_trial                â”‚ boolean   â”‚ Trial kullanÄ±ldÄ± mÄ±      â”‚
â”‚ metadata                 â”‚ json      â”‚ {order_id: 123}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š subscription_plans tablosu (Tenant DB)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscription_plan_id     â”‚ bigint    â”‚ PK                       â”‚
â”‚ title                    â”‚ json      â”‚ {'tr': 'Premium YÄ±llÄ±k'} â”‚
â”‚ billing_cycles           â”‚ json      â”‚ Dinamik cycles (yukarÄ±da)â”‚
â”‚ device_limit             â”‚ int       â”‚ Cihaz limiti             â”‚
â”‚ trial_days               â”‚ int       â”‚ Deneme sÃ¼resi            â”‚
â”‚ is_trial                 â”‚ boolean   â”‚ Trial planÄ± mÄ±?          â”‚
â”‚ is_featured              â”‚ boolean   â”‚ Ã–ne Ã§Ä±kan mÄ±?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 3: SUBSCRIPTION CHAIN SÄ°STEMÄ° -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">3ï¸âƒ£ Subscription Chain Sistemi (Zincir)</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        KullanÄ±cÄ±lar <strong>birden fazla abonelik satÄ±n alabilir</strong> ve bu abonelikler
                        <strong>zincir ÅŸeklinde</strong> birbirine baÄŸlanÄ±r. Yani bir abonelik bittikten sonra
                        otomatik olarak bir sonraki abonelik baÅŸlar.
                    </p>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Ã–rnek Senaryo</h4>
                        <div class="space-y-3 text-sm">
                            <div class="border-l-4 border-green-500 pl-4">
                                <div class="text-green-400 font-semibold">1 Ocak 2026: Ä°lk SatÄ±n Alma (1 YÄ±l)</div>
                                <div class="text-slate-400">Status: <strong>ACTIVE</strong></div>
                                <div class="text-slate-300">BaÅŸlangÄ±Ã§: 2026-01-01 â†’ BitiÅŸ: 2027-01-01</div>
                            </div>

                            <div class="border-l-4 border-amber-500 pl-4">
                                <div class="text-amber-400 font-semibold">15 Haziran 2026: Ä°kinci SatÄ±n Alma (1 YÄ±l)</div>
                                <div class="text-slate-400">Status: <strong>PENDING</strong> (beklemede)</div>
                                <div class="text-slate-300">BaÅŸlangÄ±Ã§: 2027-01-01 â†’ BitiÅŸ: 2028-01-01</div>
                                <div class="text-xs text-slate-500">âš ï¸ Ä°lk abonelik bitene kadar bekler, sonra aktif olur</div>
                            </div>

                            <div class="border-l-4 border-purple-500 pl-4">
                                <div class="text-purple-400 font-semibold">20 AralÄ±k 2026: ÃœÃ§Ã¼ncÃ¼ SatÄ±n Alma (2 YÄ±l)</div>
                                <div class="text-slate-400">Status: <strong>PENDING</strong> (beklemede)</div>
                                <div class="text-slate-300">BaÅŸlangÄ±Ã§: 2028-01-01 â†’ BitiÅŸ: 2030-01-01</div>
                                <div class="text-xs text-slate-500">âš ï¸ Ä°kinci abonelik bitene kadar bekler</div>
                            </div>

                            <div class="border-l-4 border-pink-500 pl-4 bg-pink-900/20 rounded p-2">
                                <div class="text-pink-400 font-semibold">âœ¨ SonuÃ§</div>
                                <div class="text-slate-300">users.subscription_expires_at = <strong>2030-01-01</strong></div>
                                <div class="text-xs text-slate-400">Toplam 4 yÄ±l kesintisiz premium Ã¼yelik!</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/30 border-l-4 border-green-500 p-4 rounded">
                            <div class="font-bold text-green-400 mb-1">âœ… Avantajlar</div>
                            <ul class="text-sm text-slate-300 space-y-1">
                                <li>â€¢ Kesintisiz hizmet (sÃ¼re bitmeden yeni satÄ±n alma)</li>
                                <li>â€¢ Kampanyalardan yararlanma (erken alÄ±m indirimleri)</li>
                                <li>â€¢ Otomatik uzatma (manuel iÅŸlem gerekmez)</li>
                            </ul>
                        </div>

                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="font-bold text-blue-400 mb-1">ğŸ”§ Sistem MekanizmasÄ±</div>
                            <ul class="text-sm text-slate-300 space-y-1">
                                <li>â€¢ Ä°lk subscription: <strong>active</strong></li>
                                <li>â€¢ Sonraki subscriptions: <strong>pending</strong></li>
                                <li>â€¢ Ä°lki bitince: Pending â†’ Active</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Zincir sistemi sayesinde kullanÄ±cÄ±lar istedikleri kadar ileriye dÃ¶nÃ¼k abonelik satÄ±n alabilir.
                            Ã–zel gÃ¼nlerde (yÄ±lbaÅŸÄ±, kampanyalar) Ã§ok sayÄ±da abonelik alÄ±p yÄ±llarca premium kalabilirler.
                            Sistem otomatik olarak sÄ±rayÄ± yÃ¶netir, hiÃ§bir sÃ¼re kaybolmaz.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">User::recalculateSubscriptionExpiry()</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Models/User.php (lines 506-573)

/**
 * KullanÄ±cÄ±nÄ±n subscription_expires_at deÄŸerini yeniden hesapla
 * TÃ¼m active ve pending subscription'larÄ±n en son bitiÅŸ tarihini bul
 */
public function recalculateSubscriptionExpiry(): void {
    $connection = $this->getConnectionName();
    if (!$connection) return;

    // Sadece Ã–DENMÄ°Å veya MANUEL abonelikleri dahil et
    $validSubscriptions = $this->subscriptions()
        ->whereIn('status', ['active', 'pending'])
        ->get()
        ->filter(function ($sub) {
            $orderId = $sub->metadata['order_id'] ?? null;

            // Order yoksa = manuel oluÅŸturulmuÅŸ, dahil et
            if (!$orderId) return true;

            // Order varsa Ã¶deme durumunu kontrol et
            if (class_exists(\Modules\Cart\App\Models\Order::class)) {
                $order = \Modules\Cart\App\Models\Order::find($orderId);
                if ($order && in_array($order->payment_status, ['paid', 'completed'])) {
                    return true;
                }
            }

            return false;
        });

    // En son bitiÅŸ tarihini bul
    $lastSubscription = $validSubscriptions->sortByDesc('current_period_end')->first();
    $expiresAt = $lastSubscription?->current_period_end;

    // users.subscription_expires_at gÃ¼ncelle
    \DB::connection($connection)
        ->table('users')
        ->where('id', $this->id)
        ->update(['subscription_expires_at' => $expiresAt]);

    $this->subscription_expires_at = $expiresAt;

    // Premium cache'i temizle
    \Cache::forget('user_' . $this->id . '_is_premium_tenant_' . (tenant()?->id ?? 0));
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Subscription::rechainUserSubscriptions()</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Subscription/App/Models/Subscription.php (lines 370-459)

/**
 * KullanÄ±cÄ±nÄ±n tÃ¼m abonelik zincirini yeniden hesapla
 * Bir abonelik silindiÄŸinde veya deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r
 */
public static function rechainUserSubscriptions(int $userId): void {
    if (!tenant()) return;

    \DB::transaction(function () use ($userId) {
        // Aktif aboneliÄŸi bul
        $active = self::where('user_id', $userId)
            ->where('status', 'active')
            ->orderBy('current_period_end', 'desc')
            ->first();

        if (!$active) {
            // Aktif yok, sadece subscription_expires_at gÃ¼ncelle
            $user = User::find($userId);
            $user?->recalculateSubscriptionExpiry();
            return;
        }

        // Pending abonelikleri bul (oluÅŸturma sÄ±rasÄ±na gÃ¶re)
        $pendings = self::where('user_id', $userId)
            ->where('status', 'pending')
            ->orderBy('subscription_id', 'asc')
            ->get();

        if ($pendings->isEmpty()) {
            $user = User::find($userId);
            $user?->recalculateSubscriptionExpiry();
            return;
        }

        // Zinciri hesapla
        $chainEnd = $active->current_period_end;
        $updated = 0;

        foreach ($pendings as $pending) {
            // Bu aboneliÄŸin sÃ¼resi
            $duration = 365; // Default
            if ($pending->current_period_start && $pending->current_period_end) {
                $duration = $pending->current_period_start->diffInDays($pending->current_period_end);
            }

            $newStart = $chainEnd->copy();
            $newEnd = $chainEnd->copy()->addDays($duration);

            // Tarihler farklÄ±ysa gÃ¼ncelle
            if ($pending->current_period_start->format('Y-m-d') !== $newStart->format('Y-m-d')
                || $pending->current_period_end->format('Y-m-d') !== $newEnd->format('Y-m-d')) {

                $pending->updateQuietly([
                    'current_period_start' => $newStart,
                    'current_period_end' => $newEnd,
                    'next_billing_date' => $newEnd,
                ]);
                $updated++;
            }

            // Zinciri ilerlet
            $chainEnd = $newEnd;
        }

        // subscription_expires_at gÃ¼ncelle
        $user = User::find($userId);
        $user?->recalculateSubscriptionExpiry();
    });
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Chain Position</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Subscription Model - getChainPositionAttribute

/**
 * Subscription'Ä±n zincirdeki sÄ±rasÄ±nÄ± al
 * 1 = aktif, 2 = ilk bekleyen, 3 = ikinci bekleyen...
 */
public function getChainPositionAttribute(): int {
    if ($this->status === 'active') {
        return 1;
    }

    if ($this->status !== 'pending') {
        return 0; // Zincirde deÄŸil
    }

    $position = self::where('user_id', $this->user_id)
        ->whereIn('status', ['active', 'pending'])
        ->where('current_period_start', '<', $this->current_period_start)
        ->count();

    return $position + 1;
}

ğŸ“Œ KullanÄ±m:
@foreach($user->subscriptions as $sub)
    SÄ±ra: {{ $sub->chain_position }}
    Durum: {{ $sub->status }}
    BaÅŸlangÄ±Ã§: {{ $sub->current_period_start }}
@endforeach</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 4: DEVICE LIMIT SÄ°STEMÄ° -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">4ï¸âƒ£ Device Limit Sistemi (3-Tier Hierarchy)</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Her kullanÄ±cÄ±nÄ±n <strong>kaÃ§ cihazdan aynÄ± anda giriÅŸ yapabileceÄŸi</strong> sÄ±nÄ±rlÄ±dÄ±r.
                        Bu limit 3 farklÄ± yerden belirlenebilir ve <strong>Ã¶ncelik sÄ±rasÄ±</strong> vardÄ±r:
                    </p>

                    <div class="space-y-3 mb-4">
                        <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-amber-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">1</span>
                                <span class="font-bold text-amber-400">KullanÄ±cÄ± Ã–zel Limit (User Override)</span>
                            </div>
                            <p class="text-sm text-slate-300">
                                Admin, bir kullanÄ±cÄ±ya <strong>Ã¶zel limit</strong> verebilir.
                                Ã–rnek: VIP kullanÄ±cÄ±ya 10 cihaz, test kullanÄ±cÄ±sÄ±na 99 cihaz.
                            </p>
                            <div class="text-xs text-slate-400 mt-1">users.device_limit (eÄŸer NULL deÄŸilse)</div>
                        </div>

                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">2</span>
                                <span class="font-bold text-blue-400">Subscription Plan Limit</span>
                            </div>
                            <p class="text-sm text-slate-300">
                                KullanÄ±cÄ±nÄ±n <strong>aktif planÄ±na</strong> gÃ¶re belirlenir.
                                Ã–rnek: "Premium" planÄ± = 5 cihaz, "Basic" planÄ± = 2 cihaz.
                            </p>
                            <div class="text-xs text-slate-400 mt-1">subscription_plans.device_limit</div>
                        </div>

                        <div class="bg-slate-700 border-l-4 border-slate-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-slate-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">3</span>
                                <span class="font-bold text-slate-300">Global Setting (Fallback)</span>
                            </div>
                            <p class="text-sm text-slate-300">
                                YukarÄ±dakilerin hiÃ§biri yoksa <strong>sistem ayarÄ±</strong> kullanÄ±lÄ±r.
                                Ã–rnek: TÃ¼m Ã¼cretsiz kullanÄ±cÄ±lar iÃ§in 1 cihaz.
                            </p>
                            <div class="text-xs text-slate-400 mt-1">setting('auth_device_limit', 1)</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ” LIFO MekanizmasÄ± (Last In, First Out)</h4>
                        <p class="text-slate-300 mb-2">
                            KullanÄ±cÄ± limit aÅŸarsa ne olur? <strong>En eski cihaz otomatik Ã§Ä±kÄ±ÅŸ yapar!</strong>
                        </p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">1ï¸âƒ£</span>
                                <span class="text-slate-300">Limit: 2 cihaz, KullanÄ±cÄ± PC'den giriÅŸ yaptÄ± (Cihaz A)</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">2ï¸âƒ£</span>
                                <span class="text-slate-300">Telefon'dan giriÅŸ yaptÄ± (Cihaz B) â†’ Toplam 2 cihaz, limit doldu</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-amber-400">3ï¸âƒ£</span>
                                <span class="text-slate-300">Tablet'ten giriÅŸ yaptÄ± (Cihaz C) â†’ <strong>Cihaz A otomatik logout!</strong></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            3-tier sistem sayesinde hem genel kurallar hem de Ã¶zel durumlar yÃ¶netilebilir.
                            LIFO mekanizmasÄ± sayesinde kullanÄ±cÄ± yeni cihazdan giriÅŸ yaptÄ±ÄŸÄ±nda eski cihaz
                            otomatik Ã§Ä±kÄ±ÅŸ yapar, kullanÄ±cÄ±nÄ±n mÃ¼dahalesine gerek kalmaz.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">DeviceService::getDeviceLimit()</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Muzibu/App/Services/DeviceService.php (lines 537-571)

/**
 * Device limit al (3-tier hierarchy)
 * ğŸ”´ SINGLE SOURCE OF TRUTH: users.subscription_expires_at
 */
public function getDeviceLimit(User $user): int {
    if (!$this->shouldRun()) {
        return 999; // Sistem kapalÄ±ysa sÄ±nÄ±rsÄ±z
    }

    // 1ï¸âƒ£ User override (en yÃ¼ksek Ã¶ncelik)
    if ($user->device_limit !== null && $user->device_limit > 0) {
        return $user->device_limit;
    }

    // 2ï¸âƒ£ Subscription Plan
    $expiresAt = $user->subscription_expires_at;
    $hasPremium = $expiresAt && $expiresAt->isFuture();

    if ($hasPremium) {
        // Plan'dan device_limit al
        $subscription = $user->subscriptions()
            ->whereIn('status', ['active', 'trial'])
            ->with('plan')
            ->orderByDesc('created_at')
            ->first();

        if ($subscription && $subscription->plan && $subscription->plan->device_limit) {
            return (int) $subscription->plan->device_limit;
        }
    }

    // 3ï¸âƒ£ Tenant setting fallback
    if (function_exists('setting') && setting('auth_device_limit')) {
        return (int) setting('auth_device_limit');
    }

    return 1; // Son Ã§are: 1 cihaz
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">DeviceService::registerSession() - LIFO</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Muzibu/App/Services/DeviceService.php (lines 48-137)

/**
 * Yeni session kaydet (login sonrasÄ±)
 * Cookie kontrolÃ¼ ile aynÄ± tarayÄ±cÄ± mÄ± yoksa yeni cihaz mÄ± belirlenir
 */
public function registerSession(User $user): void {
    $sessionId = session()->getId();
    $cookieName = 'mzb_login_token';

    // ğŸ”¥ 1. AYNI TARAYICI MI? Cookie kontrolÃ¼
    $existingToken = request()->cookie($cookieName);

    if ($existingToken) {
        $existingSession = DB::table('user_active_sessions')
            ->where('user_id', $user->id)
            ->where('login_token', $existingToken)
            ->first();

        if ($existingSession) {
            // âœ… AYNI TARAYICI - Sadece gÃ¼ncelle, yeni token oluÅŸturma!
            DB::table('user_active_sessions')
                ->where('id', $existingSession->id)
                ->update([
                    'session_id' => $sessionId,
                    'last_activity' => now(),
                ]);

            // Cookie sÃ¼resini uzat
            cookie()->queue(cookie($cookieName, $existingToken, $lifetime));
            return; // Ä°ÅLEM BÄ°TTÄ°
        }
    }

    // ğŸ”¥ 2. FARKLI TARAYICI - Yeni session oluÅŸtur
    $lock = Cache::lock("user_login:{$user->id}", 10);
    $lock->get();

    try {
        $loginToken = bin2hex(random_bytes(32)); // 64 char

        DB::table('user_active_sessions')->insert([
            'user_id' => $user->id,
            'session_id' => $sessionId,
            'login_token' => $loginToken,
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'device_type' => $this->getDeviceType($agent),
            'device_name' => $this->getDeviceName($agent),
            'last_activity' => now(),
        ]);

        // Cookie oluÅŸtur
        cookie()->queue(cookie($cookieName, $loginToken, $lifetime));

        // ğŸ”¥ 3. LIFO KONTROLÃœ - Limit aÅŸÄ±ldÄ±ysa eski cihaz Ã§Ä±kÄ±ÅŸ yapsÄ±n
        $this->enforceDeviceLimit($user, $sessionId);

    } finally {
        $lock->release();
    }
}

protected function enforceDeviceLimit(User $user, string $currentSessionId): void {
    $limit = $this->getDeviceLimit($user);

    $sessions = DB::table('user_active_sessions')
        ->where('user_id', $user->id)
        ->orderBy('last_activity', 'asc') // En eski Ã¶nce
        ->get();

    if ($sessions->count() > $limit) {
        $toRemove = $sessions->count() - $limit;

        // En eski session'larÄ± sil (mevcut hariÃ§)
        $oldSessions = $sessions
            ->filter(fn($s) => $s->session_id !== $currentSessionId)
            ->take($toRemove);

        foreach ($oldSessions as $old) {
            $this->terminateSessionAtomicByRow($old, 'lifo', $user);
        }
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Session Tracking with Login Token</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ DeviceService::sessionExists() - Polling iÃ§in

/**
 * Session DB'de var mÄ±? (polling iÃ§in)
 * Cookie'deki login_token ile DB'deki login_token eÅŸleÅŸirse = geÃ§erli session
 *
 * LIFO ile Ã§alÄ±ÅŸmasÄ±:
 * - Tab A login â†’ token_A, cookie + DB
 * - Tab B login â†’ token_B, LIFO token_A'yÄ± DB'den siler
 * - Tab A polling â†’ cookie'de token_A var ama DB'de YOK â†’ LOGOUT
 */
public function sessionExists(User $user): bool {
    // 1. Cookie'den login_token al
    $cookieToken = request()->cookie('mzb_login_token');

    if (!$cookieToken) {
        return false; // Cookie yok = invalid
    }

    // 2. Login token ile DB'de kontrol et
    $session = DB::table('user_active_sessions')
        ->where('user_id', $user->id)
        ->where('login_token', $cookieToken)
        ->first();

    if ($session) {
        // Token eÅŸleÅŸti - session geÃ§erli, activity gÃ¼ncelle
        DB::table('user_active_sessions')
            ->where('id', $session->id)
            ->update(['last_activity' => now()]);
        return true;
    }

    // 3. Token eÅŸleÅŸmiyor = LIFO tarafÄ±ndan silindi â†’ LOGOUT
    return false;
}

ğŸ“Š user_active_sessions tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon          â”‚ Tip       â”‚ AÃ§Ä±klama                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id             â”‚ bigint    â”‚ PK                      â”‚
â”‚ user_id        â”‚ bigint    â”‚ FK users                â”‚
â”‚ session_id     â”‚ varchar   â”‚ Laravel session ID      â”‚
â”‚ login_token    â”‚ varchar   â”‚ 64 char unique token    â”‚
â”‚ ip_address     â”‚ varchar   â”‚ GiriÅŸ IP                â”‚
â”‚ user_agent     â”‚ text      â”‚ Browser bilgisi         â”‚
â”‚ device_type    â”‚ varchar   â”‚ mobile/tablet/desktop   â”‚
â”‚ device_name    â”‚ varchar   â”‚ Platform - Browser      â”‚
â”‚ last_activity  â”‚ timestamp â”‚ Son aktivite            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 5: TRIAL SÄ°STEMÄ° -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">5ï¸âƒ£ Trial (Deneme) Sistemi</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Yeni kullanÄ±cÄ±lar <strong>Ã¼cretsiz deneme</strong> (trial) hakkÄ±na sahiptir.
                        Deneme sÃ¼resi boyunca tÃ¼m premium Ã¶zellikler kullanÄ±labilir.
                    </p>

                    <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded mb-4">
                        <div class="font-bold text-blue-400 mb-2">ğŸ Trial KurallarÄ±</div>
                        <ul class="text-sm text-slate-300 space-y-1">
                            <li>â€¢ Her kullanÄ±cÄ± <strong>sadece 1 kez</strong> trial hakkÄ± kullanabilir</li>
                            <li>â€¢ Trial sÃ¼resi: Genellikle 7 gÃ¼n (plan ayarlarÄ±nda belirtilir)</li>
                            <li>â€¢ Trial bitince <strong>otomatik Ã¼cretlendirme YOK</strong>, kullanÄ±cÄ± satÄ±n almalÄ±</li>
                            <li>â€¢ Trial sÄ±rasÄ±nda tÃ¼m premium Ã¶zellikler aktif</li>
                        </ul>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Trial AkÄ±ÅŸÄ±</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">1ï¸âƒ£</span>
                                <span class="text-slate-300">KullanÄ±cÄ± kayÄ±t olur</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">2ï¸âƒ£</span>
                                <span class="text-slate-300">Sistem <strong>has_used_trial</strong> kontrolÃ¼ yapar (false ise devam)</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">3ï¸âƒ£</span>
                                <span class="text-slate-300">Trial planÄ±ndan 7 gÃ¼nlÃ¼k subscription oluÅŸturulur (status: trial)</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">4ï¸âƒ£</span>
                                <span class="text-slate-300"><strong>has_used_trial = true</strong> olarak iÅŸaretlenir</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-blue-400">5ï¸âƒ£</span>
                                <span class="text-slate-300">7 gÃ¼n boyunca premium Ã¶zellikler kullanÄ±lÄ±r</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-amber-400">6ï¸âƒ£</span>
                                <span class="text-slate-300">7. gÃ¼n bitince subscription status: expired olur</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-400">7ï¸âƒ£</span>
                                <span class="text-slate-300">KullanÄ±cÄ±nÄ±n abonelik satÄ±n almasÄ± gerekir (trial hakkÄ± tÃ¼kendi)</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Trial sistemi yeni kullanÄ±cÄ±larÄ±n servisi denemesini saÄŸlar. <strong>has_used_trial</strong>
                            flag'i sayesinde her kullanÄ±cÄ± sadece 1 kez deneme yapabilir, sistemin kÃ¶tÃ¼ye kullanÄ±mÄ± engellenir.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">SubscriptionService::createTrialForUser()</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Subscription/App/Services/SubscriptionService.php (lines 232-283)

public function createTrialForUser(User $user): ?Subscription {
    // 1. Setting kontrolÃ¼
    if (!setting('auth_subscription')) {
        return null;
    }

    // 2. Trial plan kontrolÃ¼
    $trialPlan = $this->getTrialPlan();
    if (!$trialPlan) {
        return null;
    }

    // 3. has_used_trial kontrolÃ¼
    if ($user->has_used_trial) {
        return null; // Trial hakkÄ± tÃ¼kendi
    }

    // 4. Subscription oluÅŸtur
    $duration = $this->getTrialDuration(); // Trial plan'dan al (Ã¶rn: 7 gÃ¼n)

    $cycles = $trialPlan->billing_cycles;
    $firstCycle = array_values($cycles)[0];

    $subscription = Subscription::create([
        'user_id' => $user->id,
        'subscription_plan_id' => $trialPlan->subscription_plan_id,
        'status' => 'active', // Trial da active sayÄ±lÄ±r
        'started_at' => now(),
        'current_period_start' => now(),
        'current_period_end' => now()->addDays($duration),
        'price_per_cycle' => 0, // Trial Ã¼cretsiz
        'currency' => $trialPlan->currency ?? 'TRY',
        'cycle_key' => array_keys($cycles)[0] ?? 'deneme-7-gun',
        'cycle_metadata' => $firstCycle,
        'has_trial' => true,
        'trial_days' => $duration,
        'trial_ends_at' => now()->addDays($duration),
    ]);

    // 5. has_used_trial = true
    $user->update(['has_used_trial' => true]);

    return $subscription;
}

/**
 * KullanÄ±cÄ± daha Ã¶nce trial kullandÄ± mÄ±?
 */
public static function userHasUsedTrial(int $userId): bool {
    return self::where('user_id', $userId)
        ->where('has_trial', true)
        ->where('status', '!=', 'pending_payment') // Pending olanlarÄ± sayma
        ->exists();
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Trial Plan TanÄ±mÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š Trial Plan Ã–rneÄŸi (subscription_plans tablosu)

{
    "subscription_plan_id": 1,
    "title": {"tr": "Ãœcretsiz Deneme", "en": "Free Trial"},
    "slug": "free-trial",
    "is_trial": true, // ğŸ”´ KRÄ°TÄ°K: Trial planÄ± olduÄŸunu belirtir
    "is_public": true,
    "is_active": true,
    "billing_cycles": {
        "deneme-7-gun": {
            "label": {"tr": "7 GÃ¼n Deneme", "en": "7 Days Trial"},
            "duration_days": 7,
            "price": 0, // Ãœcretsiz
            "sort_order": 1
        }
    },
    "device_limit": 3, // Trial sÄ±rasÄ±nda 3 cihaz
    "features": ["ReklamsÄ±z", "HD Kalite", "Offline"]
}

ğŸ“Œ Kodda KullanÄ±m:
$trialPlan = SubscriptionPlan::where('is_trial', true)
    ->where('is_active', true)
    ->first();</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Database Schema - Trial Fields</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š users tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ has_used_trial   â”‚ boolean  â”‚ Trial hakkÄ± kullanÄ±ldÄ± mÄ±  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š subscriptions tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ has_trial        â”‚ boolean  â”‚ Bu subscription trial mÄ±   â”‚
â”‚ trial_days       â”‚ int      â”‚ Trial sÃ¼resi (gÃ¼n)         â”‚
â”‚ trial_ends_at    â”‚ timestampâ”‚ Trial bitiÅŸ tarihi         â”‚
â”‚ status           â”‚ varchar  â”‚ trial / active / expired   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š subscription_plans tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ is_trial         â”‚ boolean  â”‚ Trial planÄ± mÄ±             â”‚
â”‚ trial_days       â”‚ int      â”‚ Default trial sÃ¼resi       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 6: CORPORATE ACCOUNT (KURUMSAL ABONELÄ°K) -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">6ï¸âƒ£ Corporate Account Sistemi (Kurumsal Abonelik)</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        <strong>Kurumsal hesaplar</strong>, bir ÅŸirketin birden fazla Ã§alÄ±ÅŸanÄ±na toplu abonelik vermesi iÃ§in tasarlanmÄ±ÅŸtÄ±r.
                        Sadece <strong>Muzibu.com</strong> tenant'Ä±nda (tenant_id: 1001) kullanÄ±lÄ±r.
                    </p>

                    <div class="bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded mb-4">
                        <div class="font-bold text-purple-400 mb-2">ğŸ¢ Kurumsal Hesap YapÄ±sÄ±</div>
                        <ul class="text-sm text-slate-300 space-y-1">
                            <li>â€¢ <strong>Kurum Sahibi (Owner):</strong> Abonelik satÄ±n alan, Ã¶demeyi yapan kiÅŸi</li>
                            <li>â€¢ <strong>Ã‡alÄ±ÅŸanlar (Members):</strong> Davet kodu ile katÄ±lan, Ã¼cretsiz yararlanan kiÅŸiler</li>
                            <li>â€¢ <strong>Spot Sistemi:</strong> Åirket mÃ¼ziÄŸi dinlerken araya anonslar ekleyebilir</li>
                        </ul>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Ã–rnek Senaryo</h4>
                        <div class="space-y-3 text-sm">
                            <div class="border-l-4 border-green-500 pl-4">
                                <div class="text-green-400 font-semibold">ABC Åirketi - Kurucu</div>
                                <div class="text-slate-400">Sahibi: Ahmet YÄ±lmaz</div>
                                <div class="text-slate-300">â€¢ 50 kullanÄ±cÄ±lÄ±k abonelik satÄ±n aldÄ± (50 x 20 TL/ay = 1000 TL)</div>
                                <div class="text-slate-300">â€¢ Davet kodu oluÅŸturdu: <strong>ABC12345</strong></div>
                            </div>

                            <div class="border-l-4 border-blue-500 pl-4">
                                <div class="text-blue-400 font-semibold">Ã‡alÄ±ÅŸan - Mehmet</div>
                                <div class="text-slate-300">â€¢ <strong>ABC12345</strong> kodunu girdi</div>
                                <div class="text-slate-300">â€¢ ABC Åirketi'ne baÄŸlandÄ±, premium Ã¼yelik kazandÄ±</div>
                                <div class="text-slate-300">â€¢ Ã–deme yapmadÄ±, ÅŸirketin aboneliÄŸinden yararlanÄ±yor</div>
                            </div>

                            <div class="border-l-4 border-amber-500 pl-4">
                                <div class="text-amber-400 font-semibold">Spot Sistemi</div>
                                <div class="text-slate-300">â€¢ ABC Åirketi her 10 ÅŸarkÄ±da bir anons ekleyebilir</div>
                                <div class="text-slate-300">â€¢ Ã–rn: "Mola zamanÄ±! Kantinden sÄ±cak Ã§ay alabilirsiniz"</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Kurumsal sistem sayesinde ÅŸirketler toplu alÄ±m yapÄ±p Ã§alÄ±ÅŸanlarÄ±na premium hizmet verebilir.
                            Her Ã§alÄ±ÅŸan ayrÄ± hesap aÃ§mak zorunda kalmaz, merkezi yÃ¶netim saÄŸlanÄ±r.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">MuzibuCorporateAccount Model</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/Muzibu/App/Models/MuzibuCorporateAccount.php

class MuzibuCorporateAccount extends Model {
    protected $fillable = [
        'user_id',              // Kurum sahibi
        'parent_id',            // Ana ÅŸube (NULL ise ana firma)
        'corporate_code',       // Davet kodu (8 char)
        'company_name',         // Åirket adÄ±
        'branch_name',          // Åube adÄ±
        'is_active',
        // Spot sistemi
        'spot_enabled',         // Spot aktif mi
        'spot_songs_between',   // KaÃ§ ÅŸarkÄ±da bir spot
        'spot_current_index',   // Mevcut spot sÄ±rasÄ±
        'spot_is_paused',       // Spot duraklatÄ±ldÄ± mÄ±
    ];

    // Ä°liÅŸkiler
    public function owner(): BelongsTo {
        return $this->belongsTo(User::class, 'user_id');
    }

    public function parent(): BelongsTo {
        return $this->belongsTo(self::class, 'parent_id');
    }

    public function children(): HasMany {
        return $this->hasMany(self::class, 'parent_id'); // Åubeler
    }

    public function spots(): HasMany {
        return $this->hasMany(CorporateSpot::class);
    }

    // Helper metodlar
    public function isParent(): bool {
        return $this->parent_id === null;
    }

    public static function generateCode(): string {
        do {
            $code = strtoupper(substr(md5(uniqid()), 0, 8));
        } while (self::where('corporate_code', $code)->exists());

        return $code; // Ã–rn: ABC12345
    }

    public static function getCorporateForUser(int $userId): ?self {
        $record = self::where('user_id', $userId)->first();
        if (!$record) return null;

        // Ãœyeyse parent kurumu dÃ¶ndÃ¼r
        if ($record->parent_id) {
            return $record->parent;
        }

        // Kurum sahibiyse kendisini dÃ¶ndÃ¼r
        return $record;
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">User Model - Corporate MetodlarÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Models/User.php (lines 248-447)

// Corporate Account iliÅŸkileri (Sadece Muzibu)
public function corporateAccount() {
    if (!$this->isMuzibuTenant()) {
        return $this->belongsTo(self::class, 'id')->whereRaw('1=0'); // Empty
    }
    return $this->belongsTo(MuzibuCorporateAccount::class);
}

public function ownedCorporateAccount() {
    if (!$this->isMuzibuTenant()) {
        return $this->hasOne(self::class, 'id')->whereRaw('1=0');
    }
    return $this->hasOne(MuzibuCorporateAccount::class, 'user_id');
}

// Kurum kontrolÃ¼
public function isCorporateOwner(): bool {
    if (!$this->isMuzibuTenant()) return false;
    return $this->ownedCorporateAccount()->exists();
}

public function isCorporateMember(): bool {
    if (!$this->isMuzibuTenant()) return false;
    return $this->corporate_account_id !== null;
}

// Effective Subscription (kurum Ã¼yesi ise owner'Ä±n subscription'Ä±nÄ± al)
public function getEffectiveSubscription() {
    if (!$this->isMuzibuTenant()) {
        return $this->subscriptions()->active()->first();
    }

    // Kurum Ã¼yesi ise owner'Ä±n subscription'Ä±nÄ± kullan
    if ($this->isCorporateMember() && $this->corporateAccount) {
        return $this->corporateAccount->owner->subscriptions()->active()->first();
    }

    // Normal kullanÄ±cÄ±
    return $this->subscriptions()->active()->first();
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Database Schema</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š muzibu_corporate_accounts tablosu (Tenant 1001)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon                  â”‚ Tip      â”‚ AÃ§Ä±klama                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                     â”‚ bigint   â”‚ PK                       â”‚
â”‚ user_id                â”‚ bigint   â”‚ FK users (owner)         â”‚
â”‚ parent_id              â”‚ bigint   â”‚ Ana ÅŸube (NULL = owner)  â”‚
â”‚ corporate_code         â”‚ varchar  â”‚ Davet kodu (ABC12345)    â”‚
â”‚ company_name           â”‚ varchar  â”‚ Åirket adÄ±               â”‚
â”‚ branch_name            â”‚ varchar  â”‚ Åube adÄ±                 â”‚
â”‚ is_active              â”‚ boolean  â”‚ Aktif mi                 â”‚
â”‚ spot_enabled           â”‚ boolean  â”‚ Spot sistemi aktif mi    â”‚
â”‚ spot_songs_between     â”‚ int      â”‚ KaÃ§ ÅŸarkÄ±da bir spot     â”‚
â”‚ spot_current_index     â”‚ int      â”‚ Mevcut spot sÄ±rasÄ±       â”‚
â”‚ spot_is_paused         â”‚ boolean  â”‚ Spot duraklatÄ±ldÄ± mÄ±     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š users tablosu eklentisi
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ corporate_account_id   â”‚ bigint   â”‚ FK muzibu_corporate_...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ Ä°liÅŸki:
- Owner: corporate_account_id = NULL, ownedCorporateAccount var
- Member: corporate_account_id = X, corporateAccount var</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-slate-400 text-sm mt-16 pb-8">
            28 Ocak 2026 â€¢ Muzibu.com.tr
        </footer>

    </div>
</body>
</html>
