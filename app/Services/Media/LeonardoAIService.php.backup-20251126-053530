<?php

namespace App\Services\Media;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

/**
 * Leonardo AI Image Generation Service
 *
 * Blog iÃ§erikleri iÃ§in tamamen dinamik AI gÃ¶rselleri Ã¼retir
 * Her gÃ¶rsel iÃ§in benzersiz prompt zinciri oluÅŸturur
 * API: https://docs.leonardo.ai/reference
 */
class LeonardoAIService
{
    protected string $apiKey;
    protected string $baseUrl = 'https://cloud.leonardo.ai/api/rest/v1';

    // Lucid Origin - En kaliteli model
    protected string $defaultModel = '7b592283-e8a7-4c5a-9ba6-d18c31f258b9';

    // Style UUID'leri
    protected array $styleUUIDs = [
        'cinematic' => 'a5632c7c-ddbb-4e2f-ba34-8456ab3ac436',
        'cinematic_closeup' => 'cc53f935-884c-40a0-b7eb-1f5c42821fb5',
        'dynamic' => '111dc692-d470-4eec-b791-3475abac4c46',
        'film' => '85da2dcc-c373-464c-9a7a-5624359be859',
        'hdr' => '97c20e5c-1af6-4d42-b227-54d03d8f0727',
        'moody' => '621e1c9a-6319-4bee-a12d-ae40659162fa',
        'stock_photo' => '5bdc3f2a-1be6-4d1c-8e77-992a30824a2c',
        'vibrant' => 'dee282d3-891f-4f73-ba02-7f8131e5541b',
        'neutral' => '0d914779-c822-430a-b976-30075033f1c4',
    ];

    public function __construct()
    {
        $this->apiKey = config('services.leonardo.api_key', '');
    }

    /**
     * Blog baÅŸlÄ±ÄŸÄ±ndan gÃ¶rsel Ã¼ret
     */
    public function generateForBlog(string $title, string $context = 'blog'): ?array
    {
        if (empty($this->apiKey)) {
            Log::error('Leonardo AI: API key not configured');
            return null;
        }

        // Tamamen dinamik prompt oluÅŸtur
        $promptData = $this->buildDynamicPrompt($title, $context);

        Log::info('ðŸŽ¨ Leonardo AI: Starting generation', [
            'title' => $title,
            'prompt' => $promptData['prompt'],
            'style' => $promptData['style'],
        ]);

        try {
            // GÃ¶rsel Ã¼retimi baÅŸlat
            $generationId = $this->createGeneration($promptData);

            if (!$generationId) {
                return null;
            }

            // Sonucu bekle ve al
            $imageUrl = $this->waitForGeneration($generationId);

            if (!$imageUrl) {
                return null;
            }

            // GÃ¶rseli indir
            $imageData = $this->downloadImage($imageUrl);

            if (!$imageData) {
                return null;
            }

            Log::info('ðŸŽ¨ Leonardo AI: Generation successful', [
                'generation_id' => $generationId,
                'image_size' => strlen($imageData),
            ]);

            return [
                'content' => $imageData,
                'url' => $imageUrl,
                'generation_id' => $generationId,
                'provider' => 'leonardo',
                'prompt' => $promptData['prompt'],
                'style' => $promptData['style'],
            ];

        } catch (\Exception $e) {
            Log::error('ðŸŽ¨ Leonardo AI: Generation failed', [
                'error' => $e->getMessage(),
                'title' => $title,
            ]);
            return null;
        }
    }

    /**
     * GÃ¶rsel Ã¼retimi baÅŸlat - Lucid Origin modeli ile
     */
    protected function createGeneration(array $promptData): ?string
    {
        // GerÃ§ekÃ§ilik kÄ±sÄ±tlamasÄ± + yazÄ± yasaÄŸÄ± ekle (ULTRA GÃœÃ‡LÃœ)
        $realismConstraint = " CRITICAL ABSOLUTE REQUIREMENTS: 1) Realistic industrial equipment ONLY - real-world designs from Toyota, Linde, Jungheinrich, Crown, Yale. Standard colors: yellow, orange, red, blue, gray. NO futuristic/sci-fi/conceptual designs. 2) ABSOLUTELY ZERO TEXT, LETTERS, NUMBERS, OR SYMBOLS ANYWHERE IN THE IMAGE - no text on equipment, no text on signs, no text on floor, no text on walls, no text on screens, no text on labels, no comparison charts, no graphs with text, no infographics. The image must be 100% text-free. 3) NO comparison charts, tables, graphs, diagrams, or any visual with data/numbers.";

        $finalPrompt = $promptData['prompt'] . $realismConstraint;

        // ULTRA AGGRESSIVE Negative prompt - YazÄ± ve kÄ±yaslama grafiklerini kesinlikle engelle
        $negativePrompt = "text, letters, words, numbers, digits, brand names, logos, labels, signs, watermarks, typography, writing, captions, subtitles, titles, stamps, badges, stickers, name plates, serial numbers, model numbers, any written content, illegible text, garbled text, distorted letters, comparison chart, comparison table, comparison graphic, infographic, data visualization, graph, pie chart, bar chart, spreadsheet, checklist, bullet points, price tags, specifications text, technical text, measurement text, warning text, instruction text, any form of alphanumeric characters";

        $response = Http::withHeaders([
            'accept' => 'application/json',
            'content-type' => 'application/json',
            'authorization' => 'Bearer ' . $this->apiKey,
        ])->timeout(30)->post($this->baseUrl . '/generations', [
            'modelId' => $this->defaultModel,
            'prompt' => $finalPrompt,
            'negative_prompt' => $negativePrompt,
            'styleUUID' => $promptData['styleUUID'],
            'contrast' => $promptData['contrast'],
            'num_images' => 1,
            'width' => 1472,
            'height' => 832,
            'alchemy' => false,
            'ultra' => false,
        ]);

        if (!$response->successful()) {
            Log::error('Leonardo AI: Create generation failed', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);
            return null;
        }

        $data = $response->json();
        return $data['sdGenerationJob']['generationId'] ?? null;
    }

    /**
     * Ãœretimin tamamlanmasÄ±nÄ± bekle
     */
    protected function waitForGeneration(string $generationId, int $maxAttempts = 30, int $delay = 3): ?string
    {
        for ($i = 0; $i < $maxAttempts; $i++) {
            sleep($delay);

            $response = Http::withHeaders([
                'accept' => 'application/json',
                'authorization' => 'Bearer ' . $this->apiKey,
            ])->timeout(30)->get($this->baseUrl . '/generations/' . $generationId);

            if (!$response->successful()) {
                continue;
            }

            $data = $response->json();
            $generation = $data['generations_by_pk'] ?? null;

            if (!$generation) {
                continue;
            }

            $status = $generation['status'] ?? '';

            if ($status === 'COMPLETE') {
                $images = $generation['generated_images'] ?? [];
                if (!empty($images)) {
                    return $images[0]['url'];
                }
            } elseif ($status === 'FAILED') {
                Log::error('Leonardo AI: Generation failed', [
                    'generation_id' => $generationId,
                ]);
                return null;
            }

            Log::debug('Leonardo AI: Still processing', [
                'generation_id' => $generationId,
                'attempt' => $i + 1,
                'status' => $status,
            ]);
        }

        Log::error('Leonardo AI: Timeout waiting for generation', [
            'generation_id' => $generationId,
        ]);
        return null;
    }

    /**
     * GÃ¶rseli indir
     */
    protected function downloadImage(string $url): ?string
    {
        $response = Http::timeout(60)->get($url);

        if (!$response->successful()) {
            Log::error('Leonardo AI: Image download failed', [
                'url' => $url,
                'status' => $response->status(),
            ]);
            return null;
        }

        return $response->body();
    }

    /**
     * Tamamen dinamik prompt oluÅŸtur
     * Prompt Zinciri: Subject â†’ Context â†’ Texture â†’ Angle â†’ Background â†’ Lighting â†’ Camera â†’ Lens â†’ Atmosphere
     */
    protected function buildDynamicPrompt(string $title, string $context): array
    {
        $tenantId = function_exists('tenant') && tenant() ? tenant('id') : null;

        // Tenant 2 (ixtif.com) - EndÃ¼striyel ekipman
        if ($tenantId == 2) {
            return $this->buildIndustrialDynamicPrompt($title);
        }

        // Tenant 1001 (muzibu.com) - MÃ¼zik
        if ($tenantId == 1001) {
            return $this->buildMusicDynamicPrompt($title);
        }

        // Genel
        return $this->buildGenericDynamicPrompt($title);
    }

    /**
     * EndÃ¼striyel ekipman iÃ§in dinamik prompt (Tenant 2)
     */
    protected function buildIndustrialDynamicPrompt(string $title): array
    {
        // Ana ekipmanÄ± tespit et
        $equipment = $this->detectEquipment($title);

        // ========== PROMPT ZÄ°NCÄ°RÄ° HAVUZLARI ==========

        // 1. SUBJECT - Ana konu (ekipmanÄ±n durumu/aksiyonu)
        $subjects = [
            "a {$equipment} being operated by a worker",
            "a {$equipment} lifting heavy pallets",
            "a {$equipment} parked in the corner of a facility",
            "a {$equipment} undergoing maintenance",
            "workers inspecting a {$equipment}",
            "a technician repairing a {$equipment}",
            "a {$equipment} moving through narrow aisles",
            "a {$equipment} loading a delivery truck",
            "multiple {$equipment}s lined up for shift change",
            "a {$equipment} with its operator taking a break",
            "a brand new {$equipment} being delivered",
            "a {$equipment} charging at its station",
            "a {$equipment} navigating around obstacles",
            "workers training on a {$equipment}",
            "a {$equipment} stacking boxes on high shelves",
            "a supervisor overseeing {$equipment} operations",
            "a {$equipment} in the middle of inventory counting",
            "a dusty {$equipment} after a long shift",
            "a {$equipment} with safety lights flashing",
            "workers discussing near a parked {$equipment}",
        ];

        // 2. CONTEXT/ACTION - BaÄŸlam ve aksiyon
        $contexts = [
            "during a busy morning shift",
            "in the middle of a large shipment arrival",
            "during routine safety inspection",
            "at the end of a productive day",
            "during peak season operations",
            "while other workers walk by",
            "as packages move on conveyor belts nearby",
            "during a training session for new employees",
            "while rain falls outside the open warehouse door",
            "during an efficiency audit",
            "as the facility prepares for a major order",
            "during shift handover",
            "while inventory is being reorganized",
            "during a scheduled maintenance window",
            "as natural light streams through skylights",
            "while forklifts pass in the background",
            "during a quality control check",
            "as workers sort packages nearby",
            "during early morning preparations",
            "while the facility buzzes with activity",
        ];

        // 3. FACTORY TEXTURE - EndÃ¼striyel doku detaylarÄ±
        $textures = [
            "scratched metal surfaces and worn rubber wheels",
            "oil stains on concrete floor",
            "industrial grime on machinery",
            "dust particles visible in light beams",
            "weathered wooden pallets stacked nearby",
            "scuffed safety barriers",
            "peeling warning labels on equipment",
            "rust spots on older machinery",
            "tire marks on the polished floor",
            "condensation on cold metal surfaces",
            "fingerprints on control panels",
            "chalk marks on the floor for positioning",
            "cable management systems showing wear",
            "patched concrete where equipment was moved",
            "faded floor markings from years of use",
            "grease spots near maintenance areas",
            "worn grip tape on handles",
            "scratched safety glass on enclosures",
            "paint chips on metal railings",
            "subtle vibration blur from running machinery",
        ];

        // 4. CAMERA ANGLE - Kamera aÃ§Ä±sÄ±
        $angles = [
            "shot from a low angle emphasizing scale",
            "captured from eye level for natural perspective",
            "photographed from above showing the workspace",
            "taken from a three-quarter view",
            "shot through warehouse shelving",
            "captured with slight Dutch angle for dynamism",
            "photographed from behind the operator",
            "taken from a distance showing full context",
            "close-up focusing on operational details",
            "wide shot encompassing the entire scene",
            "shot from the side showing profile",
            "captured looking down an aisle",
            "photographed through a doorway",
            "taken from mezzanine level looking down",
            "shot at operator's shoulder level",
            "captured from forklift's perspective",
            "photographed through safety netting",
            "taken with leading lines of floor markings",
            "shot emphasizing depth of the facility",
            "captured with equipment in foreground",
        ];

        // 5. BACKGROUND - Arka plan
        $backgrounds = [
            "rows of metal pallet racks extending into distance",
            "loading dock with trucks waiting",
            "automated conveyor system in motion",
            "office windows overlooking the warehouse floor",
            "emergency exits with green signage",
            "fire extinguisher stations along walls",
            "electrical panels and industrial controls",
            "stacked cardboard boxes ready for shipping",
            "empty pallets waiting to be used",
            "other workers operating different equipment",
            "industrial fans mounted on walls",
            "time clocks and safety bulletin boards",
            "plastic strip curtains between zones",
            "cold storage doors with frost",
            "packaging stations with materials",
            "quality control inspection area",
            "break room visible through windows",
            "shipping labels and scanners on tables",
            "maintenance tool cabinets",
            "safety equipment storage lockers",
        ];

        // 6. LIGHTING - AydÄ±nlatma
        $lightings = [
            "harsh fluorescent lights casting sharp shadows",
            "natural daylight from large skylights",
            "warm evening light through high windows",
            "mixed lighting from different sources",
            "dramatic side lighting from dock doors",
            "soft diffused light on overcast day",
            "bright LED panels creating even illumination",
            "spotlights highlighting work areas",
            "dim lighting in less-used sections",
            "golden hour light streaming through windows",
            "blue-tinted light from computer screens",
            "emergency lighting creating red accents",
            "motion-sensor lights flickering on",
            "light rays cutting through dusty air",
            "reflected light from polished floors",
            "harsh overhead lights with deep shadows",
            "backlit scene with equipment silhouettes",
            "cool white industrial lighting",
            "warm incandescent from office areas",
            "strobing safety lights on equipment",
        ];

        // 7. CAMERA - Kamera tipi
        $cameras = [
            "shot on Canon EOS R5",
            "captured with Sony A7R IV",
            "photographed using Nikon Z9",
            "taken with Hasselblad medium format",
            "shot on Fujifilm GFX 100S",
            "captured with Leica SL2",
            "photographed using Phase One",
            "taken with RED cinema camera",
            "shot on ARRI Alexa",
            "captured with Blackmagic Pocket",
            "photographed using Canon C70",
            "taken with Sony FX6",
            "shot on Panasonic S1H",
            "captured with Sigma fp L",
            "photographed using Canon 5D Mark IV",
        ];

        // 8. LENS - Lens tipi
        $lenses = [
            "with 24mm wide angle lens",
            "using 35mm prime for natural view",
            "with 50mm lens for standard perspective",
            "using 85mm for compressed background",
            "with 16-35mm zoom for flexibility",
            "using 24-70mm versatile zoom",
            "with 70-200mm telephoto",
            "using tilt-shift lens for architecture",
            "with 14mm ultra-wide for dramatic effect",
            "using 100mm macro for detail shots",
            "with 28mm street photography lens",
            "using 40mm pancake lens",
            "with anamorphic lens for cinematic look",
            "using vintage manual focus lens",
            "with f/1.4 aperture for shallow depth",
        ];

        // 9. ATMOSPHERE - Atmosfer ve mood
        $atmospheres = [
            "conveying industrial efficiency and precision",
            "showing the human element of logistics work",
            "emphasizing safety and professionalism",
            "capturing the rhythm of warehouse operations",
            "highlighting modern supply chain technology",
            "showing wear and authenticity of daily use",
            "conveying scale and organization",
            "emphasizing teamwork and coordination",
            "capturing a moment of focused concentration",
            "showing the contrast of human and machine",
            "highlighting the complexity of logistics",
            "conveying reliability and consistency",
            "showing pride in skilled equipment operation",
            "capturing the energy of a working facility",
            "emphasizing cleanliness despite heavy use",
            "showing the passage of time through wear",
            "conveying urgency during busy periods",
            "highlighting attention to detail",
            "showing quiet moments between rushes",
            "capturing the satisfaction of completed work",
        ];

        // ========== PROMPT BÄ°RLEÅžTÄ°RME ==========

        $prompt = sprintf(
            "Photograph of %s, %s. Details include %s. %s. Background shows %s. %s. %s %s. The image %s.",
            $subjects[array_rand($subjects)],
            $contexts[array_rand($contexts)],
            $textures[array_rand($textures)],
            $angles[array_rand($angles)],
            $backgrounds[array_rand($backgrounds)],
            $lightings[array_rand($lightings)],
            $cameras[array_rand($cameras)],
            $lenses[array_rand($lenses)],
            $atmospheres[array_rand($atmospheres)]
        );

        // Style ve contrast seÃ§imi
        $styles = ['cinematic', 'dynamic', 'film', 'hdr', 'moody', 'stock_photo', 'vibrant', 'neutral'];
        $selectedStyle = $styles[array_rand($styles)];

        $contrasts = [3, 3.5, 4];
        $selectedContrast = $contrasts[array_rand($contrasts)];

        return [
            'prompt' => $prompt,
            'style' => $selectedStyle,
            'styleUUID' => $this->styleUUIDs[$selectedStyle],
            'contrast' => $selectedContrast,
        ];
    }

    /**
     * MÃ¼zik sektÃ¶rÃ¼ iÃ§in dinamik prompt (Tenant 1001)
     */
    protected function buildMusicDynamicPrompt(string $title): array
    {
        // MÃ¼zik enstrÃ¼manÄ±/konusu tespit et
        $musicSubject = $this->detectMusicSubject($title);

        $subjects = [
            "a musician playing {$musicSubject}",
            "a {$musicSubject} resting on a stand",
            "hands positioned on {$musicSubject}",
            "a vintage {$musicSubject} in a studio",
            "a {$musicSubject} during a recording session",
            "a collection of instruments including {$musicSubject}",
            "a {$musicSubject} being tuned",
            "close-up of {$musicSubject} details",
            "a {$musicSubject} on stage before a concert",
            "a {$musicSubject} in a practice room",
        ];

        $contexts = [
            "in a professional recording studio",
            "during a late night jam session",
            "at a live concert venue",
            "in a cozy home studio",
            "during a music lesson",
            "at a rehearsal space",
            "in a vintage music shop",
            "during soundcheck",
            "at a music festival backstage",
            "in an acoustic treatment room",
        ];

        $lightings = [
            "warm amber stage lighting",
            "soft studio lighting with diffusers",
            "dramatic spotlight from above",
            "neon accent lights in background",
            "natural window light in studio",
            "colored LED strips creating mood",
            "classic incandescent warmth",
            "blue hour light through windows",
            "mixed practical and studio lights",
            "silhouette backlighting",
        ];

        $cameras = [
            "shot on Canon EOS R5",
            "captured with Sony A7 III",
            "photographed using Leica Q2",
            "taken with Fujifilm X-T4",
            "shot on Nikon Z6",
        ];

        $lenses = [
            "with 35mm prime lens",
            "using 50mm f/1.2 for bokeh",
            "with 85mm portrait lens",
            "using 24mm for environment",
            "with vintage anamorphic lens",
        ];

        $atmospheres = [
            "conveying passion for music",
            "showing artistic dedication",
            "capturing creative energy",
            "emphasizing musical craftsmanship",
            "showing intimate connection with instrument",
        ];

        $prompt = sprintf(
            "Photograph of %s, %s. %s. %s %s. The image %s.",
            $subjects[array_rand($subjects)],
            $contexts[array_rand($contexts)],
            $lightings[array_rand($lightings)],
            $cameras[array_rand($cameras)],
            $lenses[array_rand($lenses)],
            $atmospheres[array_rand($atmospheres)]
        );

        $styles = ['cinematic', 'moody', 'film', 'vibrant'];
        $selectedStyle = $styles[array_rand($styles)];

        return [
            'prompt' => $prompt,
            'style' => $selectedStyle,
            'styleUUID' => $this->styleUUIDs[$selectedStyle],
            'contrast' => 3.5,
        ];
    }

    /**
     * Genel dinamik prompt
     */
    protected function buildGenericDynamicPrompt(string $title): array
    {
        $prompt = "Professional photograph representing the concept of: {$title}. Shot on high-end camera with natural lighting, showing authentic details and professional composition.";

        return [
            'prompt' => $prompt,
            'style' => 'stock_photo',
            'styleUUID' => $this->styleUUIDs['stock_photo'],
            'contrast' => 3.5,
        ];
    }

    /**
     * BaÅŸlÄ±ktan ekipman tipini tespit et
     */
    protected function detectEquipment(string $title): string
    {
        $titleLower = mb_strtolower($title);

        // Forklift varyasyonlarÄ±
        if (preg_match('/forklift/ui', $titleLower)) {
            $types = [
                'yellow forklift',
                'electric forklift',
                'propane forklift',
                'reach truck',
                'counterbalance forklift',
                'side loader forklift',
                'turret truck',
                'order picker forklift',
                'rough terrain forklift',
                'compact forklift',
            ];
            return $types[array_rand($types)];
        }

        // Transpalet varyasyonlarÄ±
        if (preg_match('/transpalet|palet\s*jak/ui', $titleLower)) {
            $types = [
                'electric pallet jack',
                'manual pallet truck',
                'powered pallet jack',
                'walkie pallet jack',
                'rider pallet jack',
                'low-profile pallet jack',
                'stainless steel pallet jack',
                'scale pallet jack',
                'narrow aisle pallet jack',
                'heavy-duty pallet truck',
            ];
            return $types[array_rand($types)];
        }

        // Ä°stif makinesi
        if (preg_match('/istif|stacker/ui', $titleLower)) {
            $types = [
                'electric stacker',
                'manual stacker',
                'walkie stacker',
                'counterbalance stacker',
                'reach stacker',
                'semi-electric stacker',
                'pallet stacker',
                'platform stacker',
            ];
            return $types[array_rand($types)];
        }

        // Order picker
        if (preg_match('/order\s*picker|sipariÅŸ\s*toplama/ui', $titleLower)) {
            $types = [
                'order picker',
                'stock picker',
                'cherry picker',
                'man-up order picker',
                'low-level order picker',
            ];
            return $types[array_rand($types)];
        }

        // Depo/lojistik genel
        if (preg_match('/depo|lojistik|warehouse|logistics/ui', $titleLower)) {
            $types = [
                'warehouse equipment',
                'material handling equipment',
                'logistics machinery',
                'warehouse vehicles',
            ];
            return $types[array_rand($types)];
        }

        // VarsayÄ±lan - karÄ±ÅŸÄ±k ekipman
        $defaults = [
            'forklift',
            'pallet jack',
            'warehouse stacker',
            'material handling equipment',
        ];
        return $defaults[array_rand($defaults)];
    }

    /**
     * BaÅŸlÄ±ktan mÃ¼zik konusunu tespit et
     */
    protected function detectMusicSubject(string $title): string
    {
        $titleLower = mb_strtolower($title);

        if (preg_match('/gitar|guitar/ui', $titleLower)) {
            return 'guitar';
        }
        if (preg_match('/piyano|piano/ui', $titleLower)) {
            return 'piano';
        }
        if (preg_match('/davul|drum/ui', $titleLower)) {
            return 'drums';
        }
        if (preg_match('/keman|violin/ui', $titleLower)) {
            return 'violin';
        }
        if (preg_match('/synthesizer|synth/ui', $titleLower)) {
            return 'synthesizer';
        }

        return 'musical instrument';
    }

    /**
     * Direkt prompt'tan gÃ¶rsel Ã¼ret (Admin Panel iÃ§in)
     * OpenAI tarafÄ±ndan enhance edilmiÅŸ prompt alÄ±r
     *
     * @param string $enhancedPrompt Enhance edilmiÅŸ prompt
     * @param array $options ['width' => 1472, 'height' => 832, 'style' => 'cinematic']
     * @return array|null ['url' => '...', 'content' => '...', 'generation_id' => '...']
     */
    public function generateFromPrompt(string $enhancedPrompt, array $options = []): ?array
    {
        if (empty($this->apiKey)) {
            Log::error('Leonardo AI: API key not configured');
            return null;
        }

        $width = $options['width'] ?? 1472;
        $height = $options['height'] ?? 832;
        $style = $options['style'] ?? 'cinematic';
        $styleUUID = $this->styleUUIDs[$style] ?? $this->styleUUIDs['cinematic'];

        Log::info('ðŸŽ¨ Leonardo AI: Starting generation from enhanced prompt', [
            'prompt_length' => strlen($enhancedPrompt),
            'style' => $style,
            'dimensions' => "{$width}x{$height}",
        ]);

        try {
            // GÃ¶rsel Ã¼retimi baÅŸlat
            $generationId = $this->createGenerationDirect($enhancedPrompt, $width, $height, $styleUUID);

            if (!$generationId) {
                return null;
            }

            // Sonucu bekle
            $imageUrl = $this->waitForGeneration($generationId);

            if (!$imageUrl) {
                return null;
            }

            // GÃ¶rseli indir
            $imageData = $this->downloadImage($imageUrl);

            if (!$imageData) {
                return null;
            }

            Log::info('ðŸŽ¨ Leonardo AI: Generation successful', [
                'generation_id' => $generationId,
                'image_size' => strlen($imageData),
            ]);

            return [
                'url' => $imageUrl,
                'content' => $imageData,
                'generation_id' => $generationId,
                'provider' => 'leonardo',
                'prompt' => $enhancedPrompt,
                'style' => $style,
            ];

        } catch (\Exception $e) {
            Log::error('ðŸŽ¨ Leonardo AI: Generation failed', [
                'error' => $e->getMessage(),
            ]);
            return null;
        }
    }

    /**
     * Direkt prompt ile generation oluÅŸtur (enhance edilmiÅŸ prompt iÃ§in)
     */
    protected function createGenerationDirect(string $prompt, int $width, int $height, string $styleUUID): ?string
    {
        // Negative prompt - yazÄ± ve gereksiz elementleri engelle
        $negativePrompt = "text, letters, words, numbers, digits, brand names, logos, labels, signs, watermarks, typography, writing, captions, subtitles, titles, stamps, badges, stickers, distorted faces, extra limbs, blurry, low quality";

        $response = Http::withHeaders([
            'accept' => 'application/json',
            'content-type' => 'application/json',
            'authorization' => 'Bearer ' . $this->apiKey,
        ])->timeout(30)->post($this->baseUrl . '/generations', [
            'modelId' => $this->defaultModel,
            'prompt' => $prompt,
            'negative_prompt' => $negativePrompt,
            'styleUUID' => $styleUUID,
            'contrast' => 3.5,
            'num_images' => 1,
            'width' => $width,
            'height' => $height,
            'alchemy' => false,
            'ultra' => false,
        ]);

        if (!$response->successful()) {
            Log::error('Leonardo AI: Create generation failed', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);
            return null;
        }

        $data = $response->json();
        return $data['sdGenerationJob']['generationId'] ?? null;
    }

    /**
     * API durumunu kontrol et
     */
    public function checkApiStatus(): array
    {
        if (empty($this->apiKey)) {
            return [
                'status' => 'error',
                'message' => 'API key not configured',
            ];
        }

        try {
            $response = Http::withHeaders([
                'accept' => 'application/json',
                'authorization' => 'Bearer ' . $this->apiKey,
            ])->timeout(10)->get($this->baseUrl . '/me');

            if ($response->successful()) {
                $data = $response->json();
                return [
                    'status' => 'ok',
                    'user' => $data['user_details'] ?? [],
                ];
            }

            return [
                'status' => 'error',
                'message' => 'API request failed: ' . $response->status(),
            ];
        } catch (\Exception $e) {
            return [
                'status' => 'error',
                'message' => $e->getMessage(),
            ];
        }
    }
}
