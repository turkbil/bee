<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant OluÅŸturma HatalarÄ± & Ã‡Ã¶zÃ¼mleri - DetaylÄ± Analiz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #334155;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f87171, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .summary-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 40px;
        }

        .summary-box h2 {
            color: #22c55e;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        section {
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #f87171;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.3rem;
            color: #60a5fa;
            margin-bottom: 15px;
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #ef4444;
        }

        .error-card h3 {
            color: #f87171;
            margin-bottom: 15px;
        }

        .solution-card {
            background: rgba(34, 197, 94, 0.1);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #22c55e;
        }

        .solution-card h4 {
            color: #22c55e;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .code-block {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #334155;
        }

        .file-path {
            color: #fbbf24;
            font-weight: 500;
            word-break: break-all;
        }

        .error-msg {
            color: #f87171;
            font-style: italic;
        }

        .cause {
            color: #fb923c;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        li::before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #60a5fa;
        }

        .warning-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box strong {
            color: #fbbf24;
        }

        .checklist {
            background: rgba(30, 41, 59, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .checklist li::before {
            content: "âœ“";
            color: #22c55e;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: "";
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #334155;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: -26px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .summary-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”§ Tenant OluÅŸturma HatalarÄ± & Ã‡Ã¶zÃ¼mleri</h1>
            <div class="meta">
                ğŸ“… Tarih: 2025-11-23 |
                ğŸ¯ Sistem: tuufi.com Multi-Tenant |
                ğŸ“Š Durum: TÃ¼m hatalar Ã§Ã¶zÃ¼ldÃ¼
            </div>
        </header>

        <div class="summary-box">
            <h2>âœ… Test Sonucu: BAÅARILI</h2>
            <p>TÃ¼m migration hatalarÄ± dÃ¼zeltildi. Yeni tenant oluÅŸturulabilir.</p>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number">5</div>
                    <div class="stat-label">Kritik Hata</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">8</div>
                    <div class="stat-label">DÃ¼zeltilen Dosya</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">92</div>
                    <div class="stat-label">Tablo OluÅŸturuldu</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">104</div>
                    <div class="stat-label">Migration</div>
                </div>
            </div>
        </div>

        <section>
            <h2>ğŸš¨ Hata 1: Plesk Komutu BulunamadÄ±</h2>

            <div class="error-card">
                <h3>Hata MesajÄ±</h3>
                <div class="code-block">
                    <span class="error-msg">sh: plesk: command not found</span>
                </div>
                <p><strong class="cause">Sebep:</strong> PHP Process Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken PATH deÄŸiÅŸkeninde /usr/sbin bulunmuyor. Plesk komutlarÄ± bu dizinde yer alÄ±yor.</p>
            </div>

            <div class="solution-card">
                <h4>Ã‡Ã¶zÃ¼m: Tam Yol KullanÄ±mÄ±</h4>
                <p>TÃ¼m <code>plesk</code> komutlarÄ± <code>/usr/sbin/plesk</code> olarak deÄŸiÅŸtirildi.</p>

                <p class="file-path">Dosya 1: app/Jobs/UnregisterDatabaseFromPlesk.php</p>
                <div class="code-block">
// Eski: Process::run("plesk db ...")
// Yeni:
$deleteResult = Process::timeout(10)->run("/usr/sbin/plesk db \"{$deleteSql}\"");
                </div>

                <p class="file-path">Dosya 2: app/Listeners/RegisterTenantDatabaseToPlesk.php</p>
                <div class="code-block">
// TÃ¼m plesk komutlarÄ± gÃ¼ncellendi:
$result = Process::timeout(10)->run("/usr/sbin/plesk db \"$sql\"");
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸš¨ Hata 2: Foreign Key Constraint HatasÄ±</h2>

            <div class="error-card">
                <h3>Hata MesajÄ±</h3>
                <div class="code-block">
                    <span class="error-msg">SQLSTATE[HY000]: General error: 1005 Can't create table `tenant_test_muzibu`.`shop_orders`
(errno: 150 "Foreign key constraint is incorrectly formed")</span>
                </div>
                <p><strong class="cause">Sebep:</strong> <code>shop_orders</code> tablosu <code>shop_payment_methods</code> tablosuna foreign key ile baÄŸlÄ±. Ancak bu tablo migration'Ä± arÅŸivlenmiÅŸ ve tenant klasÃ¶rÃ¼nde mevcut deÄŸildi.</p>
            </div>

            <div class="solution-card">
                <h4>Ã‡Ã¶zÃ¼m: Eksik Migration'larÄ± Geri YÃ¼kle</h4>
                <p>ArÅŸivlenen migration dosyalarÄ± tenant klasÃ¶rÃ¼ne kopyalandÄ±:</p>

                <ul class="checklist">
                    <li><span class="file-path">007_create_shop_payment_methods_table.php</span> â†’ Modules/Shop/database/migrations/tenant/</li>
                    <li><span class="file-path">023_create_shop_payments_table.php</span> â†’ Modules/Shop/database/migrations/tenant/</li>
                </ul>

                <div class="warning-box">
                    <strong>âš ï¸ Kritik Not:</strong> Migration dosyalarÄ± hem <code>database/migrations/</code> hem de <code>database/migrations/tenant/</code> klasÃ¶rlerinde bulunmalÄ±!
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸš¨ Hata 3: Plesk'te Database GÃ¶rÃ¼nmÃ¼yor</h2>

            <div class="error-card">
                <h3>Problem</h3>
                <p>Yeni oluÅŸturulan tenant database'leri Plesk panelinde tuufi.com altÄ±nda gÃ¶rÃ¼nmÃ¼yordu.</p>
                <p><strong class="cause">Sebep:</strong> <code>RegisterTenantDatabaseToPlesk</code> listener'Ä± tenant'Ä±n domain'ini (ixtif.com) kullanmaya Ã§alÄ±ÅŸÄ±yordu, ancak Plesk'te sadece tuufi.com ana domain olarak kayÄ±tlÄ±.</p>
            </div>

            <div class="solution-card">
                <h4>Ã‡Ã¶zÃ¼m: Domain Sabit Kodlama</h4>
                <p class="file-path">Dosya: app/Listeners/RegisterTenantDatabaseToPlesk.php</p>
                <div class="code-block">
// Eski: Tenant domain'ini dinamik almaya Ã§alÄ±ÅŸÄ±yordu

// Yeni: TÃ¼m tenant database'leri ana domain'e baÄŸlanÄ±r
// Ã‡Ã¼nkÃ¼ Plesk'te diÄŸer domain'ler alias olarak tanÄ±mlÄ±
$domain = 'tuufi.com';
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸš¨ Hata 4: Duplicate Index (morphs)</h2>

            <div class="error-card">
                <h3>Hata MesajÄ±</h3>
                <div class="code-block">
                    <span class="error-msg">SQLSTATE[42000]: Duplicate key name 'favorites_favoritable_type_favoritable_id_index'</span>
                </div>
                <p><strong class="cause">Sebep:</strong> Laravel'in <code>morphs()</code> helper'Ä± otomatik olarak <code>type + id</code> iÃ§in composite index oluÅŸturur. Kod ayrÄ±ca manuel index tanÄ±mlÄ±yordu.</p>
            </div>

            <div class="solution-card">
                <h4>Ã‡Ã¶zÃ¼m: Tekrar Eden Index'leri KaldÄ±r</h4>
                <p>AÅŸaÄŸÄ±daki dosyalarda morphs index tanÄ±mlarÄ± kaldÄ±rÄ±ldÄ±:</p>

                <ul class="checklist">
                    <li><span class="file-path">Modules/Favorite/database/migrations/tenant/2024_11_10_000001_create_favorites_table.php</span></li>
                    <li><span class="file-path">Modules/ReviewSystem/database/migrations/tenant/2024_11_10_000001_create_ratings_table.php</span></li>
                    <li><span class="file-path">Modules/ReviewSystem/database/migrations/tenant/2024_11_10_000002_create_reviews_table.php</span></li>
                    <li><span class="file-path">Modules/Cart/database/migrations/tenant/2025_11_12_170813_create_cart_items_table.php</span></li>
                    <li><span class="file-path">Modules/Payment/database/migrations/tenant/2025_11_09_002_create_payments_table.php</span></li>
                    <li><span class="file-path">Modules/SeoManagement/database/migrations/tenant/2025_07_19_000001_create_seo_settings_table.php</span></li>
                </ul>

                <div class="code-block">
// morphs() kullanÄ±yorsan, ayrÄ±ca index tanÄ±mlama!
$table->morphs('favoritable'); // Bu zaten index oluÅŸturur

// âŒ YANLIÅ - KaldÄ±r:
$table->index(['favoritable_type', 'favoritable_id']);

// âœ… DOÄRU - Sadece yorum ekle:
// NOT: morphs() zaten favoritable_type + favoritable_id iÃ§in index oluÅŸturur
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸš¨ Hata 5: Duplicate is_approved Index</h2>

            <div class="error-card">
                <h3>Hata MesajÄ±</h3>
                <div class="code-block">
                    <span class="error-msg">SQLSTATE[42000]: Duplicate key name 'reviews_is_approved_index'</span>
                </div>
                <p><strong class="cause">Sebep:</strong> <code>is_approved</code> sÃ¼tunu tanÄ±mlanÄ±rken <code>->index()</code> chain edilmiÅŸ, ayrÄ±ca <code>$table->index('is_approved')</code> ile tekrar tanÄ±mlanmÄ±ÅŸ.</p>
            </div>

            <div class="solution-card">
                <h4>Ã‡Ã¶zÃ¼m: Tekrar Eden Index'i KaldÄ±r</h4>
                <p class="file-path">Dosya: Modules/ReviewSystem/database/migrations/tenant/2024_11_10_000002_create_reviews_table.php</p>
                <div class="code-block">
// SatÄ±r 31'de zaten index var:
$table->boolean('is_approved')->default(false)->index()->comment('Admin onayÄ±');

// Indexes bÃ¶lÃ¼mÃ¼nde tekrar tanÄ±mlama! KaldÄ±rÄ±ldÄ±:
// $table->index('is_approved'); // âŒ KaldÄ±rÄ±ldÄ±

// Composite index kalabilir:
$table->index(['is_approved', 'created_at']); // âœ… Bu farklÄ±, kalabilir
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ“‹ Tenant OluÅŸturma Kontrol Listesi</h2>

            <div class="checklist">
                <ul>
                    <li>Migration dosyalarÄ± hem central hem tenant klasÃ¶rÃ¼nde mevcut</li>
                    <li>Foreign key baÄŸÄ±mlÄ±lÄ±klarÄ± doÄŸru sÄ±rada</li>
                    <li>Duplicate index tanÄ±mlarÄ± yok</li>
                    <li>Plesk komutu tam yol ile Ã§alÄ±ÅŸÄ±yor</li>
                    <li>Database tuufi.com domain'ine baÄŸlanÄ±yor</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>âš ï¸ Admin Panelden Tenant OluÅŸturma:</strong>
                <p>ArtÄ±k tÃ¼m hatalar dÃ¼zeltildi. Admin panelden yeni tenant gÃ¼venle oluÅŸturulabilir.</p>
            </div>
        </section>

        <section>
            <h2>ğŸ”„ Gelecekte Dikkat Edilecekler</h2>

            <div class="timeline">
                <div class="timeline-item">
                    <h3>Migration OluÅŸtururken</h3>
                    <p>Her migration dosyasÄ± <strong>iki yere</strong> koyulmalÄ±: central ve tenant klasÃ¶rÃ¼</p>
                </div>
                <div class="timeline-item">
                    <h3>morphs() KullanÄ±rken</h3>
                    <p>Otomatik index oluÅŸturduÄŸunu unutma, tekrar index tanÄ±mlama</p>
                </div>
                <div class="timeline-item">
                    <h3>SÃ¼tun TanÄ±mÄ±nda ->index() Varsa</h3>
                    <p>AyrÄ±ca $table->index() ile tekrar tanÄ±mlama</p>
                </div>
                <div class="timeline-item">
                    <h3>Foreign Key BaÄŸÄ±mlÄ±lÄ±klarÄ±</h3>
                    <p>Referans edilen tablo Ã¶nce oluÅŸturulmalÄ± (dosya sÄ±rasÄ± Ã¶nemli)</p>
                </div>
            </div>
        </section>

        <footer>
            ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu | 2025-11-23
        </footer>
    </div>
</body>
</html>
