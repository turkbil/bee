<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Kontrolu - Tek Kaynak Cozum Plani</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">

        <!-- Header -->
        <header class="mb-8 border-b border-slate-700 pb-6">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full text-sm font-medium border border-emerald-500/30">
                    Cozum Plani
                </span>
                <span class="text-slate-400 text-sm">9 Ocak 2026</span>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Premium Kontrolu: Tek Kaynak Mimarisi</h1>
            <p class="text-slate-400">users.subscription_expires_at = Tek Gercek Kaynak</p>
        </header>

        <!-- Basit Anlatim -->
        <div class="bg-green-900/20 border border-green-800 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-green-400 mb-4">Basit Anlatim</h2>
            <div class="space-y-4 text-slate-300">
                <p><strong>Sorun:</strong> Sistemde premium kontrolu icin 6 farkli fonksiyon ve 2 farkli kavram (premium + trial) var. Bu tutarsizlik yaratiyor.</p>
                <p><strong>Cozum:</strong> TEK bir kaynak: <code class="bg-slate-700 px-2 py-1 rounded">users.subscription_expires_at</code></p>
                <p><strong>Kural:</strong> Bu tarih gelecekte ise = Premium. Gecmiste veya NULL ise = Ucretsiz. Trial ayrimi yok.</p>
            </div>
        </div>

        <!-- Mevcut Kaos -->
        <div class="bg-red-900/20 border border-red-800 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-red-400 mb-4">Mevcut Durum (Kaos)</h2>
            
            <div class="space-y-4">
                <h3 class="text-white font-medium">PHP Fonksiyonlari (User Model)</h3>
                <div class="grid md:grid-cols-3 gap-3">
                    <div class="bg-slate-800 rounded-lg p-3">
                        <code class="text-yellow-400 text-sm">isPremium()</code>
                        <p class="text-xs text-slate-400 mt-1">3 katmanli kontrol: model + fresh DB + subscriptions fallback</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-3">
                        <code class="text-yellow-400 text-sm">isTrialActive()</code>
                        <p class="text-xs text-slate-400 mt-1">Subscriptions tablosundan trial kontrolu</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-3">
                        <code class="text-yellow-400 text-sm">isPremiumOrTrial()</code>
                        <p class="text-xs text-slate-400 mt-1">isPremium() || isTrialActive()</p>
                    </div>
                </div>

                <h3 class="text-white font-medium mt-4">API Fonksiyonlari</h3>
                <div class="bg-slate-800 rounded-lg p-3">
                    <code class="text-yellow-400 text-sm">getSubscriptionData()</code>
                    <p class="text-xs text-slate-400 mt-1">SongStreamController - Sadece model degerine bakiyor, fresh DB yok</p>
                </div>

                <h3 class="text-white font-medium mt-4">JavaScript Degiskenleri</h3>
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="bg-slate-800 rounded-lg p-3">
                        <code class="text-yellow-400 text-sm">currentUser.is_premium</code>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-3">
                        <code class="text-yellow-400 text-sm">currentUser.is_trial</code>
                    </div>
                </div>
                <p class="text-xs text-red-400">Her yerde is_premium || is_trial kontrolu yapiliyor = 2 degisken</p>

                <h3 class="text-white font-medium mt-4">Blade Kullanimi (Tutarsiz)</h3>
                <table class="w-full text-sm mt-2">
                    <thead>
                        <tr class="border-b border-slate-700">
                            <th class="text-left py-2 text-slate-400">Dosya</th>
                            <th class="text-left py-2 text-slate-400">Kullanilan Metod</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-300">
                        <tr class="border-b border-slate-700">
                            <td class="py-2">app.blade.php:716</td>
                            <td class="py-2 font-mono text-xs">isPremiumOrTrial()</td>
                        </tr>
                        <tr class="border-b border-slate-700">
                            <td class="py-2">sidebar.blade.php:58,71,77</td>
                            <td class="py-2 font-mono text-xs">isPremium()</td>
                        </tr>
                        <tr class="border-b border-slate-700">
                            <td class="py-2">header.blade.php:685</td>
                            <td class="py-2 font-mono text-xs">isPremiumOrTrial()</td>
                        </tr>
                        <tr class="border-b border-slate-700">
                            <td class="py-2">dashboard.blade.php:35</td>
                            <td class="py-2 font-mono text-xs">isPremiumOrTrial()</td>
                        </tr>
                        <tr>
                            <td class="py-2">sidebar-left.blade.php (JS)</td>
                            <td class="py-2 font-mono text-xs">currentUser?.is_premium</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Yeni Mimari -->
        <div class="bg-emerald-900/20 border border-emerald-800 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-emerald-400 mb-4">Yeni Mimari (Tek Kaynak)</h2>
            
            <div class="bg-slate-800 rounded-lg p-4 mb-4">
                <h3 class="text-white font-medium mb-2">Tek Gercek Kaynak</h3>
                <code class="text-2xl text-emerald-400">users.subscription_expires_at</code>
                <div class="mt-3 space-y-1 text-sm">
                    <p class="text-green-400">Gelecekte = Premium</p>
                    <p class="text-red-400">NULL veya Gecmiste = Ucretsiz</p>
                    <p class="text-slate-400">Trial ayrimi YOK - subscription_expires_at her seyi kapsar</p>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-white font-medium">Yeni PHP Yapisi</h3>
                <pre class="bg-slate-800 rounded-lg p-4 text-sm overflow-x-auto"><code class="text-green-300">// app/Models/User.php

/**
 * Premium mi? TEK KAYNAK: subscription_expires_at
 */
public function isPremium(): bool
{
    // Tenant kontrolu
    if (!$this->isMuzibuTenant()) {
        return false;
    }

    // 1. Model degeri (hizli)
    if ($this->subscription_expires_at && $this->subscription_expires_at->isFuture()) {
        return true;
    }

    // 2. Fresh DB kontrolu (model stale olabilir)
    $freshExpiry = \DB::table('users')
        ->where('id', $this->id)
        ->value('subscription_expires_at');

    return $freshExpiry && \Carbon\Carbon::parse($freshExpiry)->isFuture();
}

// isTrialActive() - KALDIRILDI
// isPremiumOrTrial() - KALDIRILDI (isPremium() kullan)</code></pre>

                <h3 class="text-white font-medium mt-4">Yeni API Yapisi</h3>
                <pre class="bg-slate-800 rounded-lg p-4 text-sm overflow-x-auto"><code class="text-green-300">// SongStreamController.php

protected function getSubscriptionData($user): array
{
    if (!$user) {
        return ['is_premium' => false, 'subscription_ends_at' => null];
    }

    // Fresh DB kontrolu (model stale olabilir)
    $expiresAt = \DB::table('users')
        ->where('id', $user->id)
        ->value('subscription_expires_at');

    $isPremium = $expiresAt && \Carbon\Carbon::parse($expiresAt)->isFuture();

    return [
        'is_premium' => $isPremium,
        'subscription_ends_at' => $expiresAt,
        // is_trial KALDIRILDI
    ];
}</code></pre>

                <h3 class="text-white font-medium mt-4">Yeni JavaScript Yapisi</h3>
                <pre class="bg-slate-800 rounded-lg p-4 text-sm overflow-x-auto"><code class="text-green-300">// app.blade.php - muzibuPlayerConfig
currentUser: {
    id: {{ $user->id }},
    name: "{{ $user->name }}",
    is_premium: {{ $user->isPremium() ? 'true' : 'false' }},
    subscription_ends_at: "{{ $user->subscription_expires_at?->toIso8601String() }}"
    // is_trial KALDIRILDI
}

// Tum JS dosyalarinda:
// ESKI: currentUser?.is_premium || currentUser?.is_trial
// YENI: currentUser?.is_premium</code></pre>
            </div>
        </div>

        <!-- Degistirilecek Dosyalar -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-blue-400 mb-4">Degistirilecek Dosyalar</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="text-white font-medium mb-2">1. Backend (PHP)</h3>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-2 text-slate-400">Dosya</th>
                                <th class="text-left py-2 text-slate-400">Degisiklik</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">app/Models/User.php</td>
                                <td class="py-2 text-xs">isPremium() sadele, isTrialActive() deprecated, isPremiumOrTrial() kaldir</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">SongStreamController.php</td>
                                <td class="py-2 text-xs">getSubscriptionData() fresh DB ekle, is_trial kaldir</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <h3 class="text-white font-medium mb-2">2. Blade Templates</h3>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-2 text-slate-400">Dosya</th>
                                <th class="text-left py-2 text-slate-400">Degisiklik</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">layouts/app.blade.php:716</td>
                                <td class="py-2 text-xs">isPremiumOrTrial() -> isPremium()</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">components/header.blade.php:685,759</td>
                                <td class="py-2 text-xs">isPremiumOrTrial() -> isPremium()</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">dashboard.blade.php:35</td>
                                <td class="py-2 text-xs">isPremiumOrTrial() -> isPremium()</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">partials/dashboard-content.blade.php:52</td>
                                <td class="py-2 text-xs">isPremiumOrTrial() -> isPremium()</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">components/sidebar-left.blade.php</td>
                                <td class="py-2 text-xs">is_trial kontrollerini kaldir</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <h3 class="text-white font-medium mb-2">3. JavaScript</h3>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-2 text-slate-400">Dosya</th>
                                <th class="text-left py-2 text-slate-400">Degisiklik</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">player-core.js</td>
                                <td class="py-2 text-xs">is_premium || is_trial -> is_premium (20+ yer)</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">player-core.js:3208-3212</td>
                                <td class="py-2 text-xs">is_trial guncelleme kodunu kaldir</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-2 font-mono text-xs">play-helpers.js</td>
                                <td class="py-2 text-xs">is_premium || is_trial -> is_premium (5 yer)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ozet -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">Ozet</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-red-400 font-medium mb-2">Kaldirilacaklar</h3>
                    <ul class="space-y-1 text-sm text-slate-300">
                        <li>- isTrialActive() metodu</li>
                        <li>- isPremiumOrTrial() metodu</li>
                        <li>- is_trial degiskeni (JS)</li>
                        <li>- is_trial API response</li>
                        <li>- Subscriptions tablosu fallback</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-green-400 font-medium mb-2">Kalacaklar</h3>
                    <ul class="space-y-1 text-sm text-slate-300">
                        <li>+ isPremium() metodu (sadelestirilerek)</li>
                        <li>+ is_premium degiskeni (JS)</li>
                        <li>+ users.subscription_expires_at (TEK KAYNAK)</li>
                        <li>+ Fresh DB kontrolu</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Uygulama Sirasi -->
        <div class="bg-cyan-900/20 border border-cyan-800 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-cyan-400 mb-4">Uygulama Sirasi</h2>
            <ol class="space-y-3 text-slate-300">
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">1</span>
                    <span><strong>User.php:</strong> isPremium() sadele, diger metodlari deprecated yap</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">2</span>
                    <span><strong>SongStreamController.php:</strong> getSubscriptionData() fresh DB ekle, is_trial kaldir</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">3</span>
                    <span><strong>app.blade.php:</strong> is_trial kaldir, isPremiumOrTrial -> isPremium</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">4</span>
                    <span><strong>player-core.js:</strong> is_trial kontrollerini kaldir, sadece is_premium kullan</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">5</span>
                    <span><strong>Diger Blade/JS:</strong> Tum is_trial referanslarini temizle</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-cyan-500 text-white text-xs px-2 py-1 rounded font-bold">6</span>
                    <span><strong>Cache temizle:</strong> php artisan cache:clear && npm run prod</span>
                </li>
            </ol>
        </div>

        <!-- Footer -->
        <footer class="mt-8 pt-6 border-t border-slate-700 text-center text-slate-500 text-sm">
            <p>Bu rapor Claude AI tarafindan hazirlanmistir.</p>
            <p class="mt-1">muzibu.com.tr | 9 Ocak 2026</p>
        </footer>
    </div>
</body>
</html>
