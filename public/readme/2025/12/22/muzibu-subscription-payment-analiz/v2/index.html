<!doctype html>
<html lang="tr" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Muzibu Subscription & Payment Analizi - v2</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.14/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    body { font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif; background: radial-gradient(circle at 15% 20%, rgba(34,211,238,0.18), transparent 30%), radial-gradient(circle at 85% 15%, rgba(249,115,22,0.16), transparent 28%), radial-gradient(circle at 70% 80%, rgba(16,185,129,0.18), transparent 26%), #050915; }
    .card { background: rgba(13,17,28,0.8); border: 1px solid rgba(148,163,184,0.18); box-shadow: 0 24px 80px rgba(0,0,0,0.45); backdrop-filter: blur(10px); }
    .pill { display:inline-flex; align-items:center; gap:0.4rem; padding:0.45rem 0.9rem; border-radius:999px; font-weight:600; }
  </style>
</head>
<body class="h-full text-slate-50">
  <div class="max-w-6xl mx-auto px-4 py-10 space-y-10">
    <header class="card rounded-3xl p-6 sm:p-8 flex flex-col gap-6 shadow-2xl">
      <div class="flex flex-col gap-3">
        <p class="text-xs uppercase tracking-[0.3em] text-teal-200/70">muzibu.com Â· subscription Â· paytr Â· cart</p>
        <h1 class="text-3xl sm:text-4xl font-semibold leading-tight text-white">Muzibu Ã¼yelik & kredi kartÄ± akÄ±ÅŸÄ± Â· Analiz Raporu</h1>
        <div class="flex flex-wrap gap-3">
          <span class="pill bg-emerald-500/15 border border-emerald-400/40 text-emerald-200">v2 Â· 22 AralÄ±k 2025</span>
          <span class="pill bg-cyan-500/15 border border-cyan-400/40 text-cyan-100">PayTR Callback</span>
          <span class="pill bg-amber-500/15 border border-amber-400/40 text-amber-100">Subscription</span>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="card rounded-2xl p-5 border-teal-400/40">
          <h3 class="text-lg font-semibold text-emerald-200 mb-2">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
          <p class="text-slate-200 leading-relaxed">Kartla Ã¶deme PayTR Ã¼zerinden alÄ±nÄ±yor ve PayTR baÅŸarÄ± bildirir bildirmez sipariÅŸ otomatik tamamlanÄ±yor; Ã¼yelik sÃ¼resi anÄ±nda uzuyor, onay beklemiyor. Ama Ã¶deme yapÄ±lmadan aÃ§Ä±lan bekleyen abonelik kayÄ±tlarÄ± deneme hakkÄ±nÄ± yanlÄ±ÅŸ kilitleyebiliyor; ayrÄ±ca bazÄ± premium kontrolleri yanlÄ±ÅŸ veritabanÄ±na baktÄ±ÄŸÄ± iÃ§in Ã¶deyen kullanÄ±cÄ± bile engellenebiliyor.</p>
        </div>
        <div class="card rounded-2xl p-5 border-cyan-400/40">
          <h3 class="text-lg font-semibold text-cyan-200 mb-2">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>
          <ul class="space-y-2 text-slate-200 text-sm leading-relaxed list-disc list-inside">
            <li>PayTR callback â†’ <span class="text-slate-50">PayTRCallbackService::handleSuccessPayment</span> â†’ <span class="text-slate-50">Order::onPaymentCompleted</span> â†’ <span class="text-slate-50">activateSubscriptionItems</span> mevcut <span class="text-slate-50">current_period_end</span> Ã¼zerine gÃ¼n ekliyor veya yeni subscription aÃ§Ä±yor.</li>
            <li>CSRF istisnasÄ± aÃ§Ä±k (<span class="text-slate-50">payment/callback/*</span>); deÄŸiÅŸiklikler <span class="text-slate-50">SubscriptionObserver</span> ile premium cache (5 dk) temizleniyor.</li>
            <li>Checkout, Ã¶deme Ã¶ncesi <span class="text-slate-50">status=pending_payment</span> subscription kaydÄ± aÃ§Ä±yor; Ã¶deme sonrasÄ± aynÄ± kayÄ±t aktive edilmediÄŸi iÃ§in ikincil aktif kayÄ±t oluÅŸabiliyor.</li>
            <li>Premium middleware central DBâ€™de <span class="text-slate-50">ends_at</span> alanÄ±nÄ± okuyor; gerÃ§ek veri tenant DBâ€™de <span class="text-slate-50">current_period_end</span> Ã¼zerinde.</li>
            <li>PayTR Direct <span class="text-slate-50">merchant_oid</span> iÃ§in modelde olmayan <span class="text-slate-50">transaction_id</span> alanÄ±nÄ± kullanÄ±yor; callback eÅŸleÅŸmesi boÅŸa dÃ¼ÅŸÃ¼yor.</li>
          </ul>
        </div>
      </div>
    </header>

    <section class="grid gap-4 md:grid-cols-2">
      <div class="card rounded-2xl p-6 space-y-4 border-emerald-400/30">
        <div class="flex items-start gap-3">
          <div class="h-10 w-10 rounded-xl bg-emerald-500/15 border border-emerald-400/40 flex items-center justify-center text-emerald-200 text-xl">âš¡</div>
          <div>
            <h2 class="text-xl font-semibold text-white">Kredi kartÄ± sonrasÄ± Ã¼yelik uzamasÄ±</h2>
            <p class="text-slate-300 text-sm">PayTR dÃ¶nÃ¼ÅŸÃ¼ gelir gelmez abonelik sÃ¼resi otomatik uzuyor, manuel onay yok.</p>
          </div>
        </div>
        <div class="grid gap-3 md:grid-cols-2 text-sm text-slate-200">
          <div class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-400/30">
            <p class="font-semibold text-emerald-200 mb-1">AkÄ±ÅŸ</p>
            <p>PayTR callback â†’ payment <span class="text-white">completed</span> â†’ <span class="text-white">Order::onPaymentCompleted</span> â†’ <span class="text-white">activateSubscriptionItems</span> mevcut tarihe gÃ¼n ekler veya yeni abonelik aÃ§ar.</p>
          </div>
          <div class="p-4 rounded-xl bg-cyan-500/10 border border-cyan-400/30">
            <p class="font-semibold text-cyan-200 mb-1">HÄ±z</p>
            <p>Callback yanÄ±tÄ±yla eÅŸzamanlÄ± Ã§alÄ±ÅŸÄ±r; tek koÅŸul PayTRâ€™in <span class="text-white">merchant_oid</span> ile dÃ¶nmesi ve <span class="text-white">payment/callback/paytr</span> eriÅŸilebilir olmasÄ±.</p>
          </div>
        </div>
      </div>

      <div class="card rounded-2xl p-6 space-y-4 border-sky-400/30">
        <div class="flex items-start gap-3">
          <div class="h-10 w-10 rounded-xl bg-sky-500/15 border border-sky-400/40 flex items-center justify-center text-sky-200 text-xl">ğŸ›°ï¸</div>
          <div>
            <h2 class="text-xl font-semibold text-white">Premium veri yolu</h2>
            <p class="text-slate-300 text-sm">Premium kontrollerinin doÄŸru DB ve alanÄ± okumasÄ± kritik.</p>
          </div>
        </div>
        <div class="p-4 rounded-xl bg-sky-500/10 border border-sky-400/30 text-sm text-slate-200 space-y-2">
          <p><span class="font-semibold text-white">DoÄŸru kaynak:</span> Tenant DB Â· <span class="text-white">subscriptions.current_period_end</span> Â· <span class="text-white">status in (active, trial)</span>.</p>
          <p><span class="font-semibold text-white">YanlÄ±ÅŸ kaynak:</span> Central DB Â· <span class="text-white">ends_at</span> alanÄ± â†’ Premium kullanÄ±cÄ± bile 403 gÃ¶rebilir.</p>
        </div>
      </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-3">
      <div class="card rounded-2xl p-6 space-y-3 border-amber-400/30">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-lg bg-amber-500/20 border border-amber-400/40 flex items-center justify-center text-amber-200 text-lg">âš ï¸</div>
          <div>
            <h3 class="text-lg font-semibold text-white">Pending abonelikler trial'Ä± kilitliyor</h3>
            <p class="text-slate-300 text-sm">Ã–deme Ã¶ncesi yazÄ±lan kayÄ±tlar baÅŸarÄ±sÄ±z Ã¶demede bile trial'i tÃ¼ketmiÅŸ gÃ¶steriyor.</p>
          </div>
        </div>
        <ul class="text-sm text-slate-200 space-y-2">
          <li><strong>Sebep:</strong> <span class="text-white">CheckoutPage::createSubscriptionsFromOrder()</span> Ã¶deme Ã¶ncesi <span class="text-white">has_trial=true</span> kayÄ±t ekliyor.</li>
          <li><strong>SonuÃ§:</strong> <span class="text-white">Subscription::userHasUsedTrial()</span> status filtresiz olduÄŸu iÃ§in baÅŸarÄ±sÄ±z/iptal sipariÅŸler de trial'i yakÄ±yor; aynÄ± plan iÃ§in ikinci aktif kayÄ±t aÃ§Ä±labiliyor.</li>
          <li><strong>Ã–neri:</strong> Pending kaydÄ± oluÅŸturma veya Ã¶deme sonrasÄ± aynÄ± kaydÄ± <span class="text-white">active</span>'e Ã§evir; trial kontrolÃ¼ne <span class="text-white">status IN (active, trial)</span> filtresi ekle.</li>
        </ul>
      </div>

      <div class="card rounded-2xl p-6 space-y-3 border-red-400/30">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-lg bg-red-500/20 border border-red-400/40 flex items-center justify-center text-red-200 text-lg">ğŸš«</div>
          <div>
            <h3 class="text-lg font-semibold text-white">Premium middleware yanlÄ±ÅŸ DB'yi okuyor</h3>
            <p class="text-slate-300 text-sm">Central DBâ€™deki <span class="text-white">ends_at</span> sorgusu premium kullanÄ±cÄ±yÄ± bile 403â€™e dÃ¼ÅŸÃ¼rebilir.</p>
          </div>
        </div>
        <ul class="text-sm text-slate-200 space-y-2">
          <li><strong>Sebep:</strong> <span class="text-white">Modules/Muzibu/app/Http/Middleware/CheckPremiumSubscription.php</span> â†’ <span class="text-white">DB::connection('central')</span> + <span class="text-white">ends_at</span>.</li>
          <li><strong>Ã–neri:</strong> Tenant DB + <span class="text-white">User::isPremiumOrTrial()</span> + <span class="text-white">current_period_end &gt; now()</span> ile yeniden yaz.</li>
        </ul>
      </div>

      <div class="card rounded-2xl p-6 space-y-3 border-orange-400/30">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-lg bg-orange-500/20 border border-orange-400/40 flex items-center justify-center text-orange-200 text-lg">ğŸ§¾</div>
          <div>
            <h3 class="text-lg font-semibold text-white">PayTR Direct merchant_oid boÅŸ</h3>
            <p class="text-slate-300 text-sm">Direct akÄ±ÅŸÄ± <span class="text-white">transaction_id</span> alanÄ±nÄ± kullanÄ±yor; modelde yok.</p>
          </div>
        </div>
        <ul class="text-sm text-slate-200 space-y-2">
          <li><strong>Sebep:</strong> <span class="text-white">PayTRDirectService</span> / <span class="text-white">PayTRPaymentService</span> <span class="text-white">->transaction_id</span> okuyor.</li>
          <li><strong>SonuÃ§:</strong> Direct Ã¶deme baÅŸlarsa PayTR'e hatalÄ± <span class="text-white">merchant_oid</span> gider, callback eÅŸleÅŸmez, abonelik uzamaz.</li>
          <li><strong>Ã–neri:</strong> Direct modunu kapat veya <span class="text-white">payment_number</span>/<span class="text-white">gateway_transaction_id</span> ile tutarlÄ± <span class="text-white">merchant_oid</span> Ã¼retip callback aramasÄ±nÄ± buna gÃ¶re yap.</li>
        </ul>
      </div>
    </section>

    <section class="card rounded-2xl p-6 space-y-3 border-emerald-400/30">
      <h2 class="text-xl font-semibold text-white">Ã–ncelikli aksiyonlar</h2>
      <ol class="list-decimal list-inside text-slate-200 space-y-2 text-sm">
        <li>Checkout'ta Ã¶deme Ã¶ncesi oluÅŸturulan <span class="text-white">pending_payment</span> kayÄ±tlarÄ±nÄ± kaldÄ±r veya Ã¶deme sonrasÄ± aynÄ± kaydÄ± aktive et; trial kontrolÃ¼ne <span class="text-white">status IN (active, trial)</span> filtresi ekle.</li>
        <li>Premium middleware'i tenant DB + <span class="text-white">User::isPremiumOrTrial()</span> + <span class="text-white">current_period_end</span> ile yeniden yaz; AI/stream endpoint'lerinde 403 testi ekle.</li>
        <li>PayTR Direct iÃ§in <span class="text-white">merchant_oid</span> Ã¼retimini <span class="text-white">payment_number</span>/<span class="text-white">gateway_transaction_id</span> bazlÄ± yap veya Direct modu kapatÄ±p iframe akÄ±ÅŸÄ±nÄ± tek kaynak olarak tut.</li>
        <li>Callback loglarÄ±nÄ± izle; <span class="text-white">payment/callback/paytr</span> iÃ§in uptime/health kontrolÃ¼ ekle.</li>
      </ol>
    </section>
  </div>
</body>
</html>
