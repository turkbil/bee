<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayTR Ã–deme SÃ¼reci - AdÄ±m AdÄ±m AkÄ±ÅŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="px-3 py-1 bg-blue-600 text-white text-sm rounded-full font-medium">ğŸ“Š Analiz</span>
                <span class="px-3 py-1 bg-slate-700 text-slate-300 text-sm rounded-full">25 AralÄ±k 2025</span>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">PayTR Ã–deme SÃ¼reci</h1>
            <p class="text-slate-400 text-lg">Ã–deme yapÄ±ldÄ±ktan sonra sistemde nasÄ±l iÅŸleniyor?</p>
        </header>

        <!-- Basit AnlatÄ±m -->
        <div class="bg-green-900/20 border border-green-800 rounded-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                <span>ğŸ“</span> Basit AnlatÄ±m (Herkes Ä°Ã§in)
            </h3>
            <div class="space-y-3 text-slate-300">
                <p class="leading-relaxed">
                    KullanÄ±cÄ± kredi kartÄ± bilgilerini PayTR'ye girer ve Ã¶deme yapar. 
                    PayTR Ã¶demeyi iÅŸledikten sonra sistemimize bir bildirim gÃ¶nderir (webhook).
                </p>
                <p class="leading-relaxed">
                    Sistemimiz bu bildirimi alÄ±r ve ÅŸu kontrolleri yapar:
                </p>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>Ã–deme gerÃ§ekten PayTR'den mi geliyor? (GÃ¼venlik kontrolÃ¼)</li>
                    <li>Tutar doÄŸru mu? (Ã–denen miktar sipariÅŸ tutarÄ±yla eÅŸleÅŸiyor mu?)</li>
                    <li>Bu Ã¶deme daha Ã¶nce iÅŸlendi mi? (Tekrar kontrolÃ¼)</li>
                </ul>
                <p class="leading-relaxed">
                    TÃ¼m kontroller baÅŸarÄ±lÄ±ysa:
                </p>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>Ã–deme durumu "completed" (tamamlandÄ±) olarak iÅŸaretlenir</li>
                    <li>SipariÅŸ durumu gÃ¼ncellenir</li>
                    <li>KullanÄ±cÄ±ya email/SMS bildirimi gider</li>
                    <li>Abonelik varsa aktif edilir</li>
                </ul>
            </div>
        </div>

        <!-- Teknik Detaylar -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
                <span>ğŸ”§</span> Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)
            </h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-white mb-2">ğŸ“ Ä°lgili Dosyalar:</h4>
                    <div class="bg-slate-800 rounded p-3 font-mono text-sm space-y-1">
                        <div>â€¢ <span class="text-yellow-400">Modules/Payment/app/Http/Controllers/PayTRCallbackController.php</span></div>
                        <div>â€¢ <span class="text-yellow-400">Modules/Payment/app/Services/PayTRCallbackService.php</span></div>
                        <div>â€¢ <span class="text-yellow-400">Modules/Payment/app/Models/Payment.php</span></div>
                        <div>â€¢ <span class="text-yellow-400">app/Http/Middleware/VerifyCsrfToken.php</span> (CSRF bypass)</div>
                    </div>
                </div>

                <div>
                    <h4 class="font-semibold text-white mb-2">ğŸ”— Callback URL:</h4>
                    <div class="bg-slate-800 rounded p-3 font-mono text-sm">
                        <span class="text-green-400">POST</span> https://tuufi.com/payment/paytr/callback
                    </div>
                </div>

                <div>
                    <h4 class="font-semibold text-white mb-2">ğŸ“Š Database TablolarÄ±:</h4>
                    <div class="bg-slate-800 rounded p-3 font-mono text-sm space-y-1">
                        <div>â€¢ <span class="text-cyan-400">payments</span> (Central DB)</div>
                        <div>â€¢ <span class="text-cyan-400">subscriptions</span> (Central DB)</div>
                        <div>â€¢ <span class="text-cyan-400">shop_orders</span> (Tenant DB - Ä°xtif)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AdÄ±m AdÄ±m AkÄ±ÅŸ -->
        <div class="mb-6">
            <h3 class="text-2xl font-bold text-white mb-4">ğŸ”„ AdÄ±m AdÄ±m Ä°ÅŸlem AkÄ±ÅŸÄ±</h3>
            
            <!-- AdÄ±m 1 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-blue-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white font-bold text-lg">1</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-blue-400 mb-2">PayTR Webhook (POST Request)</h4>
                        <p class="text-slate-300 mb-3">PayTR Ã¶deme sonucunu sisteme bildirir</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="text-slate-400 mb-2">GÃ¶nderilen Veriler:</div>
                            <div class="font-mono text-slate-300 space-y-1">
                                <div>â€¢ <span class="text-yellow-400">merchant_oid:</span> "T2PAY202500010" (SipariÅŸ numarasÄ±)</div>
                                <div>â€¢ <span class="text-yellow-400">status:</span> "success" veya "failed"</div>
                                <div>â€¢ <span class="text-yellow-400">total_amount:</span> "9900" (kuruÅŸ olarak)</div>
                                <div>â€¢ <span class="text-yellow-400">hash:</span> "abc123..." (GÃ¼venlik hash'i)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 2 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-green-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-green-600 text-white font-bold text-lg">2</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-green-400 mb-2">Tenant ID Parse</h4>
                        <p class="text-slate-300 mb-3">merchant_oid'den hangi tenant'a ait olduÄŸu belirlenir</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="font-mono text-slate-300 space-y-1">
                                <div><span class="text-green-400">T2PAY202500010</span> â†’ Tenant ID: <span class="text-yellow-400">2</span> (Ä°xtif)</div>
                                <div><span class="text-green-400">T1001PAY202500020</span> â†’ Tenant ID: <span class="text-yellow-400">1001</span> (Muzibu)</div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                <strong>Kod:</strong> PayTRCallbackController.php:103-119
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 3 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-yellow-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-yellow-600 text-white font-bold text-lg">3</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-yellow-400 mb-2">Tenant Context BaÅŸlatma</h4>
                        <p class="text-slate-300 mb-3">Tenant database'e baÄŸlanÄ±lÄ±r</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="font-mono text-slate-300">
                                <div>tenancy()->initialize($tenant);</div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                Bu noktadan sonra tÃ¼m database iÅŸlemleri tenant database'de yapÄ±lÄ±r
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 4 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-purple-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-600 text-white font-bold text-lg">4</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-purple-400 mb-2">Payment KaydÄ± Bulma</h4>
                        <p class="text-slate-300 mb-3">merchant_oid kullanÄ±larak payment kaydÄ± bulunur</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="text-slate-400 mb-2">3 FarklÄ± YÃ¶ntemle Arama:</div>
                            <div class="font-mono text-slate-300 space-y-2">
                                <div>1. <span class="text-cyan-400">gateway_transaction_id</span> ile ara</div>
                                <div>2. Reconstruct edilmiÅŸ <span class="text-cyan-400">payment_number</span> ile ara</div>
                                <div>3. Stripped merchant_oid ile ara</div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                <strong>Kod:</strong> PayTRCallbackService.php:38-59
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 5 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-red-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-red-600 text-white font-bold text-lg">5</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-red-400 mb-2">GÃ¼venlik Kontrolleri</h4>
                        <p class="text-slate-300 mb-3">Duplicate, Hash, ve Tutar kontrolleri</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="space-y-3">
                                <div>
                                    <div class="text-yellow-400 font-semibold mb-1">âœ“ Duplicate KontrolÃ¼:</div>
                                    <div class="text-slate-300">Payment zaten iÅŸlenmiÅŸ mi? (completed, failed, refunded)</div>
                                </div>
                                <div>
                                    <div class="text-yellow-400 font-semibold mb-1">âœ“ Hash DoÄŸrulama:</div>
                                    <div class="text-slate-300 font-mono text-xs">
                                        hash = base64(hmac_sha256(<br>
                                        &nbsp;&nbsp;merchant_oid + salt + status + total_amount,<br>
                                        &nbsp;&nbsp;merchant_key<br>
                                        ))
                                    </div>
                                </div>
                                <div>
                                    <div class="text-yellow-400 font-semibold mb-1">âœ“ Tutar KontrolÃ¼:</div>
                                    <div class="text-slate-300">PayTR'den gelen tutar ile payment tutarÄ± eÅŸleÅŸmeli</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 6 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-emerald-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-emerald-600 text-white font-bold text-lg">6</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-emerald-400 mb-2">Payment GÃ¼ncelleme</h4>
                        <p class="text-slate-300 mb-3">Status "success" ise payment completed olarak iÅŸaretlenir</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="font-mono text-slate-300 space-y-1">
                                <div>payment.status = <span class="text-green-400">"completed"</span></div>
                                <div>payment.paid_at = <span class="text-green-400">now()</span></div>
                                <div>payment.gateway_response = <span class="text-green-400">$callbackData</span></div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                <strong>Kod:</strong> PayTRCallbackService.php:145-149
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 7 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-cyan-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-cyan-600 text-white font-bold text-lg">7</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-cyan-400 mb-2">Payable Ä°ÅŸlemleri (onPaymentCompleted)</h4>
                        <p class="text-slate-300 mb-3">Ä°lgili model'in onPaymentCompleted metodu Ã§aÄŸrÄ±lÄ±r</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="text-slate-400 mb-2">Payable Model Ã–rnekleri:</div>
                            <div class="space-y-3">
                                <div>
                                    <div class="text-yellow-400 font-semibold mb-1">ğŸ›’ ShopOrder (E-Ticaret):</div>
                                    <div class="text-slate-300 text-sm">
                                        â€¢ SipariÅŸ durumu "pending" â†’ "processing" olur<br>
                                        â€¢ Stok dÃ¼ÅŸÃ¼lÃ¼r<br>
                                        â€¢ MÃ¼ÅŸteriye "sipariÅŸ alÄ±ndÄ±" maili gider
                                    </div>
                                </div>
                                <div>
                                    <div class="text-yellow-400 font-semibold mb-1">ğŸ”„ Subscription (Abonelik):</div>
                                    <div class="text-slate-300 text-sm">
                                        â€¢ Status "pending_payment" â†’ "active" olur<br>
                                        â€¢ started_at, current_period_start tarihleri set edilir<br>
                                        â€¢ KullanÄ±cÄ±ya "abonelik aktif" maili gider
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                <strong>Kod:</strong> PayTRCallbackService.php:166-169
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AdÄ±m 8 -->
            <div class="mb-4 bg-slate-800 border-l-4 border-pink-500 rounded-r-lg p-5">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-pink-600 text-white font-bold text-lg">8</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-pink-400 mb-2">PayTR'ye YanÄ±t GÃ¶nderme</h4>
                        <p class="text-slate-300 mb-3">Ä°ÅŸlem sonucu PayTR'ye bildirilir</p>
                        <div class="bg-slate-900 rounded p-3 text-sm">
                            <div class="space-y-2">
                                <div class="text-green-400 font-mono">
                                    BaÅŸarÄ±lÄ±: return response("OK", 200);
                                </div>
                                <div class="text-red-400 font-mono">
                                    HatalÄ±: return response("FAIL: {reason}", 400);
                                </div>
                            </div>
                            <div class="mt-3 text-slate-400">
                                PayTR bu yanÄ±tÄ± almazsa veya hata alÄ±rsa webhook'u tekrar gÃ¶nderir
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hata DurumlarÄ± -->
        <div class="bg-red-900/20 border border-red-800 rounded-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                <span>âš ï¸</span> OlasÄ± Hata DurumlarÄ±
            </h3>
            <div class="space-y-3 text-slate-300">
                <div class="bg-slate-800 rounded p-3">
                    <div class="font-semibold text-red-400 mb-1">âŒ Tenant ID Parse Edilemedi</div>
                    <div class="text-sm">merchant_oid formatÄ± yanlÄ±ÅŸ veya tanÄ±msÄ±z</div>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <div class="font-semibold text-red-400 mb-1">âŒ Payment BulunamadÄ±</div>
                    <div class="text-sm">VeritabanÄ±nda eÅŸleÅŸen payment kaydÄ± yok</div>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <div class="font-semibold text-red-400 mb-1">âŒ Hash DoÄŸrulama HatasÄ±</div>
                    <div class="text-sm">GÃ¼venlik hash'i eÅŸleÅŸmiyor (merchant_key/salt yanlÄ±ÅŸ)</div>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <div class="font-semibold text-red-400 mb-1">âŒ Tutar UyumsuzluÄŸu</div>
                    <div class="text-sm">PayTR'den gelen tutar ile payment tutarÄ± farklÄ±</div>
                </div>
            </div>
        </div>

        <!-- Log Takibi -->
        <div class="bg-indigo-900/20 border border-indigo-800 rounded-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-indigo-400 mb-4 flex items-center gap-2">
                <span>ğŸ“‹</span> Log Takibi
            </h3>
            <div class="space-y-3 text-slate-300">
                <p>TÃ¼m PayTR callback iÅŸlemleri detaylÄ± loglanÄ±r:</p>
                <div class="bg-slate-800 rounded p-3 font-mono text-sm space-y-1">
                    <div class="text-green-400">ğŸ“¨ PayTR callback received</div>
                    <div class="text-blue-400">ğŸ”µ PayTR callback: Processing</div>
                    <div class="text-blue-400">ğŸ”µ Payment update result</div>
                    <div class="text-blue-400">ğŸ”µ Payable check</div>
                    <div class="text-green-400">âœ… onPaymentCompleted called</div>
                    <div class="text-green-400">ğŸ“¨ PayTR callback processed</div>
                </div>
                <div class="text-sm text-slate-400 mt-2">
                    Log DosyasÄ±: <span class="font-mono">storage/logs/laravel-{date}.log</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-slate-700 text-center text-slate-500 text-sm">
            <p>ğŸ¤– Claude Code tarafÄ±ndan oluÅŸturuldu</p>
            <p class="mt-1">Multi-Tenant PayTR Ã–deme Sistemi Analizi</p>
        </footer>
    </div>
</body>
</html>
