<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizon CPU %100 Sorunu - KÃ¶k Sebep Analizi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #334155;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .alert {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 20px;
            margin: 30px 0;
            border-radius: 8px;
        }

        .alert h2 {
            color: #ef4444;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        section {
            margin-bottom: 50px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.4rem;
            margin: 30px 0 15px 0;
            color: #fbbf24;
        }

        .problem-box {
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #ef4444;
            backdrop-filter: blur(10px);
        }

        .solution-box {
            background: rgba(16, 185, 129, 0.1);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #10b981;
        }

        .code {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #334155;
        }

        .code pre {
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .metric {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-weight: 600;
        }

        .metric.bad {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .metric.good {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
            margin: 30px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #334155;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid #1a1a2e;
        }

        .timeline-item h4 {
            color: #60a5fa;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .stat-card .label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .comparison {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
        }

        .comparison .before {
            color: #fca5a5;
            text-decoration: line-through;
        }

        .comparison .arrow {
            color: #fbbf24;
            font-size: 1.5rem;
        }

        .comparison .after {
            color: #6ee7b7;
            font-weight: 600;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¥ Horizon CPU %100 Sorunu - KÃ¶k Sebep Analizi</h1>
            <div class="meta">
                ğŸ“… Tarih: 2025-11-30 02:05 |
                ğŸ¯ Sorun: CPU Load 18+ | Horizon 112+ Process |
                ğŸ‘¤ Analiz: Claude AI
            </div>
        </header>

        <div class="alert">
            <h2>ğŸš¨ Kritik Bulgu</h2>
            <p><strong>KÃ¶k Sebep:</strong> <code>app/Console/Kernel.php</code> iÃ§indeki <strong>horizon-auto-restart</strong> cron job'u her 5 dakikada Horizon'Ä± Ã¶ldÃ¼rÃ¼p yeniden baÅŸlatÄ±yordu. Bu, orphan process'ler ve Ã§ift baÅŸlatma sorununa yol aÃ§Ä±yordu.</p>
        </div>

        <section>
            <h2>ğŸ“Š Sorun Ã–ncesi Durum</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Load Average</div>
                    <div class="value" style="color: #ef4444;">18.44</div>
                </div>
                <div class="stat-card">
                    <div class="label">CPU Idle</div>
                    <div class="value" style="color: #ef4444;">1.2%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Horizon Process</div>
                    <div class="value" style="color: #ef4444;">112+</div>
                </div>
                <div class="stat-card">
                    <div class="label">Site HÄ±zÄ±</div>
                    <div class="value" style="color: #ef4444;">45s</div>
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ” Sorun Zinciri - AdÄ±m AdÄ±m Analiz</h2>

            <div class="timeline">
                <div class="timeline-item">
                    <h4>1ï¸âƒ£ Cron Her Dakika Ã‡alÄ±ÅŸÄ±yor</h4>
                    <p>Sistem crontab'Ä±nda Laravel scheduler her dakika tetikleniyor:</p>
                    <div class="code"><pre>* * * * * /usr/bin/php artisan schedule:run</pre></div>
                </div>

                <div class="timeline-item">
                    <h4>2ï¸âƒ£ Schedule Ä°Ã§inde Horizon Auto-Restart</h4>
                    <p><code>app/Console/Kernel.php</code> satÄ±r 92-117:</p>
                    <div class="code"><pre>$schedule->call(function () {
    exec('php artisan horizon:status 2>/dev/null', $output, $return_var);

    if ($return_var !== 0 || empty($output)) {
        // âŒ SORUN: pkill tÃ¼m Horizon'larÄ± Ã¶ldÃ¼rÃ¼yor
        exec('pkill -f "horizon" 2>/dev/null');
        sleep(2);

        // âŒ SORUN: Background'da baÅŸlatÄ±yor (orphan process!)
        exec('cd ' . base_path() . ' && php artisan horizon > /dev/null 2>&1 &');
    }
})->everyFiveMinutes();</pre></div>
                </div>

                <div class="timeline-item">
                    <h4>3ï¸âƒ£ Ã‡ift BaÅŸlatma Sorunu</h4>
                    <p><strong>Supervisor</strong> zaten Horizon'u yÃ¶netiyor ama <strong>Cron da</strong> ayrÄ±ca baÅŸlatÄ±yor!</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Supervisor: 2 Horizon master process (tuufi.com_ user)</li>
                        <li>Cron: 2-3 Horizon master process (root user)</li>
                        <li><strong>Toplam:</strong> 4-5 master Horizon!</li>
                    </ul>
                </div>

                <div class="timeline-item">
                    <h4>4ï¸âƒ£ Her Master â†’ 3 Supervisor Spawn Ediyor</h4>
                    <p>Her Horizon master ÅŸu supervisor'leri oluÅŸturuyor:</p>
                    <div class="code"><pre>- ai-supervisor (max 2 processes)
- tenant-supervisor (max 1 process)
- background-supervisor (max 1 process)</pre></div>
                    <p><strong>Toplam:</strong> 4 master Ã— 3 supervisor = <strong>12 supervisor process</strong></p>
                </div>

                <div class="timeline-item">
                    <h4>5ï¸âƒ£ Her Supervisor â†’ Queue Worker'larÄ± Spawn Ediyor</h4>
                    <p>Her supervisor, her queue iÃ§in ayrÄ± worker oluÅŸturuyor:</p>
                    <div class="code"><pre>ai-supervisor queues:
  - ai-translation, ai-content, ai-file-analysis
  - translation, ai, blog-ai, critical
  = 7 queue Ã— 2 processes = 14 worker

tenant-supervisor queues:
  - tenant_isolated, default, hls
  - tenant_1001_default, tenant_1001_hls
  = 5 queue Ã— 1 process = 5 worker

background-supervisor queues:
  - background, maintenance
  = 2 queue Ã— 1 process = 2 worker</pre></div>
                    <p><strong>Her supervisor grubu:</strong> ~20 worker</p>
                </div>

                <div class="timeline-item">
                    <h4>6ï¸âƒ£ Nihai SonuÃ§: Process PatlamasÄ±!</h4>
                    <div class="code"><pre>4 master Ã— 3 supervisor Ã— ~20 worker = <strong>240+ process potansiyeli!</strong>

GerÃ§ekte: ~112 process (bazÄ± queue'ler boÅŸ olduÄŸu iÃ§in spawn etmedi)</pre></div>
                </div>
            </div>
        </section>

        <section>
            <h2>âœ… Uygulanan Ã‡Ã¶zÃ¼mler</h2>

            <div class="solution-box">
                <h3>1. Horizon Auto-Restart Devre DÄ±ÅŸÄ± BÄ±rakÄ±ldÄ±</h3>
                <p><code>app/Console/Kernel.php</code> - SatÄ±r 91-102 comment'lendi:</p>
                <div class="code"><pre>// ğŸ”§ HORIZON MONITORING - DISABLED (Supervisor handles restart)
// âš ï¸ BU AUTO-RESTART SORUNLUYDU!
// - Her 5 dakikada pkill yapÄ±yordu
// - Background'da baÅŸlatÄ±yordu (&) â†’ Orphan process
// - Supervisor zaten Horizon'u yÃ¶netiyor
//
// $schedule->call(function () {
//     // DISABLED
// })->everyFiveMinutes();</pre></div>
                <p><strong>Neden:</strong> Supervisor zaten Horizon'u yÃ¶netiyor, cron'dan Ã§ift baÅŸlatmaya gerek yok!</p>
            </div>

            <div class="solution-box">
                <h3>2. Horizon Config Optimize Edildi</h3>
                <p><code>config/horizon.php</code> - Production environment maxProcesses azaltÄ±ldÄ±:</p>
                <div class="comparison">
                    <span class="before">ai-supervisor: 8 maxProcesses</span>
                    <span class="arrow">â†’</span>
                    <span class="after">2 maxProcesses</span>
                </div>
                <div class="comparison">
                    <span class="before">tenant-supervisor: 6 maxProcesses</span>
                    <span class="arrow">â†’</span>
                    <span class="after">2 maxProcesses</span>
                </div>
                <div class="comparison">
                    <span class="before">background-supervisor: 2 maxProcesses</span>
                    <span class="arrow">â†’</span>
                    <span class="after">1 maxProcesses</span>
                </div>
            </div>

            <div class="solution-box">
                <h3>3. Database Performans Ä°yileÅŸtirmeleri</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>âœ… Currency N+1 dÃ¼zeltildi (1,440 query â†’ 0 query)</li>
                    <li>âœ… Settings global cache (700+ query â†’ 2 query)</li>
                    <li>âœ… Database composite indexes (11s â†’ 85ms)</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>4. Process Cleanup</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>âœ… TÃ¼m orphan Horizon process'leri temizlendi</li>
                    <li>âœ… Zombie process'ler temizlendi</li>
                    <li>âœ… Background Claude process'leri kapatÄ±ldÄ±</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>ğŸ“ˆ Sorun SonrasÄ± Durum</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Load Average</div>
                    <div class="value" style="color: #10b981;">7.09</div>
                    <p style="color: #10b981; margin-top: 5px;">â†“ %61 azalma</p>
                </div>
                <div class="stat-card">
                    <div class="label">CPU Idle</div>
                    <div class="value" style="color: #10b981;">72%</div>
                    <p style="color: #10b981; margin-top: 5px;">â†‘ 21 puan artÄ±ÅŸ</p>
                </div>
                <div class="stat-card">
                    <div class="label">Horizon Process</div>
                    <div class="value" style="color: #10b981;">38</div>
                    <p style="color: #10b981; margin-top: 5px;">â†“ %66 azalma</p>
                </div>
                <div class="stat-card">
                    <div class="label">Site HÄ±zÄ±</div>
                    <div class="value" style="color: #10b981;">2-3s</div>
                    <p style="color: #10b981; margin-top: 5px;">â†“ 15-22x hÄ±zlanma</p>
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ¯ Ã–nemli Ã‡Ä±karÄ±mlar</h2>

            <div class="problem-box">
                <h3>1. Cron Ä°Ã§inden Process BaÅŸlatmayÄ±n!</h3>
                <p>Background process'leri <code>exec(...&)</code> ile baÅŸlatÄ±rsanÄ±z orphan process oluÅŸur. Supervisor veya systemd kullanÄ±n!</p>
            </div>

            <div class="problem-box">
                <h3>2. Auto-Restart Ä°kili BaÅŸlatmaya Yol AÃ§ar</h3>
                <p>EÄŸer Supervisor zaten Horizon'u yÃ¶netiyorsa, cron'dan ayrÄ±ca restart yapmayÄ±n! Ã‡ift baÅŸlatma CPU patlamasÄ±na neden olur.</p>
            </div>

            <div class="problem-box">
                <h3>3. maxProcesses Dikkatli AyarlayÄ±n</h3>
                <p>Production environment iÃ§in agresif deÄŸerler (8, 6, 2) yerine konservatif deÄŸerler (2, 2, 1) kullanÄ±n. GerektiÄŸinde artÄ±rÄ±n.</p>
            </div>

            <div class="problem-box">
                <h3>4. Queue SayÄ±sÄ±nÄ± Minimize Edin</h3>
                <p>Her queue iÃ§in ayrÄ± worker spawn edilir. 7 AI queue yerine birleÅŸtirilebilir queue'ler kullanÄ±n (priority ile ayÄ±rÄ±n).</p>
            </div>
        </section>

        <section>
            <h2>âœ… Test SonuÃ§larÄ±</h2>

            <h3>Site HÄ±zÄ± (https://ixtif.com/)</h3>
            <div class="code"><pre>ğŸ” Test 1: 3.31s
ğŸ” Test 2: 2.23s
ğŸ” Test 3: 3.20s

Ortalama: ~2.9s (Ã¶nceden 45s timeout!)</pre></div>

            <h3>Horizon Master SayÄ±sÄ±</h3>
            <div class="code"><pre>happy-sammet159-253-45-94pleskpage-AcVu (PID: 358117)
happy-sammet159-253-45-94pleskpage-CNnk (PID: 358123)

Toplam: 2 master (Ã¶nceden 4-5 master)</pre></div>

            <h3>Process DaÄŸÄ±lÄ±mÄ±</h3>
            <div class="code"><pre>2 master Ã— 3 supervisor Ã— ~6 worker = ~38 process
(Ã¶nceden: 4 master Ã— 3 supervisor Ã— ~20 worker = 112+ process)</pre></div>
        </section>

        <footer>
            ğŸ¤– Claude AI tarafÄ±ndan analiz edildi | 2025-11-30 02:05
        </footer>
    </div>
</body>
</html>