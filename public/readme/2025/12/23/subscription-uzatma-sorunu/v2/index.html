<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Zincir Sistemi - Yeni Mimari PlanÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; }
        .gradient-text { background: linear-gradient(135deg, #34d399, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen text-slate-300">
    <div class="max-w-6xl mx-auto px-6 py-12">

        <!-- Header -->
        <header class="mb-12">
            <div class="flex items-center gap-3 mb-4">
                <span class="px-3 py-1 bg-green-500/20 text-green-400 text-sm rounded-full">ğŸ—ï¸ Mimari Plan</span>
                <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-sm rounded-full">v2</span>
                <span class="text-slate-500">23 AralÄ±k 2025</span>
            </div>
            <h1 class="text-4xl font-bold gradient-text mb-4">Subscription Zincir Sistemi</h1>
            <p class="text-xl text-slate-400">ArdÄ±ÅŸÄ±k subscription'lar ile Ã¼yelik sÃ¼resi yÃ¶netimi</p>
        </header>

        <!-- Basit AnlatÄ±m -->
        <section class="bg-green-900/20 border border-green-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-green-400 mb-4">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h2>
            <div class="space-y-4 text-slate-300">
                <p><strong>Yeni MantÄ±k NasÄ±l Ã‡alÄ±ÅŸacak?</strong></p>
                <ul class="list-disc ml-6 space-y-2">
                    <li><strong>Her satÄ±n alma = AyrÄ± kayÄ±t:</strong> KullanÄ±cÄ± her paket aldÄ±ÄŸÄ±nda subscriptions tablosuna yeni kayÄ±t eklenir (bu doÄŸru)</li>
                    <li><strong>KullanÄ±cÄ± tablosunda expires_at:</strong> KullanÄ±cÄ±nÄ±n toplam Ã¼yelik bitiÅŸ tarihi burada tutulur</li>
                    <li><strong>Zincir mantÄ±ÄŸÄ±:</strong> Yeni subscription, bir Ã¶ncekinin bittiÄŸi yerden baÅŸlar</li>
                    <li><strong>Otomatik geÃ§iÅŸ:</strong> Aktif subscription bitince, beklemedeki subscription otomatik aktif olur</li>
                </ul>

                <div class="bg-slate-800/50 rounded-lg p-4 mt-4">
                    <p class="font-semibold text-white mb-2">ğŸ“Œ Ã–rnek Senaryo:</p>
                    <div class="text-sm space-y-1">
                        <p>1. KullanÄ±cÄ± 1 aylÄ±k paket alÄ±yor â†’ Subscription #1 (Aktif: 23 AralÄ±k - 23 Ocak)</p>
                        <p>2. 10 gÃ¼n sonra 3 aylÄ±k paket alÄ±yor â†’ Subscription #2 (Beklemede: 23 Ocak - 23 Nisan)</p>
                        <p>3. 23 Ocak gelince â†’ Subscription #1 "SÃ¼resi Doldu", Subscription #2 "Aktif" olur</p>
                        <p>4. users.expires_at = 23 Nisan 2026</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Durum AkÄ±ÅŸ ÅemasÄ± -->
        <section class="bg-slate-800/50 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-6">ğŸ”„ Subscription DurumlarÄ± ve AkÄ±ÅŸÄ±</h2>

            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-yellow-500/20 border border-yellow-600 rounded-lg p-4 text-center">
                    <div class="text-3xl mb-2">â³</div>
                    <p class="font-bold text-yellow-400">pending_payment</p>
                    <p class="text-xs text-slate-400 mt-1">Ã–deme Bekliyor</p>
                </div>
                <div class="bg-blue-500/20 border border-blue-600 rounded-lg p-4 text-center">
                    <div class="text-3xl mb-2">â¸ï¸</div>
                    <p class="font-bold text-blue-400">pending</p>
                    <p class="text-xs text-slate-400 mt-1">Beklemede</p>
                </div>
                <div class="bg-green-500/20 border border-green-600 rounded-lg p-4 text-center">
                    <div class="text-3xl mb-2">âœ…</div>
                    <p class="font-bold text-green-400">active</p>
                    <p class="text-xs text-slate-400 mt-1">Aktif</p>
                </div>
                <div class="bg-red-500/20 border border-red-600 rounded-lg p-4 text-center">
                    <div class="text-3xl mb-2">ğŸ”´</div>
                    <p class="font-bold text-red-400">expired</p>
                    <p class="text-xs text-slate-400 mt-1">SÃ¼resi Doldu</p>
                </div>
            </div>

            <div class="bg-slate-900 rounded-lg p-4">
                <p class="text-sm font-mono text-slate-300">
                    <span class="text-yellow-400">pending_payment</span>
                    <span class="text-slate-500">â†’ (Ã¶deme baÅŸarÄ±lÄ±) â†’</span>
                    <span class="text-blue-400">pending</span> veya <span class="text-green-400">active</span>
                    <span class="text-slate-500">â†’ (sÃ¼re dolunca) â†’</span>
                    <span class="text-red-400">expired</span>
                </p>
                <p class="text-xs text-slate-500 mt-2">
                    * EÄŸer Ã¶deme anÄ±nda aktif subscription yoksa â†’ direkt "active"<br>
                    * EÄŸer Ã¶deme anÄ±nda aktif subscription varsa â†’ "pending" (sÄ±raya girer)
                </p>
            </div>
        </section>

        <!-- Teknik Detaylar -->
        <section class="bg-blue-900/20 border border-blue-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-blue-400 mb-4">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h2>

            <div class="space-y-6">
                <!-- VeritabanÄ± DeÄŸiÅŸiklikleri -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <h3 class="font-semibold text-white mb-3">ğŸ“Š VeritabanÄ± DeÄŸiÅŸiklikleri</h3>

                    <div class="space-y-4">
                        <div>
                            <p class="text-purple-400 font-medium mb-2">1. users tablosuna yeni sÃ¼tun (Central DB):</p>
                            <div class="bg-slate-900 rounded p-3 font-mono text-sm">
                                <span class="text-green-400">subscription_expires_at</span> DATETIME NULL<br>
                                <span class="text-slate-500">-- KullanÄ±cÄ±nÄ±n toplam Ã¼yelik bitiÅŸ tarihi</span>
                            </div>
                        </div>

                        <div>
                            <p class="text-purple-400 font-medium mb-2">2. subscriptions.status enum gÃ¼ncelleme:</p>
                            <div class="bg-slate-900 rounded p-3 font-mono text-sm">
                                ENUM('pending_payment', 'pending', 'active', 'expired', 'cancelled')
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SatÄ±n Alma AkÄ±ÅŸÄ± -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <h3 class="font-semibold text-white mb-3">ğŸ›’ Yeni SatÄ±n Alma AkÄ±ÅŸÄ±</h3>

                    <div class="space-y-3 text-sm">
                        <div class="flex gap-3">
                            <span class="bg-yellow-500/30 text-yellow-300 px-2 py-1 rounded text-xs">CHECKOUT</span>
                            <div>
                                <p class="text-white">Subscription oluÅŸtur (status: pending_payment)</p>
                                <p class="text-slate-400">started_at ve current_period_end henÃ¼z belirlenmez</p>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <span class="bg-green-500/30 text-green-300 px-2 py-1 rounded text-xs">CALLBACK</span>
                            <div>
                                <p class="text-white">Ã–deme baÅŸarÄ±lÄ± â†’ Tarihleri hesapla:</p>
                                <div class="bg-slate-900 rounded p-2 mt-1 font-mono text-xs">
                                    <p class="text-slate-400">// Mevcut aktif/pending subscription var mÄ±?</p>
                                    <p>$lastSub = Subscription::where('user_id', $userId)</p>
                                    <p class="ml-4">->whereIn('status', ['active', 'pending'])</p>
                                    <p class="ml-4">->orderBy('current_period_end', 'desc')->first();</p>
                                    <br>
                                    <p class="text-slate-400">// Yeni subscription baÅŸlangÄ±cÄ±</p>
                                    <p><span class="text-green-400">$startDate</span> = $lastSub ? $lastSub->current_period_end : now();</p>
                                    <p><span class="text-green-400">$endDate</span> = $startDate->addDays($durationDays);</p>
                                    <br>
                                    <p class="text-slate-400">// Status belirleme</p>
                                    <p><span class="text-green-400">$status</span> = $lastSub ? 'pending' : 'active';</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <span class="bg-blue-500/30 text-blue-300 px-2 py-1 rounded text-xs">UPDATE</span>
                            <div>
                                <p class="text-white">users.subscription_expires_at gÃ¼ncelle</p>
                                <div class="bg-slate-900 rounded p-2 mt-1 font-mono text-xs">
                                    $user->subscription_expires_at = $endDate;
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cron Job -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <h3 class="font-semibold text-white mb-3">â° Scheduler / Cron Job</h3>

                    <div class="bg-slate-900 rounded p-3 font-mono text-sm">
                        <p class="text-slate-400">// Her saat Ã§alÄ±ÅŸacak command</p>
                        <p class="text-purple-400">php artisan subscription:process-transitions</p>
                        <br>
                        <p class="text-slate-400">// 1. SÃ¼resi dolan active subscription'larÄ± expired yap</p>
                        <p>Subscription::where('status', 'active')</p>
                        <p class="ml-4">->where('current_period_end', '&lt;', now())</p>
                        <p class="ml-4">->update(['status' => 'expired']);</p>
                        <br>
                        <p class="text-slate-400">// 2. SÄ±rasÄ± gelen pending subscription'larÄ± active yap</p>
                        <p>Subscription::where('status', 'pending')</p>
                        <p class="ml-4">->where('current_period_start', '&lt;=', now())</p>
                        <p class="ml-4">->update(['status' => 'active']);</p>
                    </div>
                </div>

                <!-- Premium Kontrol -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <h3 class="font-semibold text-white mb-3">ğŸ” Premium EriÅŸim KontrolÃ¼</h3>

                    <div class="bg-slate-900 rounded p-3 font-mono text-sm">
                        <p class="text-slate-400">// HÄ±zlÄ± kontrol (users tablosundan)</p>
                        <p>$isPremium = $user->subscription_expires_at > now();</p>
                        <br>
                        <p class="text-slate-400">// veya aktif subscription kontrolÃ¼</p>
                        <p>$hasActiveSubscription = $user->subscriptions()</p>
                        <p class="ml-4">->where('status', 'active')</p>
                        <p class="ml-4">->where('current_period_end', '>', now())</p>
                        <p class="ml-4">->exists();</p>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">
                        ğŸ’¡ users.subscription_expires_at ile hÄ±zlÄ± kontrol yapÄ±labilir,
                        subscription tablosuna sorgu gerekmez.
                    </p>
                </div>
            </div>
        </section>

        <!-- GÃ¶rsel Ã–rnek -->
        <section class="bg-slate-800/50 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-4">ğŸ“Š GÃ¶rsel Ã–rnek: Zincir Subscription</h2>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-slate-400 border-b border-slate-700">
                        <tr>
                            <th class="text-left py-3 px-2">ID</th>
                            <th class="text-left py-3 px-2">Plan</th>
                            <th class="text-left py-3 px-2">BaÅŸlangÄ±Ã§</th>
                            <th class="text-left py-3 px-2">BitiÅŸ</th>
                            <th class="text-left py-3 px-2">Status</th>
                            <th class="text-left py-3 px-2">AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-slate-700/50">
                            <td class="py-3 px-2">101</td>
                            <td class="py-3 px-2">1 AylÄ±k</td>
                            <td class="py-3 px-2">23 Ara 2025</td>
                            <td class="py-3 px-2">23 Oca 2026</td>
                            <td class="py-3 px-2"><span class="bg-green-500/30 text-green-300 px-2 py-1 rounded text-xs">active</span></td>
                            <td class="py-3 px-2 text-slate-400">Åu an kullanÄ±lÄ±yor</td>
                        </tr>
                        <tr class="border-b border-slate-700/50">
                            <td class="py-3 px-2">102</td>
                            <td class="py-3 px-2">3 AylÄ±k</td>
                            <td class="py-3 px-2">23 Oca 2026</td>
                            <td class="py-3 px-2">23 Nis 2026</td>
                            <td class="py-3 px-2"><span class="bg-blue-500/30 text-blue-300 px-2 py-1 rounded text-xs">pending</span></td>
                            <td class="py-3 px-2 text-slate-400">SÄ±rada bekliyor</td>
                        </tr>
                        <tr class="border-b border-slate-700/50">
                            <td class="py-3 px-2">103</td>
                            <td class="py-3 px-2">1 YÄ±llÄ±k</td>
                            <td class="py-3 px-2">23 Nis 2026</td>
                            <td class="py-3 px-2">23 Nis 2027</td>
                            <td class="py-3 px-2"><span class="bg-blue-500/30 text-blue-300 px-2 py-1 rounded text-xs">pending</span></td>
                            <td class="py-3 px-2 text-slate-400">En son sÄ±rada</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 p-3 bg-green-900/30 border border-green-700 rounded-lg">
                <p class="text-green-400 font-medium">ğŸ‘¤ users.subscription_expires_at = 23 Nisan 2027</p>
                <p class="text-sm text-slate-400 mt-1">KullanÄ±cÄ±nÄ±n toplam Ã¼yelik sÃ¼resi (tÃ¼m subscription'larÄ±n toplamÄ±)</p>
            </div>
        </section>

        <!-- YapÄ±lacaklar -->
        <section class="bg-purple-900/20 border border-purple-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-purple-400 mb-4">ğŸ“‹ YapÄ±lacaklar Listesi</h2>

            <div class="space-y-4">
                <!-- Migration -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="bg-purple-500/30 text-purple-300 px-3 py-1 rounded text-sm font-medium">1. Migration</span>
                    </div>
                    <ul class="list-disc ml-6 text-sm space-y-1">
                        <li>users tablosuna <code class="bg-slate-700 px-1 rounded">subscription_expires_at</code> sÃ¼tunu ekle (Central DB)</li>
                        <li>subscriptions.status enum gÃ¼ncelle (pending_payment, pending, active, expired, cancelled)</li>
                    </ul>
                </div>

                <!-- Model GÃ¼ncelleme -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="bg-blue-500/30 text-blue-300 px-3 py-1 rounded text-sm font-medium">2. Model GÃ¼ncelleme</span>
                    </div>
                    <ul class="list-disc ml-6 text-sm space-y-1">
                        <li>User.php â†’ subscription_expires_at cast, isPremium() helper</li>
                        <li>Subscription.php â†’ Yeni status scope'larÄ± (pending, expired)</li>
                    </ul>
                </div>

                <!-- Order Logic -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="bg-green-500/30 text-green-300 px-3 py-1 rounded text-sm font-medium">3. SatÄ±n Alma MantÄ±ÄŸÄ±</span>
                    </div>
                    <ul class="list-disc ml-6 text-sm space-y-1">
                        <li>Order::activateSubscriptionItems() gÃ¼ncelle:
                            <ul class="list-circle ml-4 mt-1 text-slate-400">
                                <li>Son subscription bitiÅŸ tarihini bul</li>
                                <li>Yeni subscription tarihlerini ona gÃ¶re hesapla</li>
                                <li>Aktif subscription varsa "pending", yoksa "active" yap</li>
                                <li>users.subscription_expires_at gÃ¼ncelle</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <!-- Scheduler -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="bg-yellow-500/30 text-yellow-300 px-3 py-1 rounded text-sm font-medium">4. Scheduler Command</span>
                    </div>
                    <ul class="list-disc ml-6 text-sm space-y-1">
                        <li>ProcessSubscriptionTransitions command oluÅŸtur</li>
                        <li>Kernel.php'ye saatlik schedule ekle</li>
                        <li>Active â†’ Expired geÃ§iÅŸi</li>
                        <li>Pending â†’ Active geÃ§iÅŸi</li>
                    </ul>
                </div>

                <!-- Mevcut Veri DÃ¼zeltme -->
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="bg-red-500/30 text-red-300 px-3 py-1 rounded text-sm font-medium">5. Mevcut Veri DÃ¼zeltme</span>
                    </div>
                    <ul class="list-disc ml-6 text-sm space-y-1">
                        <li>Duplicate active subscription'larÄ± dÃ¼zelt (User 2 gibi)</li>
                        <li>users.subscription_expires_at deÄŸerlerini hesapla ve doldur</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Ä°lgili Dosyalar -->
        <section class="bg-slate-800/50 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-4">ğŸ“ DeÄŸiÅŸecek Dosyalar</h2>
            <div class="font-mono text-sm space-y-3">
                <div>
                    <p class="text-purple-400">Migration (Yeni):</p>
                    <p class="text-slate-400 ml-4">database/migrations/xxxx_add_subscription_expires_at_to_users.php</p>
                    <p class="text-slate-400 ml-4">database/migrations/tenant/xxxx_update_subscriptions_status_enum.php</p>
                </div>
                <div>
                    <p class="text-blue-400">Model:</p>
                    <p class="text-slate-400 ml-4">app/Models/User.php â†’ subscription_expires_at, isPremium()</p>
                    <p class="text-slate-400 ml-4">Modules/Subscription/app/Models/Subscription.php â†’ status scopes</p>
                </div>
                <div>
                    <p class="text-green-400">SatÄ±n Alma:</p>
                    <p class="text-slate-400 ml-4">Modules/Cart/app/Models/Order.php â†’ activateSubscriptionItems()</p>
                </div>
                <div>
                    <p class="text-yellow-400">Command (Yeni):</p>
                    <p class="text-slate-400 ml-4">app/Console/Commands/ProcessSubscriptionTransitions.php</p>
                    <p class="text-slate-400 ml-4">app/Console/Kernel.php â†’ schedule</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-slate-500 text-sm pt-8 border-t border-slate-800">
            <p>Claude AI Mimari Plan â€¢ 23 AralÄ±k 2025 â€¢ v2</p>
            <p class="mt-1">Muzibu.com.tr - Subscription Zincir Sistemi</p>
        </footer>

    </div>
</body>
</html>
