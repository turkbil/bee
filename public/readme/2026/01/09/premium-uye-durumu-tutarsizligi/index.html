<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Ãœye Durumu TutarsÄ±zlÄ±ÄŸÄ± - Analiz Raporu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        muzibu: {
                            coral: '#ff6b6b',
                            gray: '#1e1e1e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .gradient-border {
            background: linear-gradient(135deg, #ff6b6b, #ff9966);
            padding: 2px;
            border-radius: 12px;
        }
        .gradient-border-inner {
            background: #1e293b;
            border-radius: 10px;
        }
        .code-block {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-error { background: rgba(220, 38, 38, 0.2); color: #fca5a5; border: 1px solid rgba(220, 38, 38, 0.3); }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-warning { background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .step-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #ff6b6b, #ff9966);
        }
        .step-number {
            background: linear-gradient(135deg, #ff6b6b, #ff9966);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }
        .flow-arrow {
            color: #ff6b6b;
            font-size: 24px;
            text-align: center;
            margin: 8px 0;
        }
    </style>
</head>
<body class="text-slate-200">

<div class="container mx-auto px-4 py-8 max-w-6xl">

    <!-- Header -->
    <div class="gradient-border mb-8">
        <div class="gradient-border-inner p-8">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-bug text-3xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Premium Ãœye Durumu TutarsÄ±zlÄ±ÄŸÄ±</h1>
                        <p class="text-slate-400 text-sm">DetaylÄ± Analiz ve Ã‡Ã¶zÃ¼m Ã–nerileri</p>
                    </div>
                </div>
                <span class="badge badge-error">
                    <i class="fas fa-exclamation-circle"></i>
                    Kritik Bug
                </span>
            </div>
            <div class="flex flex-wrap gap-3 text-sm text-slate-400">
                <span><i class="far fa-calendar mr-2"></i>9 Ocak 2026</span>
                <span><i class="far fa-clock mr-2"></i>Analiz Tarihi</span>
                <span><i class="far fa-user mr-2"></i>Claude AI</span>
                <span><i class="far fa-folder mr-2"></i>Muzibu Premium System</span>
            </div>
        </div>
    </div>

    <!-- Ä°ki Seviyeli Ä°Ã§erik -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

        <!-- Basit AnlatÄ±m -->
        <div class="bg-green-900/20 border border-green-800 rounded-lg p-6">
            <h2 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                <i class="fas fa-book-open"></i>
                Basit AnlatÄ±m (Herkes Ä°Ã§in)
            </h2>
            <div class="space-y-3 text-slate-300">
                <p><strong>Problem:</strong> Muzibu.com.tr sitesinde premium Ã¼ye olan kullanÄ±cÄ±, sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda "Premium Ãœye" olarak gÃ¶rÃ¼nÃ¼yor. Ancak herhangi bir ÅŸarkÄ±ya, albÃ¼me veya Ã§alma listesine tÄ±kladÄ±ÄŸÄ±nda sistem "Ãœcretsiz Ãœye" olarak deÄŸiÅŸtiriyor ve "Premium'a GeÃ§" uyarÄ±sÄ± gÃ¶steriyor.</p>

                <p><strong>Neden Oluyor:</strong> Sistem, kullanÄ±cÄ±nÄ±n premium durumunu iki farklÄ± yerden kontrol ediyor:</p>
                <ul class="list-disc list-inside ml-4 space-y-2">
                    <li><strong>Sayfa ilk yÃ¼klenirken:</strong> Database'den doÄŸru bilgi Ã§ekiliyor â†’ "Premium Ãœye" âœ…</li>
                    <li><strong>ÅarkÄ±ya tÄ±klayÄ±nca:</strong> API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor ve burada yanlÄ±ÅŸ kontrol var â†’ KullanÄ±cÄ± bilgileri gÃ¼ncelleniyor â†’ "Ãœcretsiz Ãœye" âŒ</li>
                </ul>

                <p><strong>SonuÃ§:</strong> Premium Ã¼ye olan kullanÄ±cÄ±, mÃ¼zik dinleyemiyor. Sistem sÃ¼rekli "abonelik gerekiyor" diyor.</p>

                <p class="text-yellow-400 font-semibold">ğŸ¯ Ã‡Ã¶zÃ¼m: API'deki yanlÄ±ÅŸ kontrol mantÄ±ÄŸÄ± dÃ¼zeltilmeli. User model'indeki mevcut kontrolÃ¼ kullanmalÄ±.</p>
            </div>
        </div>

        <!-- Teknik Detaylar -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-6">
            <h2 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
                <i class="fas fa-code"></i>
                Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)
            </h2>
            <div class="space-y-3 text-slate-300 text-sm">
                <div>
                    <strong>Etkilenen Dosyalar:</strong>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li><code>Modules/Muzibu/app/Http/Controllers/Api/SongStreamController.php</code> (512-548. satÄ±rlar)</li>
                        <li><code>public/themes/muzibu/js/player/core/player-core.js</code> (3207-3218. satÄ±rlar)</li>
                        <li><code>resources/views/themes/muzibu/components/sidebar-left.blade.php</code> (138-146. satÄ±rlar)</li>
                        <li><code>app/Models/User.php</code> (379-416. satÄ±rlar - isPremium metodu)</li>
                    </ul>
                </div>

                <div>
                    <strong>Ana Sorun:</strong>
                    <p class="mt-2"><code>getSubscriptionData()</code> metodu, <code>User::isPremium()</code> metodunu kullanmak yerine kendi mantÄ±ÄŸÄ±nÄ± yazÄ±yor. Bu mantÄ±k <code>subscription_expires_at</code> field'ini okurken user model'ini fresh load etmiyor.</p>
                </div>

                <div>
                    <strong>Single Source of Truth:</strong>
                    <p class="mt-2"><code>users.subscription_expires_at</code> field'i tÃ¼m sistemde tek doÄŸru kaynaktÄ±r. <code>User::isPremium()</code> metodu bunu doÄŸru kullanÄ±yor, ama API endpoint'teki <code>getSubscriptionData()</code> metodu Ã§eliÅŸen sonuÃ§ Ã¼retiyor.</p>
                </div>

                <div>
                    <strong>Cache Problemi:</strong>
                    <p class="mt-2">Auth guard'dan gelen user object'i request baÅŸÄ±nda yÃ¼kleniyor ve fresh deÄŸil. <code>$user->fresh()->subscription_expires_at</code> veya <code>$user->refresh()</code> kullanÄ±lmalÄ±.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Hata AkÄ±ÅŸ DiyagramÄ± -->
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-diagram-project text-red-500"></i>
            Hata AkÄ±ÅŸ DiyagramÄ±
        </h2>

        <div class="space-y-4">
            <!-- AdÄ±m 1 -->
            <div class="step-card">
                <div class="flex items-start gap-4">
                    <div class="step-number">1</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">Sayfa Ä°lk YÃ¼kleniyor (VarsayÄ±lan ÅarkÄ±)</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p><strong>Blade Template:</strong> <code>window.muzibuPlayerConfig.currentUser</code> objesi oluÅŸturuluyor</p>
                            <p><strong>Backend:</strong> <code>User::isPremium()</code> metodu Ã§aÄŸrÄ±lÄ±yor</p>
                            <div class="code-block text-green-400">
âœ… subscription_expires_at = '2026-02-15 14:30:00'  (gelecek tarih)
âœ… isPremium() = true
âœ… currentUser.is_premium = true
âœ… Sidebar â†’ "Premium Ãœye" gÃ¶steriliyor</div>
                        </div>
                    </div>
                    <span class="badge badge-success"><i class="fas fa-check"></i> DoÄŸru</span>
                </div>
            </div>

            <div class="flow-arrow">
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- AdÄ±m 2 -->
            <div class="step-card">
                <div class="flex items-start gap-4">
                    <div class="step-number">2</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">KullanÄ±cÄ± Rastgele ÅarkÄ±ya/Playlist'e TÄ±klÄ±yor</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p><strong>Frontend:</strong> <code>playSong(32125)</code> â†’ API Ã§aÄŸrÄ±sÄ± tetikleniyor</p>
                            <div class="code-block text-blue-400">
GET /api/muzibu/songs/32125/stream
ğŸ” Auth: web guard (session-based)
ğŸ“¡ Controller: SongStreamController@stream()</div>
                        </div>
                    </div>
                    <span class="badge badge-info"><i class="fas fa-bolt"></i> Tetikleme</span>
                </div>
            </div>

            <div class="flow-arrow">
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- AdÄ±m 3 (HATA!) -->
            <div class="step-card border-2 border-red-500">
                <div class="flex items-start gap-4">
                    <div class="step-number" style="background: linear-gradient(135deg, #dc2626, #991b1b);">3</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-red-400 mb-2">Backend: YANLIÅ Premium KontrolÃ¼!</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p><strong>Dosya:</strong> <code>SongStreamController.php</code> â†’ <code>getSubscriptionData()</code> metodu (512-548. satÄ±rlar)</p>

                            <p class="text-red-400 font-semibold">âš ï¸ HATA: User model'i fresh deÄŸil!</p>

                            <div class="code-block text-red-400">
âŒ $user = auth('web')->user();  // Request baÅŸÄ±nda yÃ¼klenmiÅŸ (eski data)
âŒ $expiresAt = $user->subscription_expires_at;  // NULL veya eski tarih dÃ¶nÃ¼yor
âŒ $hasPremium = $expiresAt && $expiresAt->isFuture();  // FALSE
âŒ return ['is_premium' => false, ...]  // YANLIÅ SONUÃ‡!</div>

                            <p class="text-yellow-400"><strong>Neden?</strong> Auth guard'dan gelen user object'i cache'lenmiÅŸ/eski. Fresh load edilmiyor!</p>
                        </div>
                    </div>
                    <span class="badge badge-error"><i class="fas fa-times"></i> HATA!</span>
                </div>
            </div>

            <div class="flow-arrow">
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- AdÄ±m 4 -->
            <div class="step-card border-2 border-orange-500">
                <div class="flex items-start gap-4">
                    <div class="step-number" style="background: linear-gradient(135deg, #f97316, #ea580c);">4</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-orange-400 mb-2">Frontend: KullanÄ±cÄ± Bilgilerini GÃ¼ncelliyor</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p><strong>Dosya:</strong> <code>player-core.js</code> (3207-3218. satÄ±rlar)</p>

                            <div class="code-block text-orange-400">
// API'den gelen yanlÄ±ÅŸ data
const streamData = {
    is_premium: false,  // âŒ YANLIÅ!
    is_trial: false
};

// Frontend gÃ¼ncelleme
if (this.currentUser) {
    this.currentUser.is_premium = streamData.is_premium;  // false yazÄ±lÄ±yor âŒ
    this.currentUser.is_trial = streamData.is_trial;      // false yazÄ±lÄ±yor
}</div>
                        </div>
                    </div>
                    <span class="badge badge-warning"><i class="fas fa-exclamation-triangle"></i> YanlÄ±ÅŸ Data</span>
                </div>
            </div>

            <div class="flow-arrow">
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- AdÄ±m 5 -->
            <div class="step-card border-2 border-red-500">
                <div class="flex items-start gap-4">
                    <div class="step-number" style="background: linear-gradient(135deg, #dc2626, #991b1b);">5</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-red-400 mb-2">Sidebar: "Ãœcretsiz Ãœye" GÃ¶steriliyor!</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p><strong>Dosya:</strong> <code>sidebar-left.blade.php</code> (138-146. satÄ±rlar)</p>

                            <div class="code-block text-red-400">
get memberType() {
    if (!this.currentUser?.is_premium) {  // âœ… true (Ã§Ã¼nkÃ¼ is_premium=false)
        return 'Ãœcretsiz Ãœye';  // âŒ BURAYA GÄ°RÄ°YOR!
    }
    if (this.currentUser?.is_trial) {
        return 'Deneme Ãœyesi';
    }
    return 'Premium Ãœye';
}</div>

                            <p class="text-red-400 font-semibold">âŒ SONUÃ‡: KullanÄ±cÄ± "Ãœcretsiz Ãœye" olarak gÃ¶steriliyor!</p>
                            <p class="text-red-400 font-semibold">âŒ "Premium'a GeÃ§" butonu Ã§Ä±kÄ±yor!</p>
                        </div>
                    </div>
                    <span class="badge badge-error"><i class="fas fa-ban"></i> HatalÄ± GÃ¶rÃ¼nÃ¼m</span>
                </div>
            </div>

        </div>
    </div>

    <!-- Kod KarÅŸÄ±laÅŸtÄ±rmasÄ± -->
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-code-compare text-yellow-500"></i>
            Kod KarÅŸÄ±laÅŸtÄ±rmasÄ±: DoÄŸru vs YanlÄ±ÅŸ
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- DoÄŸru Kod -->
            <div>
                <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    DoÄŸru: User::isPremium() (User.php)
                </h3>
                <div class="code-block text-green-300">
<span class="text-slate-500">// app/Models/User.php (379-416. satÄ±rlar)</span>

public function isPremium(): bool
{
    <span class="text-slate-500">// Tenant yoksa false</span>
    if (!$this->isMuzibuTenant()) {
        return false;
    }

    <span class="text-green-400">// âœ… ULTRA FAST: Ã–nce tenant users tablosundan kontrol</span>
    if ($this->subscription_expires_at
        && $this->subscription_expires_at->isFuture()) {
        return true;
    }

    <span class="text-green-400">// âœ… Tenant DB'den fresh kontrol</span>
    $tenantExpiry = \DB::table('users')
        ->where('id', $this->id)
        ->value('subscription_expires_at');

    if ($tenantExpiry
        && \Carbon\Carbon::parse($tenantExpiry)->isFuture()) {
        return true;
    }

    <span class="text-green-400">// âœ… Fallback: Subscription tablosu</span>
    return \Cache::remember($cacheKey, 300, function () {
        return $this->subscriptions()
            ->where('status', 'active')
            ->where('current_period_end', '>', now())
            ->exists();
    });
}</div>
            </div>

            <!-- YanlÄ±ÅŸ Kod -->
            <div>
                <h3 class="text-lg font-bold text-red-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-times-circle"></i>
                    YanlÄ±ÅŸ: getSubscriptionData() (SongStreamController.php)
                </h3>
                <div class="code-block text-red-300">
<span class="text-slate-500">// SongStreamController.php (512-548. satÄ±rlar)</span>

protected function getSubscriptionData($user): array
{
    if (!$user) {
        return ['is_premium' => false, ...];
    }

    <span class="text-red-400">// âŒ PROBLEM: User fresh deÄŸil!</span>
    <span class="text-red-400">// Auth guard'dan gelen user cache'lenmiÅŸ</span>
    $expiresAt = $user->subscription_expires_at;

    <span class="text-red-400">// âŒ NULL veya eski tarih dÃ¶nÃ¼yor!</span>
    $hasPremium = $expiresAt && $expiresAt->isFuture();

    if (!$hasPremium) {
        <span class="text-red-400">// âŒ YANLIÅ SONUÃ‡!</span>
        return [
            'is_premium' => false,
            'trial_ends_at' => null,
            'subscription_ends_at' => null,
        ];
    }

    <span class="text-slate-500">// ...</span>
}</div>
            </div>

        </div>
    </div>

    <!-- Neden Oldu? -->
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-search text-purple-500"></i>
            Neden Bu Hata OluÅŸtu?
        </h2>

        <div class="space-y-4">

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center gap-2">
                    <span class="text-2xl">1ï¸âƒ£</span>
                    Auth Guard Cache
                </h3>
                <p class="text-slate-300">
                    Laravel'in auth guard'Ä± (web/sanctum), request baÅŸÄ±nda kullanÄ±cÄ±yÄ± yÃ¼klÃ¼yor ve cache'liyor.
                    Sonraki <code>auth()->user()</code> Ã§aÄŸrÄ±larÄ± aynÄ± object'i dÃ¶ndÃ¼rÃ¼yor.
                    EÄŸer baÅŸka bir sÃ¼reÃ§ (observer, command, job) <code>subscription_expires_at</code> field'ini gÃ¼ncellediyse,
                    mevcut request'teki user object'i bu deÄŸiÅŸikliÄŸi gÃ¶rmÃ¼yor.
                </p>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center gap-2">
                    <span class="text-2xl">2ï¸âƒ£</span>
                    DRY Prensibi Ä°hlali
                </h3>
                <p class="text-slate-300">
                    Sistem zaten <code>User::isPremium()</code> metoduna sahip ve bu metod doÄŸru Ã§alÄ±ÅŸÄ±yor.
                    Ama <code>SongStreamController</code> kendi mantÄ±ÄŸÄ±nÄ± yazmÄ±ÅŸ (duplicate logic).
                    Bu iki mantÄ±k Ã§eliÅŸen sonuÃ§lar Ã¼retiyor.
                </p>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center gap-2">
                    <span class="text-2xl">3ï¸âƒ£</span>
                    Fresh Load EksikliÄŸi
                </h3>
                <p class="text-slate-300">
                    <code>getSubscriptionData()</code> metodu, <code>$user->subscription_expires_at</code> deÄŸerini direkt okuyor.
                    Ama <code>$user->fresh()->subscription_expires_at</code> veya <code>DB::table('users')-&gt;where('id', $user->id)->value('subscription_expires_at')</code>
                    gibi fresh data Ã§ekmiyor.
                </p>
            </div>

        </div>
    </div>

    <!-- Ã‡Ã¶zÃ¼m Ã–nerileri -->
    <div class="bg-gradient-to-br from-green-900/30 to-emerald-900/30 border border-green-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-green-400 mb-6 flex items-center gap-3">
            <i class="fas fa-wrench"></i>
            Ã‡Ã¶zÃ¼m Ã–nerileri
        </h2>

        <div class="space-y-6">

            <!-- Ã‡Ã¶zÃ¼m 1 (Ã–NERÄ°LEN) -->
            <div class="bg-slate-900 border border-green-700 rounded-lg p-5">
                <div class="flex items-center gap-3 mb-4">
                    <span class="badge badge-success text-base">
                        <i class="fas fa-star"></i>
                        Ã–NERÄ°LEN Ã‡Ã–ZÃœM
                    </span>
                    <h3 class="text-xl font-bold text-green-400">Ã‡Ã¶zÃ¼m 1: User::isPremium() Kullan</h3>
                </div>

                <p class="text-slate-300 mb-4">
                    <code>getSubscriptionData()</code> metodunu sil ve doÄŸrudan <code>User::isPremium()</code> metodunu kullan.
                    Bu metod zaten fresh data Ã§ekiyor ve doÄŸru Ã§alÄ±ÅŸÄ±yor.
                </p>

                <div class="code-block text-green-300">
<span class="text-slate-500">// SongStreamController.php - getSubscriptionData() metodunu DEÄÄ°ÅTÄ°R</span>

protected function getSubscriptionData($user): array
{
    if (!$user) {
        return [
            'is_premium' => false,
            'is_trial' => false,
            'trial_ends_at' => null,
            'subscription_ends_at' => null,
        ];
    }

    <span class="text-green-400">// âœ… Ã‡Ã–ZÃœM: User model metodunu kullan</span>
    $isPremium = $user->isPremium();
    $isTrial = $user->isTrialActive();

    if (!$isPremium) {
        return [
            'is_premium' => false,
            'is_trial' => false,
            'trial_ends_at' => null,
            'subscription_ends_at' => null,
        ];
    }

    <span class="text-slate-500">// Premium ise tarihleri getir</span>
    $expiresAt = $user->fresh()->subscription_expires_at;

    <span class="text-slate-500">// Trial subscription kontrolÃ¼</span>
    $trialSubscription = $user->subscriptions()
        ->whereIn('status', ['active', 'trial'])
        ->where('has_trial', true)
        ->whereNotNull('trial_ends_at')
        ->where('trial_ends_at', '>', now())
        ->first();

    return [
        'is_premium' => true,
        'is_trial' => $isTrial,
        'trial_ends_at' => $trialSubscription
            ? $trialSubscription->trial_ends_at->toIso8601String()
            : null,
        'subscription_ends_at' => $expiresAt
            ? $expiresAt->toIso8601String()
            : null,
    ];
}</div>

                <div class="mt-4 p-3 bg-green-900/20 border border-green-800 rounded">
                    <p class="text-green-300 text-sm">
                        <strong>Avantajlar:</strong>
                    </p>
                    <ul class="list-disc list-inside text-green-300 text-sm ml-4 mt-2 space-y-1">
                        <li>Single source of truth (User model)</li>
                        <li>Duplicate code kaldÄ±rÄ±lÄ±yor</li>
                        <li>User::isPremium() zaten fresh check yapÄ±yor</li>
                        <li>Daha az kod, daha kolay bakÄ±m</li>
                    </ul>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 2 -->
            <div class="bg-slate-900 border border-blue-700 rounded-lg p-5">
                <div class="flex items-center gap-3 mb-4">
                    <span class="badge badge-info">ALTERNATÄ°F</span>
                    <h3 class="text-xl font-bold text-blue-400">Ã‡Ã¶zÃ¼m 2: Fresh Load Ekle</h3>
                </div>

                <p class="text-slate-300 mb-4">
                    Mevcut <code>getSubscriptionData()</code> metodunu koruyarak sadece fresh load ekle.
                </p>

                <div class="code-block text-blue-300">
<span class="text-slate-500">// SongStreamController.php</span>

protected function getSubscriptionData($user): array
{
    if (!$user) {
        return ['is_premium' => false, ...];
    }

    <span class="text-blue-400">// âœ… FRESH LOAD: DB'den gÃ¼ncel veriyi Ã§ek</span>
    $freshUser = $user->fresh(['subscriptions']);
    $expiresAt = $freshUser->subscription_expires_at;

    $hasPremium = $expiresAt && $expiresAt->isFuture();

    <span class="text-slate-500">// ... geri kalan kod aynÄ±</span>
}</div>

                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-800 rounded">
                    <p class="text-blue-300 text-sm">
                        <strong>Avantajlar:</strong>
                    </p>
                    <ul class="list-disc list-inside text-blue-300 text-sm ml-4 mt-2 space-y-1">
                        <li>Minimum kod deÄŸiÅŸikliÄŸi</li>
                        <li>Mevcut mantÄ±k korunuyor</li>
                    </ul>
                    <p class="text-blue-300 text-sm mt-3">
                        <strong>Dezavantajlar:</strong>
                    </p>
                    <ul class="list-disc list-inside text-blue-300 text-sm ml-4 mt-2 space-y-1">
                        <li>Duplicate logic devam ediyor</li>
                        <li>Extra DB query (fresh load)</li>
                    </ul>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 3 -->
            <div class="bg-slate-900 border border-yellow-700 rounded-lg p-5">
                <div class="flex items-center gap-3 mb-4">
                    <span class="badge badge-warning">HIZ OPTÄ°MÄ°ZASYONU</span>
                    <h3 class="text-xl font-bold text-yellow-400">Ã‡Ã¶zÃ¼m 3: Cache Invalidation</h3>
                </div>

                <p class="text-slate-300 mb-4">
                    Observer kullanarak subscription deÄŸiÅŸikliÄŸinde auth cache'i temizle.
                </p>

                <div class="code-block text-yellow-300">
<span class="text-slate-500">// app/Observers/SubscriptionObserver.php</span>

public function updated(Subscription $subscription)
{
    <span class="text-yellow-400">// âœ… Auth cache temizle</span>
    $user = $subscription->user;
    if ($user) {
        <span class="text-slate-500">// Auth guard cache'i temizle</span>
        auth()->guard('web')->setUser($user->fresh());

        <span class="text-slate-500">// Premium cache'i temizle</span>
        \Cache::forget('user_' . $user->id . '_is_premium_tenant_' . tenant()->id);
    }
}</div>

                <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-800 rounded">
                    <p class="text-yellow-300 text-sm">
                        <strong>Not:</strong> Bu Ã§Ã¶zÃ¼m tek baÅŸÄ±na yeterli deÄŸil. Ã‡Ã¶zÃ¼m 1 ile birlikte kullanÄ±lmalÄ±.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- Test Senaryosu -->
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-flask text-cyan-500"></i>
            Test Senaryosu
        </h2>

        <div class="space-y-4">

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-cyan-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-clipboard-check"></i>
                    Test AdÄ±mlarÄ±
                </h3>
                <ol class="list-decimal list-inside text-slate-300 space-y-2 ml-4">
                    <li>Premium Ã¼ye hesabÄ±yla giriÅŸ yap</li>
                    <li>Ana sayfa yÃ¼klendiÄŸinde sidebar'da "Premium Ãœye" yazdÄ±ÄŸÄ±nÄ± kontrol et</li>
                    <li>Herhangi bir ÅŸarkÄ±ya/albÃ¼me/playlist'e tÄ±kla</li>
                    <li>Sidebar'da hala "Premium Ãœye" yazdÄ±ÄŸÄ±nÄ± kontrol et (deÄŸiÅŸmemeli!) âœ…</li>
                    <li>"Premium'a GeÃ§" butonu Ã‡IKMAMALI âœ…</li>
                    <li>ÅarkÄ± sorunsuz Ã§almalÄ± âœ…</li>
                </ol>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-cyan-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-terminal"></i>
                    Debug KomutlarÄ±
                </h3>
                <div class="code-block text-cyan-300">
<span class="text-slate-500">// Tinker ile premium kontrolÃ¼</span>
php artisan tinker

$user = User::find(YOUR_USER_ID);
echo "subscription_expires_at: " . $user->subscription_expires_at;
echo "isPremium(): " . ($user->isPremium() ? 'true' : 'false');
echo "isPremiumOrTrial(): " . ($user->isPremiumOrTrial() ? 'true' : 'false');

<span class="text-slate-500">// DB'den direkt kontrol</span>
$expiry = DB::table('users')->where('id', YOUR_USER_ID)->value('subscription_expires_at');
echo "DB expiry: " . $expiry;</div>
            </div>

        </div>
    </div>

    <!-- Ã–nleyici Tedbirler -->
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-shield-alt text-indigo-500"></i>
            Ã–nleyici Tedbirler (Gelecek Ä°Ã§in)
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-indigo-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-check-double"></i>
                    Single Source of Truth
                </h3>
                <p class="text-slate-300 text-sm">
                    Bir veri iÃ§in tek kaynak belirle. Premium kontrolÃ¼ iÃ§in <code>User::isPremium()</code> kullan,
                    baÅŸka yerde aynÄ± mantÄ±ÄŸÄ± yazma.
                </p>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-indigo-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    Fresh Load Awareness
                </h3>
                <p class="text-slate-300 text-sm">
                    Auth guard'dan gelen user object'i cache'lenmiÅŸ olabilir.
                    Kritik iÅŸlemlerde <code>$user->fresh()</code> veya direkt DB query kullan.
                </p>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-indigo-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-flask"></i>
                    Unit Test
                </h3>
                <p class="text-slate-300 text-sm">
                    API endpoint'leri iÃ§in unit test yaz. Premium/Trial kullanÄ±cÄ± senaryolarÄ±nÄ± test et.
                </p>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                <h3 class="text-lg font-bold text-indigo-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-eye"></i>
                    Code Review
                </h3>
                <p class="text-slate-300 text-sm">
                    Duplicate logic oluÅŸturmadan Ã¶nce mevcut metodlarÄ± kontrol et.
                    Code review sÃ¼recinde DRY prensibi ihlallerini yakala.
                </p>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-slate-500 text-sm py-6 border-t border-slate-700">
        <p class="mb-2">
            <i class="fas fa-robot text-muzibu-coral"></i>
            <strong>Claude AI</strong> tarafÄ±ndan 9 Ocak 2026 tarihinde hazÄ±rlanmÄ±ÅŸtÄ±r.
        </p>
        <p>
            <i class="fas fa-code"></i>
            Muzibu Premium System - Bug Analysis & Solution Report
        </p>
    </div>

</div>

</body>
</html>