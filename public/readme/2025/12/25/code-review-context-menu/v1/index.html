<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review: Context Menu Overhaul - KRİTİK HATA BULUNDU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-8">

        <!-- Header -->
        <header class="text-center mb-10">
            <span class="inline-block bg-red-600 text-white text-xs font-bold px-4 py-1 rounded-full mb-4 animate-pulse">
                <i class="fas fa-exclamation-triangle mr-1"></i> KRİTİK HATA BULUNDU
            </span>
            <h1 class="text-3xl font-black text-white mb-2">Code Review: Context Menu Overhaul</h1>
            <p class="text-gray-400">Detaylı Backend & Frontend Analizi</p>
            <p class="text-gray-500 text-sm mt-2">25 Aralık 2025</p>
        </header>

        <!-- Kritik Hata -->
        <div class="bg-red-900/30 border-2 border-red-600 rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-red-400 mb-4 flex items-center gap-2">
                <i class="fas fa-bug"></i>
                KRİTİK HATA: API Endpoint Eksik!
            </h2>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-4">
                <h3 class="font-bold text-white mb-2">❌ Problem:</h3>
                <p class="text-gray-300 mb-3">
                    JavaScript kodu <code class="bg-red-900/50 px-2 py-1 rounded text-red-400">/api/muzibu/playlists/{id}/add-album</code>
                    endpoint'ine istek atıyor, ancak bu endpoint backend'de <strong>TANIMLI DEĞİL!</strong>
                </p>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-semibold text-red-400 mb-2">Frontend (muzibu-store.js:1032)</h4>
                        <pre class="bg-slate-800 p-3 rounded text-xs text-gray-300 overflow-x-auto">async addAlbumToPlaylists() {
    const promises = this.selectedPlaylists.map(playlistId =>
        fetch(`<span class="text-red-400">/api/muzibu/playlists/${playlistId}/add-album</span>`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({ album_id: this.contentId })
        }).then(res => res.json())
    );
    ...
}</pre>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-yellow-400 mb-2">Backend Routes (api.php)</h4>
                        <pre class="bg-slate-800 p-3 rounded text-xs text-gray-300 overflow-x-auto">Route::middleware(['web', 'auth'])->group(function () {
    Route::post('/{id}/add-song', [PlaylistController::class, 'addSong']);
    <span class="text-red-400">// ❌ add-album route YOK!</span>
    Route::delete('/{id}/remove-song/{songId}', ...);
    ...
});</pre>
                    </div>
                </div>
            </div>

            <div class="bg-amber-900/30 border border-amber-700 rounded-lg p-4">
                <h3 class="font-bold text-amber-400 mb-2"><i class="fas fa-lightbulb mr-2"></i>Sonuç:</h3>
                <ul class="text-gray-300 space-y-1 text-sm">
                    <li><i class="fas fa-times text-red-400 mr-2"></i>Albüme sağ tıklayıp "Playliste Ekle" yapılırsa → <strong>404 Not Found</strong></li>
                    <li><i class="fas fa-times text-red-400 mr-2"></i>Kullanıcı albüm ekleyemez → Kötü UX</li>
                    <li><i class="fas fa-times text-red-400 mr-2"></i>Console'da hata gösterir</li>
                </ul>
            </div>
        </div>

        <!-- Çözüm -->
        <div class="bg-green-900/20 border border-green-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-green-400 mb-4"><i class="fas fa-tools mr-2"></i>Çözüm Önerisi</h2>

            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-white mb-2">1️⃣ Route Ekle (api.php:48)</h3>
                    <pre class="bg-slate-800 p-3 rounded text-sm text-green-400 overflow-x-auto">Route::post('/{id}/add-song', [PlaylistController::class, 'addSong'])->name('api.muzibu.playlists.add-song');
<span class="text-green-300">Route::post('/{id}/add-album', [PlaylistController::class, 'addAlbum'])->name('api.muzibu.playlists.add-album');</span></pre>
                </div>

                <div>
                    <h3 class="font-semibold text-white mb-2">2️⃣ Controller Metodu Ekle (PlaylistController.php)</h3>
                    <pre class="bg-slate-800 p-3 rounded text-sm text-green-400 overflow-x-auto">/**
 * Add all songs from album to playlist
 */
public function addAlbum(Request $request, int $id): JsonResponse
{
    try {
        $request->validate([
            'album_id' => 'required|integer|exists:muzibu_albums,album_id',
        ]);

        $userId = auth()->id();
        $albumId = $request->input('album_id');

        // Get album with songs
        $album = Album::with('songs')->findOrFail($albumId);
        $songIds = $album->songs->where('is_active', 1)->pluck('song_id')->toArray();

        if (empty($songIds)) {
            return response()->json([
                'success' => false,
                'message' => 'Albümde aktif şarkı bulunamadı',
            ], 400);
        }

        // Add all songs to playlist (using existing service)
        $addedCount = 0;
        foreach ($songIds as $songId) {
            $result = $this->playlistService->addSongToPlaylist($id, $songId, $userId);
            if ($result['success']) {
                $addedCount++;
            }
        }

        return response()->json([
            'success' => true,
            'added_count' => $addedCount,
            'total_songs' => count($songIds),
            'message' => "{$addedCount} şarkı playliste eklendi",
        ]);

    } catch (\Exception $e) {
        \Log::error('Add album to playlist error:', ['message' => $e->getMessage()]);
        return response()->json([
            'success' => false,
            'message' => 'Albüm ekleme başarısız',
        ], 500);
    }
}</pre>
                </div>
            </div>
        </div>

        <!-- Diğer Bulgular -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-blue-400 mb-4"><i class="fas fa-check-circle mr-2"></i>Diğer Bulgular (Sorun Yok)</h2>

            <div class="space-y-4">
                <!-- API Endpoints -->
                <div>
                    <h3 class="font-semibold text-white mb-2">✅ Mevcut API Endpoint'leri</h3>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <table class="w-full text-sm">
                            <thead class="text-gray-400 border-b border-slate-700">
                                <tr>
                                    <th class="text-left py-2">Endpoint</th>
                                    <th class="text-center py-2">Durum</th>
                                    <th class="text-left py-2">Dosya</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                                <tr>
                                    <td class="py-2"><code class="text-cyan-400 text-xs">/api/muzibu/playlists/my-playlists</code></td>
                                    <td class="text-center"><span class="text-green-400">✓ VAR</span></td>
                                    <td class="text-xs text-gray-400">api.php:44</td>
                                </tr>
                                <tr>
                                    <td class="py-2"><code class="text-cyan-400 text-xs">/api/muzibu/songs/{id}/playlists</code></td>
                                    <td class="text-center"><span class="text-green-400">✓ VAR</span></td>
                                    <td class="text-xs text-gray-400">api.php:82</td>
                                </tr>
                                <tr>
                                    <td class="py-2"><code class="text-cyan-400 text-xs">/api/muzibu/playlists/{id}/add-song</code></td>
                                    <td class="text-center"><span class="text-green-400">✓ VAR</span></td>
                                    <td class="text-xs text-gray-400">api.php:47</td>
                                </tr>
                                <tr class="bg-red-900/20">
                                    <td class="py-2"><code class="text-red-400 text-xs">/api/muzibu/playlists/{id}/add-album</code></td>
                                    <td class="text-center"><span class="text-red-400">✗ YOK</span></td>
                                    <td class="text-xs text-gray-400">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Alpine Store -->
                <div>
                    <h3 class="font-semibold text-white mb-2">✅ Alpine.js playlistModal Store</h3>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <ul class="text-sm text-gray-300 space-y-1">
                            <li><i class="fas fa-check text-green-400 mr-2"></i><code>showForSong()</code> - Doğru çalışır</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><code>showForAlbum()</code> - Mantık doğru, sadece backend eksik</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><code>fetchPlaylists()</code> - API doğru</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><code>checkExistingPlaylists()</code> - API doğru</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><code>addSongToPlaylists()</code> - API doğru, çalışır</li>
                            <li><i class="fas fa-exclamation-triangle text-red-400 mr-2"></i><code>addAlbumToPlaylists()</code> - <strong>Backend eksik, 404 verir!</strong></li>
                        </ul>
                    </div>
                </div>

                <!-- Context Menu Data -->
                <div>
                    <h3 class="font-semibold text-white mb-2">✅ Context Menu Data Integrity</h3>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <ul class="text-sm text-gray-300 space-y-1">
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>artist_id, artist_slug:</strong> Başarıyla kaldırılmış</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>cover_url:</strong> Tüm componentlere eklenmiş (<code>getCoverUrl(300, 300)</code>)</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>album_id, album_slug:</strong> Korunmuş (gerekli)</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>is_favorite:</strong> Doğru kontrol ediliyor</li>
                        </ul>
                    </div>
                </div>

                <!-- Menu Items -->
                <div>
                    <h3 class="font-semibold text-white mb-2">✅ Menu Item Değişiklikleri</h3>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <div class="grid md:grid-cols-3 gap-3 text-xs">
                            <div>
                                <p class="text-pink-400 font-semibold mb-1">Song Menu</p>
                                <ul class="text-gray-400 space-y-0.5">
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>goToArtist kaldırıldı</li>
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>addToPlaylist var</li>
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>Albüme Git korundu</li>
                                </ul>
                            </div>
                            <div>
                                <p class="text-blue-400 font-semibold mb-1">Album Menu</p>
                                <ul class="text-gray-400 space-y-0.5">
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>goToArtist kaldırıldı</li>
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>addToPlaylist eklendi</li>
                                    <li><i class="fas fa-exclamation-triangle text-red-400 mr-1"></i>Backend eksik!</li>
                                </ul>
                            </div>
                            <div>
                                <p class="text-red-400 font-semibold mb-1">Radio Menu</p>
                                <ul class="text-gray-400 space-y-0.5">
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>addToQueue kaldırıldı</li>
                                    <li><i class="fas fa-check text-green-400 mr-1"></i>Sadece play + favorite</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Files -->
                <div>
                    <h3 class="font-semibold text-white mb-2">✅ Action Handler'lar</h3>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <ul class="text-sm text-gray-300 space-y-1">
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>song-actions.js:</strong> goToArtist kaldırıldı, addToPlaylist doğru</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>album-actions.js:</strong> goToArtist kaldırıldı, addToPlaylist eklendi</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i><strong>radio-actions.js:</strong> addToQueue kaldırıldı</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i>Tüm handler'lar <code>playlistModal.showForSong/Album</code> kullanıyor</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Özet -->
        <div class="bg-gradient-to-r from-red-900/30 to-orange-900/30 border-2 border-orange-600 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-clipboard-check mr-2"></i>Özet</h2>

            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-slate-900/50 rounded-lg p-4">
                    <h3 class="font-semibold text-red-400 mb-2">❌ Kritik Sorunlar (1)</h3>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li><i class="fas fa-bug text-red-400 mr-2"></i><code>/api/muzibu/playlists/{id}/add-album</code> endpoint'i YOK</li>
                    </ul>
                </div>

                <div class="bg-slate-900/50 rounded-lg p-4">
                    <h3 class="font-semibold text-green-400 mb-2">✅ Başarılı İşlemler (12)</h3>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li><i class="fas fa-check text-green-400 mr-2"></i>playlistModal store eksiksiz</li>
                        <li><i class="fas fa-check text-green-400 mr-2"></i>Context menu data temiz</li>
                        <li><i class="fas fa-check text-green-400 mr-2"></i>Menu yapısı doğru</li>
                        <li><i class="fas fa-check text-green-400 mr-2"></i>Action handler'lar çalışıyor</li>
                        <li><i class="fas fa-check text-green-400 mr-2"></i>API endpoint'lerin çoğu var</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Action Items -->
        <div class="bg-yellow-900/20 border border-yellow-700 rounded-xl p-6">
            <h2 class="text-xl font-bold text-yellow-400 mb-4"><i class="fas fa-exclamation-circle mr-2"></i>Yapılması Gerekenler</h2>

            <div class="space-y-2">
                <label class="flex items-start gap-3 text-sm text-gray-300">
                    <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-600">
                    <span><code class="bg-yellow-900/50 px-2 py-1 rounded text-yellow-300">api.php</code> dosyasına <code>/{id}/add-album</code> route'u ekle</span>
                </label>
                <label class="flex items-start gap-3 text-sm text-gray-300">
                    <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-600">
                    <span><code class="bg-yellow-900/50 px-2 py-1 rounded text-yellow-300">PlaylistController.php</code>'ye <code>addAlbum()</code> metodu ekle</span>
                </label>
                <label class="flex items-start gap-3 text-sm text-gray-300">
                    <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-600">
                    <span>Test: Albüme sağ tıkla → Playliste Ekle → Çalışmalı</span>
                </label>
                <label class="flex items-start gap-3 text-sm text-gray-300">
                    <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-600">
                    <span>Cache temizle: <code>php artisan view:clear && php artisan responsecache:clear</code></span>
                </label>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm py-8 border-t border-slate-800 mt-8">
            <p>Claude AI - Detaylı Code Review</p>
            <p class="text-xs mt-1">25 Aralık 2025</p>
        </footer>
    </div>
</body>
</html>
