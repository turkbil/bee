<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Mode - DRM KorumalÄ± Dinleme</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.8;
            padding: 40px 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 3rem; color: #1DB954; margin-bottom: 30px; }
        h2 { font-size: 2rem; color: #60a5fa; margin: 40px 0 20px 0; }
        h3 { font-size: 1.5rem; color: #a78bfa; margin: 30px 0 15px 0; }
        .code-block {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
        }
        pre { color: #cbd5e1; font-size: 0.95rem; line-height: 1.6; }
        .highlight { background: rgba(29, 185, 84, 0.2); padding: 2px 6px; border-radius: 4px; color: #1ed760; }
        .critical { background: rgba(239, 68, 68, 0.2); padding: 20px; border-left: 4px solid #ef4444; border-radius: 8px; margin: 20px 0; }
        .success { background: rgba(29, 185, 84, 0.2); padding: 20px; border-left: 4px solid #1DB954; border-radius: 8px; margin: 20px 0; }
        .info { background: rgba(59, 130, 246, 0.2); padding: 20px; border-left: 4px solid #3b82f6; border-radius: 8px; margin: 20px 0; }
        .warning { background: rgba(251, 191, 36, 0.2); padding: 20px; border-left: 4px solid #fbbf24; border-radius: 8px; margin: 20px 0; }
        ul, ol { margin: 20px 0; padding-left: 30px; }
        li { margin: 12px 0; }
        .back { display: inline-block; padding: 12px 24px; background: #1DB954; color: #000; text-decoration: none; border-radius: 8px; font-weight: 700; margin-bottom: 30px; }
        .back:hover { background: #1ed760; }
        .scenario-box {
            background: #1e293b;
            border: 1px solid #334155;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
        }
        .scenario-step {
            background: #0f172a;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        .scenario-step strong {
            color: #60a5fa;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back">â† TÃ¼m Ã–zelliklere DÃ¶n</a>

        <h1>ğŸ“¥ Offline Mode - DRM KorumalÄ±</h1>

        <div class="critical">
            <h3>ğŸ”´ GÃœVENLÄ°K Ã–NCELÄ°ÄÄ°!</h3>
            <p><strong>KURAL:</strong> ÅarkÄ±lar PC'ye normal media player'da dinlenebilecek ÅŸekilde indirilemez!</p>
            <p><strong>AMAÃ‡:</strong> KullanÄ±cÄ±lar sadece muzibu.com Ã¼zerinden dinleyebilir (offline bile olsa).</p>
        </div>

        <div class="success">
            <h3>âœ… Ã‡Ã–ZÃœM: Service Worker + Encrypted Cache</h3>
            <p>ÅarkÄ±lar browser cache'ine ÅŸifreli olarak kaydedilir. Sadece muzibu.com'dan aÃ§Ä±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r!</p>
        </div>

        <h2>ğŸ¯ Offline Mode Nedir?</h2>

        <div class="info">
            <p><strong>Offline Mode:</strong> Ä°nternet olmadan mÃ¼zik dinleme Ã¶zelliÄŸi.</p>
            <ul>
                <li>ÅarkÄ±lar tarayÄ±cÄ± cache'ine kaydedilir</li>
                <li>Ä°nternet kesildiÄŸinde cache'den Ã§alÄ±nÄ±r</li>
                <li><strong>AMA:</strong> PC'ye .mp3 olarak indirilemez!</li>
                <li>Sadece browser iÃ§inde, sadece muzibu.com'da Ã§alÄ±ÅŸÄ±r</li>
            </ul>
        </div>

        <h2>ğŸ¢ B2B KullanÄ±m Senaryosu</h2>

        <div class="scenario-box">
            <h3 style="color: #1DB954; margin-bottom: 20px;">â˜• Kahve DÃ¼kkanÄ± Senaryosu</h3>

            <div class="scenario-step">
                <strong>1. Sabah HazÄ±rlÄ±k (09:00)</strong>
                <p>Cafe sahibi PC'yi aÃ§ar, muzibu.com'a girer, "KahvaltÄ± Jazz" playlist'i baÅŸlatÄ±r.</p>
                <p><strong>âœ… Offline sync baÅŸlar:</strong> 50 ÅŸarkÄ± cache'e indirilir (arka planda, sessizce).</p>
            </div>

            <div class="scenario-step">
                <strong>2. GÃ¼n Ä°Ã§inde (09:00 - 18:00)</strong>
                <p>MÃ¼ÅŸteriler gelir, mÃ¼zik Ã§alar. Her ÅŸey normal.</p>
                <p><strong>Cache'den Ã§alÄ±yor:</strong> Ä°nternet hÄ±zlÄ±, yavaÅŸ veya kesik olsa da sorun yok!</p>
            </div>

            <div class="scenario-step">
                <strong>3. Ä°nternet Kesildi! (14:30)</strong>
                <p>âš ï¸ Modem arÄ±zalandÄ±, internet gitti!</p>
                <p><strong>âœ… MÃ¼zik DURMUYOR!</strong> Cache'deki ÅŸarkÄ±lar Ã§almaya devam eder.</p>
                <p><strong>Bildirim:</strong> "Offline moddasÄ±nÄ±z - cache'deki ÅŸarkÄ±lar Ã§alÄ±nÄ±yor (23 ÅŸarkÄ± kaldÄ±)"</p>
            </div>

            <div class="scenario-step">
                <strong>4. Teknisyen Geldi (17:00)</strong>
                <p>Ä°nternet dÃ¼zeldi, modem yeniden baÅŸladÄ±.</p>
                <p><strong>âœ… Otomatik sync:</strong> Cache yenilenir, yeni ÅŸarkÄ±lar indirilir.</p>
            </div>

            <div class="scenario-step">
                <strong>5. Ertesi GÃ¼n (09:00)</strong>
                <p>PC aÃ§Ä±ldÄ±, mÃ¼zik baÅŸladÄ± - internet hala yavaÅŸ.</p>
                <p><strong>âœ… Cache sayesinde:</strong> AnÄ±nda baÅŸladÄ±, buffering yok!</p>
            </div>
        </div>

        <h2>ğŸ”§ Teknik Ä°mplementasyon</h2>

        <h3>1. Service Worker (sw.js)</h3>
        <div class="code-block">
<pre>// Service Worker: Offline cache yÃ¶netimi
const CACHE_NAME = 'muzibu-audio-v1';
const MAX_CACHE_SONGS = 50; // Max 50 ÅŸarkÄ± cache'lenebilir

// Service Worker install
self.addEventListener('install', (event) => {
    console.log('Muzibu SW installed');
    self.skipWaiting();
});

// Fetch intercept - audio isteklerini cache'le
self.addEventListener('fetch', (event) => {
    const url = new URL(event.request.url);

    // Audio stream isteÄŸi mi?
    if (url.pathname.includes('/api/muzibu/songs/') && url.pathname.includes('/stream')) {
        event.respondWith(
            caches.open(CACHE_NAME).then(async (cache) => {
                // Cache'de var mÄ±?
                const cached = await cache.match(event.request);
                if (cached) {
                    console.log('ğŸµ Serving from cache:', url.pathname);
                    return cached;
                }

                // Yoksa fetch et ve cache'e ekle
                try {
                    const response = await fetch(event.request);

                    // Sadece baÅŸarÄ±lÄ± istekleri cache'le
                    if (response.ok) {
                        cache.put(event.request, response.clone());
                        console.log('ğŸ’¾ Cached:', url.pathname);
                    }

                    return response;
                } catch (error) {
                    console.error('âŒ Fetch failed (offline):', error);
                    throw error;
                }
            })
        );
    } else {
        // DiÄŸer istekler normal
        event.respondWith(fetch(event.request));
    }
});</pre>
        </div>

        <h3>2. Cache Manager (Alpine.js)</h3>
        <div class="code-block">
<pre>// muzibuApp() iÃ§inde

data() {
    return {
        // ... mevcut state'ler

        // Offline mode
        offlineMode: false,           // Offline mu?
        cachedSongs: [],              // Cache'deki ÅŸarkÄ±lar
        cacheSyncProgress: 0,         // Sync progress (0-100)

        // ... diÄŸer state'ler
    };
},

init() {
    // ... mevcut init kodu

    // Service Worker register
    this.registerServiceWorker();

    // Network status listener
    this.watchNetworkStatus();

    // Cache status check
    this.checkCacheStatus();
},

// Service Worker register
async registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('âœ… Service Worker registered:', registration);
        } catch (error) {
            console.error('Service Worker registration failed:', error);
        }
    }
},

// Network status monitor
watchNetworkStatus() {
    // Online/Offline event'leri
    window.addEventListener('online', () => {
        this.offlineMode = false;
        this.showToast('Ä°nternet baÄŸlantÄ±sÄ± geri geldi', 'success');
        this.syncCache(); // Yeni ÅŸarkÄ±larÄ± indir
    });

    window.addEventListener('offline', () => {
        this.offlineMode = true;
        this.showToast('Offline moddasÄ±nÄ±z - cache\'deki ÅŸarkÄ±lar Ã§alÄ±nÄ±yor', 'warning');
    });

    // Ä°lk durum kontrolÃ¼
    this.offlineMode = !navigator.onLine;
},

// Cache'e ÅŸarkÄ± ekle (background sync)
async addToCache(songId) {
    try {
        // Stream URL al
        const response = await fetch(`/api/muzibu/songs/${songId}/stream`);
        const data = await response.json();

        // Cache'e ekle (Service Worker otomatik yapar)
        const audioResponse = await fetch(data.stream_url);

        if (audioResponse.ok) {
            this.cachedSongs.push(songId);
            console.log(`ğŸ’¾ Song ${songId} cached`);
        }
    } catch (error) {
        console.error('Cache add failed:', error);
    }
},

// Playlist'i cache'e indir (background)
async cachePlaylist(playlistId) {
    try {
        // Playlist ÅŸarkÄ±larÄ±nÄ± al
        const response = await fetch(`/api/muzibu/playlists/${playlistId}`);
        const playlist = await response.json();

        this.showToast(`${playlist.songs.length} ÅŸarkÄ± cache'e indiriliyor...`, 'info');

        let cached = 0;
        for (const song of playlist.songs.slice(0, MAX_CACHE_SONGS)) {
            await this.addToCache(song.song_id);
            cached++;

            // Progress gÃ¼ncelle
            this.cacheSyncProgress = Math.round((cached / playlist.songs.length) * 100);
        }

        this.showToast(`âœ… ${cached} ÅŸarkÄ± offline dinlemeye hazÄ±r!`, 'success');
        this.cacheSyncProgress = 0;
    } catch (error) {
        console.error('Playlist cache failed:', error);
    }
},

// Cache status check
async checkCacheStatus() {
    if (!('caches' in window)) return;

    const cache = await caches.open(CACHE_NAME);
    const keys = await cache.keys();

    // Audio stream URL'lerini filtrele
    const audioKeys = keys.filter(req => req.url.includes('/stream'));

    this.cachedSongs = audioKeys.map(req => {
        // URL'den song ID'yi Ã§Ä±kar
        const match = req.url.match(/\/songs\/(\d+)\/stream/);
        return match ? parseInt(match[1]) : null;
    }).filter(Boolean);

    console.log(`ğŸ’¾ Cache status: ${this.cachedSongs.length} songs`);
}</pre>
        </div>

        <h3>3. UI - Cache Butonu</h3>
        <div class="code-block">
<pre>&lt;!-- Queue item'da offline download button --&gt;
&lt;button @click="addToCache(song.song_id)"
        :disabled="cachedSongs.includes(song.song_id)"
        class="px-3 py-1 rounded text-xs"
        :class="cachedSongs.includes(song.song_id) ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-300'"&gt;
    &lt;i :class="cachedSongs.includes(song.song_id) ? 'fas fa-check' : 'fas fa-download'"&gt;&lt;/i&gt;
    &lt;span x-text="cachedSongs.includes(song.song_id) ? 'Offline HazÄ±r' : 'Offline Ä°ndir'"&gt;&lt;/span&gt;
&lt;/button&gt;

&lt;!-- Playlist offline download --&gt;
&lt;button @click="cachePlaylist(playlist.id)"
        class="bg-green-500 text-white px-4 py-2 rounded-lg"&gt;
    ğŸ“¥ Playlist'i Offline Ä°ndir
&lt;/button&gt;

&lt;!-- Sync progress --&gt;
&lt;div x-show="cacheSyncProgress > 0" class="fixed bottom-24 right-4 bg-gray-900 p-4 rounded-lg shadow-xl"&gt;
    &lt;p class="text-white mb-2"&gt;Offline sync...&lt;/p&gt;
    &lt;div class="w-64 h-2 bg-gray-700 rounded"&gt;
        &lt;div class="h-full bg-green-500 rounded"
             :style="`width: ${cacheSyncProgress}%`"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;p class="text-sm text-gray-400 mt-1" x-text="`${cacheSyncProgress}% tamamlandÄ±`"&gt;&lt;/p&gt;
&lt;/div&gt;</pre>
        </div>

        <h2>ğŸ”’ DRM KorumasÄ± - Neden PC'ye Ä°ndirilemez?</h2>

        <div class="warning">
            <h3>ğŸ›¡ï¸ GÃ¼venlik KatmanlarÄ±</h3>
            <ul>
                <li><strong>1. Cache API:</strong> TarayÄ±cÄ± cache'i binary format, .mp3 olarak eriÅŸilemez</li>
                <li><strong>2. Origin Binding:</strong> Cache sadece muzibu.com origin'inden eriÅŸilebilir</li>
                <li><strong>3. Encrypted Streams (opsiyonel):</strong> HLS stream'ler AES-128 ile ÅŸifrelenebilir</li>
                <li><strong>4. Session Token:</strong> Her istek geÃ§erli session token gerektirir</li>
                <li><strong>5. Blob URL:</strong> Audio element'e blob URL verilir (file path yok)</li>
            </ul>
        </div>

        <div class="info">
            <h3>ğŸ’¡ KullanÄ±cÄ± Neden Ã‡Ä±karamaz?</h3>
            <ol>
                <li><strong>Cache Inspector:</strong> Chrome DevTools'da cache iÃ§eriÄŸi gÃ¶rÃ¼lÃ¼r AMA binary format (oynatÄ±lamaz)</li>
                <li><strong>Dosya Sistemi:</strong> Cache browser sandbox'Ä±nda, OS file system'de deÄŸil</li>
                <li><strong>Export Ä°mkansÄ±z:</strong> Cache API export fonksiyonu yok</li>
                <li><strong>Token Dependency:</strong> Stream URL'ler token iÃ§erir, expire olur (15 dakika)</li>
            </ol>
        </div>

        <h2>ğŸ“Š Cache Limitleri</h2>

        <div class="code-block">
<pre>// Cache limitleri
const CACHE_LIMITS = {
    maxSongs: 50,                 // Max 50 ÅŸarkÄ±
    maxSizePerSong: 10 * 1024 * 1024,  // 10 MB per song
    maxTotalSize: 500 * 1024 * 1024,   // Total 500 MB
    expirationDays: 7             // 7 gÃ¼n sonra expire
};

// Cache temizleme (eski ÅŸarkÄ±lar)
async cleanOldCache() {
    const cache = await caches.open(CACHE_NAME);
    const keys = await cache.keys();

    // 7 gÃ¼nden eski cache'leri sil
    // (Cache metadata'dan timestamp kontrol et)
}</pre>
        </div>

        <h2>âœ… Avantajlar</h2>
        <ul>
            <li>âœ… <span class="highlight">Ä°nternet Kesintisinde MÃ¼zik Devam Eder:</span> B2B iÃ§in kritik!</li>
            <li>âœ… <span class="highlight">HÄ±zlÄ± BaÅŸlangÄ±Ã§:</span> Cache'den Ã§alma, buffering yok</li>
            <li>âœ… <span class="highlight">DRM KorumalÄ±:</span> PC'ye indirilemez, sadece browser'da Ã§alÄ±ÅŸÄ±r</li>
            <li>âœ… <span class="highlight">Background Sync:</span> KullanÄ±cÄ± fark etmeden indirilir</li>
            <li>âœ… <span class="highlight">Mobil Data Tasarrufu:</span> Bir kere indir, sonra offline Ã§al</li>
        </ul>

        <h2>âš ï¸ SÄ±nÄ±rlamalar</h2>

        <div class="critical">
            <h3>Cache API Limitleri</h3>
            <ul>
                <li><strong>Storage Quota:</strong> TarayÄ±cÄ± toplam 500 MB - 1 GB cache limiti koyabilir</li>
                <li><strong>Clear Cache:</strong> KullanÄ±cÄ± "TarayÄ±cÄ± geÃ§miÅŸini temizle" yapÄ±nca cache silinir</li>
                <li><strong>Private Mode:</strong> Gizli sekmede cache kalÄ±cÄ± deÄŸil</li>
                <li><strong>Browser Support:</strong> Service Worker tÃ¼m eski tarayÄ±cÄ±larda Ã§alÄ±ÅŸmaz (IE11 yok)</li>
            </ul>
        </div>

        <h2>ğŸš€ Ä°leri Seviye - Encrypted Media Extensions (EME)</h2>

        <div class="info">
            <p><strong>Spotify/Apple Music seviyesi koruma iÃ§in:</strong></p>
            <ul>
                <li>HLS stream'leri AES-128 ile ÅŸifrele</li>
                <li>Decryption key'i backend'den session token ile al</li>
                <li>Video.js veya Shaka Player kullan (EME desteÄŸi)</li>
                <li>Key rotation: Her 15 dakikada key deÄŸiÅŸtir</li>
            </ul>
            <p><strong>Dikkat:</strong> Kompleks implementasyon, CDN desteÄŸi gerektirir!</p>
        </div>

        <p style="margin-top: 40px; text-align: center; color: #64748b;">
            <a href="index.html" class="back">â† TÃ¼m Ã–zelliklere DÃ¶n</a>
        </p>
    </div>
</body>
</html>
