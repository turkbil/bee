<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muzibu HLS Segment 404 HatasÄ± - DetaylÄ± Analiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="px-3 py-1 bg-red-900/30 text-red-300 border border-red-800 rounded-md text-sm">ğŸ”´ Bug Analizi</span>
                <span class="px-3 py-1 bg-purple-900/30 text-purple-300 border border-purple-800 rounded-md text-sm">HLS Streaming</span>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">Muzibu HLS Segment 404 HatasÄ±</h1>
            <p class="text-slate-400">MÃ¼zik dinlerken segment dosyalarÄ±nÄ±n yanlÄ±ÅŸ URL pattern ile Ã§aÄŸrÄ±lmasÄ± sorunu</p>
            <p class="text-slate-500 text-sm mt-2">10 Ocak 2026 - DetaylÄ± Sistem Analizi</p>
        </header>

        <!-- Basit AnlatÄ±m -->
        <div class="bg-green-900/20 border border-green-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-green-300 mb-4">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h2>
            <div class="space-y-3 text-slate-200">
                <p><strong>Sorun:</strong> MÃ¼zik Ã§alarken bazen ÅŸarkÄ± dosyalarÄ± yanlÄ±ÅŸ adresten aranÄ±yor ve bulunamÄ±yor.</p>
                <p><strong>Ã–rnek:</strong> Player "/api/muzibu/songs/123/segment-000.ts" diye arÄ±yor, ama dosya "/hls/muzibu/songs/123/segment-000.ts" adresinde.</p>
                <p><strong>SonuÃ§:</strong> Bazen ÅŸarkÄ±lar takÄ±labiliyor veya atlanabiliyor.</p>
                <p><strong>Neden Ã–nemli:</strong> KullanÄ±cÄ± deneyimi bozuluyor, ÅŸarkÄ± akÄ±ÅŸÄ± kesintiye uÄŸruyor.</p>
                <p><strong>8 farklÄ± ÅŸarkÄ±da tespit edildi.</strong></p>
            </div>
        </div>

        <!-- Teknik Detaylar -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h2>

            <h3 class="text-xl font-bold text-blue-200 mb-3 mt-6">ğŸ“Š Hata LoglarÄ±:</h3>
            <div class="bg-slate-950 rounded-lg p-4 mb-4 font-mono text-sm overflow-x-auto">
<pre class="text-red-300">GET /api/muzibu/songs/28745/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/28704/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/28698/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/22187/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/28765/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/28773/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/11985/segment-000.ts HTTP/2" 404
GET /api/muzibu/songs/28741/segment-000.ts HTTP/2" 404</pre>
            </div>

            <h3 class="text-xl font-bold text-blue-200 mb-3 mt-6">âœ… DoÄŸru URL Pattern:</h3>
            <div class="bg-green-950 rounded-lg p-4 mb-4 font-mono text-sm">
                <p class="text-green-300">GET /hls/muzibu/songs/31118/segment-000.ts?expires=1767993687&token=3&sig=... HTTP/2" 200</p>
            </div>

            <h3 class="text-xl font-bold text-blue-200 mb-3 mt-6">ğŸ¯ Sistem Mimarisi:</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-yellow-300 mb-2">Backend (Laravel)</p>
                    <ul class="text-sm space-y-1 text-slate-300">
                        <li>â€¢ SignedUrlService: HLS URL Ã¼retimi</li>
                        <li>â€¢ SongStreamController: Stream endpoint</li>
                        <li>â€¢ MuzibuServiceProvider: Route tanÄ±mlarÄ±</li>
                        <li>â€¢ ConvertToHLSJob: FFmpeg conversion</li>
                    </ul>
                </div>
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-purple-300 mb-2">Frontend (JavaScript)</p>
                    <ul class="text-sm space-y-1 text-slate-300">
                        <li>â€¢ player-core.js: Ana player modÃ¼lÃ¼</li>
                        <li>â€¢ HLS.js: HLS streaming library</li>
                        <li>â€¢ createHlsBlobUrl(): Blob URL converter</li>
                        <li>â€¢ playHlsStream(): HLS yÃ¼kleme fonksiyonu</li>
                    </ul>
                </div>
            </div>

            <h3 class="text-xl font-bold text-blue-200 mb-3 mt-6">ğŸ“ Etkilenen Dosyalar:</h3>
            <div class="space-y-2 text-sm">
                <div class="bg-slate-800 rounded p-3">
                    <p class="font-bold text-white mb-1">public/themes/muzibu/js/player/core/player-core.js</p>
                    <p class="text-slate-400">â€¢ Line 109-151: <code>createHlsBlobUrl()</code> - Blob URL conversion</p>
                    <p class="text-slate-400">â€¢ Line 3350-4069: <code>playSongFromQueue()</code> - Ana play fonksiyonu</p>
                    <p class="text-slate-400">â€¢ Line 4069-4117: <code>loadAndPlaySong()</code> - Stream loader</p>
                    <p class="text-slate-400">â€¢ Line 4279-4650: <code>playHlsStream()</code> - HLS player</p>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <p class="font-bold text-white mb-1">app/Services/SignedUrlService.php</p>
                    <p class="text-slate-400">â€¢ Line 52-72: <code>generateHlsUrl()</code> - HLS URL generator âœ… DOÄRU</p>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <p class="font-bold text-white mb-1">Modules/Muzibu/Providers/MuzibuServiceProvider.php</p>
                    <p class="text-slate-400">â€¢ Line 305-317: HLS files route tanÄ±mÄ± âœ… DOÄRU</p>
                </div>
                <div class="bg-slate-800 rounded p-3">
                    <p class="font-bold text-white mb-1">Modules/Muzibu/app/Jobs/ConvertToHLSJob.php</p>
                    <p class="text-slate-400">â€¢ Line 79-122: FFmpeg HLS conversion âœ… DOÄRU</p>
                </div>
            </div>
        </div>

        <!-- Sorun Analizi -->
        <div class="bg-red-900/20 border border-red-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-red-300 mb-4">ğŸ” Sorun Analizi</h2>

            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-bold text-red-200 mb-3">1ï¸âƒ£ Backend URL Generation (âœ… DOÄRU)</h3>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-green-300">// SignedUrlService.php (Line 62)
$basePath = "/hls/muzibu/songs/{$songId}/playlist.m3u8";

// OluÅŸturulan URL:
https://muzibu.com.tr/hls/muzibu/songs/123/playlist.m3u8?expires=...&token=...&sig=...</pre>
                    </div>
                    <p class="text-slate-300 mt-2">âœ… Backend doÄŸru <code>/hls/</code> prefix'i ile URL Ã¼retiyor.</p>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-red-200 mb-3">2ï¸âƒ£ Route Definition (âœ… DOÄRU)</h3>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-green-300">// MuzibuServiceProvider.php (Line 315)
Route::match(['get', 'options'], '/hls/muzibu/songs/{id}/{filename}', ...)
    ->where('filename', 'playlist\.m3u8|segment-\d+\.ts');</pre>
                    </div>
                    <p class="text-slate-300 mt-2">âœ… Route doÄŸru <code>/hls/</code> pattern ile tanÄ±mlanmÄ±ÅŸ.</p>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-red-200 mb-3">3ï¸âƒ£ Playlist.m3u8 Ä°Ã§eriÄŸi (âœ… DOÄRU)</h3>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-green-300">#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXTINF:10.005333,
segment-000.ts    <-- Relative path (DOÄRU!)
#EXTINF:9.994667,
segment-001.ts
...</pre>
                    </div>
                    <p class="text-slate-300 mt-2">âœ… Segment path'leri relative olarak yazÄ±lmÄ±ÅŸ (doÄŸru).</p>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-red-200 mb-3">4ï¸âƒ£ JavaScript Blob URL Conversion (âš ï¸ SORUN BURDA!)</h3>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-yellow-300">// player-core.js (Line 119-133)
async function createHlsBlobUrl(originalUrl) {
    // 1. m3u8 iÃ§eriÄŸini fetch et
    const response = await fetch(originalUrl);
    let m3u8Content = await response.text();

    // 2. Base URL'yi Ã§Ä±kar (segment'ler iÃ§in)
    const urlObj = new URL(originalUrl);
    const baseUrl = urlObj.origin + urlObj.pathname.substring(0, urlObj.pathname.lastIndexOf('/') + 1);
    const queryString = urlObj.search; // ?token=...&expires=...&sig=...

    // 3. Relative segment URL'lerini absolute yap
    m3u8Content = m3u8Content.replace(
        /(segment-\d+\.ts)(\?[^\s\n]*)?/g,
        (match, segment, query) => {
            const finalQuery = query || queryString;
            return baseUrl + segment + finalQuery;  // âš ï¸ SORUN BURDA!
        }
    );
}</pre>
                    </div>
                    <p class="text-red-300 mt-3 font-bold">âŒ SORUN: <code>baseUrl</code> deÄŸiÅŸkeni <code>originalUrl</code> parametresinden Ã§Ä±karÄ±lÄ±yor.</p>

                    <div class="mt-4 p-4 bg-red-950 rounded-lg">
                        <p class="font-bold text-red-200 mb-2">Senaryo 1: DoÄŸru URL gelirse âœ…</p>
                        <div class="bg-slate-950 rounded p-3 font-mono text-xs">
<pre class="text-green-300">originalUrl = "/hls/muzibu/songs/123/playlist.m3u8?token=..."
baseUrl = "https://muzibu.com.tr/hls/muzibu/songs/123/"
Segment URL = "https://muzibu.com.tr/hls/muzibu/songs/123/segment-000.ts?..." âœ… 200 OK</pre>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-red-950 rounded-lg">
                        <p class="font-bold text-red-200 mb-2">Senaryo 2: YanlÄ±ÅŸ URL gelirse âŒ</p>
                        <div class="bg-slate-950 rounded p-3 font-mono text-xs">
<pre class="text-red-300">originalUrl = "/api/muzibu/songs/123/playlist.m3u8?..." (YANLIÅ!)
baseUrl = "https://muzibu.com.tr/api/muzibu/songs/123/"
Segment URL = "https://muzibu.com.tr/api/muzibu/songs/123/segment-000.ts?..." âŒ 404 NOT FOUND</pre>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-red-200 mb-3">5ï¸âƒ£ Neden YanlÄ±ÅŸ URL Geliyor?</h3>
                    <div class="space-y-3 text-slate-300">
                        <div class="bg-yellow-950 border border-yellow-800 rounded-lg p-4">
                            <p class="font-bold text-yellow-300 mb-2">OlasÄ± Neden 1: Cache'de Eski URL</p>
                            <p class="text-sm">Player stream URL'lerini cache'liyor. Cache'de eski <code>/api/</code> prefix'li URL kalÄ±yor olabilir.</p>
                        </div>
                        <div class="bg-yellow-950 border border-yellow-800 rounded-lg p-4">
                            <p class="font-bold text-yellow-300 mb-2">OlasÄ± Neden 2: Refresh URL Fonksiyonu</p>
                            <p class="text-sm">HLS URL refresh mekanizmasÄ± eski URL pattern kullanÄ±yor olabilir.</p>
                        </div>
                        <div class="bg-yellow-950 border border-yellow-800 rounded-lg p-4">
                            <p class="font-bold text-yellow-300 mb-2">OlasÄ± Neden 3: Fallback MekanizmasÄ±</p>
                            <p class="text-sm">HLS hata verince fallback URL eski pattern ile deniyor olabilir.</p>
                        </div>
                        <div class="bg-yellow-950 border border-yellow-800 rounded-lg p-4">
                            <p class="font-bold text-yellow-300 mb-2">OlasÄ± Neden 4: Preload/Crossfade Path</p>
                            <p class="text-sm">Preload veya crossfade sÄ±rasÄ±nda eski cached URL kullanÄ±lÄ±yor olabilir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ã‡Ã¶zÃ¼m Ã–nerileri -->
        <div class="bg-green-900/20 border border-green-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-green-300 mb-4">ğŸ’¡ Ã‡Ã¶zÃ¼m Ã–nerileri</h2>

            <div class="space-y-6">
                <div class="bg-slate-800 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-green-300 mb-3">âœ… Ã‡Ã¶zÃ¼m 1: URL Validation (Ã–ncelikli)</h3>
                    <p class="text-slate-300 mb-3">createHlsBlobUrl() fonksiyonuna URL validation ekle, <code>/api/</code> prefix'ini <code>/hls/</code> ile deÄŸiÅŸtir.</p>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-green-300">async function createHlsBlobUrl(originalUrl) {
    // âš ï¸ URL FIX: /api/ prefix'ini /hls/ ile deÄŸiÅŸtir
    let fixedUrl = originalUrl;
    if (fixedUrl.includes('/api/muzibu/songs/')) {
        fixedUrl = fixedUrl.replace('/api/muzibu/songs/', '/hls/muzibu/songs/');
        console.warn('ğŸ”§ URL FIX: /api/ â†’ /hls/', originalUrl);
    }

    const response = await fetch(fixedUrl);
    // ... rest of the code
}</pre>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-yellow-300 mb-3">âš¡ Ã‡Ã¶zÃ¼m 2: Cache Temizleme</h3>
                    <p class="text-slate-300 mb-3">Stream URL cache'ini temizle, eski URL'leri kullanÄ±mdan kaldÄ±r.</p>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-yellow-300">// player-core.js iÃ§inde cache clear
clearStreamCache() {
    // LocalStorage/SessionStorage cache temizleme
    Object.keys(localStorage).forEach(key => {
        if (key.includes('stream_cache_')) {
            localStorage.removeItem(key);
        }
    });
}</pre>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-blue-300 mb-3">ğŸ” Ã‡Ã¶zÃ¼m 3: Debug Logging</h3>
                    <p class="text-slate-300 mb-3">Player'a detaylÄ± logging ekle, hangi URL'in nereden geldiÄŸini takip et.</p>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-blue-300">async function createHlsBlobUrl(originalUrl) {
    console.log('ğŸµ HLS Blob URL Creation:', {
        originalUrl: originalUrl,
        hasApiPrefix: originalUrl.includes('/api/'),
        hasHlsPrefix: originalUrl.includes('/hls/'),
        timestamp: new Date().toISOString()
    });

    // Server'a da log gÃ¶nder (debug iÃ§in)
    serverLog('hlsBlobUrlCreated', { url: originalUrl });
}</pre>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-purple-300 mb-3">ğŸ›¡ï¸ Ã‡Ã¶zÃ¼m 4: Route Fallback (Son Ã‡are)</h3>
                    <p class="text-slate-300 mb-3">Backend'e <code>/api/muzibu/songs/{id}/segment-*.ts</code> route'u ekle, doÄŸru yere redirect et.</p>
                    <div class="bg-slate-950 rounded-lg p-4 font-mono text-sm">
<pre class="text-purple-300">// MuzibuServiceProvider.php
// Eski URL'leri yeni URL'e redirect et (backward compatibility)
Route::get('/api/muzibu/songs/{id}/segment-{segment}.ts', function($id, $segment) {
    return redirect("/hls/muzibu/songs/{$id}/segment-{$segment}.ts?" . request()->getQueryString());
})->where('segment', '\d+');</pre>
                    </div>
                    <p class="text-yellow-300 text-sm mt-2">âš ï¸ Bu geÃ§ici bir Ã§Ã¶zÃ¼m! AsÄ±l sorun player'da dÃ¼zeltilmeli.</p>
                </div>
            </div>
        </div>

        <!-- Test PlanÄ± -->
        <div class="bg-purple-900/20 border border-purple-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">ğŸ§ª Test PlanÄ±</h2>

            <div class="space-y-4">
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-white mb-2">1ï¸âƒ£ Hata TekrarÄ±</p>
                    <p class="text-slate-300 text-sm">â€¢ Loglardan etkilenen ÅŸarkÄ±lardan birini Ã§al (song_id: 28745, 28704, vb.)</p>
                    <p class="text-slate-300 text-sm">â€¢ Browser DevTools Network tab'Ä±nda <code>/api/muzibu/songs/</code> isteÄŸi var mÄ± kontrol et</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-white mb-2">2ï¸âƒ£ URL Validation Testi</p>
                    <p class="text-slate-300 text-sm">â€¢ Ã‡Ã¶zÃ¼m 1'i uygula, aynÄ± ÅŸarkÄ±yÄ± tekrar Ã§al</p>
                    <p class="text-slate-300 text-sm">â€¢ Console'da "URL FIX" warning'i gÃ¶rÃ¼nmeli</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-white mb-2">3ï¸âƒ£ Segment Ä°stekleri</p>
                    <p class="text-slate-300 text-sm">â€¢ Network tab'da segment istekleri <code>/hls/muzibu/songs/</code> ile baÅŸlamalÄ±</p>
                    <p class="text-slate-300 text-sm">â€¢ TÃ¼m segment istekleri 200 OK dÃ¶nmeli</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-white mb-2">4ï¸âƒ£ Cache Temizleme</p>
                    <p class="text-slate-300 text-sm">â€¢ Browser'da Ctrl+Shift+Delete â†’ Cache temizle</p>
                    <p class="text-slate-300 text-sm">â€¢ TÃ¼m ÅŸarkÄ±larÄ± baÅŸtan yÃ¼klet, hiÃ§birinde <code>/api/</code> prefix olmamalÄ±</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-4">
                    <p class="font-bold text-white mb-2">5ï¸âƒ£ Production Test</p>
                    <p class="text-slate-300 text-sm">â€¢ DÃ¼zeltme sonrasÄ± 24 saat access log'larÄ± takip et</p>
                    <p class="text-slate-300 text-sm">â€¢ <code>grep "segment-.*404" access_log</code> â†’ 0 sonuÃ§ olmalÄ±</p>
                </div>
            </div>
        </div>

        <!-- Etkilenen ÅarkÄ±lar -->
        <div class="bg-orange-900/20 border border-orange-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-orange-300 mb-4">ğŸµ Etkilenen ÅarkÄ±lar</h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28745</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28704</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28698</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 22187</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28765</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28773</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 11985</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
                <div class="bg-slate-800 rounded p-3 text-center">
                    <p class="font-bold text-white">Song ID: 28741</p>
                    <p class="text-xs text-slate-400 mt-1">10 Ocak 2026</p>
                </div>
            </div>

            <p class="text-slate-400 text-sm mt-4">Toplam 8 ÅŸarkÄ±da 404 hatasÄ± tespit edildi. Bu ÅŸarkÄ±lar cache temizleme sonrasÄ± test edilmeli.</p>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-slate-800 text-center text-slate-500 text-sm">
            <p>ğŸ¤– Claude AI TarafÄ±ndan DetaylÄ± Sistem Analizi ile OluÅŸturuldu</p>
            <p class="mt-2">Muzibu MÃ¼zik Platformu - HLS Streaming Diagnostics</p>
        </footer>
    </div>
</body>
</html>
