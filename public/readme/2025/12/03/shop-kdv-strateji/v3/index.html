<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop KDV Stratejisi v3 FINAL - Runtime Hesaplama + Livewire Auto-Calculate + 2 Settings</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid #334155; }
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .final-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-left: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .meta { color: #94a3b8; font-size: 0.95rem; }
        section { margin-bottom: 50px; }
        h2 { font-size: 1.8rem; margin-bottom: 25px; color: #10b981; }
        h3 { font-size: 1.4rem; margin: 25px 0 15px; color: #34d399; }
        .highlight-box {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid #10b981;
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
        }
        .highlight-box h4 { color: #10b981; margin-bottom: 15px; font-size: 1.3rem; }
        .code-box {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        .setting-card {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid #f59e0b;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .setting-card h4 { color: #fbbf24; margin-bottom: 12px; font-size: 1.2rem; }
        .flow-diagram {
            background: rgba(30, 41, 59, 0.3);
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
            border: 2px dashed #475569;
        }
        .flow-step {
            background: rgba(16, 185, 129, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        ul { margin-left: 25px; margin-top: 10px; }
        li { margin: 8px 0; }
        .code-inline {
            background: rgba(16, 185, 129, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #34d399;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .comparison-card {
            background: rgba(30, 41, 59, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #334155;
        }
        .comparison-card h4 { color: #34d399; margin-bottom: 15px; font-size: 1.2rem; }
        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›’ Shop KDV Stratejisi <span class="final-badge">v3 FINAL âœ“</span></h1>
            <div class="meta">
                ğŸ“… 2025-12-03 | âš¡ Runtime Hesaplama + Livewire Auto-Calculate + 2 Settings | ğŸ¢ iXtif
            </div>
        </header>

        <section>
            <h2>ğŸ¯ v3 FINAL Strateji</h2>

            <div class="highlight-box">
                <h4>âœ… Database: Sadece Kaynak Veri (price_without_tax + tax_rate)</h4>
                <ul>
                    <li>âœ… <strong>price_without_tax:</strong> 1.000 TL (KDV hariÃ§ - kaynak veri)</li>
                    <li>âœ… <strong>tax_rate:</strong> 20% (KDV oranÄ±)</li>
                    <li>âœ… <strong>price_with_tax:</strong> ACCESSOR (runtime hesaplama)</li>
                </ul>
                <div class="code-box">
// ShopProduct Model<br>
public function getPriceWithTaxAttribute() {<br>
    return $this->price_without_tax * (1 + $this->tax_rate / 100);<br>
}<br><br>
// KullanÄ±m:<br>
$product->price_with_tax  // 1200 TL (otomatik hesaplanÄ±r)
                </div>
            </div>

            <div class="highlight-box">
                <h4>âš™ï¸ 2 Settings (Settings Management)</h4>
                <ol>
                    <li><strong>admin_price_input_mode:</strong> Admin varsayÄ±lan ne girsin? (with_tax / without_tax)</li>
                    <li><strong>product_price_display:</strong> Frontend nasÄ±l gÃ¶stersin? (with_tax / without_tax)</li>
                </ol>
            </div>

            <div class="highlight-box">
                <h4>ğŸ”¥ Admin Panel: Livewire ile AnlÄ±k Hesaplama!</h4>
                <p>Admin fiyat girerken, sistem otomatik diÄŸer fiyatÄ± hesaplar.</p>
            </div>
        </section>

        <section>
            <h2>âš™ï¸ Settings Management - 2 Ayar</h2>

            <div class="setting-card">
                <h4>Setting 1: admin_price_input_mode</h4>
                <p><strong>AmaÃ§:</strong> Admin panelde varsayÄ±lan olarak hangi fiyat girilsin?</p>
                <div class="code-box">
Key: admin_price_input_mode<br>
Type: select<br>
Options:<br>
  - with_tax (KDV Dahil Girerim - B2C iÃ§in)<br>
  - without_tax (KDV HariÃ§ Girerim - B2B iÃ§in)<br>
Default: without_tax<br><br>
Group: Product Management<br>
Label: "Fiyat GiriÅŸi VarsayÄ±lan Modu"
                </div>
            </div>

            <div class="setting-card">
                <h4>Setting 2: product_price_display</h4>
                <p><strong>AmaÃ§:</strong> Frontend'de Ã¼rÃ¼n kartlarÄ±nda fiyat nasÄ±l gÃ¶sterilsin?</p>
                <div class="code-box">
Key: product_price_display<br>
Type: select<br>
Options:<br>
  - with_tax (KDV Dahil GÃ¶ster - B2C iÃ§in)<br>
  - without_tax (KDV HariÃ§ GÃ¶ster - B2B iÃ§in)<br>
Default: with_tax<br><br>
Group: Frontend Display<br>
Label: "ÃœrÃ¼n KartlarÄ±nda Fiyat GÃ¶sterimi"
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ‘¨â€ğŸ’¼ Admin Panel - Livewire AnlÄ±k Hesaplama</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <strong>1. Setting Kontrol Et</strong><br>
                    admin_price_input_mode = "without_tax" (Ã¶rnek)
                </div>

                <div class="flow-step">
                    <strong>2. Form GÃ¶ster</strong><br>
                    Primary Input: "KDV HariÃ§ Fiyat" (1000 TL)<br>
                    Info Display: "KDV Dahil: 1200 TL" (disabled, info amaÃ§lÄ±)
                </div>

                <div class="flow-step">
                    <strong>3. Admin DeÄŸiÅŸiklik YaptÄ±kÃ§a Hesapla (Livewire)</strong><br>
                    wire:model.live="priceWithoutTax" â†’ DeÄŸiÅŸince hesapla()<br>
                    System: priceWithTax = priceWithoutTax * 1.20
                </div>
            </div>

            <div class="comparison-grid">
                <div class="comparison-card">
                    <h4>Mod 1: without_tax (B2B)</h4>
                    <div class="code-box">
&lt;!-- Primary Input --&gt;<br>
&lt;label&gt;KDV HariÃ§ Fiyat&lt;/label&gt;<br>
&lt;input wire:model.live="priceWithoutTax"&gt;<br><br>

&lt;label&gt;KDV OranÄ±&lt;/label&gt;<br>
&lt;select wire:model.live="taxRate"&gt;<br>
  &lt;option value="20"&gt;%20&lt;/option&gt;<br>
&lt;/select&gt;<br><br>

&lt;!-- Info Display --&gt;<br>
&lt;label&gt;KDV Dahil (Hesaplanan)&lt;/label&gt;<br>
&lt;input value="{{ $priceWithTax }}" disabled&gt;
                    </div>
                </div>

                <div class="comparison-card">
                    <h4>Mod 2: with_tax (B2C)</h4>
                    <div class="code-box">
&lt;!-- Primary Input --&gt;<br>
&lt;label&gt;KDV Dahil Fiyat&lt;/label&gt;<br>
&lt;input wire:model.live="priceWithTax"&gt;<br><br>

&lt;label&gt;KDV OranÄ±&lt;/label&gt;<br>
&lt;select wire:model.live="taxRate"&gt;<br>
  &lt;option value="20"&gt;%20&lt;/option&gt;<br>
&lt;/select&gt;<br><br>

&lt;!-- Info Display --&gt;<br>
&lt;label&gt;KDV HariÃ§ (Hesaplanan)&lt;/label&gt;<br>
&lt;input value="{{ $priceWithoutTax }}" disabled&gt;
                    </div>
                </div>
            </div>

            <h3>Livewire Component</h3>
            <div class="code-box">
class ProductManageComponent extends Component<br>
{<br>
    public $priceWithoutTax;<br>
    public $priceWithTax;<br>
    public $taxRate = 20;<br><br>

    public function mount() {<br>
        $this->inputMode = setting('admin_price_input_mode', 'without_tax');<br>
    }<br><br>

    public function updatedPriceWithoutTax() {<br>
        // KDV hariÃ§ deÄŸiÅŸince â†’ KDV dahil hesapla<br>
        $this->priceWithTax = $this->priceWithoutTax * (1 + $this->taxRate / 100);<br>
    }<br><br>

    public function updatedPriceWithTax() {<br>
        // KDV dahil deÄŸiÅŸince â†’ KDV hariÃ§ hesapla<br>
        $this->priceWithoutTax = $this->priceWithTax / (1 + $this->taxRate / 100);<br>
    }<br><br>

    public function updatedTaxRate() {<br>
        // KDV oranÄ± deÄŸiÅŸince â†’ SeÃ§ili moda gÃ¶re yeniden hesapla<br>
        if ($this->inputMode === 'without_tax') {<br>
            $this->updatedPriceWithoutTax();<br>
        } else {<br>
            $this->updatedPriceWithTax();<br>
        }<br>
    }<br><br>

    public function save() {<br>
        // Database'e SADECE price_without_tax + tax_rate kaydet!<br>
        $this->product->update([<br>
            'price_without_tax' => $this->priceWithoutTax,<br>
            'tax_rate' => $this->taxRate,<br>
        ]);<br>
    }<br>
}
            </div>
        </section>

        <section>
            <h2>ğŸ—„ï¸ Database Migration</h2>

            <div class="highlight-box">
                <h4>Sadece 1 Alan Ekle!</h4>
                <div class="code-box">
// shop_products tablosuna:<br><br>

$table->decimal('price_without_tax', 12, 2)<br>
      ->nullable()<br>
      ->after('base_price')<br>
      ->comment('KDV hariÃ§ fiyat (kaynak veri)');<br><br>

// tax_rate zaten var (mevcut alan)<br>
// price_with_tax ekleme! (accessor ile hesaplanÄ±r)
                </div>
                <p style="margin-top: 15px; color: #34d399;">
                    âœ… <strong>price_with_tax alanÄ± database'e eklenmeyecek!</strong> Accessor ile runtime hesaplanÄ±r.
                </p>
            </div>
        </section>

        <section>
            <h2>ğŸ¨ Frontend - Fiyat GÃ¶sterimi</h2>

            <div class="code-box">
// ÃœrÃ¼n kartÄ±nda (component, blade)<br>
@php<br>
    $displayMode = setting('product_price_display', 'with_tax');<br>
@endphp<br><br>

@if($displayMode === 'with_tax')<br>
    &lt;span class="price"&gt;{{ number_format($product->price_with_tax, 2) }} TL&lt;/span&gt;<br>
    &lt;span class="tax-info"&gt;(KDV Dahil)&lt;/span&gt;<br>
@else<br>
    &lt;span class="price"&gt;{{ number_format($product->price_without_tax, 2) }} TL&lt;/span&gt;<br>
    &lt;span class="tax-info"&gt;+ KDV&lt;/span&gt;<br>
@endif
            </div>

            <div class="highlight-box">
                <h4>ğŸ›’ Cart + Checkout: HER ZAMAN KDV Dahil!</h4>
                <div class="code-box">
// Sepet ve Checkout sayfalarÄ±nda Settings'e bakma!<br>
// DAIMA price_with_tax kullan:<br><br>

Ara Toplam (KDV HariÃ§): {{ $cart->subtotal }} TL<br>
KDV ({{ $cart->taxRate }}%): {{ $cart->taxAmount }} TL<br>
---------------------------------------------<br>
Toplam (KDV Dahil): {{ $cart->total }} TL
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ›ï¸ CartService - GÃ¼ncelleme</h2>

            <div class="code-box">
protected function setPricing(CartItem $cartItem, $item, array $options = []): void<br>
{<br>
    // Database'den direkt al (hesaplamaya gerek yok!)<br>
    $priceWithoutTax = $item->price_without_tax ?? 0;<br>
    $taxRate = $item->tax_rate ?? 20.0;<br><br>

    // price_with_tax accessor ile otomatik hesaplanÄ±r<br>
    $priceWithTax = $item->price_with_tax;  // Accessor Ã§aÄŸrÄ±sÄ±<br>
    $taxAmount = $priceWithTax - $priceWithoutTax;<br><br>

    // CartItem'a kaydet<br>
    $cartItem->unit_price = $priceWithoutTax;<br>
    $cartItem->tax_rate = $taxRate;<br>
    $cartItem->tax_amount = $taxAmount;<br>
    $cartItem->final_price = $priceWithTax;<br>
    $cartItem->quantity = $quantity;<br><br>

    // Toplam<br>
    $cartItem->subtotal = $priceWithoutTax * $quantity;<br>
    $cartItem->total = $priceWithTax * $quantity;<br>
}
            </div>
        </section>

        <section>
            <h2>ğŸ”„ KDV OranÄ± DeÄŸiÅŸirse Ne Olur?</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <strong>Senaryo: KDV %20'den %25'e Ã‡Ä±ktÄ±</strong><br>
                    Devlet KDV oranÄ±nÄ± artÄ±rdÄ±
                </div>

                <div class="flow-step">
                    <strong>Admin Panel: Toplu GÃ¼ncelleme</strong><br>
                    TÃ¼m Ã¼rÃ¼nlerin tax_rate'ini %20 â†’ %25 yap
                </div>

                <div class="flow-step">
                    <strong>Otomatik YansÄ±r!</strong><br>
                    price_with_tax accessor'u yeni oranla hesaplar:<br>
                    1000 * 1.25 = 1250 TL
                </div>

                <div class="flow-step">
                    <strong>KullanÄ±cÄ± Yeni FiyatÄ± GÃ¶rÃ¼r</strong><br>
                    HiÃ§bir kod deÄŸiÅŸikliÄŸi gerekmez!
                </div>
            </div>

            <div class="highlight-box">
                <h4>âœ… Avantajlar</h4>
                <ul>
                    <li>âœ… KDV oranÄ± deÄŸiÅŸince otomatik gÃ¼ncellenir</li>
                    <li>âœ… Database'de sadece kaynak veri (price_without_tax + tax_rate)</li>
                    <li>âœ… Her zaman tutarlÄ± fiyat</li>
                    <li>âœ… Manuel gÃ¼ncelleme gerekmez</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>ğŸ’³ Subscription - AynÄ± MantÄ±k</h2>

            <div class="code-box">
// billing_cycles yapÄ±sÄ±:<br>
"billing_cycles": {<br>
    "monthly": {<br>
        "name": {"tr": "1 AylÄ±k"},<br>
        "duration_months": 1,<br>
        "price_without_tax": 166.58,  // Kaynak veri<br>
        "tax_rate": 20.00              // KDV oranÄ±<br>
        // price_with_tax YOK! Accessor ile hesaplanÄ±r<br>
    }<br>
}<br><br>

// SubscriptionPlan Model:<br>
public function getCyclePriceWithTax(string $cycle): float {<br>
    $cycleData = $this->billing_cycles[$cycle] ?? [];<br>
    $priceWithoutTax = $cycleData['price_without_tax'] ?? 0;<br>
    $taxRate = $cycleData['tax_rate'] ?? 20;<br>
    return $priceWithoutTax * (1 + $taxRate / 100);<br>
}
            </div>
        </section>

        <section>
            <h2>âœ… Ã–zet - AdÄ±m AdÄ±m</h2>

            <div class="flow-diagram">
                <div class="flow-step"><strong>1.</strong> Migration: price_without_tax ekle</div>
                <div class="flow-step"><strong>2.</strong> ShopProduct: getPriceWithTaxAttribute() accessor ekle</div>
                <div class="flow-step"><strong>3.</strong> Settings: 2 ayar ekle (admin_price_input_mode + product_price_display)</div>
                <div class="flow-step"><strong>4.</strong> Admin Panel: Livewire anlÄ±k hesaplama ekle</div>
                <div class="flow-step"><strong>5.</strong> Frontend: Settings'e gÃ¶re fiyat gÃ¶ster</div>
                <div class="flow-step"><strong>6.</strong> Cart: HER ZAMAN price_with_tax</div>
                <div class="flow-step"><strong>7.</strong> Subscription: AynÄ± mantÄ±ÄŸÄ± uygula</div>
            </div>
        </section>

        <section>
            <h2>ğŸ¯ SonuÃ§</h2>

            <div class="highlight-box">
                <h4>v3 FINAL AvantajlarÄ±</h4>
                <ul>
                    <li>âœ… <strong>Runtime hesaplama:</strong> KDV oranÄ± deÄŸiÅŸince otomatik gÃ¼ncellenir</li>
                    <li>âœ… <strong>Livewire auto-calculate:</strong> Admin anlÄ±k sonuÃ§ gÃ¶rÃ¼r</li>
                    <li>âœ… <strong>2 Settings:</strong> Esneklik (admin giriÅŸ + frontend gÃ¶sterim)</li>
                    <li>âœ… <strong>Temiz database:</strong> Sadece kaynak veri (price_without_tax + tax_rate)</li>
                    <li>âœ… <strong>Universal:</strong> Shop + Subscription aynÄ± mantÄ±k</li>
                    <li>âœ… <strong>TutarlÄ±lÄ±k garantili:</strong> Her zaman doÄŸru hesaplama</li>
                </ul>
            </div>
        </section>

        <footer>
            ğŸ¤– Claude AI - 2025-12-03 | v3 FINAL âœ“
        </footer>
    </div>
</body>
</html>
