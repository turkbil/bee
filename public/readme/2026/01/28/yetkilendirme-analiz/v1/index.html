<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root ve Normal KullanÄ±cÄ± Yetkilendirme Sistemi Analizi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
        .badge-root { background: #dc2626; color: white; }
        .badge-admin { background: #f59e0b; color: white; }
        .badge-editor { background: #3b82f6; color: white; }
        .section-card { background: #1e293b; border-left: 4px solid #667eea; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ” Root ve Normal KullanÄ±cÄ± Yetkilendirme Sistemi</h1>
            <p class="text-slate-200">Muzibu.com Multi-Tenant SaaS Platformu - KapsamlÄ± Yetkilendirme Analizi</p>
            <div class="flex gap-3 mt-4">
                <span class="badge badge-root">ROOT</span>
                <span class="badge badge-admin">ADMIN</span>
                <span class="badge badge-editor">EDITOR</span>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-12">

        <!-- Ã–zet BÃ¶lÃ¼mÃ¼ -->
        <div class="bg-slate-800 rounded-lg p-8 mb-8 border-l-4 border-purple-500">
            <h2 class="text-2xl font-bold mb-4 text-purple-400">ğŸ“‹ Sistem Ã–zeti</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-red-400">3</div>
                    <div class="text-slate-300">Rol Seviyesi</div>
                    <div class="text-sm text-slate-400 mt-1">root, admin, editor</div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-amber-400">4</div>
                    <div class="text-slate-300">Ä°zin Tipi</div>
                    <div class="text-sm text-slate-400 mt-1">view, create, update, delete</div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-blue-400">2</div>
                    <div class="text-slate-300">VeritabanÄ±</div>
                    <div class="text-sm text-slate-400 mt-1">Central + Tenant DB</div>
                </div>
            </div>
        </div>

        <!-- BÃ–LÃœM 1: ROL YAPISI -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">1ï¸âƒ£ Rol YapÄ±sÄ± ve HiyerarÅŸi</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Sistem, kullanÄ±cÄ±larÄ± Ã¼Ã§ ana gruba ayÄ±rÄ±r: <strong>root (sÃ¼per yÃ¶netici)</strong>,
                        <strong>admin (yÃ¶netici)</strong> ve <strong>editor (editÃ¶r)</strong>. Her grubun farklÄ± yetkileri vardÄ±r.
                    </p>

                    <div class="space-y-4">
                        <div class="bg-red-900/30 border-l-4 border-red-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="badge badge-root">ROOT</span>
                                <span class="font-bold text-red-400">Tam Yetkili YÃ¶netici</span>
                            </div>
                            <p class="text-slate-300">
                                <strong>Her ÅŸeyi yapabilir.</strong> Sistemin her yerine eriÅŸebilir, tÃ¼m ayarlarÄ± deÄŸiÅŸtirebilir.
                                Hem merkezi sistemde (central) hem de her mÃ¼ÅŸterinin (tenant) kendi alanÄ±nda tam yetkilidir.
                            </p>
                            <div class="mt-3 text-sm text-slate-400">
                                âœ… TÃ¼m modÃ¼llere eriÅŸim<br>
                                âœ… Debugbar gÃ¶rÃ¼ntÃ¼leme<br>
                                âœ… Kritik sistem ayarlarÄ±<br>
                                âœ… Central ve tenant DB'ye tam eriÅŸim
                            </div>
                        </div>

                        <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="badge badge-admin">ADMIN</span>
                                <span class="font-bold text-amber-400">YÃ¶netici</span>
                            </div>
                            <p class="text-slate-300">
                                <strong>Kendi alanÄ±nda tam yetkili.</strong> Bir mÃ¼ÅŸterinin (tenant) kendi sisteminde her ÅŸeyi yÃ¶netebilir,
                                ancak sadece kendisine atanan modÃ¼lleri kullanabilir. Central sistemde bazÄ± kÄ±sÄ±tlamalarÄ± vardÄ±r.
                            </p>
                            <div class="mt-3 text-sm text-slate-400">
                                âœ… Tenant'a atanan modÃ¼llere tam eriÅŸim<br>
                                âœ… KullanÄ±cÄ± yÃ¶netimi (kendi tenant'Ä±)<br>
                                âœ… Ä°Ã§erik dÃ¼zenleme (kendi tenant'Ä±)<br>
                                âŒ Central'da bazÄ± modÃ¼ller kÄ±sÄ±tlÄ±
                            </div>
                        </div>

                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="badge badge-editor">EDITOR</span>
                                <span class="font-bold text-blue-400">EditÃ¶r</span>
                            </div>
                            <p class="text-slate-300">
                                <strong>SÄ±nÄ±rlÄ± yetkiler.</strong> Sadece kendisine Ã¶zel olarak verilen modÃ¼lleri ve
                                belirli iÅŸlemleri (gÃ¶rÃ¼ntÃ¼leme, ekleme, dÃ¼zenleme, silme) yapabilir. Her modÃ¼l iÃ§in ayrÄ± ayrÄ± izin verilir.
                            </p>
                            <div class="mt-3 text-sm text-slate-400">
                                âœ… Belirli modÃ¼llere Ã¶zel izinler<br>
                                âœ… Ä°zin tipi bazlÄ± eriÅŸim (view/create/update/delete)<br>
                                âŒ Sistem ayarlarÄ±na eriÅŸim yok<br>
                                âŒ KullanÄ±cÄ± yÃ¶netimi yok
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Bu sistem sayesinde her kullanÄ±cÄ± sadece yapmasÄ± gereken iÅŸleri gÃ¶rebilir. Bir editÃ¶rÃ¼n yanlÄ±ÅŸlÄ±kla
                            Ã¶nemli ayarlarÄ± bozmasÄ± veya baÅŸka kullanÄ±cÄ±larÄ±n verilerine eriÅŸmesi engellenir. GÃ¼venlik ve dÃ¼zen saÄŸlanÄ±r.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Rol Modeli</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/UserManagement/App/Models/Role.php

class Role extends SpatieRole {
    const BASE_ROLES = ['root', 'admin', 'editor'];
    const ROLE_TYPES = [
        'root' => 'Tam Yetkili YÃ¶netici',
        'admin' => 'YÃ¶netici',
        'editor' => 'EditÃ¶r'
    ];

    protected $fillable = ['name', 'guard_name', 'is_protected', 'role_type', 'description'];

    public function isRoot(): bool { return $this->role_type === 'root'; }
    public function isAdmin(): bool { return $this->role_type === 'admin'; }
    public function isEditor(): bool { return $this->role_type === 'editor'; }
    public function isDeletable(): bool {
        return !$this->isBaseRole() && !$this->is_protected && $this->users()->count() === 0;
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">User Model Entegrasyonu</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Models/User.php

use Spatie\Permission\Traits\HasRoles;
use Modules\UserManagement\App\Traits\HasModulePermissions;

class User extends Authenticatable {
    use HasRoles, HasModulePermissions;

    protected $guard_name = 'web';

    // Spatie Permission override (global scope bypass)
    public function roles() {
        return $this->morphToMany(Role::class, 'model', 'model_has_roles')
            ->where('roles.guard_name', 'web')
            ->withoutGlobalScopes(); // ğŸ”´ KRÄ°TÄ°K: Multi-tenant iÃ§in
    }

    // Cache-aware rol kontrolÃ¼
    public function hasCachedRole($role): bool {
        return cache()->remember("user_role_{$this->id}_{$role}", 300, fn() => $this->hasRole($role));
    }

    // Rol helper metodlarÄ±
    public function isRoot(): bool { return $this->hasRole('root'); }
    public function isAdmin(): bool { return $this->hasRole('admin'); }
    public function isEditor(): bool { return $this->hasRole('editor'); }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">VeritabanÄ± YapÄ±sÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š roles tablosu (Central + Tenant)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon         â”‚ Tip          â”‚ AÃ§Ä±klama    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id            â”‚ bigint       â”‚ PK          â”‚
â”‚ name          â”‚ varchar(255) â”‚ root/admin  â”‚
â”‚ guard_name    â”‚ varchar(255) â”‚ web         â”‚
â”‚ role_type     â”‚ varchar(50)  â”‚ rol tipi    â”‚
â”‚ is_protected  â”‚ boolean      â”‚ silinemez   â”‚
â”‚ description   â”‚ text         â”‚ aÃ§Ä±klama    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š model_has_roles tablosu (Spatie)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role_id       â”‚ bigint       â”‚ FK roles    â”‚
â”‚ model_type    â”‚ varchar(255) â”‚ App\Models\User â”‚
â”‚ model_id      â”‚ bigint       â”‚ user_id     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Seeder</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ database/seeders/RolePermissionSeeder.php

// Root kullanÄ±cÄ±larÄ± (her tenant + central)
$rootEmails = ['nurullah@nurullah.net', 'info@turkbilisim.com.tr'];

// Central DB
if (isCentral()) {
    createOrUpdateRole('root', 'Tam yetkili sistem yÃ¶neticisi', 'root', true);
    createOrUpdateRole('admin', 'Tenant yÃ¶neticisi', 'admin', true);
    createOrUpdateRole('editor', 'ModÃ¼l bazlÄ± yetkilendirilebilir editÃ¶r', 'editor', true);
}

// Tenant DB
if (isTenant()) {
    // AynÄ± roller tenant DB'ye de eklenir
    Role::create(['name' => 'root', 'role_type' => 'root', 'is_protected' => true]);
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 2: MODÃœL BAZLI YETKÄ°LENDÄ°RME -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">2ï¸âƒ£ ModÃ¼l BazlÄ± Yetkilendirme Sistemi</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Sistem, modÃ¼ler bir yapÄ±ya sahip. Yani her Ã¶zellik (blog, mÃ¼zik, Ã¶deme sistemi gibi) birer <strong>modÃ¼l</strong>dÃ¼r.
                        Her modÃ¼l iÃ§in 4 farklÄ± iÅŸlem izni vardÄ±r:
                    </p>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/30 border-l-4 border-green-500 p-4 rounded">
                            <div class="font-bold text-green-400 mb-1">ğŸ‘ï¸ VIEW (GÃ¶rÃ¼ntÃ¼leme)</div>
                            <p class="text-sm text-slate-300">ModÃ¼lÃ¼n iÃ§eriÄŸini gÃ¶rebilir, listeleyebilir</p>
                        </div>
                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="font-bold text-blue-400 mb-1">â• CREATE (OluÅŸturma)</div>
                            <p class="text-sm text-slate-300">Yeni kayÄ±t ekleyebilir (yeni ÅŸarkÄ±, blog yazÄ±sÄ±)</p>
                        </div>
                        <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded">
                            <div class="font-bold text-amber-400 mb-1">âœï¸ UPDATE (GÃ¼ncelleme)</div>
                            <p class="text-sm text-slate-300">Mevcut kayÄ±tlarÄ± dÃ¼zenleyebilir</p>
                        </div>
                        <div class="bg-red-900/30 border-l-4 border-red-500 p-4 rounded">
                            <div class="font-bold text-red-400 mb-1">ğŸ—‘ï¸ DELETE (Silme)</div>
                            <p class="text-sm text-slate-300">KayÄ±tlarÄ± silebilir</p>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Ã–rnek Senaryo</h4>
                        <p class="text-slate-300 mb-2">
                            <strong>Ali</strong> adÄ±nda bir editÃ¶r var. Ali'ye <strong>Blog modÃ¼lÃ¼</strong> iÃ§in ÅŸu izinler verilmiÅŸ:
                        </p>
                        <ul class="list-disc list-inside text-slate-300 space-y-1">
                            <li>âœ… VIEW: Blog yazÄ±larÄ±nÄ± gÃ¶rebilir</li>
                            <li>âœ… CREATE: Yeni blog yazÄ±sÄ± ekleyebilir</li>
                            <li>âœ… UPDATE: YazÄ±larÄ± dÃ¼zenleyebilir</li>
                            <li>âŒ DELETE: YazÄ±larÄ± SÄ°LEMEZ</li>
                        </ul>
                        <p class="text-slate-300 mt-2">
                            AynÄ± zamanda Ali'ye <strong>MÃ¼zik modÃ¼lÃ¼</strong> iÃ§in sadece VIEW izni verilmiÅŸ.
                            Yani ÅŸarkÄ±larÄ± gÃ¶rebilir ama ekleyemez, dÃ¼zenleyemez veya silemez.
                        </p>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Bu sistem sayesinde her editÃ¶rÃ¼n yetkisi tam olarak kontrol edilir. Bir kiÅŸinin yanlÄ±ÅŸlÄ±kla
                            Ã¶nemli verileri silmesi veya yetkisi olmayan alanlara eriÅŸmesi engellenir. Her kiÅŸi sadece
                            yapmasÄ± gereken iÅŸleri yapar.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">HasModulePermissions Trait</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/UserManagement/App/Traits/HasModulePermissions.php

trait HasModulePermissions {

    // Ana yetki kontrolÃ¼
    public function hasModulePermission(string $moduleName, string $permissionType): bool {
        // 1. Root: Her zaman true
        if ($this->hasRole('root')) return true;

        // 2. Admin: Tenant'a atanmÄ±ÅŸ modÃ¼ller iÃ§in true
        if ($this->hasRole('admin')) {
            if (tenant()) {
                $module = ModuleAccessService::getModuleByName($moduleName);
                return ModuleAccessService::isModuleAssignedToTenant($module->module_id, tenant()->id);
            }
            // Central'da kÄ±sÄ±tlÄ± modÃ¼ller kontrol edilir
            return !in_array($moduleName, config('module-permissions.admin_restricted_modules'));
        }

        // 3. Editor: UserModulePermission tablosundan kontrol
        $cacheKey = "user_{$this->id}_module_{$moduleName}_permission_{$permissionType}";
        return Cache::remember($cacheKey, 300, function() {
            return $this->userModulePermissions()
                ->where('module_name', $moduleName)
                ->where('permission_type', $permissionType)
                ->where('is_active', true)
                ->exists();
        });
    }

    // ModÃ¼lÃ¼n tÃ¼m izinlerini getir
    public function getModulePermissions(string $moduleName): array {
        if ($this->isRoot() || $this->isAdmin()) {
            return ['view', 'create', 'update', 'delete'];
        }

        return $this->userModulePermissions()
            ->where('module_name', $moduleName)
            ->where('is_active', true)
            ->pluck('permission_type')
            ->toArray();
    }

    // Ä°zin ekleme
    public function giveModulePermissionTo(string $moduleName, $permissionTypes): void {
        foreach ((array)$permissionTypes as $type) {
            UserModulePermission::updateOrCreate(
                ['user_id' => $this->id, 'module_name' => $moduleName, 'permission_type' => $type],
                ['is_active' => true]
            );
        }
        $this->clearModulePermissionCache($moduleName);
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">UserModulePermission Model</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Modules/UserManagement/App/Models/UserModulePermission.php

class UserModulePermission extends Model {
    protected $fillable = ['user_id', 'module_name', 'permission_type', 'is_active'];
    protected $casts = ['is_active' => 'boolean'];

    public function user(): BelongsTo {
        return $this->belongsTo(User::class);
    }

    public static function getPermissionTypes(): array {
        return ModulePermission::getPermissionTypes();
    }
}

ğŸ“Š user_module_permissions tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon            â”‚ Tip          â”‚ AÃ§Ä±klama                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚ bigint       â”‚ PK                         â”‚
â”‚ user_id          â”‚ bigint       â”‚ FK users                   â”‚
â”‚ module_name      â”‚ varchar(50)  â”‚ 'blog', 'muzibu', vb.      â”‚
â”‚ permission_type  â”‚ varchar(20)  â”‚ 'view', 'create', vb.      â”‚
â”‚ is_active        â”‚ boolean      â”‚ aktif/pasif                â”‚
â”‚ created_at       â”‚ timestamp    â”‚                            â”‚
â”‚ updated_at       â”‚ timestamp    â”‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNIQUE: (user_id, module_name, permission_type)              â”‚
â”‚ INDEX: module_name, permission_type, is_active               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Helper FonksiyonlarÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Helpers/ModulePermissionHelper.php

// Blade'de kullanÄ±m: @if(can_module('blog', 'create'))
function can_module(string $moduleName, string $permissionType = 'view'): bool {
    $user = Auth::user();
    if (!$user) return false;

    if ($user->hasRole('root') || $user->hasRole('admin')) {
        return true;
    }

    $cacheKey = "user_{$user->id}_module_{$moduleName}_permission_{$permissionType}";
    return Cache::remember($cacheKey, 86400, fn() =>
        $user->hasModulePermission($moduleName, $permissionType)
    );
}

// ModÃ¼l aktif mi kontrolÃ¼
function is_module_active(string $moduleName, string $permissionType = 'view'): bool {
    $cacheKey = "module_{$moduleName}_permission_{$permissionType}_active";
    return Cache::remember($cacheKey, 86400, function() use ($moduleName, $permissionType) {
        return Module::where('name', $moduleName)
            ->where('is_active', true)
            ->whereHas('permissions', fn($q) =>
                $q->where('permission_type', $permissionType)->where('is_active', true)
            )
            ->exists();
    });
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 3: MÄ°DDLEWARE SÄ°STEMÄ° -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">3ï¸âƒ£ Middleware Koruma KatmanlarÄ±</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        <strong>Middleware</strong>, bir sayfa aÃ§Ä±lmadan Ã¶nce Ã§alÄ±ÅŸan <strong>gÃ¼venlik kontrol noktalarÄ±</strong>dÄ±r.
                        TÄ±pkÄ± bir binanÄ±n gÃ¼venlik gÃ¶revlisi gibi, her ziyaretÃ§iyi kontrol eder ve yetkisi yoksa iÃ§eri almaz.
                    </p>

                    <div class="space-y-4">
                        <div class="bg-red-900/30 border-l-4 border-red-500 p-4 rounded">
                            <div class="font-bold text-red-400 mb-2">ğŸš« RootAccessMiddleware (Sadece Root)</div>
                            <p class="text-slate-300 mb-2">
                                BazÄ± sayfalar <strong>sadece root kullanÄ±cÄ±larÄ±n</strong> eriÅŸebileceÄŸi kadar kritiktir.
                                Bu middleware, root olmayan hiÃ§ kimsenin o sayfalara girmesine izin vermez.
                            </p>
                            <div class="text-sm text-slate-400">
                                <strong>Ã–rnek:</strong> Sistem ayarlarÄ±, tenant oluÅŸturma, global yapÄ±landÄ±rma sayfalarÄ±
                            </div>
                        </div>

                        <div class="bg-amber-900/30 border-l-4 border-amber-500 p-4 rounded">
                            <div class="font-bold text-amber-400 mb-2">ğŸ” AdminAccessMiddleware (Admin KontrolÃ¼)</div>
                            <p class="text-slate-300 mb-2">
                                Admin paneline giriÅŸ yapmak isteyen herkesi kontrol eder. Root ve admin'lere izin verir,
                                editÃ¶rler iÃ§in Ã¶zel kontroller yapar. AyrÄ±ca hangi modÃ¼le eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± tespit eder.
                            </p>
                            <div class="text-sm text-slate-400 space-y-1">
                                <div>âœ… Root: Her yere eriÅŸebilir</div>
                                <div>âœ… Admin: Tenant'a atanan modÃ¼llere eriÅŸebilir</div>
                                <div>âœ… Editor: Ä°zin verilen modÃ¼llere eriÅŸebilir</div>
                                <div>âŒ Yetkisiz kullanÄ±cÄ±: 403 Forbidden</div>
                            </div>
                        </div>

                        <div class="bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded">
                            <div class="font-bold text-purple-400 mb-2">ğŸ” RootOnlyDebugbar (GeliÅŸtirici AraÃ§larÄ±)</div>
                            <p class="text-slate-300 mb-2">
                                Debugbar (geliÅŸtirici debug araÃ§larÄ±), sadece root kullanÄ±cÄ±larÄ±n gÃ¶rebileceÄŸi hassas bilgiler iÃ§erir.
                                Bu middleware, debugbar'Ä± sadece root kullanÄ±cÄ±lara gÃ¶sterir.
                            </p>
                            <div class="text-sm text-slate-400">
                                <strong>Performans:</strong> Session cache kullanarak her istekte DB sorgusu yapmaz
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Middleware sistemi sayesinde her sayfa aÃ§Ä±lmadan Ã¶nce yetki kontrolÃ¼ yapÄ±lÄ±r. YanlÄ±ÅŸlÄ±kla
                            veya kasÄ±tlÄ± olarak yetkisiz sayfalara eriÅŸim denemeleri engellenir. Sistem gÃ¼venliÄŸi otomatik
                            olarak saÄŸlanÄ±r, her sayfada ayrÄ± kontrol yazmaya gerek kalmaz.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">RootAccessMiddleware</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Http/Middleware/RootAccessMiddleware.php

class RootAccessMiddleware {
    public function handle(Request $request, Closure $next) {
        // Root yetkisi kontrolÃ¼
        if (!auth()->user() || !auth()->user()->isRoot()) {
            abort(403, 'ERÄ°ÅÄ°M ENGELENDÄ°.');
        }

        // Tenant kontrolÃ¼ - sadece central'da eriÅŸime izin ver
        if (TenantHelpers::isTenant()) {
            abort(403, 'ERÄ°ÅÄ°M ENGELENDÄ°.');
        }

        return $next($request);
    }
}

ğŸ“‹ KullanÄ±m:
Route::middleware(['auth', 'root'])->group(function() {
    Route::get('/admin/system-settings', ...);
    Route::get('/admin/create-tenant', ...);
});</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">AdminAccessMiddleware</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Http/Middleware/AdminAccessMiddleware.php

class AdminAccessMiddleware {
    public function handle(Request $request, Closure $next) {
        if (!auth()->check()) {
            abort(403, 'Bu alana eriÅŸim yetkiniz bulunmamaktadÄ±r.');
        }

        $user = auth()->user();

        // URL'den modÃ¼l adÄ±nÄ± Ã§Ä±kar: /admin/blog/posts â†’ 'blog'
        preg_match('/^admin\/([^\/]+)/', $request->path(), $matches);
        $moduleName = $matches[1] ?? null;

        // Path-to-module mapping
        $pathModuleMap = ['orders' => 'cart', 'checkout' => 'cart'];
        if ($moduleName && isset($pathModuleMap[$moduleName])) {
            $moduleName = $pathModuleMap[$moduleName];
        }

        // ROOT: Her yere eriÅŸebilir
        if ($user->isRoot()) {
            return $next($request);
        }

        // ADMIN: Tenant'a atanan modÃ¼llere eriÅŸebilir
        if ($user->isAdmin()) {
            $systemRoutes = ['dashboard', 'cache', 'debug', 'ai', 'language'];
            if (in_array($moduleName, $systemRoutes)) {
                return $next($request);
            }

            // Central'da kÄ±sÄ±tlÄ± modÃ¼l kontrolÃ¼
            if (TenantHelpers::isCentral() &&
                in_array($moduleName, config('module-permissions.admin_restricted_modules'))) {
                abort(403, 'Bu modÃ¼le eriÅŸim yetkiniz bulunmamaktadÄ±r.');
            }

            // Tenant'ta modÃ¼l atama kontrolÃ¼ (10 dakika cache)
            if (TenantHelpers::isTenant() && $moduleName) {
                $cacheKey = "module_tenant_access:{$moduleName}:" . tenant()->id;
                $hasAccess = Cache::remember($cacheKey, 600, function() use ($moduleName) {
                    $module = ModuleAccessService::getModuleByName($moduleName);
                    return $module && ModuleAccessService::isModuleAssignedToTenant($module->module_id, tenant()->id);
                });

                if (!$hasAccess) {
                    abort(403, 'Bu modÃ¼l bu tenant\'a atanmamÄ±ÅŸ.');
                }
            }

            return $next($request);
        }

        // EDITOR: ModÃ¼l bazlÄ± izin kontrolÃ¼
        if ($user->isEditor()) {
            if ($moduleName && !ModuleAccessService::canAccess($moduleName, 'view')) {
                abort(403, 'Bu modÃ¼le eriÅŸim yetkiniz bulunmamaktadÄ±r.');
            }
            return $next($request);
        }

        abort(403, 'Bu alana eriÅŸim yetkiniz bulunmamaktadÄ±r.');
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">RootOnlyDebugbar</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Http/Middleware/RootOnlyDebugbar.php

class RootOnlyDebugbar {
    public function handle(Request $request, Closure $next): Response {
        if (!class_exists(\Barryvdh\Debugbar\Facade::class)) {
            return $next($request);
        }

        $showDebugbar = false;

        if (auth()->check()) {
            $userId = auth()->id();
            $sessionKey = "is_root_user_{$userId}";

            if (session()->has($sessionKey)) {
                // Session'dan al (0 query)
                $showDebugbar = session($sessionKey);
            } else {
                // Ä°lk kez: Cache'den al, session'a kaydet
                $isRoot = Cache::remember("user_is_root_{$userId}", 300, fn() =>
                    auth()->user()?->hasRole('root') ?? false
                );
                session([$sessionKey => $isRoot]);
                $showDebugbar = $isRoot;
            }
        }

        if (!$showDebugbar) {
            \Barryvdh\Debugbar\Facade::disable();
        }

        return $next($request);
    }
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 4: MULTI-TENANT YETKÄ°LENDÄ°RME -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">4ï¸âƒ£ Multi-Tenant Yetkilendirme Mimarisi</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Sistem, <strong>multi-tenant</strong> (Ã§ok kiracÄ±lÄ±) bir yapÄ±ya sahip. Yani her mÃ¼ÅŸteri (tenant)
                        kendi baÄŸÄ±msÄ±z veritabanÄ±na sahip. Bir mÃ¼ÅŸterinin yÃ¶neticisi, sadece kendi mÃ¼ÅŸterisinin verilerine
                        eriÅŸebilir, baÅŸka mÃ¼ÅŸterilerin verilerini gÃ¶remez.
                    </p>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded">
                            <div class="font-bold text-purple-400 mb-2">ğŸ¢ Central (Merkezi) VeritabanÄ±</div>
                            <p class="text-slate-300 text-sm mb-2">
                                TÃ¼m tenant'larÄ±, modÃ¼lleri ve global ayarlarÄ± tutan merkezi veritabanÄ±.
                                Sadece root kullanÄ±cÄ±lar buraya tam eriÅŸebilir.
                            </p>
                            <div class="text-sm text-slate-400">
                                <div>ğŸ“Š Tenant listesi</div>
                                <div>ğŸ“¦ ModÃ¼l tanÄ±mlarÄ±</div>
                                <div>ğŸ”— ModÃ¼l-tenant atamalarÄ±</div>
                            </div>
                        </div>

                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="font-bold text-blue-400 mb-2">ğŸª Tenant VeritabanÄ±</div>
                            <p class="text-slate-300 text-sm mb-2">
                                Her mÃ¼ÅŸterinin kendi veritabanÄ±. KullanÄ±cÄ±lar, iÃ§erikler, sipariÅŸler gibi
                                tenant'a Ã¶zel tÃ¼m veriler burada saklanÄ±r.
                            </p>
                            <div class="text-sm text-slate-400">
                                <div>ğŸ‘¥ KullanÄ±cÄ±lar</div>
                                <div>ğŸ“ Ä°Ã§erikler (blog, mÃ¼zik vb.)</div>
                                <div>ğŸ” Roller ve izinler</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ“Œ Ã–rnek Senaryo</h4>
                        <p class="text-slate-300 mb-3">
                            3 farklÄ± mÃ¼ÅŸteri var: <strong>Tuufi.com</strong> (central), <strong>Ixtif.com</strong> ve <strong>Muzibu.com</strong>
                        </p>

                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="badge badge-root text-xs">ROOT</span>
                                <span class="text-slate-300">Nurullah: TÃ¼m tenant'lara ve central DB'ye eriÅŸebilir</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="badge badge-admin text-xs">ADMIN</span>
                                <span class="text-slate-300">Ahmet (Muzibu yÃ¶neticisi): Sadece Muzibu DB'ye eriÅŸebilir, Ixtif'i gÃ¶remez</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="badge badge-editor text-xs">EDITOR</span>
                                <span class="text-slate-300">AyÅŸe (Muzibu editÃ¶r): Muzibu'da sadece kendisine verilen modÃ¼llere eriÅŸebilir</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ¯ ModÃ¼l Atama Sistemi</h4>
                        <p class="text-slate-300 mb-2">
                            Her tenant'a hangi modÃ¼llerin aktif olacaÄŸÄ± <strong>central DB'den</strong> kontrol edilir.
                            Ã–rneÄŸin Muzibu'ya "MÃ¼zik" modÃ¼lÃ¼ atanmÄ±ÅŸ ama Ixtif'e atanmamÄ±ÅŸ.
                        </p>
                        <div class="text-sm text-slate-400">
                            BÃ¶ylece her mÃ¼ÅŸteri sadece ihtiyacÄ± olan Ã¶zellikleri kullanÄ±r, gereksiz karmaÅŸa olmaz.
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Multi-tenant yapÄ± sayesinde her mÃ¼ÅŸteri tamamen izole edilmiÅŸ ortamda Ã§alÄ±ÅŸÄ±r.
                            Bir mÃ¼ÅŸterinin yÃ¶neticisi yanlÄ±ÅŸlÄ±kla baÅŸka mÃ¼ÅŸterinin verilerini gÃ¶remez veya deÄŸiÅŸtiremez.
                            Veri gÃ¼venliÄŸi ve gizlilik maksimum seviyede saÄŸlanÄ±r.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Tenant Kontrol MekanizmasÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ HasModulePermissions Trait - Tenant-Aware Permission Check

public function hasModulePermission(string $moduleName, string $permissionType): bool {
    // Root: Her zaman bypass
    if ($this->hasRole('root')) return true;

    // Admin: Tenant context'e gÃ¶re kontrol
    if ($this->hasRole('admin')) {
        // Tenant initialized mÄ±?
        if (app(\Stancl\Tenancy\Tenancy::class)->initialized) {
            // ModÃ¼l bu tenant'a atanmÄ±ÅŸ mÄ±? (Central DB sorgusu)
            $moduleService = app(\App\Services\ModuleAccessService::class);
            $module = $moduleService->getModuleByName($moduleName);

            if (!$module) {
                \Log::warning("Module not found: {$moduleName}");
                return false;
            }

            return $moduleService->isModuleAssignedToTenant($module->module_id, tenant()->id);
        }

        // Central'da ise admin_restricted_modules kontrolÃ¼
        if (in_array($moduleName, config('module-permissions.admin_restricted_modules', []))) {
            \Log::warning("Admin tried to access restricted module: {$moduleName}");
            return false;
        }

        return true;
    }

    // Editor: UserModulePermission kontrolÃ¼ (Tenant DB)
    return $this->userModulePermissions()
        ->where('module_name', $moduleName)
        ->where('permission_type', $permissionType)
        ->where('is_active', true)
        ->exists();
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">ModuleAccessService - Tenant Assignment</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Services/ModuleAccessService.php

public function isModuleAssignedToTenant(string $moduleId, string $tenantId): bool {
    // Central tenant (ID: 1) tÃ¼m modÃ¼llere eriÅŸebilir
    if ($tenantId === '1' || $tenantId === 1) {
        return true;
    }

    // Cache kontrolÃ¼ (10 dakika)
    $cached = $this->cache->getTenantAssignmentCache($moduleId, $tenantId);
    if ($cached !== null) return $cached;

    // Database'den kontrol et (Central DB'den!)
    $isAssigned = TenantHelpers::central(function () use ($moduleId, $tenantId) {
        // module_tenants tablosunda aktif atama var mÄ±?
        $assigned = DB::table('module_tenants')
            ->where('module_id', $moduleId)
            ->where('tenant_id', $tenantId)
            ->where('is_active', true)
            ->exists();

        if ($assigned) return true;

        // Veya tenant central tenant mÄ±?
        return DB::table('tenants')
            ->where('id', $tenantId)
            ->where('central', true)
            ->where('is_active', true)
            ->exists();
    });

    // Cache'e kaydet
    $this->cache->setTenantAssignmentCache($moduleId, $tenantId, $isAssigned);

    return $isAssigned;
}

// Tenant'Ä±n modÃ¼llerini getir
public function getTenantModules(int $tenantId): \Illuminate\Support\Collection {
    return TenantHelpers::central(function () use ($tenantId) {
        // Central tenant tÃ¼m modÃ¼llere eriÅŸir
        if ($tenantId === 1) {
            return Module::where('is_active', true)->get();
        }

        // DiÄŸer tenant'lar iÃ§in module_tenants tablosundan
        return Module::select('modules.*')
            ->join('module_tenants', 'modules.module_id', '=', 'module_tenants.module_id')
            ->where('module_tenants.tenant_id', $tenantId)
            ->where('module_tenants.is_active', true)
            ->where('modules.is_active', true)
            ->get();
    });
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Database Schema</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“Š Central DB - module_tenants tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kolon       â”‚ Tip      â”‚ AÃ§Ä±klama                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚ bigint   â”‚ PK                           â”‚
â”‚ module_id   â”‚ string   â”‚ FK modules (UUID)            â”‚
â”‚ tenant_id   â”‚ bigint   â”‚ FK tenants                   â”‚
â”‚ is_active   â”‚ boolean  â”‚ aktif/pasif                  â”‚
â”‚ created_at  â”‚timestamp â”‚                              â”‚
â”‚ updated_at  â”‚timestamp â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š Tenant DB - user_module_permissions tablosu
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id          â”‚ module_name  â”‚ permission_typeâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 42               â”‚ blog         â”‚ view           â”‚
â”‚ 42               â”‚ blog         â”‚ create         â”‚
â”‚ 42               â”‚ blog         â”‚ update         â”‚
â”‚ 58               â”‚ muzibu       â”‚ view           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âš ï¸ Bu tablo her tenant'Ä±n kendi DB'sinde!</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">TenantHelpers KullanÄ±mÄ±</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Helpers/TenantHelpers.php

// Central DB'de sorgu Ã§alÄ±ÅŸtÄ±rma
TenantHelpers::central(function () {
    return Module::all(); // Central DB'den modÃ¼lleri al
});

// Tenant kontrolÃ¼
if (TenantHelpers::isTenant()) {
    // Tenant context'indeyiz
}

if (TenantHelpers::isCentral()) {
    // Central domain'deyiz
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 5: CACHE ve PERFORMANS -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">5ï¸âƒ£ Cache Sistemi ve Performans Optimizasyonu</h2>

                <!-- Basit AnlatÄ±m -->
                <div class="bg-slate-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                    <p class="text-slate-300 mb-4">
                        Sistem, yetki kontrollerinde <strong>cache (Ã¶nbellek)</strong> kullanÄ±r. Yani bir kullanÄ±cÄ±nÄ±n
                        yetkisi bir kez kontrol edildiÄŸinde, sonuÃ§ hatÄ±rlanÄ±r ve tekrar veritabanÄ±na sorulmaz.
                        Bu sayede sistem Ã§ok daha hÄ±zlÄ± Ã§alÄ±ÅŸÄ±r.
                    </p>

                    <div class="bg-slate-800 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸš€ NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h4>
                        <div class="space-y-2 text-sm text-slate-300">
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">1ï¸âƒ£</span>
                                <span>KullanÄ±cÄ± bir sayfaya girmek ister (Ã¶rn: Blog modÃ¼lÃ¼)</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">2ï¸âƒ£</span>
                                <span>Sistem Ã¶nce cache'e bakar: "Bu kullanÄ±cÄ±nÄ±n blog yetkisi daha Ã¶nce sorulmuÅŸ mu?"</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">3ï¸âƒ£</span>
                                <span>EÄŸer cache'de varsa direkt oradan alÄ±r (Ã§ok hÄ±zlÄ± âš¡)</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">4ï¸âƒ£</span>
                                <span>EÄŸer cache'de yoksa veritabanÄ±ndan kontrol eder ve sonucu cache'e kaydeder</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">5ï¸âƒ£</span>
                                <span>5-24 saat boyunca cache'deki sonuÃ§ kullanÄ±lÄ±r, tekrar sorulmaz</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-green-900/30 border-l-4 border-green-500 p-4 rounded">
                            <div class="font-bold text-green-400 mb-1">â±ï¸ 5 Dakika</div>
                            <p class="text-sm text-slate-300">ModÃ¼l izin kontrolÃ¼ cache sÃ¼resi</p>
                        </div>
                        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded">
                            <div class="font-bold text-blue-400 mb-1">â±ï¸ 10 Dakika</div>
                            <p class="text-sm text-slate-300">Tenant-modÃ¼l atama cache</p>
                        </div>
                        <div class="bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded">
                            <div class="font-bold text-purple-400 mb-1">â±ï¸ 24 Saat</div>
                            <p class="text-sm text-slate-300">Helper fonksiyon cache</p>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-300 mb-2">ğŸ’¡ Neden Ã–nemli?</h4>
                        <p class="text-slate-300">
                            Cache kullanmadan her sayfa yÃ¼kleniÅŸinde veritabanÄ±na 10-20 kez "bu kullanÄ±cÄ±nÄ±n yetkisi var mÄ±?"
                            diye sorulurdu. Cache sayesinde bu sorgu sayÄ±sÄ± 0'a iner. Sayfa yÃ¼kleme sÃ¼releri 10 kat hÄ±zlanÄ±r,
                            veritabanÄ± yÃ¼kÃ¼ azalÄ±r.
                        </p>
                    </div>
                </div>

                <!-- Teknik Detaylar -->
                <div class="section-card rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">ğŸ”§ Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h3>

                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Cache Key Stratejisi</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Cache Key YapÄ±sÄ±

// ModÃ¼l izin cache (5 dakika)
"user_{$userId}_module_{$moduleName}_permission_{$permissionType}"
Ã–rnek: "user_42_module_blog_permission_create"

// ModÃ¼lÃ¼n tÃ¼m izinleri (60 dakika)
"user_{$userId}_module_{$moduleName}_permissions"
Ã–rnek: "user_42_module_blog_permissions"

// Rol cache (5 dakika)
"user_role_{$userId}_{$roleName}"
"user_is_root_{$userId}"

// Tenant-modÃ¼l atama (10 dakika)
"module_tenant_access:{$moduleName}:{$tenantId}"

// ModÃ¼l aktif mi (24 saat)
"module_{$moduleName}_permission_{$permissionType}_active"

// ModÃ¼l by name (15 dakika)
"module_by_name:{$moduleName}"</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Cache Implementation</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ HasModulePermissions Trait

public function hasModulePermission(string $moduleName, string $permissionType): bool {
    if ($this->hasRole('root')) return true;
    if ($this->hasRole('admin')) { /* ... */ }

    // Editor iÃ§in cache'li kontrol
    $cacheKey = "user_{$this->id}_module_{$moduleName}_permission_{$permissionType}";

    return Cache::remember($cacheKey, now()->addMinutes(5), function () use ($moduleName, $permissionType) {
        // Spatie Permission kontrolÃ¼
        $permissionName = "{$moduleName}.{$permissionType}";
        if (!Permission::where('name', $permissionName)->exists()) {
            \Log::error("Permission does not exist: {$permissionName}");
            return false;
        }

        if ($this->hasPermissionTo($permissionName)) {
            return true;
        }

        // Direct DB kontrolÃ¼ (fallback)
        $hasPermissionInDB = \DB::table('model_has_permissions')
            ->join('permissions', 'model_has_permissions.permission_id', '=', 'permissions.id')
            ->where('model_id', $this->id)
            ->where('model_type', get_class($this))
            ->where('permissions.name', $permissionName)
            ->exists();

        if ($hasPermissionInDB) return true;

        // UserModulePermission kontrolÃ¼
        return $this->userModulePermissions()
            ->where('module_name', $moduleName)
            ->where('permission_type', $permissionType)
            ->where('is_active', true)
            ->exists();
    });
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">ModuleAccessCache Service</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ app/Services/ModuleAccessCache.php

class ModuleAccessCache {
    const CACHE_TTL = 600; // 10 dakika

    public function getAccessCache(int $userId, string $moduleName, string $permissionType): ?bool {
        $key = $this->buildAccessKey($userId, $moduleName, $permissionType);
        return Cache::get($key);
    }

    public function setAccessCache(int $userId, string $moduleName, string $permissionType, bool $hasAccess): void {
        $key = $this->buildAccessKey($userId, $moduleName, $permissionType);
        Cache::put($key, $hasAccess, self::CACHE_TTL);
    }

    public function getTenantAssignmentCache(string $moduleId, string $tenantId): ?bool {
        $key = "module_tenant_assignment:{$moduleId}:{$tenantId}";
        return Cache::get($key);
    }

    public function setTenantAssignmentCache(string $moduleId, string $tenantId, bool $isAssigned): void {
        $key = "module_tenant_assignment:{$moduleId}:{$tenantId}";
        Cache::put($key, $isAssigned, self::CACHE_TTL);
    }

    public function clearUserCache(string $userId): void {
        // Wildcard cache clear (Redis pattern delete)
        $pattern = "laravel_cache:user_{$userId}_*";
        $keys = Redis::keys($pattern);
        if ($keys) Redis::del($keys);
    }

    private function buildAccessKey(int $userId, string $moduleName, string $permissionType): string {
        return "user_module_access:{$userId}:{$moduleName}:{$permissionType}";
    }
}</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Cache Temizleme Stratejisi</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ Cache Invalidation Points

// Rol deÄŸiÅŸtiÄŸinde (User model)
public function flushRoleCache(): void {
    app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
    $this->unsetRelation('roles');
    $this->unsetRelation('permissions');
    \Cache::forget("user_{$this->id}_roles");
    \Cache::forget("user_{$this->id}_permissions");
}

// ModÃ¼l izni eklendiÄŸinde/kaldÄ±rÄ±ldÄ±ÄŸÄ±nda
private function clearModulePermissionCache(string $moduleName): void {
    $permissionTypes = UserModulePermission::getPermissionTypes();
    foreach ($permissionTypes as $type => $name) {
        Cache::forget("user_{$this->id}_module_{$moduleName}_permission_{$type}");
    }
    Cache::forget("user_{$this->id}_module_{$moduleName}_permissions");
}

// TÃ¼m modÃ¼l cache'i temizleme
ModuleAccessService::clearModuleAccessCache($userId); // Belirli kullanÄ±cÄ±
ModuleAccessService::clearModuleAccessCache();        // TÃ¼m cache</pre>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Session Cache (Debugbar)</h4>
                            <div class="code-block text-sm">
<pre>ğŸ“ RootOnlyDebugbar Middleware - Zero Query Optimization

if (auth()->check()) {
    $userId = auth()->id();
    $sessionKey = "is_root_user_{$userId}";

    if (session()->has($sessionKey)) {
        // Session'dan al (0 DB query, 0 Redis query)
        $showDebugbar = session($sessionKey);
    } else {
        // Ä°lk kez: Redis cache + session
        $isRoot = Cache::remember("user_is_root_{$userId}", 300, fn() =>
            auth()->user()?->hasRole('root') ?? false
        );
        session([$sessionKey => $isRoot]); // Session'a kaydet
        $showDebugbar = $isRoot;
    }
}

// Sonraki isteklerde: Session'dan okur, hiÃ§ sorgu yapmaz! âš¡</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BÃ–LÃœM 6: KULLANIM Ã–RNEKLERÄ° -->
        <section class="mb-12">
            <div class="bg-slate-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6 text-slate-100">6ï¸âƒ£ Kod KullanÄ±m Ã–rnekleri</h2>

                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-400">Blade Template'de Yetki KontrolÃ¼</h3>
                        <div class="code-block text-sm">
<pre>{{-- Root kontrolÃ¼ --}}
@if(auth()->user()->isRoot())
    &lt;button class="btn btn-danger"&gt;Sistemi SÄ±fÄ±rla&lt;/button&gt;
@endif

{{-- ModÃ¼l izin kontrolÃ¼ --}}
@if(can_module('blog', 'create'))
    &lt;a href="{{ route('admin.blog.create') }}"&gt;Yeni YazÄ± Ekle&lt;/a&gt;
@endif

{{-- Ã‡oklu izin kontrolÃ¼ --}}
@if(auth()->user()->hasModulePermissions('muzibu', ['update', 'delete']))
    &lt;button class="btn btn-warning"&gt;DÃ¼zenle&lt;/button&gt;
    &lt;button class="btn btn-danger"&gt;Sil&lt;/button&gt;
@endif

{{-- Rol bazlÄ± UI --}}
@role('admin')
    &lt;div class="admin-panel"&gt;YÃ¶netici Paneli&lt;/div&gt;
@endrole

@role('editor')
    &lt;div class="editor-panel"&gt;EditÃ¶r Paneli&lt;/div&gt;
@endrole</pre>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-400">Controller'da Yetki KontrolÃ¼</h3>
                        <div class="code-block text-sm">
<pre>use App\Services\ModuleAccessService;

class BlogController extends Controller {

    public function __construct(protected ModuleAccessService $moduleAccess) {
        // Middleware ile genel kontrol
        $this->middleware(['auth', 'admin']);
    }

    public function create() {
        // Ä°zin kontrolÃ¼
        if (!$this->moduleAccess->canAccess('blog', 'create')) {
            abort(403, 'Blog oluÅŸturma yetkiniz yok.');
        }

        return view('blog.create');
    }

    public function destroy(Blog $blog) {
        // Policy kullanÄ±mÄ±
        $this->authorize('delete', $blog);

        // veya manuel kontrol
        if (!auth()->user()->hasModulePermission('blog', 'delete')) {
            abort(403);
        }

        $blog->delete();
        return redirect()->back();
    }
}</pre>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-400">Policy KullanÄ±mÄ±</h3>
                        <div class="code-block text-sm">
<pre>ğŸ“ app/Policies/WidgetPolicy.php

class WidgetPolicy {

    // Root-only iÅŸlem
    public function update(User $user, Widget $widget): bool {
        return $user->hasRole('root');
    }

    // ModÃ¼l bazlÄ± izin
    public function manageContent(User $user, Widget $widget): bool {
        return $user->hasModulePermission('widgetmanagement', 'update');
    }

    // KarmaÅŸÄ±k kontrol
    public function delete(User $user, Widget $widget): bool {
        if ($user->isRoot()) return true;

        if ($user->isAdmin()) {
            // Admin sadece kendi tenant'Ä±nÄ±n widget'larÄ±nÄ± silebilir
            return $widget->tenant_id === tenant()->id;
        }

        return $user->hasModulePermission('widgetmanagement', 'delete');
    }
}</pre>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-400">Route Middleware KullanÄ±mÄ±</h3>
                        <div class="code-block text-sm">
<pre>ğŸ“ routes/web.php

// Root-only routes
Route::middleware(['auth', 'root'])->group(function() {
    Route::get('/admin/system-settings', [SystemController::class, 'index']);
    Route::post('/admin/create-tenant', [TenantController::class, 'store']);
});

// Admin routes (tenant-aware)
Route::middleware(['auth', 'admin'])->prefix('admin')->group(function() {
    Route::resource('blog', BlogController::class);
    Route::resource('pages', PageController::class);
});

// Spatie middleware kullanÄ±mÄ±
Route::middleware(['role:root'])->group(function() {
    Route::get('/debug/queries', ...);
});

Route::middleware(['role:admin|editor'])->group(function() {
    Route::get('/admin/dashboard', ...);
});

Route::middleware(['permission:blog.create'])->group(function() {
    Route::post('/admin/blog', ...);
});</pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-slate-400 text-sm mt-16 pb-8">
            28 Ocak 2026 â€¢ Muzibu.com.tr
        </footer>

    </div>
</body>
</html>
