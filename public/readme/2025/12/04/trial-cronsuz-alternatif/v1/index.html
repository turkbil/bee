<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Bitirme - Cron Alternatifleri</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 {
            font-size: 2.3rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-align: center;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .section {
            background: rgba(30, 41, 59, 0.5);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border-left: 5px solid #3b82f6;
        }
        
        h2 {
            font-size: 1.7rem;
            color: #60a5fa;
            margin-bottom: 20px;
        }
        
        .approach {
            background: rgba(15, 23, 42, 0.7);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid;
        }
        
        .approach.cron { border-color: #3b82f6; }
        .approach.lazy { border-color: #10b981; }
        .approach.middleware { border-color: #f59e0b; }
        .approach.queue { border-color: #8b5cf6; }
        
        .approach h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .pros { color: #10b981; margin-top: 15px; }
        .cons { color: #ef4444; margin-top: 15px; }
        
        ul { padding-left: 25px; margin: 10px 0; }
        li { margin: 8px 0; color: #cbd5e1; }
        
        .code-block {
            background: rgba(15, 23, 42, 0.9);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            color: #e5e7eb;
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
        }
        
        .winner {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.15));
            padding: 25px;
            border-radius: 12px;
            border: 3px solid #10b981;
            text-align: center;
            margin: 25px 0;
        }
        
        .winner h3 {
            color: #10b981;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .comp-card {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 12px;
            border-top: 3px solid;
        }
        
        .comp-card.good { border-color: #10b981; }
        .comp-card.bad { border-color: #ef4444; }
        .comp-card.medium { border-color: #f59e0b; }
        
        .comp-card h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.15);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.15);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #ef4444;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        th {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            font-weight: 600;
        }
        
        .check { color: #10b981; }
        .cross { color: #ef4444; }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° Trial Bitirme YÃ¶ntemleri</h1>
        <p class="subtitle">Cron Ã‡alÄ±ÅŸmazsa Ne Olur? - TÃ¼m Alternatifler</p>

        <!-- Sorun -->
        <div class="section">
            <h2>âŒ Cron Ã‡alÄ±ÅŸmazsa Ne Olur?</h2>
            
            <div class="warning-box">
                <strong style="color: #ef4444; display: block; margin-bottom: 10px; font-size: 1.1rem;">ğŸš¨ SORUN:</strong>
                <ul>
                    <li><strong>Trial bitmiyor:</strong> 7 gÃ¼n geÃ§ti ama kullanÄ±cÄ± hala premium gibi kullanÄ±yor!</li>
                    <li><strong>Status gÃ¼ncellenmiyor:</strong> <code>active</code> olarak kalÄ±yor, <code>expired</code> olmuyor</li>
                    <li><strong>Gelir kaybÄ±:</strong> KullanÄ±cÄ±lar Ã¼cretsiz premium kullanÄ±yor</li>
                    <li><strong>HaksÄ±z kullanÄ±m:</strong> Sistemin amacÄ± bozuluyor</li>
                </ul>
            </div>

            <div class="info-box">
                <strong style="color: #60a5fa; display: block; margin-bottom: 10px;">ğŸ’¡ Neden Cron Ã‡alÄ±ÅŸmayabilir?</strong>
                <ul>
                    <li>Sunucu cron servisi devre dÄ±ÅŸÄ±</li>
                    <li>Cron job yanlÄ±ÅŸ kurulmuÅŸ</li>
                    <li>Laravel schedule Ã§alÄ±ÅŸmÄ±yor</li>
                    <li>Shared hosting cron kÄ±sÄ±tlamasÄ±</li>
                    <li>Sunucu yeniden baÅŸlatÄ±ldÄ±, cron unutuldu</li>
                </ul>
            </div>
        </div>

        <!-- 4 YaklaÅŸÄ±m -->
        <div class="section">
            <h2>ğŸ¯ 4 FarklÄ± YaklaÅŸÄ±m</h2>

            <div class="approach cron">
                <h3 style="color: #3b82f6;">YaklaÅŸÄ±m 1: Cron Job (Klasik)</h3>
                <p>Her gÃ¼n belirli saatte Ã§alÄ±ÅŸan otomatik script.</p>
                
                <div class="code-block">// app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    $schedule-&gt;call(function () {
        Subscription::whereHas('plan', fn($q) =&gt; $q-&gt;where('is_trial', true))
            -&gt;where('status', 'active')
            -&gt;whereDate('ends_at', '&lt;=', now())
            -&gt;update(['status' =&gt; 'expired']);
    })-&gt;daily();
}

// Crontab
* * * * * php /path/to/artisan schedule:run</div>

                <p class="pros"><strong>âœ… ArtÄ±larÄ±:</strong></p>
                <ul>
                    <li>ZamanÄ±nda Ã§alÄ±ÅŸÄ±r (her gÃ¼n aynÄ± saatte)</li>
                    <li>Performans etkisi yok (arka planda)</li>
                    <li>Profesyonel yaklaÅŸÄ±m</li>
                </ul>

                <p class="cons"><strong>âŒ Eksileri:</strong></p>
                <ul>
                    <li>Cron Ã§alÄ±ÅŸmazsa sistem durur!</li>
                    <li>Shared hosting'de sorunlu olabilir</li>
                    <li>Kurulum gerektirir</li>
                </ul>
            </div>

            <div class="approach lazy">
                <h3 style="color: #10b981;">YaklaÅŸÄ±m 2: Lazy Check (Kontrol SÄ±rasÄ±nda)</h3>
                <p>Trial kontrolÃ¼ yapÄ±lÄ±rken otomatik expire eder.</p>
                
                <div class="code-block">// User model
public function isPremium(): bool
{
    // Aktif subscription var mÄ±?
    $subscription = $this-&gt;subscriptions()
        -&gt;where('status', 'active')
        -&gt;first();
    
    if (!$subscription) {
        return false;
    }
    
    // ğŸ”¥ LAZY CHECK: BitmiÅŸ mi kontrol et!
    if ($subscription-&gt;ends_at &lt; now()) {
        // Otomatik expire et
        $subscription-&gt;update(['status' =&gt; 'expired']);
        return false;
    }
    
    return true;
}</div>

                <p class="pros"><strong>âœ… ArtÄ±larÄ±:</strong></p>
                <ul>
                    <li><strong>CRON GEREKSIZ!</strong> Her kontrol sÄ±rasÄ±nda otomatik</li>
                    <li>Her zaman Ã§alÄ±ÅŸÄ±r (kullanÄ±cÄ± siteye girdiÄŸinde)</li>
                    <li>Shared hosting'de sorunsuz</li>
                    <li>Kurulum gerektirmez</li>
                </ul>

                <p class="cons"><strong>âŒ Eksileri:</strong></p>
                <ul>
                    <li>KullanÄ±cÄ± siteye girmezse expire olmaz (nadir)</li>
                    <li>Her kontrol sÄ±rasÄ±nda ekstra sorgu (minimal)</li>
                </ul>
            </div>

            <div class="approach middleware">
                <h3 style="color: #f59e0b;">YaklaÅŸÄ±m 3: Middleware (Her Ä°stek)</h3>
                <p>Her HTTP isteÄŸinde arka planda kontrol eder.</p>
                
                <div class="code-block">// app/Http/Middleware/CheckExpiredTrials.php
public function handle($request, Closure $next)
{
    // Sadece auth kullanÄ±cÄ± iÃ§in
    if (auth()-&gt;check()) {
        $user = auth()-&gt;user();
        
        // Trial subscription var mÄ±?
        $trialSubscription = $user-&gt;subscriptions()
            -&gt;whereHas('plan', fn($q) =&gt; $q-&gt;where('is_trial', true))
            -&gt;where('status', 'active')
            -&gt;first();
        
        if ($trialSubscription &amp;&amp; $trialSubscription-&gt;ends_at &lt; now()) {
            $trialSubscription-&gt;update(['status' =&gt; 'expired']);
        }
    }
    
    return $next($request);
}</div>

                <p class="pros"><strong>âœ… ArtÄ±larÄ±:</strong></p>
                <ul>
                    <li>GerÃ§ek zamanlÄ± (her istek)</li>
                    <li>Cron gerektirmez</li>
                    <li>Otomatik Ã§alÄ±ÅŸÄ±r</li>
                </ul>

                <p class="cons"><strong>âŒ Eksileri:</strong></p>
                <ul>
                    <li>Her istekte DB sorgusu (performans)</li>
                    <li>Gereksiz yÃ¼k (her sayfa yÃ¼kleniÅŸinde)</li>
                </ul>
            </div>

            <div class="approach queue">
                <h3 style="color: #8b5cf6;">YaklaÅŸÄ±m 4: Database Scope (AkÄ±llÄ± Sorgu)</h3>
                <p>Database seviyesinde otomatik filtreleme.</p>
                
                <div class="code-block">// Subscription model
public function scopeActive($query)
{
    return $query-&gt;where('status', 'active')
        -&gt;where(function($q) {
            // BitiÅŸ tarihi gelmemiÅŸse VEYA null ise
            $q-&gt;where('ends_at', '&gt;', now())
              -&gt;orWhereNull('ends_at');
        });
}

// KullanÄ±m
$activeSubscriptions = $user-&gt;subscriptions()-&gt;active()-&gt;get();
// BitmiÅŸ trial'lar otomatik filtrelenir!</div>

                <p class="pros"><strong>âœ… ArtÄ±larÄ±:</strong></p>
                <ul>
                    <li>GerÃ§ek zamanlÄ± (sorgu sÄ±rasÄ±nda)</li>
                    <li>Cron gerektirmez</li>
                    <li>PerformanslÄ± (DB seviyesinde)</li>
                </ul>

                <p class="cons"><strong>âŒ Eksileri:</strong></p>
                <ul>
                    <li>Status gÃ¼ncellenmiyor (sadece filtreliyor)</li>
                    <li>Raporlama karÄ±ÅŸÄ±k (status hala active)</li>
                </ul>
            </div>
        </div>

        <!-- KarÅŸÄ±laÅŸtÄ±rma -->
        <div class="section">
            <h2>ğŸ“Š KarÅŸÄ±laÅŸtÄ±rma Tablosu</h2>

            <table>
                <thead>
                    <tr>
                        <th>Ã–zellik</th>
                        <th>Cron Job</th>
                        <th>Lazy Check</th>
                        <th>Middleware</th>
                        <th>DB Scope</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Cron Gerekli mi?</strong></td>
                        <td class="cross">âœ— Evet</td>
                        <td class="check">âœ“ HayÄ±r</td>
                        <td class="check">âœ“ HayÄ±r</td>
                        <td class="check">âœ“ HayÄ±r</td>
                    </tr>
                    <tr>
                        <td><strong>GerÃ§ek ZamanlÄ±</strong></td>
                        <td class="cross">âœ— GÃ¼nde 1</td>
                        <td class="check">âœ“ Kontrol sÄ±rasÄ±nda</td>
                        <td class="check">âœ“ Her istek</td>
                        <td class="check">âœ“ Sorgu sÄ±rasÄ±nda</td>
                    </tr>
                    <tr>
                        <td><strong>Performans</strong></td>
                        <td class="check">âœ“ MÃ¼kemmel</td>
                        <td class="check">âœ“ Ä°yi</td>
                        <td class="cross">âœ— Orta</td>
                        <td class="check">âœ“ Ä°yi</td>
                    </tr>
                    <tr>
                        <td><strong>Status GÃ¼ncelleme</strong></td>
                        <td class="check">âœ“ Evet</td>
                        <td class="check">âœ“ Evet</td>
                        <td class="check">âœ“ Evet</td>
                        <td class="cross">âœ— HayÄ±r</td>
                    </tr>
                    <tr>
                        <td><strong>Shared Hosting</strong></td>
                        <td class="cross">âœ— Sorunlu</td>
                        <td class="check">âœ“ Sorunsuz</td>
                        <td class="check">âœ“ Sorunsuz</td>
                        <td class="check">âœ“ Sorunsuz</td>
                    </tr>
                    <tr>
                        <td><strong>Raporlama</strong></td>
                        <td class="check">âœ“ Net</td>
                        <td class="check">âœ“ Net</td>
                        <td class="check">âœ“ Net</td>
                        <td class="cross">âœ— KarÄ±ÅŸÄ±k</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Hibrit Ã‡Ã¶zÃ¼m -->
        <div class="section">
            <h2>ğŸ¯ Ã–NERÄ°LEN: Hibrit Ã‡Ã¶zÃ¼m</h2>

            <div class="winner">
                <h3>âœ… Lazy Check + Cron Job (Ä°kisini Birlikte Kullan!)</h3>
                <p style="color: #cbd5e1; margin-top: 10px;">
                    En gÃ¼venli yaklaÅŸÄ±m: <strong>Her iki yÃ¶ntemi de kullan!</strong>
                </p>
            </div>

            <div class="comparison">
                <div class="comp-card good">
                    <h4 style="color: #10b981;">ğŸ”¥ Lazy Check (Ana GÃ¼venlik)</h4>
                    <p style="margin-bottom: 15px;">isPremium() metodunda kontrol:</p>
                    <div class="code-block">if ($subscription-&gt;ends_at &lt; now()) {
    $subscription-&gt;update([
        'status' =&gt; 'expired'
    ]);
    return false;
}</div>
                    <p style="margin-top: 15px;"><strong>GÃ¶revi:</strong> KullanÄ±cÄ± siteye girdiÄŸinde otomatik kontrol</p>
                </div>

                <div class="comp-card good">
                    <h4 style="color: #3b82f6;">â° Cron Job (Yedek GÃ¼venlik)</h4>
                    <p style="margin-bottom: 15px;">GÃ¼nlÃ¼k 00:00'da Ã§alÄ±ÅŸan script:</p>
                    <div class="code-block">$schedule-&gt;call(function () {
    Subscription::expireTrials();
})-&gt;daily();</div>
                    <p style="margin-top: 15px;"><strong>GÃ¶revi:</strong> Siteye girmeyen kullanÄ±cÄ±larÄ± da kontrol et</p>
                </div>
            </div>

            <div class="info-box">
                <strong style="color: #60a5fa; display: block; margin-bottom: 15px; font-size: 1.1rem;">ğŸ’¡ Neden Ä°kisi Birlikte?</strong>
                <ul>
                    <li><strong>Lazy Check:</strong> KullanÄ±cÄ± siteye girdiÄŸinde anÄ±nda kontrol (gerÃ§ek zamanlÄ±)</li>
                    <li><strong>Cron Job:</strong> Siteye girmeyen kullanÄ±cÄ±lar iÃ§in yedek (toplu temizlik)</li>
                    <li><strong>Cron Ã§alÄ±ÅŸmazsa:</strong> Lazy check devreye girer, sorun olmaz!</li>
                    <li><strong>KullanÄ±cÄ± girmezse:</strong> Cron job devreye girer, yine sorun olmaz!</li>
                </ul>
            </div>
        </div>

        <!-- Kod Ã–rneÄŸi -->
        <div class="section">
            <h2>ğŸ’» Hibrit Ã‡Ã¶zÃ¼m - Kod Ã–rneÄŸi</h2>

            <h3 style="color: #fbbf24; margin-bottom: 15px;">1. User Model (Lazy Check)</h3>
            <div class="code-block">// app/Models/User.php
public function isPremium(): bool
{
    if (!$this-&gt;isMuzibuTenant()) {
        return false;
    }
    
    $subscription = $this-&gt;subscriptions()
        -&gt;where('status', 'active')
        -&gt;where('ends_at', '&gt;', now()) // BitiÅŸi gelmiÅŸ olanlarÄ± alma!
        -&gt;first();
    
    // ğŸ”¥ LAZY CHECK: BitmiÅŸ ama status active kalanlarÄ± temizle
    $expiredSubscription = $this-&gt;subscriptions()
        -&gt;where('status', 'active')
        -&gt;where('ends_at', '&lt;=', now())
        -&gt;first();
    
    if ($expiredSubscription) {
        $expiredSubscription-&gt;update(['status' =&gt; 'expired']);
    }
    
    return $subscription ? true : false;
}</div>

            <h3 style="color: #fbbf24; margin: 25px 0 15px;">2. Subscription Model (Helper Method)</h3>
            <div class="code-block">// app/Models/Subscription.php
public static function expireTrials()
{
    $expired = self::whereHas('plan', function($q) {
            $q-&gt;where('is_trial', true);
        })
        -&gt;where('status', 'active')
        -&gt;where('ends_at', '&lt;=', now())
        -&gt;get();
    
    foreach ($expired as $subscription) {
        $subscription-&gt;update(['status' =&gt; 'expired']);
        
        // Log
        \Log::info("Trial expired for user: {$subscription-&gt;user_id}");
    }
    
    return $expired-&gt;count();
}</div>

            <h3 style="color: #fbbf24; margin: 25px 0 15px;">3. Cron Job (Yedek)</h3>
            <div class="code-block">// app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    $schedule-&gt;call(function () {
        $count = \App\Models\Subscription::expireTrials();
        \Log::info("Expired {$count} trial subscriptions via cron");
    })-&gt;daily();
}</div>

            <div class="info-box" style="margin-top: 20px;">
                <strong style="color: #60a5fa; display: block; margin-bottom: 10px;">âœ… SonuÃ§:</strong>
                <ul>
                    <li><strong>KullanÄ±cÄ± siteye girer:</strong> Lazy check devreye girer â†’ Trial expire</li>
                    <li><strong>KullanÄ±cÄ± 1 hafta girmez:</strong> Cron job devreye girer â†’ Trial expire</li>
                    <li><strong>Cron Ã§alÄ±ÅŸmaz:</strong> Sorun yok! Lazy check her zaman Ã§alÄ±ÅŸÄ±r</li>
                    <li><strong>KullanÄ±cÄ± hiÃ§ gelmez:</strong> Cron job temizler (Ã¶nemli deÄŸil zaten)</li>
                </ul>
            </div>
        </div>

        <!-- SonuÃ§ -->
        <div class="section">
            <h2>âœ… SON KARAR</h2>

            <div class="winner">
                <h3>ğŸ¯ Hibrit YaklaÅŸÄ±m: Lazy Check + Cron Job</h3>
                <div style="text-align: left; max-width: 700px; margin: 20px auto 0;">
                    <p style="margin-bottom: 15px;"><strong>Ana GÃ¼venlik:</strong> Lazy Check</p>
                    <ul>
                        <li><code>isPremium()</code> metodunda otomatik kontrol</li>
                        <li>KullanÄ±cÄ± siteye girdiÄŸinde anÄ±nda expire</li>
                        <li>Cron olmasa bile Ã§alÄ±ÅŸÄ±r!</li>
                    </ul>

                    <p style="margin: 20px 0 15px;"><strong>Yedek GÃ¼venlik:</strong> Cron Job</p>
                    <ul>
                        <li>GÃ¼nlÃ¼k toplu temizlik</li>
                        <li>Siteye girmeyen kullanÄ±cÄ±larÄ± da temizle</li>
                        <li>Log tutma</li>
                    </ul>

                    <div class="info-box" style="margin-top: 25px;">
                        <p><strong style="color: #60a5fa;">ğŸ’¡ BÃ¶ylece:</strong></p>
                        <ul>
                            <li>âœ… Cron Ã§alÄ±ÅŸsa da Ã§alÄ±ÅŸmasa da sistem gÃ¼venli!</li>
                            <li>âœ… Shared hosting'de sorunsuz!</li>
                            <li>âœ… GerÃ§ek zamanlÄ± expire!</li>
                            <li>âœ… Performans sounu yok!</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            ğŸ¤– Claude AI | ğŸ“… 2025-12-04 | â° Trial Bitirme - Cron Alternatifleri
        </footer>
    </div>
</body>
</html>
