<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Persistence + B2B Sonsuz DÃ¶ngÃ¼ Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.8;
            padding: 40px 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 3rem; color: #1DB954; margin-bottom: 30px; }
        h2 { font-size: 2rem; color: #60a5fa; margin: 40px 0 20px 0; }
        h3 { font-size: 1.5rem; color: #a78bfa; margin: 30px 0 15px 0; }
        .code-block {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
        }
        pre { color: #cbd5e1; font-size: 0.95rem; line-height: 1.6; }
        .highlight { background: rgba(29, 185, 84, 0.2); padding: 2px 6px; border-radius: 4px; color: #1ed760; }
        .critical { background: rgba(239, 68, 68, 0.2); padding: 20px; border-left: 4px solid #ef4444; border-radius: 8px; margin: 20px 0; }
        .success { background: rgba(29, 185, 84, 0.2); padding: 20px; border-left: 4px solid #1DB954; border-radius: 8px; margin: 20px 0; }
        .info { background: rgba(59, 130, 246, 0.2); padding: 20px; border-left: 4px solid #3b82f6; border-radius: 8px; margin: 20px 0; }
        ul, ol { margin: 20px 0; padding-left: 30px; }
        li { margin: 12px 0; }
        .back { display: inline-block; padding: 12px 24px; background: #1DB954; color: #000; text-decoration: none; border-radius: 8px; font-weight: 700; margin-bottom: 30px; }
        .back:hover { background: #1ed760; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back">â† TÃ¼m Ã–zelliklere DÃ¶n</a>

        <h1>ğŸ’¾ Queue Persistence + B2B Sonsuz DÃ¶ngÃ¼</h1>

        <div class="critical">
            <h3>ğŸ”´ MEVCUT DURUM: Queue Kaybolur!</h3>
            <p>Sayfa yenilenince queue sÄ±fÄ±rlanÄ±r. LocalStorage kullanÄ±mÄ± YOK!</p>
        </div>

        <div class="success">
            <h3>âœ… HEDEF: KalÄ±cÄ± Queue + B2B Sonsuz DÃ¶ngÃ¼</h3>
            <ul>
                <li>Queue localStorage'a kaydedilir</li>
                <li>Sayfa yenilenince queue geri yÃ¼klenir</li>
                <li>Queue index (hangi ÅŸarkÄ±da kaldÄ±) kaydedilir</li>
                <li><strong>B2B Sonsuz DÃ¶ngÃ¼:</strong> Queue bittiÄŸinde son ÅŸarkÄ±nÄ±n tÃ¼rÃ¼nden yeni ÅŸarkÄ±lar yÃ¼kle!</li>
            </ul>
        </div>

        <h2>ğŸ¢ B2B KullanÄ±m Senaryosu</h2>

        <div class="info">
            <h3>ğŸ“– Senaryo:</h3>
            <ol>
                <li><strong>Sabah 08:00:</strong> Cafe/restoran PC'sini aÃ§ar</li>
                <li><strong>08:05:</strong> muzibu.com'a girer, login olur</li>
                <li><strong>08:10:</strong> Bir playlist baÅŸlatÄ±r (Ã¶rn: "KahvaltÄ± Jazz" - 50 ÅŸarkÄ±)</li>
                <li><strong>08:10 - 23:00:</strong> HiÃ§bir mÃ¼dahale YAPILMADAN mÃ¼zik Ã§almaya devam eder!</li>
                <li><strong>Liste BittiÄŸinde (Ã¶rn: 12:00):</strong> Sistem otomatik olarak son ÅŸarkÄ±nÄ±n tÃ¼rÃ¼nden (Jazz) yeni ÅŸarkÄ±lar yÃ¼kler</li>
                <li><strong>Sonsuz DÃ¶ngÃ¼:</strong> Bu ÅŸekilde gÃ¼n boyu mÃ¼zik hiÃ§ kesilmez!</li>
            </ol>
        </div>

        <h2>ğŸ”§ Ä°mplementasyon</h2>

        <h3>1. Queue Storage Class</h3>
        <div class="code-block">
<pre>// storage.js
class QueueStorage {
    constructor(store) {
        this.store = store;
        this.STORAGE_KEY = 'muzibu_queue_state';
    }

    // Queue + state'i kaydet
    save() {
        const state = {
            queue: this.store.queue,
            queueIndex: this.store.queueIndex,
            currentSong: this.store.currentSong,
            currentTime: this.store.currentTime, // Nerede kaldÄ±
            volume: this.store.volume,
            repeatMode: this.store.repeatMode,
            isShuffled: this.store.isShuffled,
            lastUpdated: Date.now()
        };

        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
            console.log('Queue saved:', state.queue.length, 'songs');
        } catch (e) {
            console.error('Failed to save queue:', e);
        }
    }

    // Queue'yu geri yÃ¼kle
    restore() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (!saved) return false;

            const state = JSON.parse(saved);

            // 7 gÃ¼nden eski ise sil
            const AGE_LIMIT = 7 * 24 * 60 * 60 * 1000; // 7 gÃ¼n
            if (Date.now() - state.lastUpdated > AGE_LIMIT) {
                this.clear();
                return false;
            }

            // State'i restore et
            Object.assign(this.store, state);

            console.log('Queue restored:', state.queue.length, 'songs');
            return true;
        } catch (e) {
            console.error('Failed to restore queue:', e);
            return false;
        }
    }

    clear() {
        localStorage.removeItem(this.STORAGE_KEY);
    }
}</pre>
        </div>

        <h3>2. Auto-Save (Her DeÄŸiÅŸiklikte)</h3>
        <div class="code-block">
<pre>// Alpine.js watch ile otomatik kaydet
Alpine.effect(() => {
    // Queue deÄŸiÅŸtiÄŸinde kaydet
    const queue = this.queue;
    const queueIndex = this.queueIndex;

    // Debounce ile 1 saniye sonra kaydet (Ã§ok sÄ±k kaydetme)
    clearTimeout(this._saveTimeout);
    this._saveTimeout = setTimeout(() => {
        queueStorage.save();
    }, 1000);
});</pre>
        </div>

        <h3>3. B2B Sonsuz DÃ¶ngÃ¼ - Genre-Based Auto Continue</h3>
        <div class="code-block">
<pre>// ÅarkÄ± bittiÄŸinde kontrol et
async onTrackEnded() {
    // Normal repeat logic
    if (this.repeatMode === 'one') {
        this.playSongFromQueue(this.queueIndex);
        return;
    }

    // Queue'da sonraki ÅŸarkÄ± var mÄ±?
    if (this.queueIndex < this.queue.length - 1) {
        this.nextTrack();
        return;
    }

    // QUEUE BÄ°TTÄ°!
    if (this.repeatMode === 'all') {
        // Repeat all ise baÅŸa dÃ¶n
        this.queueIndex = 0;
        this.playSongFromQueue(0);
    } else {
        // B2B SONSUZ DÃ–NGÃœ - Son ÅŸarkÄ±nÄ±n tÃ¼rÃ¼nden yeni ÅŸarkÄ±lar yÃ¼kle!
        await this.loadMoreByGenre();
    }
}

// Son ÅŸarkÄ±nÄ±n tÃ¼rÃ¼nden yeni ÅŸarkÄ±lar yÃ¼kle
async loadMoreByGenre() {
    const lastSong = this.queue[this.queue.length - 1];
    if (!lastSong) return;

    // Son ÅŸarkÄ±nÄ±n genre'sini al
    const genre = lastSong.genre || lastSong.genre_id;

    console.log('ğŸ”„ Queue bitti! Genre bazlÄ± devam:', genre);

    try {
        // Genre'ye gÃ¶re yeni ÅŸarkÄ±lar yÃ¼kle (50 ÅŸarkÄ±)
        const response = await fetch(`/api/muzibu/songs/by-genre/${genre}?limit=50`);
        const newSongs = await response.json();

        if (newSongs.length > 0) {
            // Mevcut queue'ya ekle (shuffle yaparak)
            const shuffled = this.shuffleArray(newSongs);
            this.queue.push(...shuffled);

            // Devam et
            this.queueIndex++;
            await this.playSongFromQueue(this.queueIndex);

            // Queue'yu kaydet
            queueStorage.save();

            console.log(`âœ… ${shuffled.length} yeni ${genre} ÅŸarkÄ±sÄ± eklendi!`);
            this.showToast(`${shuffled.length} yeni ÅŸarkÄ± yÃ¼klendi - mÃ¼zik devam ediyor!`, 'success');
        } else {
            // Genre'den ÅŸarkÄ± bulunamadÄ±, rastgele popÃ¼ler ÅŸarkÄ±lar yÃ¼kle
            await this.loadRandomPopular();
        }
    } catch (error) {
        console.error('Genre-based load failed:', error);
        // Fallback: Rastgele popÃ¼ler ÅŸarkÄ±lar
        await this.loadRandomPopular();
    }
}

// Fallback: Rastgele popÃ¼ler ÅŸarkÄ±lar
async loadRandomPopular() {
    const response = await fetch('/api/muzibu/songs/popular?limit=50');
    const songs = await response.json();
    const shuffled = this.shuffleArray(songs);
    this.queue.push(...shuffled);
    this.queueIndex++;
    await this.playSongFromQueue(this.queueIndex);
    queueStorage.save();
}

// Fisher-Yates shuffle
shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}</pre>
        </div>

        <h3>4. Sayfa YÃ¼klendiÄŸinde Restore</h3>
        <div class="code-block">
<pre>// Alpine.js init
init() {
    console.log('Muzibu Player initializing...');

    // Queue'yu geri yÃ¼kle
    const restored = queueStorage.restore();

    if (restored && this.queue.length > 0) {
        console.log('âœ… Queue restored:', this.queue.length, 'songs');

        // KullanÄ±cÄ±ya bildir
        this.showToast(`KaldÄ±ÄŸÄ±nÄ±z yerden devam ediliyor (${this.queue.length} ÅŸarkÄ±)`, 'info');

        // Otomatik Ã§almaya devam et (opsiyonel)
        // setTimeout(() => {
        //     this.playSongFromQueue(this.queueIndex);
        // }, 1000);
    } else {
        console.log('â„¹ï¸ No saved queue, starting fresh');
    }
}</pre>
        </div>

        <h2>ğŸ“Š Veri YapÄ±sÄ± (localStorage)</h2>
        <div class="code-block">
<pre>{
    "queue": [
        {
            "song_id": 123,
            "song_title": { "tr": "Smooth Jazz Morning" },
            "artist_title": { "tr": "Jazz Ensemble" },
            "album_cover": "https://...",
            "genre": "Jazz", // â† GENRE Ã–NEMLI!
            "genre_id": 5,
            "duration": 240
        },
        // ... 49 ÅŸarkÄ± daha
    ],
    "queueIndex": 12,  // â† 12. ÅŸarkÄ±da kaldÄ±
    "currentSong": { /* ... */ },
    "currentTime": 45,  // â† 45. saniyede kaldÄ±
    "volume": 100,
    "repeatMode": "off",
    "isShuffled": false,
    "lastUpdated": 1732708123000
}</pre>
        </div>

        <h2>ğŸ¯ B2B Scenario Flow</h2>
        <div class="info">
            <h3>ğŸ“ˆ Zaman Ã‡izelgesi:</h3>
            <ul>
                <li><strong>08:10:</strong> 50 ÅŸarkÄ±lÄ±k "KahvaltÄ± Jazz" playlist baÅŸlatÄ±ldÄ±</li>
                <li><strong>11:30:</strong> Queue bitti (50 ÅŸarkÄ± tamamlandÄ±)</li>
                <li><strong>11:30:</strong> Sistem otomatik olarak "Jazz" genre'sinden 50 yeni ÅŸarkÄ± yÃ¼kledi</li>
                <li><strong>15:00:</strong> 2. queue bitti</li>
                <li><strong>15:00:</strong> Yine "Jazz" tÃ¼rÃ¼nden 50 yeni ÅŸarkÄ± yÃ¼klendi</li>
                <li><strong>18:30:</strong> 3. queue bitti</li>
                <li><strong>18:30:</strong> DÃ¶ngÃ¼ devam ediyor...</li>
                <li><strong>23:00:</strong> Restoran kapandÄ±, PC kapatÄ±ldÄ±</li>
                <li><strong>SONRAKI GÃœN 08:10:</strong> Sayfa aÃ§Ä±ldÄ± â†’ Queue restore edildi â†’ KaldÄ±ÄŸÄ± yerden devam!</li>
            </ul>
        </div>

        <h2>âœ… Avantajlar</h2>
        <ul>
            <li>âœ… <span class="highlight">MÃ¼dahale Gerektirmez:</span> GÃ¼n boyu hiÃ§ dokunmana gerek yok!</li>
            <li>âœ… <span class="highlight">Genre TutarlÄ±lÄ±ÄŸÄ±:</span> MÃ¼zik atmosferi bozulmaz (Jazz devam eder)</li>
            <li>âœ… <span class="highlight">Sayfa Yenilenirse:</span> Queue kaybolmaz, kaldÄ±ÄŸÄ± yerden devam!</li>
            <li>âœ… <span class="highlight">Elektrik Kesintisi:</strong> PC yeniden aÃ§Ä±ldÄ±ÄŸÄ±nda queue geri yÃ¼klenir</li>
            <li>âœ… <span class="highlight">7 GÃ¼n GeÃ§erli:</span> Eski queue'lar otomatik temizlenir</li>
        </ul>

        <h2>âš™ï¸ KullanÄ±cÄ± Kontrolleri</h2>
        <div class="code-block">
<pre>// KullanÄ±cÄ± ayarlarÄ± (localStorage)
const b2bSettings = {
    autoLoadMore: true,          // Queue bitince otomatik yÃ¼kle
    genreBasedContinue: true,    // Genre bazlÄ± devam et
    autoPlayOnRestore: false     // Restore sonrasÄ± otomatik Ã§al (opsiyonel)
};</pre>
        </div>

        <p style="margin-top: 40px; text-align: center; color: #64748b;">
            <a href="index.html" class="back">â† TÃ¼m Ã–zelliklere DÃ¶n</a>
        </p>
    </div>
</body>
</html>
