<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¢ Multi-Tenant Sistemde N+1 Ã‡Ã¶zÃ¼mleri</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-border: 2px solid #334155;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .alert {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 40px;
            border-left: 6px solid #fef3c7;
        }

        .alert h2 {
            color: #fef3c7;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .alert p {
            color: #fef3c7;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        section {
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .problem-box {
            background: rgba(239, 68, 68, 0.15);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #ef4444;
            backdrop-filter: blur(10px);
        }

        .solution-box {
            background: rgba(34, 197, 94, 0.15);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #22c55e;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .solution-box:hover {
            transform: translateX(5px);
            background: rgba(34, 197, 94, 0.25);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.15);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            backdrop-filter: blur(10px);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.15);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
            backdrop-filter: blur(10px);
        }

        .code-block {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            border: 1px solid #334155;
        }

        .code-block code {
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .code-block.bad {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .code-block.good {
            border-left: 4px solid #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-item {
            padding: 20px;
            border-radius: 8px;
        }

        .comparison-item.before {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid #ef4444;
        }

        .comparison-item.after {
            background: rgba(34, 197, 94, 0.15);
            border: 2px solid #22c55e;
        }

        .tenant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .tenant-card {
            background: rgba(30, 41, 59, 0.5);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            backdrop-filter: blur(10px);
        }

        .tenant-card h4 {
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .tech-term {
            color: #fbbf24;
            font-weight: 500;
        }

        .explanation {
            display: inline-block;
            margin-left: 5px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        ul li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }

        ul li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #60a5fa;
            font-weight: bold;
        }

        .step-number {
            display: inline-block;
            background: #f59e0b;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: 700;
            margin-right: 10px;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¢ Multi-Tenant Sistemde N+1 Ã‡Ã¶zÃ¼mleri</h1>
            <div class="meta">
                ğŸ“… Tarih: 2025-11-30 |
                ğŸ¯ Konu: Tenant BazlÄ± Cache & N+1 Optimizasyonu |
                ğŸ¢ Sistem: Multi-Tenant (tuufi.com)
            </div>
        </header>

        <div class="alert">
            <h2>ğŸš¨ KRÄ°TÄ°K: Tenant BazlÄ± Cache Zorunlu!</h2>
            <p>
                Multi-tenant sistemde <strong>her tenant'Ä±n verisi ayrÄ±</strong> tutulmalÄ±!
                Tenant 1'in cache'i Tenant 2'ye karÄ±ÅŸmamalÄ±. Aksi halde <strong>veri sÄ±zÄ±ntÄ±sÄ±</strong> olur!
            </p>
        </div>

        <section>
            <h2>ğŸ¢ Sistemimiz: Multi-Tenant YapÄ±sÄ±</h2>

            <div class="tenant-grid">
                <div class="tenant-card">
                    <h4>ğŸ¢ Tenant 1 - tuufi.com</h4>
                    <ul>
                        <li>Central sistem</li>
                        <li>Ana tenant</li>
                        <li>Database: tuufi_4ekim</li>
                    </ul>
                </div>

                <div class="tenant-card">
                    <h4>ğŸ­ Tenant 2 - ixtif.com</h4>
                    <ul>
                        <li>EndÃ¼striyel ekipman</li>
                        <li>Forklift, transpalet</li>
                        <li>Database: tenant_ixtif</li>
                    </ul>
                </div>

                <div class="tenant-card">
                    <h4>ğŸµ Tenant 1001 - muzibu.com</h4>
                    <ul>
                        <li>MÃ¼zik platformu</li>
                        <li>Song, album, artist</li>
                        <li>Database: tenant_muzibu_1528d0</li>
                    </ul>
                </div>
            </div>

            <div class="warning-box">
                <h3>âš ï¸ Tenant Ä°zolasyonu Zorunlu!</h3>
                <p>
                    Her tenant'Ä±n verisi <strong>tamamen izole</strong> olmalÄ±:
                </p>
                <ul>
                    <li>Tenant 2'nin settings'leri Tenant 1001'e gÃ¶sterilmemeli</li>
                    <li>Cache key'leri tenant ID ile ayrÄ±lmalÄ±</li>
                    <li>Database query'leri tenant bazlÄ± olmalÄ±</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>ğŸ” Tenant BazlÄ± N+1 Problemi</h2>

            <div class="problem-box">
                <h3>âŒ YANLIÅ: Tenant FarkÄ±ndasÄ±z Cache</h3>
                <div class="code-block bad">
                    <code>// âŒ TEHLÄ°KELÄ°! Tenant ID yok!
function setting($key) {
    return cache()->rememberForever('settings', function () {
        return Setting::pluck('value', 'key');
    })[$key] ?? null;
}

<span style="color: #ef4444;">// SORUN:</span>
<span style="color: #ef4444;">// Tenant 2 (ixtif.com) cache'ledi: site_title = "Ä°xtif"</span>
<span style="color: #ef4444;">// Tenant 1001 (muzibu.com) okudu: "Ä°xtif" (YANLIÅ!)</span>
<span style="color: #ef4444;">// Muzibu'nun kendi title'Ä± "Muzibu" olmalÄ±ydÄ±!</span></code>
                </div>

                <p style="margin-top: 15px;"><strong>SonuÃ§:</strong></p>
                <ul>
                    <li>ğŸš¨ Veri karÄ±ÅŸmasÄ± (data leakage)</li>
                    <li>ğŸš¨ Tenant 1001'de Tenant 2'nin verileri gÃ¶rÃ¼nÃ¼r</li>
                    <li>ğŸš¨ GÃ¼venlik aÃ§Ä±ÄŸÄ±!</li>
                    <li>ğŸš¨ HatalÄ± iÃ§erik gÃ¶sterimi</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>âœ… DOÄRU: Tenant-Aware Cache</h3>
                <div class="code-block good">
                    <code>// âœ… GÃœVENLÄ°! Tenant ID ile cache
function setting($key) {
    $tenantId = tenant()?->id ?? 'central';

    return cache()->rememberForever("settings_tenant_{$tenantId}", function () {
        return Setting::pluck('value', 'key');
    })[$key] ?? null;
}

<span style="color: #22c55e;">// SONUÃ‡:</span>
<span style="color: #22c55e;">// Tenant 2: settings_tenant_2 â†’ "Ä°xtif"</span>
<span style="color: #22c55e;">// Tenant 1001: settings_tenant_1001 â†’ "Muzibu"</span>
<span style="color: #22c55e;">// Her tenant kendi verisini gÃ¶rÃ¼r! âœ…</span></code>
                </div>

                <p style="margin-top: 15px;"><strong>Avantajlar:</strong></p>
                <ul>
                    <li>âœ… Tenant izolasyonu saÄŸlanÄ±r</li>
                    <li>âœ… Veri karÄ±ÅŸmasÄ± olmaz</li>
                    <li>âœ… Her tenant kendi cache'ini kullanÄ±r</li>
                    <li>âœ… GÃ¼venli ve hÄ±zlÄ±</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>ğŸ› ï¸ Tenant BazlÄ± Cache Stratejileri</h2>

            <div class="solution-box">
                <h3><span class="step-number">1</span> Cache Key'e Tenant ID Ekle</h3>
                <p>
                    En basit ve etkili yÃ¶ntem: Cache key'ine tenant ID'yi dahil et.
                </p>

                <div class="code-block good">
                    <code>// Strateji 1: Cache key'e tenant ID ekle
function setting($key) {
    $tenantId = tenant()?->id ?? 'central';
    $cacheKey = "settings_tenant_{$tenantId}";

    return cache()->rememberForever($cacheKey, function () {
        return Setting::pluck('value', 'key');
    })[$key] ?? null;
}</code>
                </div>
            </div>

            <div class="solution-box">
                <h3><span class="step-number">2</span> Tenant Scope ile Otomatik Filtreleme</h3>
                <p>
                    Model'de tenant scope tanÄ±mla, otomatik filtreleme yap.
                </p>

                <div class="code-block good">
                    <code>// Setting Model
class Setting extends Model
{
    // Otomatik tenant filtreleme
    protected static function booted()
    {
        static::addGlobalScope('tenant', function ($query) {
            if ($tenantId = tenant()?->id) {
                $query->where('tenant_id', $tenantId);
            }
        });
    }
}

// ArtÄ±k tÃ¼m query'ler otomatik tenant filtreli
$settings = Setting::all(); // Sadece mevcut tenant'Ä±n settings'leri</code>
                </div>
            </div>

            <div class="solution-box">
                <h3><span class="step-number">3</span> Redis Tag'ler ile Tenant Cache</h3>
                <p>
                    Redis tag sistemi kullanarak tenant bazlÄ± cache yÃ¶netimi.
                </p>

                <div class="code-block good">
                    <code>// Redis tag'ler ile cache
function setting($key) {
    $tenantId = tenant()?->id ?? 'central';

    return cache()->tags(["tenant_{$tenantId}", 'settings'])
        ->rememberForever('all_settings', function () {
            return Setting::pluck('value', 'key');
        })[$key] ?? null;
}

// Tenant deÄŸiÅŸtiÄŸinde sadece o tenant'Ä±n cache'ini temizle
cache()->tags("tenant_2")->flush(); // Sadece Tenant 2'nin cache'i temizlenir</code>
                </div>
            </div>

            <div class="solution-box">
                <h3><span class="step-number">4</span> AppServiceProvider'da Global Cache</h3>
                <p>
                    Request baÅŸÄ±nda tÃ¼m settings'leri yÃ¼kle, tenant-aware olarak.
                </p>

                <div class="code-block good">
                    <code>// app/Providers/AppServiceProvider.php
public function boot()
{
    // Tenant context'i hazÄ±r olduÄŸunda
    if (app()->bound('currentTenant')) {
        $tenantId = tenant()?->id ?? 'central';

        // Tenant'a Ã¶zel settings'leri cache'le
        config([
            'tenant_settings' => cache()->rememberForever(
                "settings_tenant_{$tenantId}",
                fn() => Setting::pluck('value', 'key')->toArray()
            )
        ]);
    }
}

// Helper fonksiyonu
function setting($key, $default = null) {
    return config("tenant_settings.{$key}", $default);
}</code>
                </div>
            </div>

            <div class="solution-box">
                <h3><span class="step-number">5</span> Middleware ile Tenant Cache YÃ¼kleme</h3>
                <p>
                    Tenant belirlendikten sonra cache'i yÃ¼kle.
                </p>

                <div class="code-block good">
                    <code>// app/Http/Middleware/LoadTenantSettings.php
class LoadTenantSettings
{
    public function handle($request, Closure $next)
    {
        if ($tenant = tenant()) {
            $cacheKey = "settings_tenant_{$tenant->id}";

            $settings = cache()->rememberForever($cacheKey, function () {
                return Setting::pluck('value', 'key');
            });

            // Request iÃ§in share et
            view()->share('settings', $settings);
            config(['app.tenant_settings' => $settings]);
        }

        return $next($request);
    }
}</code>
                </div>
            </div>
        </section>

        <section>
            <h2>âš ï¸ Tenant BazlÄ± Cache Dikkat Edilecekler</h2>

            <div class="warning-box">
                <h3>1. Cache Key Collision (Ã‡akÄ±ÅŸma)</h3>
                <p>
                    Tenant ID olmadan cache key'leri Ã§akÄ±ÅŸÄ±r!
                </p>

                <div class="code-block bad">
                    <code>// âŒ YANLIÅ: Tenant ID yok, key Ã§akÄ±ÅŸÄ±r
cache()->get('user_preferences')

// Her tenant iÃ§in aynÄ± key! Veri karÄ±ÅŸÄ±r!</code>
                </div>

                <div class="code-block good">
                    <code>// âœ… DOÄRU: Tenant ID ile unique key
$tenantId = tenant()->id;
cache()->get("tenant_{$tenantId}_user_preferences")</code>
                </div>
            </div>

            <div class="warning-box">
                <h3>2. Cache Temizleme (Flush)</h3>
                <p>
                    TÃ¼m cache'i temizleme, tÃ¼m tenant'larÄ± etkiler!
                </p>

                <div class="code-block bad">
                    <code>// âŒ TEHLÄ°KELÄ°: TÃ¼m tenant'larÄ±n cache'i uÃ§ar!
cache()->flush();</code>
                </div>

                <div class="code-block good">
                    <code>// âœ… GÃœVENLÄ°: Sadece mevcut tenant'Ä±n cache'i temizlenir
$tenantId = tenant()->id;
cache()->forget("settings_tenant_{$tenantId}");

// veya Redis tag ile
cache()->tags("tenant_{$tenantId}")->flush();</code>
                </div>
            </div>

            <div class="warning-box">
                <h3>3. Tenant Context KontrolÃ¼</h3>
                <p>
                    Tenant context'i yoksa hata vermemeli, fallback olmalÄ±.
                </p>

                <div class="code-block good">
                    <code>// âœ… DOÄRU: Tenant yoksa central kullan
$tenantId = tenant()?->id ?? 'central';
$cacheKey = "settings_{$tenantId}";

// veya tenant yoksa cache kullanma
if ($tenant = tenant()) {
    $cacheKey = "settings_tenant_{$tenant->id}";
    $settings = cache()->get($cacheKey);
} else {
    // Central sistem, cache'siz Ã§alÄ±ÅŸ
    $settings = Setting::pluck('value', 'key');
}</code>
                </div>
            </div>

            <div class="warning-box">
                <h3>4. Global Scope ile Eager Loading</h3>
                <p>
                    Tenant scope varsa, eager loading otomatik filtrelidir.
                </p>

                <div class="code-block good">
                    <code>// Setting Model'de global scope var
protected static function booted()
{
    static::addGlobalScope('tenant', function ($query) {
        if ($tenant = tenant()) {
            $query->where('tenant_id', $tenant->id);
        }
    });
}

// ArtÄ±k with() otomatik tenant filtreli
$blogs = Blog::with('settings')->get(); // Sadece mevcut tenant'Ä±n settings'leri</code>
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ¯ Bizim Sistem Ä°Ã§in Ã–nerilen Ã‡Ã¶zÃ¼m</h2>

            <div class="solution-box">
                <h3>âœ… Settings Helper - Tenant-Aware Cache</h3>
                <p>
                    <code>Modules/SettingManagement/app/Helpers/setting_helpers.php</code>
                </p>

                <div class="code-block good">
                    <code>if (!function_exists('setting')) {
    /**
     * Tenant-aware settings helper
     *
     * @param string $key
     * @param mixed $default
     * @return mixed
     */
    function setting(string $key, $default = null)
    {
        // Tenant ID al (yoksa central)
        $tenantId = tenant()?->id ?? 'central';

        // Tenant bazlÄ± cache key
        $cacheKey = "settings_tenant_{$tenantId}";

        // Cache'den al veya yÃ¼kle
        $settings = cache()->rememberForever($cacheKey, function () {
            return \Modules\SettingManagement\App\Models\Setting::query()
                ->with('values')
                ->where('is_active', 1)
                ->get()
                ->pluck('value', 'key');
        });

        return $settings[$key] ?? $default;
    }
}

// Cache temizleme fonksiyonu
if (!function_exists('flush_tenant_settings_cache')) {
    function flush_tenant_settings_cache()
    {
        $tenantId = tenant()?->id ?? 'central';
        cache()->forget("settings_tenant_{$tenantId}");
    }
}</code>
                </div>

                <p style="margin-top: 15px;"><strong>KullanÄ±m:</strong></p>
                <div class="code-block">
                    <code>// Tenant 2 (ixtif.com)
setting('site_title'); // "Ä°xtif" (cache: settings_tenant_2)

// Tenant 1001 (muzibu.com)
setting('site_title'); // "Muzibu" (cache: settings_tenant_1001)

// Settings deÄŸiÅŸtiÄŸinde cache temizle
flush_tenant_settings_cache();</code>
                </div>
            </div>
        </section>

        <section>
            <h2>ğŸ“Š Performans KarÅŸÄ±laÅŸtÄ±rmasÄ±</h2>

            <div class="comparison">
                <div class="comparison-item before">
                    <h3>âŒ ÅÄ°MDÄ° (Cache Yok)</h3>
                    <ul>
                        <li>site_title â†’ 1 query</li>
                        <li>site_logo â†’ 1 query</li>
                        <li>site_name â†’ 1 query</li>
                        <li>site_title â†’ 1 query (duplicate!)</li>
                        <li><strong>Toplam: 4 query (1 duplicate)</strong></li>
                    </ul>
                </div>

                <div class="comparison-item after">
                    <h3>âœ… TENANT-AWARE CACHE</h3>
                    <ul>
                        <li>Ä°lk Ã§aÄŸrÄ± â†’ 1 query (tÃ¼mÃ¼ cache'lenir)</li>
                        <li>site_title â†’ 0 query (cache)</li>
                        <li>site_logo â†’ 0 query (cache)</li>
                        <li>site_name â†’ 0 query (cache)</li>
                        <li><strong>Toplam: 1 query, 0 duplicate</strong></li>
                    </ul>
                </div>
            </div>

            <div class="info-box">
                <h3>ğŸ¯ Beklenen Ä°yileÅŸme</h3>
                <ul>
                    <li>Query SayÄ±sÄ±: 89 â†’ ~10 (%90 azalma)</li>
                    <li>Duplicate Query: 74 â†’ 0 (%100 azalma)</li>
                    <li>Query SÃ¼resi: 214ms â†’ ~50ms (%75 azalma)</li>
                    <li>Sayfa YÃ¼kleme: 4.5s â†’ ~2s (2x hÄ±zlanma)</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>âœ… Uygulama AdÄ±mlarÄ±</h2>

            <div class="solution-box">
                <h3>AdÄ±m 1: setting_helpers.php DosyasÄ±nÄ± GÃ¼ncelle</h3>
                <ul>
                    <li>Tenant ID ekle</li>
                    <li>Cache key tenant bazlÄ± yap</li>
                    <li>Cache temizleme fonksiyonu ekle</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>AdÄ±m 2: Test Et</h3>
                <ul>
                    <li>Tenant 2'de homepage aÃ§ â†’ cache oluÅŸsun</li>
                    <li>Tenant 1001'de homepage aÃ§ â†’ ayrÄ± cache oluÅŸsun</li>
                    <li>a-html.txt kontrolÃ¼: query sayÄ±sÄ± dÃ¼ÅŸmeli</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>AdÄ±m 3: Cache Temizleme Event'i Ekle</h3>
                <ul>
                    <li>Setting kaydedildiÄŸinde cache temizlensin</li>
                    <li>Observer veya Event kullan</li>
                </ul>

                <div class="code-block good">
                    <code>// Setting Model Observer
class SettingObserver
{
    public function saved(Setting $setting)
    {
        flush_tenant_settings_cache();
    }
}</code>
                </div>
            </div>
        </section>

        <footer>
            ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu | 2025-11-30
        </footer>
    </div>
</body>
</html>
