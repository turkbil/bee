<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muzibu Session & Auth Sistemi - Tam DokÃ¼mantasyon</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-12">
        <!-- Header -->
        <header class="mb-16 pb-8 border-b border-slate-700">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                ğŸ” Muzibu Session & Auth Sistemi
            </h1>
            <div class="text-slate-400 text-lg">
                Tam DokÃ¼mantasyon: Login, Session, Device Limit, Redis, Database
            </div>
            <div class="mt-4 flex gap-4 text-sm text-slate-500">
                <span>ğŸ“… 2025-12-10</span>
                <span>ğŸ¯ Tenant: muzibu.com.tr</span>
            </div>
        </header>

        <!-- Ä°Ã§indekiler -->
        <nav class="mb-12 bg-slate-800/50 rounded-lg p-6 border border-slate-700">
            <h2 class="text-xl font-bold mb-4 text-blue-400">ğŸ“‘ Ä°Ã§indekiler</h2>
            <ul class="grid md:grid-cols-2 gap-2 text-slate-300">
                <li><a href="#overview" class="hover:text-blue-400">1. Genel BakÄ±ÅŸ (Basit AnlatÄ±m)</a></li>
                <li><a href="#storage" class="hover:text-blue-400">2. Veriler Nereye Kaydediliyor?</a></li>
                <li><a href="#redis" class="hover:text-blue-400">3. Redis Ne YapÄ±yor?</a></li>
                <li><a href="#database" class="hover:text-blue-400">4. Database Ne YapÄ±yor?</a></li>
                <li><a href="#login-flow" class="hover:text-blue-400">5. Login AkÄ±ÅŸÄ±</a></li>
                <li><a href="#logout-flow" class="hover:text-blue-400">6. Logout AkÄ±ÅŸÄ±</a></li>
                <li><a href="#device-limit" class="hover:text-blue-400">7. Cihaz Limiti (LIFO)</a></li>
                <li><a href="#kick-user" class="hover:text-blue-400">8. KullanÄ±cÄ±yÄ± NasÄ±l Ã‡Ä±karÄ±rÄ±z?</a></li>
                <li><a href="#stream-flow" class="hover:text-blue-400">9. ÅarkÄ± Dinleme AkÄ±ÅŸÄ±</a></li>
                <li><a href="#issues" class="hover:text-blue-400">10. Mevcut Sorunlar</a></li>
            </ul>
        </nav>

        <!-- 1. Genel BakÄ±ÅŸ -->
        <section id="overview" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">1. Genel BakÄ±ÅŸ (Basit AnlatÄ±m)</h2>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700 mb-6">
                <h3 class="text-xl font-bold mb-4 text-green-400">ğŸ¯ Ne Ä°ÅŸe YarÄ±yor?</h3>
                <div class="space-y-4 text-slate-300">
                    <p><strong class="text-white">Session sistemi</strong> = KullanÄ±cÄ±nÄ±n kim olduÄŸunu takip etme</p>
                    <p><strong class="text-white">Device limit</strong> = AynÄ± anda kaÃ§ cihazda mÃ¼zik dinleyebileceÄŸini kontrol etme</p>
                    <p><strong class="text-white">LIFO (Last In First Out)</strong> = Yeni giriÅŸ yapan, eski giriÅŸi atar</p>
                </div>
            </div>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <h3 class="text-xl font-bold mb-4 text-yellow-400">ğŸ”„ Basit AkÄ±ÅŸ</h3>
                <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="px-3 py-2 bg-blue-600 rounded">KullanÄ±cÄ± Login</span>
                    <span class="text-slate-500">â†’</span>
                    <span class="px-3 py-2 bg-purple-600 rounded">Redis'e Session</span>
                    <span class="text-slate-500">â†’</span>
                    <span class="px-3 py-2 bg-green-600 rounded">DB'ye KayÄ±t</span>
                    <span class="text-slate-500">â†’</span>
                    <span class="px-3 py-2 bg-orange-600 rounded">Cookie'ye ID</span>
                    <span class="text-slate-500">â†’</span>
                    <span class="px-3 py-2 bg-red-600 rounded">MÃ¼zik Dinle!</span>
                </div>
            </div>
        </section>

        <!-- 2. Veriler Nereye Kaydediliyor -->
        <section id="storage" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">2. Veriler Nereye Kaydediliyor?</h2>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Redis -->
                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-red-500">
                    <h3 class="text-xl font-bold mb-4 text-red-400">ğŸ”´ Redis</h3>
                    <ul class="space-y-2 text-sm text-slate-300">
                        <li>âœ… Session verisi (kullanÄ±cÄ± bilgisi)</li>
                        <li>âœ… CSRF token</li>
                        <li>âœ… Flash messages</li>
                        <li>âœ… GeÃ§ici cache</li>
                    </ul>
                    <p class="mt-4 text-xs text-slate-500">
                        <strong>TTL:</strong> 10080 dakika (7 gÃ¼n)<br>
                        <strong>Key format:</strong> 40 karakter alphanumeric
                    </p>
                </div>

                <!-- Database -->
                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-blue-500">
                    <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ”µ Database</h3>
                    <ul class="space-y-2 text-sm text-slate-300">
                        <li>âœ… <code>user_active_sessions</code> tablosu</li>
                        <li>âœ… Cihaz bilgisi (browser, platform)</li>
                        <li>âœ… IP adresi</li>
                        <li>âœ… Son aktivite zamanÄ±</li>
                    </ul>
                    <p class="mt-4 text-xs text-slate-500">
                        <strong>Tablo:</strong> tenant_muzibu_1528d0.user_active_sessions<br>
                        <strong>KullanÄ±m:</strong> Device limit kontrolÃ¼
                    </p>
                </div>

                <!-- Cookie -->
                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-green-500">
                    <h3 class="text-xl font-bold mb-4 text-green-400">ğŸŸ¢ Cookie</h3>
                    <ul class="space-y-2 text-sm text-slate-300">
                        <li>âœ… Session ID (40 karakter)</li>
                        <li>âœ… XSRF-TOKEN</li>
                        <li>âœ… HttpOnly flag</li>
                        <li>âœ… Secure flag</li>
                    </ul>
                    <p class="mt-4 text-xs text-slate-500">
                        <strong>Cookie adÄ±:</strong> tuufi_session<br>
                        <strong>Åifreleme:</strong> Laravel encrypt
                    </p>
                </div>
            </div>
        </section>

        <!-- 3. Redis Ne YapÄ±yor -->
        <section id="redis" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">3. Redis Ne YapÄ±yor?</h2>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 text-red-400">ğŸ“¦ Redis'te Saklanan</h3>
                        <pre class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
Key: AKmX6ilTCPbot7IukdA8H3NblqBNmXp4qfJfcPKN

Value: {
  "_token": "csrf_token_here",
  "_previous": {"url": "https://muzibu.com.tr"},
  "login_web_...": 1,  // User ID
  "password_hash_web_...": "hash"
}</pre>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 text-green-400">âœ… Redis'in GÃ¶revi</h3>
                        <ul class="space-y-2 text-slate-300">
                            <li>â€¢ <strong>HÄ±z:</strong> Database'den 100x hÄ±zlÄ±</li>
                            <li>â€¢ <strong>Session storage:</strong> Laravel session driver</li>
                            <li>â€¢ <strong>TTL:</strong> Otomatik expire (7 gÃ¼n)</li>
                            <li>â€¢ <strong>Atomik:</strong> Race condition yok</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-yellow-900/30 border border-yellow-600 rounded">
                    <h4 class="font-bold text-yellow-400 mb-2">âš ï¸ Redis Session Silinirse Ne Olur?</h4>
                    <p class="text-slate-300 text-sm">
                        KullanÄ±cÄ± <strong>otomatik logout</strong> olur. Sayfa yenileyince login sayfasÄ±na yÃ¶nlendirilir.
                        Ama <code>user_active_sessions</code> tablosundaki kayÄ±t kalÄ±r (stale data).
                        Bu nedenle 60 dakika sonra temizlenir.
                    </p>
                </div>
            </div>
        </section>

        <!-- 4. Database Ne YapÄ±yor -->
        <section id="database" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">4. Database Ne YapÄ±yor?</h2>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-blue-400">ğŸ“Š user_active_sessions Tablosu</h3>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="p-2 text-left">Kolon</th>
                                <th class="p-2 text-left">Tip</th>
                                <th class="p-2 text-left">AÃ§Ä±klama</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">id</td>
                                <td class="p-2">bigint</td>
                                <td class="p-2">Primary key</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">user_id</td>
                                <td class="p-2">bigint</td>
                                <td class="p-2">KullanÄ±cÄ± ID (FK â†’ users)</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">session_id</td>
                                <td class="p-2">varchar(255)</td>
                                <td class="p-2">Redis session ID (unique)</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">ip_address</td>
                                <td class="p-2">varchar(45)</td>
                                <td class="p-2">KullanÄ±cÄ± IP</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">device_type</td>
                                <td class="p-2">varchar(20)</td>
                                <td class="p-2">desktop / mobile / tablet</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">device_name</td>
                                <td class="p-2">varchar(100)</td>
                                <td class="p-2">OS X - Chrome</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2 font-mono">last_activity</td>
                                <td class="p-2">timestamp</td>
                                <td class="p-2">Son aktivite (30 sn'de gÃ¼ncellenir)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 p-4 bg-blue-900/30 border border-blue-600 rounded">
                    <h4 class="font-bold text-blue-400 mb-2">ğŸ¯ Tablo Ne Ä°ÅŸe YarÄ±yor?</h4>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <li>â€¢ <strong>Device limit kontrolÃ¼:</strong> KaÃ§ cihaz aktif?</li>
                        <li>â€¢ <strong>LIFO uygulamasÄ±:</strong> Yeni giriÅŸ, eskiyi siler</li>
                        <li>â€¢ <strong>Aktif cihaz listesi:</strong> KullanÄ±cÄ±ya gÃ¶ster</li>
                        <li>â€¢ <strong>Cihaz sonlandÄ±rma:</strong> SeÃ§ili cihazÄ± Ã§Ä±kar</li>
                    </ul>
                </div>

                <div class="mt-4 p-4 bg-red-900/30 border border-red-600 rounded">
                    <h4 class="font-bold text-red-400 mb-2">âš ï¸ DB'den Session Silinirse Ne Olur?</h4>
                    <p class="text-slate-300 text-sm">
                        Frontend her 30 saniyede <code>/api/auth/check-session</code> Ã§aÄŸÄ±rÄ±yor.
                        Session DB'de yoksa â†’ <strong>"session_terminated"</strong> dÃ¶ner â†’ KullanÄ±cÄ± logout olur.
                        <br><br>
                        <strong>Ama Redis'te session hala var!</strong> Bu durumda Laravel "giriÅŸ yapmÄ±ÅŸ" sanÄ±r,
                        ama DeviceService "session yok" der. SonuÃ§: Ã‡eliÅŸki ve logout.
                    </p>
                </div>
            </div>
        </section>

        <!-- 5. Login AkÄ±ÅŸÄ± -->
        <section id="login-flow" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">5. Login AkÄ±ÅŸÄ±</h2>

            <div class="space-y-4">
                <div class="bg-slate-800/50 border-l-4 border-blue-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-blue-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">1</div>
                        <div>
                            <h3 class="text-xl font-bold text-blue-300 mb-2">KullanÄ±cÄ± Form'u GÃ¶nderir</h3>
                            <p class="text-slate-300">Email + Password â†’ <code>POST /api/auth/login</code></p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 border-l-4 border-purple-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-purple-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">2</div>
                        <div>
                            <h3 class="text-xl font-bold text-purple-300 mb-2">Laravel Auth::attempt()</h3>
                            <p class="text-slate-300">Åifre doÄŸrulanÄ±r, session regenerate edilir, yeni session ID oluÅŸur</p>
                            <pre class="mt-2 bg-slate-900 p-3 rounded text-xs">$request->session()->regenerate();</pre>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 border-l-4 border-red-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-red-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">3</div>
                        <div>
                            <h3 class="text-xl font-bold text-red-300 mb-2">Redis'e Session Kaydedilir</h3>
                            <p class="text-slate-300">Session driver redis olduÄŸu iÃ§in otomatik yazÄ±lÄ±r</p>
                            <pre class="mt-2 bg-slate-900 p-3 rounded text-xs">Redis KEY: AKmX6ilTCPbot7IukdA8...
TTL: 10080 dakika (7 gÃ¼n)</pre>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 border-l-4 border-green-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-green-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">4</div>
                        <div>
                            <h3 class="text-xl font-bold text-green-300 mb-2">DeviceService.registerSession()</h3>
                            <p class="text-slate-300">Session ID + cihaz bilgisi â†’ <code>user_active_sessions</code> tablosuna</p>
                            <pre class="mt-2 bg-slate-900 p-3 rounded text-xs">DB::table('user_active_sessions')->insert([
    'user_id' => $user->id,
    'session_id' => session()->getId(),
    'device_name' => 'OS X - Chrome',
    ...
]);</pre>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 border-l-4 border-orange-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-orange-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">5</div>
                        <div>
                            <h3 class="text-xl font-bold text-orange-300 mb-2">LIFO: Eski Sessionlar Silinir</h3>
                            <p class="text-slate-300">Device limit aÅŸÄ±ldÄ±ysa en eski session silinir</p>
                            <pre class="mt-2 bg-slate-900 p-3 rounded text-xs">// enforceDeviceLimit()
// Limit: 1 â†’ 2. cihaz giriÅŸ yapÄ±nca 1. cihaz silinir
// Limit: 2 â†’ 3. cihaz giriÅŸ yapÄ±nca 1. cihaz silinir</pre>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 border-l-4 border-yellow-500 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-yellow-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">6</div>
                        <div>
                            <h3 class="text-xl font-bold text-yellow-300 mb-2">Cookie GÃ¶nderilir</h3>
                            <p class="text-slate-300">Session ID ÅŸifrelenerek cookie'ye yazÄ±lÄ±r</p>
                            <pre class="mt-2 bg-slate-900 p-3 rounded text-xs">Set-Cookie: tuufi_session=eyJpdiI6...; HttpOnly; Secure; SameSite=Lax</pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. Logout AkÄ±ÅŸÄ± -->
        <section id="logout-flow" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">6. Logout AkÄ±ÅŸÄ±</h2>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-green-400">âœ… Normal Logout</h3>
                    <ol class="space-y-2 text-slate-300 text-sm list-decimal list-inside">
                        <li>KullanÄ±cÄ± "Ã‡Ä±kÄ±ÅŸ" butonuna tÄ±klar</li>
                        <li><code>POST /api/auth/logout</code> Ã§aÄŸrÄ±lÄ±r</li>
                        <li><code>DeviceService.unregisterSession()</code> â†’ DB'den siler</li>
                        <li><code>Auth::logout()</code> â†’ Laravel logout</li>
                        <li><code>session()->invalidate()</code> â†’ Redis'ten siler</li>
                        <li>Cookie expire edilir</li>
                        <li>Login sayfasÄ±na yÃ¶nlendirilir</li>
                    </ol>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-red-400">âš¡ Zorla Logout (LIFO)</h3>
                    <ol class="space-y-2 text-slate-300 text-sm list-decimal list-inside">
                        <li>BaÅŸka cihazdan login yapÄ±lÄ±r</li>
                        <li><code>enforceDeviceLimit()</code> Ã§alÄ±ÅŸÄ±r</li>
                        <li>Eski session DB'den silinir</li>
                        <li>Frontend 30 sn'de <code>check-session</code> Ã§aÄŸÄ±rÄ±r</li>
                        <li>API "session_terminated" dÃ¶ner</li>
                        <li>Frontend logout yapar + login'e yÃ¶nlendirir</li>
                    </ol>
                    <p class="mt-4 text-xs text-yellow-400">
                        âš ï¸ Redis session hala var ama DB'de yok â†’ Ã‡eliÅŸki
                    </p>
                </div>
            </div>
        </section>

        <!-- 7. Device Limit -->
        <section id="device-limit" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">7. Cihaz Limiti (LIFO)</h2>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700 mb-6">
                <h3 class="text-lg font-bold mb-4 text-purple-400">ğŸ“Š Limit HiyerarÅŸisi (3-Tier)</h3>

                <div class="flex flex-wrap items-center gap-4">
                    <div class="px-4 py-2 bg-red-600 rounded">
                        <span class="font-bold">1. User Override</span>
                        <p class="text-xs">users.device_limit</p>
                    </div>
                    <span class="text-2xl">â†’</span>
                    <div class="px-4 py-2 bg-yellow-600 rounded">
                        <span class="font-bold">2. Subscription Plan</span>
                        <p class="text-xs">plans.device_limit</p>
                    </div>
                    <span class="text-2xl">â†’</span>
                    <div class="px-4 py-2 bg-green-600 rounded">
                        <span class="font-bold">3. Tenant Setting</span>
                        <p class="text-xs">auth_device_limit</p>
                    </div>
                </div>

                <pre class="mt-4 bg-slate-900 p-4 rounded text-xs overflow-x-auto">
// DeviceService::getDeviceLimit()
1. User override: $user->device_limit (null deÄŸilse)
2. Subscription Plan: $user->subscriptions->plan->device_limit
3. Tenant setting: setting('auth_device_limit') â†’ Default: 1</pre>
            </div>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-orange-400">ğŸ”„ LIFO NasÄ±l Ã‡alÄ±ÅŸÄ±yor?</h3>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="p-2 text-left">Zaman</th>
                                <th class="p-2 text-left">Ä°ÅŸlem</th>
                                <th class="p-2 text-left">SonuÃ§</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="p-2">09:00</td>
                                <td class="p-2">Bilgisayardan login</td>
                                <td class="p-2 text-green-400">Session A aktif</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2">10:00</td>
                                <td class="p-2">Telefondan login</td>
                                <td class="p-2 text-yellow-400">Session B aktif, Session A siliniyor...</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="p-2">10:00:30</td>
                                <td class="p-2">Bilgisayar check-session</td>
                                <td class="p-2 text-red-400">Session A yok â†’ Logout!</td>
                            </tr>
                            <tr>
                                <td class="p-2">10:01</td>
                                <td class="p-2">Bilgisayar login sayfasÄ±na</td>
                                <td class="p-2 text-blue-400">"BaÅŸka cihazdan giriÅŸ yapÄ±ldÄ±"</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 8. KullanÄ±cÄ±yÄ± NasÄ±l Ã‡Ä±karÄ±rÄ±z -->
        <section id="kick-user" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">8. KullanÄ±cÄ±yÄ± NasÄ±l Ã‡Ä±karÄ±rÄ±z?</h2>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-green-500">
                    <h3 class="text-xl font-bold mb-4 text-green-400">âœ… YÃ¶ntem 1: DB'den Sil</h3>
                    <pre class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
-- Belirli kullanÄ±cÄ±nÄ±n tÃ¼m sessionlarÄ±nÄ± sil
DELETE FROM user_active_sessions
WHERE user_id = 1;

-- SonuÃ§: 30 saniye iÃ§inde logout olur</pre>
                    <p class="mt-4 text-sm text-slate-400">
                        Frontend polling "session yok" alÄ±r â†’ Logout
                    </p>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-blue-500">
                    <h3 class="text-xl font-bold mb-4 text-blue-400">âœ… YÃ¶ntem 2: Redis'ten Sil</h3>
                    <pre class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
# Session ID'yi bul
SELECT session_id FROM user_active_sessions
WHERE user_id = 1;

# Redis'ten sil
redis-cli DEL "AKmX6ilTCPbot7IukdA8..."

# SonuÃ§: ANINDA logout</pre>
                    <p class="mt-4 text-sm text-slate-400">
                        Laravel session yok â†’ AnÄ±nda unauthorized
                    </p>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold mb-4 text-purple-400">âœ… YÃ¶ntem 3: API ile</h3>
                    <pre class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
// Admin panelden
DeviceService::terminateSession($sessionId);

// Veya API endpoint (ileride)
POST /api/admin/users/{id}/logout</pre>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-6 border-l-4 border-yellow-500">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">âœ… YÃ¶ntem 4: Tinker ile</h3>
                    <pre class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
php artisan tinker
>>> tenancy()->initialize(\App\Models\Tenant::find(1001));
>>> DB::table('user_active_sessions')
...     ->where('user_id', 1)
...     ->delete();</pre>
                </div>
            </div>

            <div class="mt-6 p-4 bg-red-900/30 border border-red-600 rounded">
                <h4 class="font-bold text-red-400 mb-2">âš ï¸ Dikkat!</h4>
                <p class="text-slate-300 text-sm">
                    <strong>Sadece DB'den silmek yetmez!</strong> Redis'te session hala var olabilir.
                    <br>KullanÄ±cÄ± logout olduktan sonra bile cookie ile request atabilir.
                    <br>En gÃ¼venli: <strong>Hem DB hem Redis'ten sil.</strong>
                </p>
            </div>
        </section>

        <!-- 9. ÅarkÄ± Dinleme AkÄ±ÅŸÄ± -->
        <section id="stream-flow" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">9. ÅarkÄ± Dinleme AkÄ±ÅŸÄ±</h2>

            <div class="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-green-400">ğŸµ Stream Ä°steÄŸi GeldiÄŸinde</h3>

                <div class="space-y-4">
                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-blue-600 rounded text-sm">1</span>
                        <div>
                            <p class="text-slate-300"><code>GET /api/songs/{id}/stream</code></p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-purple-600 rounded text-sm">2</span>
                        <div>
                            <p class="text-slate-300">Auth kontrolÃ¼: <code>auth('web')->user()</code></p>
                            <p class="text-xs text-slate-500">GiriÅŸ yapmamÄ±ÅŸ â†’ 30 sn preview</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-green-600 rounded text-sm">3</span>
                        <div>
                            <p class="text-slate-300">Session DB'de var mÄ±?</p>
                            <pre class="mt-1 bg-slate-900 p-2 rounded text-xs">DB::table('user_active_sessions')
    ->where('session_id', session()->getId())
    ->exists();</pre>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-yellow-600 rounded text-sm">4</span>
                        <div>
                            <p class="text-slate-300">Session yoksa â†’ <code>401 session_terminated</code></p>
                            <p class="text-slate-300">Session varsa â†’ Device limit kontrolÃ¼</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-orange-600 rounded text-sm">5</span>
                        <div>
                            <p class="text-slate-300">Premium kontrolÃ¼: <code>$user->isPremiumOrTrial()</code></p>
                            <p class="text-xs text-slate-500">Premium deÄŸil â†’ 30 sn preview</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <span class="px-3 py-1 bg-red-600 rounded text-sm">6</span>
                        <div>
                            <p class="text-slate-300">âœ… Signed URL dÃ¶ndÃ¼r â†’ ÅarkÄ± Ã§alar</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 p-4 bg-blue-900/30 border border-blue-600 rounded">
                <h4 class="font-bold text-blue-400 mb-2">ğŸ” Signed URL Nedir?</h4>
                <p class="text-slate-300 text-sm">
                    MP3/HLS dosyasÄ±na eriÅŸim iÃ§in <strong>geÃ§ici ÅŸifrelenmiÅŸ URL</strong>.
                    <br>30 dakika sonra expire olur, tekrar stream isteÄŸi gerekir.
                    <br>Bu sayede direkt link paylaÅŸÄ±lsa bile Ã§alÄ±ÅŸmaz.
                </p>
            </div>
        </section>

        <!-- 10. Mevcut Sorunlar -->
        <section id="issues" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-red-400">10. Mevcut Sorunlar & Ã‡Ã¶zÃ¼mler</h2>

            <div class="space-y-6">
                <!-- Sorun 1 -->
                <div class="bg-red-900/30 border border-red-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-red-400">ğŸ› Sorun 1: "Premium'a GeÃ§in" AÃ§Ä±lÄ±ÅŸta GÃ¶steriliyor</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-bold text-yellow-400 mb-2">Neden?</h4>
                            <p class="text-slate-300 text-sm">
                                <code>localStorage</code>'dan Ã¶nceki state yÃ¼kleniyor.
                                <br>EÄŸer preview mode'da kaldÄ±ysa, <code>isPreviewBlocked = true</code> oluyor.
                                <br>Play butonuna basÄ±nca "Premium'a geÃ§in" toast Ã§Ä±kÄ±yor.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-400 mb-2">Ã‡Ã¶zÃ¼m</h4>
                            <p class="text-slate-300 text-sm">
                                State restore sÄ±rasÄ±nda <code>isPreviewBlocked</code> flag'ini sÄ±fÄ±rla.
                                <br>Veya login olduktan sonra flag'i temizle.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sorun 2 -->
                <div class="bg-red-900/30 border border-red-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-red-400">ğŸ› Sorun 2: Otomatik ÅarkÄ± Ã‡alÄ±yor</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-bold text-yellow-400 mb-2">Neden?</h4>
                            <p class="text-slate-300 text-sm">
                                <code>loadState()</code> fonksiyonu Ã¶nceki queue'yu yÃ¼klÃ¼yor.
                                <br>Sonra <code>playSongFromQueue()</code> Ã§aÄŸrÄ±lÄ±yor (autoplay=false bile olsa).
                                <br>Stream API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor, URL alÄ±nÄ±yor.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-400 mb-2">Ã‡Ã¶zÃ¼m</h4>
                            <p class="text-slate-300 text-sm">
                                State restore sÄ±rasÄ±nda sadece UI gÃ¼ncellemesi yap.
                                <br>ÅarkÄ±yÄ± yÃ¼kleme, stream isteÄŸi atma.
                                <br>KullanÄ±cÄ± play'e basÄ±nca yÃ¼kle.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sorun 3 -->
                <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">âš ï¸ Sorun 3: Redis-DB Senkronizasyon</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-bold text-yellow-400 mb-2">Neden?</h4>
                            <p class="text-slate-300 text-sm">
                                Redis session 7 gÃ¼n yaÅŸar.
                                <br>DB session 60 dakika inaktifse silinir.
                                <br>Ä°kisi arasÄ±nda senkronizasyon yok.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-400 mb-2">Ã‡Ã¶zÃ¼m</h4>
                            <p class="text-slate-300 text-sm">
                                DB cleanup TTL'ini Redis ile eÅŸitle.
                                <br>Veya logout sÄ±rasÄ±nda her ikisini de sil.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-20 pt-8 border-t border-slate-700 text-center text-slate-500 text-sm">
            <p>ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu</p>
            <p class="mt-2">Muzibu Session & Auth Sistemi DokÃ¼mantasyonu</p>
        </footer>
    </div>
</body>
</html>
