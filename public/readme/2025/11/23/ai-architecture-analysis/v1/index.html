<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ModÃ¼lÃ¼ Mimarisi - Tenant-Aware Analizi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #334155;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        section {
            margin-bottom: 50px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.3rem;
            margin-top: 25px;
            margin-bottom: 15px;
            color: #a5f3fc;
        }

        .card {
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateX(5px);
            background: rgba(30, 41, 59, 0.7);
        }

        .card.warning {
            border-left-color: #ef4444;
        }

        .card.success {
            border-left-color: #10b981;
        }

        .card.info {
            border-left-color: #06b6d4;
        }

        .code-block {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #a5f3fc;
            border: 1px solid #334155;
        }

        .file-path {
            color: #fbbf24;
            font-weight: 500;
        }

        .keyword {
            color: #c084fc;
            font-weight: 600;
        }

        ul, ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: rgba(59, 130, 246, 0.2);
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #3b82f6;
            color: #60a5fa;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-danger { background: #dc2626; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-success { background: #10b981; color: white; }
        .badge-info { background: #06b6d4; color: white; }

        .flow-diagram {
            background: rgba(30, 41, 59, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #334155;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            color: #a5f3fc;
        }

        .metric {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            padding: 8px 15px;
            border-radius: 8px;
            margin: 5px 5px 5px 0;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }

        .checklist {
            list-style: none;
        }

        .checklist li {
            padding-left: 30px;
            position: relative;
        }

        .checklist li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .checklist li.warning:before {
            content: "âš ";
            color: #f59e0b;
        }

        .checklist li.error:before {
            content: "âœ•";
            color: #ef4444;
        }

        .highlight {
            background: rgba(249, 115, 22, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #fed7aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—ï¸ AI ModÃ¼lÃ¼ Mimarisi Analizi</h1>
            <div class="meta">
                ğŸ“… Tarih: 2025-11-23 03:15 |
                ğŸ¯ Konu: Tenant-Aware Sistem Analizi |
                ğŸ‘¤ Talep: Multi-tenant mimarisi deÄŸerlendirmesi
            </div>
        </header>

        <!-- Ã–ZET BÃ–LÃœMÃœ -->
        <section>
            <h2>ğŸ“Š YÃ¶netici Ã–zeti</h2>

            <div class="card info">
                <h3>Sistem Durumu</h3>
                <p>
                    AI modÃ¼lÃ¼ ÅŸu anda <span class="badge badge-warning">ÃœÃ‡ TEMEL PROBLEM</span> ile karÅŸÄ± karÅŸÄ±yadÄ±r:
                </p>
                <ol>
                    <li><span class="highlight">Hardcoded Tenant Kontrolleri</span> - Tenant 2/3 ID'leri 8 yerde kodda yazÄ±lÄ±</li>
                    <li><span class="highlight">Ã‡ift MimarÄ± Patern</span> - Tenant-specific ve global kurallar karÄ±ÅŸÄ±k</li>
                    <li><span class="highlight">Ã–lÃ§eklenebilirlik Riski</span> - 1000+ tenant desteklemesi imkansÄ±z</li>
                </ol>
            </div>

            <div class="card">
                <h3>Mimarinin GÃ¼Ã§lÃ¼ TaraflarÄ±</h3>
                <ul class="checklist">
                    <li>Tenant-Aware Cache Service (TenantAwareCacheService)</li>
                    <li>Dinamik Tenant Service YÃ¼kleme (Factory Pattern)</li>
                    <li>Workflow Engine mimarisi (geniÅŸletilebilir)</li>
                    <li>Database Directive Sistemi (yapÄ±landÄ±rÄ±labilir)</li>
                    <li>Hybrid Search entegrasyonu</li>
                </ul>
            </div>

            <div class="card">
                <h3>Acil Ã–ncelikler</h3>
                <table>
                    <tr>
                        <th>YÃ¼kseklik</th>
                        <th>Problem</th>
                        <th>Dosya</th>
                        <th>SatÄ±rlar</th>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">KRÄ°TÄ°K</span></td>
                        <td>Hardcoded [2, 3] kontrolleri</td>
                        <td>AIResponseNode.php</td>
                        <td>85, 126</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">KRÄ°TÄ°K</span></td>
                        <td>Tenant-specific kurallara hardcode</td>
                        <td>AIResponseNode.php</td>
                        <td>125-170</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">YÃœKSEK</span></td>
                        <td>PublicAIController'da Tenant2 kontrolÃ¼</td>
                        <td>PublicAIController.php</td>
                        <td>~55</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">YÃœKSEK</span></td>
                        <td>ShopSearchService'de hardcode</td>
                        <td>ShopSearchService.php</td>
                        <td>Ã‡ok</td>
                    </tr>
                </table>
            </div>
        </section>

        <!-- MEVCUT MÄ°MARÄ° -->
        <section>
            <h2>ğŸ”„ Mevcut Mimari YapÄ±sÄ±</h2>

            <h3>1. Tenant-Aware Servisler (Ä°yi)</h3>
            
            <div class="card success">
                <h3 style="margin-top: 0;">Tenant2PromptService.php</h3>
                <p><span class="metric">1.132 satÄ±r</span> <span class="metric">Ä°XTÄ°F Ã–ZEL</span></p>
                <p><strong>AmaÃ§:</strong> Tenant 2 (ixtif.com) ve Tenant 3 (ixtif.com.tr) iÃ§in Ã¶zel prompt kurallarÄ±</p>
                <p><strong>Ä°Ã§eriÄŸi:</strong></p>
                <ul>
                    <li>Belirsiz istek kurallarÄ± (tonnaj, tip sorma)</li>
                    <li>ÃœrÃ¼n gÃ¶sterme kriterleri</li>
                    <li>Olumsuz kelime yasaÄŸÄ± (maalesef, bulunmamaktadÄ±r, vb.)</li>
                    <li>Ä°letiÅŸim bilgisi stratejisi</li>
                    <li>Fiyat ve stok politikasÄ±</li>
                </ul>
                <p><strong>Dosya Yolu:</strong></p>
                <div class="code-block">/var/www/.../Modules/AI/app/Services/Tenant/Tenant2PromptService.php</div>
            </div>

            <div class="card success">
                <h3 style="margin-top: 0;">Tenant2ProductSearchService.php</h3>
                <p><span class="metric">998 satÄ±r</span> <span class="metric">Ä°XTÄ°F Ã–ZEL</span></p>
                <p><strong>AmaÃ§:</strong> Tenant 2 iÃ§in kategori ve Ã¼rÃ¼n arama logiki</p>
                <p><strong>Ä°Ã§eriÄŸi:</strong></p>
                <ul>
                    <li>Forklift, transpalet, reach truck kategorileri (ID: 1-6)</li>
                    <li>Model numarasÄ± Ã§Ä±karma (F4, EPL153, CPD15)</li>
                    <li>Fiyat-bazlÄ± sorgular (en ucuz, en pahalÄ±)</li>
                    <li>Yedek parÃ§a filtreleme</li>
                    <li>HybridSearch entegrasyonu</li>
                </ul>
                <p><strong>Dosya Yolu:</strong></p>
                <div class="code-block">/var/www/.../Modules/AI/app/Services/Tenant/Tenant2ProductSearchService.php</div>
            </div>

            <h3>2. Global (Tenant-Neutral) YapÄ±lar</h3>

            <div class="card">
                <h3 style="margin-top: 0;">ProductSearchNode.php</h3>
                <p><strong>Ã–zellikleri:</strong></p>
                <ul>
                    <li>Factory Pattern ile Tenant-specific servis yÃ¼kleme</li>
                    <li>Dinamik sÄ±nÄ±f adÄ±: <span class="code-block" style="display: inline; margin: 0; padding: 2px 6px;">Tenant{$tenantId}ProductSearchService</span></li>
                    <li>Service yoksa fallback (MySQL, Meilisearch)</li>
                    <li>Generic keyword extraction (global tenants iÃ§in)</li>
                </ul>
                <p><strong>Dosya Yolu:</strong></p>
                <div class="code-block">Modules/AI/app/Services/Workflow/Nodes/ProductSearchNode.php</div>
                <p><strong>Kodu:</strong></p>
                <div class="code-block">protected function getTenantSearchService(?int $tenantId) {
    $serviceClass = "\\Modules\\AI\\App\\Services\\Tenant\\Tenant{$tenantId}ProductSearchService";
    if (class_exists($serviceClass)) {
        return app($serviceClass);
    }
    return null;
}</div>
            </div>

            <h3>3. Hardcoded Problemler (KÃ¶tÃ¼)</h3>

            <div class="card warning">
                <h3 style="margin-top: 0;">AIResponseNode.php - KRÄ°TÄ°K HARDCODE</h3>
                <p><span class="badge badge-danger">PROBLEM</span> SatÄ±r 85 ve 126'da hardcoded tenant kontrolÃ¼:</p>
                <div class="code-block">if (in_array($tenantId, [2, 3])) {
    // Tenant2PromptService yÃ¼klenmesi
    $tenant2Service = new \Modules\AI\App\Services\Tenant\Tenant2PromptService();
}</div>
                <p><strong>Neden Problem?</strong></p>
                <ul>
                    <li>Yeni tenant eklenirken kod deÄŸiÅŸtirilmesi gerekir</li>
                    <li>Tenant 4, 5, 1001 iÃ§in ayrÄ± if bloÄŸu yazÄ±lmalÄ±</li>
                    <li>1000+ tenant ile bu imkansÄ±z</li>
                    <li>Her gÃ¼ncellemede deployment riski</li>
                </ul>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">AIResponseNode.php - TENANT-SPECIFIC KURALLARA HARDCODE (SatÄ±r 125-170)</h3>
                <p><strong>Sorun:</strong> Ä°XTÄ°F Ã¶zel kurallar (olumsuz kelime yasaÄŸÄ±, Ã¼rÃ¼n gÃ¶sterme, vb.) global AI dosyasÄ±nda yazÄ±lÄ±:</p>
                <div class="code-block">// ğŸ­ TENANT 2 (Ä°XTÄ°F) Ã–ZEL KURALLARI
if (in_array($tenantId, [2, 3])) {
    $ixtifRules = <<<'IXTIF'
    
## Ä°XTÄ°F Ã–ZEL KURALLARI:
- "Olumsuz kelimeler yasak!"
- "Transpalet isteyince tonnaj sor"
- ...
IXTIF;
    $systemPrompt = $ixtifRules . "\n\n" . $systemPrompt;
}</div>
                <p><strong>Neden Hata?</strong></p>
                <ul>
                    <li class="error">Bu kurallar <span class="file-path">Tenant2PromptService</span>'de olmalÄ±</li>
                    <li class="error">Global Node'de tenant-specific kurallÄ± ASLA bulunmamalÄ±</li>
                    <li class="error">MÃ¼zik (Tenant 1001) kurallarÄ±nÄ± eklerken baÅŸka developer bunu hatÄ±rlayacak mÄ±?</li>
                </ul>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">PublicAIController.php - Tenant KontrolÃ¼</h3>
                <div class="code-block">if (in_array(tenant('id'), [2, 3])) {
    // Ã–zel mantÄ±k
}</div>
                <p><strong>Sorun:</strong> Controller'da tenant kontrolleri olmamalÄ±</p>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">ShopSearchService.php - Ã‡ok SayÄ±da Hardcode</h3>
                <p>Dosyada 3 yerde <span class="code-block" style="display: inline; margin: 0; padding: 2px 6px;">in_array($tenantId, [2, 3])</span> kontrolÃ¼</p>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">OptimizedPromptService.php - Hardcoded Tenant Kontrolleri</h3>
                <p>2 yerde <span class="code-block" style="display: inline; margin: 0; padding: 2px 6px;">in_array($tenantId, [2, 3])</span></p>
            </div>
        </section>

        <!-- DETAYLI BULGULER -->
        <section>
            <h2>ğŸ” DetaylÄ± Bulgular</h2>

            <h3>Hardcoded Tenant ID'leri - Tam SayÄ±</h3>
            <table>
                <tr>
                    <th>Dosya AdÄ±</th>
                    <th>SatÄ±rlar</th>
                    <th>Hardcode Tipi</th>
                    <th>Ä°ÅŸlev</th>
                </tr>
                <tr>
                    <td><span class="file-path">AIResponseNode.php</span></td>
                    <td>85, 126</td>
                    <td><span class="code-block" style="display: inline; margin: 0;">in_array([2,3])</span></td>
                    <td>Tenant2PromptService yÃ¼kleme</td>
                </tr>
                <tr>
                    <td><span class="file-path">AIResponseNode.php</span></td>
                    <td>127-169</td>
                    <td>Ä°XTÄ°F kurallarÄ± (hardcode)</td>
                    <td>Olumsuz kelimeler, Ã¼rÃ¼n gÃ¶sterme</td>
                </tr>
                <tr>
                    <td><span class="file-path">PublicAIController.php</span></td>
                    <td>~55</td>
                    <td><span class="code-block" style="display: inline; margin: 0;">in_array([2,3])</span></td>
                    <td>Controller seviyesinde kontrol</td>
                </tr>
                <tr>
                    <td><span class="file-path">ShopSearchService.php</span></td>
                    <td>Ã‡ok</td>
                    <td><span class="code-block" style="display: inline; margin: 0;">in_array([2,3])</span></td>
                    <td>Search servisi tenantÄ± kontrol</td>
                </tr>
                <tr>
                    <td><span class="file-path">OptimizedPromptService.php</span></td>
                    <td>84, +1</td>
                    <td><span class="code-block" style="display: inline; margin: 0;">in_array([2,3])</span></td>
                    <td>Optimized prompt oluÅŸturma</td>
                </tr>
                <tr>
                    <td><span class="file-path">Tenant2PromptService.php</span></td>
                    <td>~47</td>
                    <td><span class="code-block" style="display: inline; margin: 0;">return in_array(tenant('id'), [2,3])</span></td>
                    <td>Tenant kontrolÃ¼ iÃ§inde</td>
                </tr>
            </table>

            <h3>GeÃ§erli Tenant-Specific Servisler</h3>
            <table>
                <tr>
                    <th>Servis AdÄ±</th>
                    <th>SatÄ±r SayÄ±sÄ±</th>
                    <th>Tenant(lar)</th>
                    <th>AmaÃ§</th>
                </tr>
                <tr>
                    <td><span class="file-path">Tenant2PromptService</span></td>
                    <td>1.132</td>
                    <td>2, 3</td>
                    <td>Prompt kurallarÄ± (iXTÄ°F)</td>
                </tr>
                <tr>
                    <td><span class="file-path">Tenant2ProductSearchService</span></td>
                    <td>998</td>
                    <td>2, 3</td>
                    <td>ÃœrÃ¼n arama (iXTÄ°F)</td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: center; color: #94a3b8;">DiÄŸer tenantlar iÃ§in: <strong>BAÅKA SERVÄ°S YOK</strong> (fallback kullanÄ±lÄ±r)</td>
                </tr>
            </table>

            <h3>Tenant Selection / Routing MekanizmasÄ±</h3>
            
            <div class="flow-diagram">Workflow AkÄ±ÅŸÄ±:
1. AIResponseNode.execute()
   â”œâ”€ tenantId = tenant('id')
   â”œâ”€ IF tenantId IN [2,3]  â† HARDCODED!
   â”‚  â””â”€ Tenant2PromptService::buildPrompt() Ã§aÄŸÄ±r
   â””â”€ DiÄŸer kurallar

2. ProductSearchNode.execute()
   â”œâ”€ tenantId = context['tenant_id']
   â”œâ”€ getTenantSearchService(tenantId)
   â”‚  â””â”€ Service varsa: Tenant{ID}ProductSearchService yÃ¼kleme
   â”‚  â””â”€ Service yoksa: Fallback (MySQL/Meilisearch)
   â””â”€ SonuÃ§larÄ± dÃ¶n

3. New Tenant EklendiÄŸinde (Tenant 1001 - MÃ¼zik):
   ADIM 1: Tenant1001PromptService.php oluÅŸtur
   ADIM 2: Tenant1001ProductSearchService.php oluÅŸtur
   ADIM 3: AIResponseNode.php'de [2,3] â†’ [2,3,1001] ÅŸeklinde gÃ¼ncelle â† BUG!
   ADIM 4: PublicAIController.php'de gÃ¼ncelle
   ADIM 5: ShopSearchService.php'de gÃ¼ncelle
           </div>

            <h3>Default Behavior (Service Yoksa)</h3>
            <ul>
                <li><strong>ProductSearchNode:</strong> Generic keyword extraction â†’ MySQL/Meilisearch fallback</li>
                <li><strong>AIResponseNode:</strong> Global kurallar + directives (database)</li>
                <li><strong>PromptService:</strong> Ä°Ã§ iÃ§e geÃ§miÅŸ kurallar + hardcoded global rules</li>
            </ul>
        </section>

        <!-- TASARISAL SORGULAR -->
        <section>
            <h2>â“ TasarÄ±msal Sorular</h2>

            <div class="card">
                <h3 style="margin-top: 0;">Soru 1: Tenant 2 & 3 Neden AynÄ± Servisi KullanÄ±yor?</h3>
                <p><strong>Cevap:</strong> ixtif.com ve ixtif.com.tr aynÄ± iÅŸletme olduÄŸundan aynÄ± Ã¼rÃ¼n katalogu ve kurallarÄ± kullanÄ±yor.</p>
                <p><strong>Sorun:</strong> Ä°leride farklÄ± kural isterse, Tenant2 â†’ Tenant2 + Tenant3 ÅŸeklinde ayrÄ±lacak mÄ±?</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Soru 2: Neden Factory Pattern Devam Etmedi?</h3>
                <p><strong>Durum:</strong></p>
                <ul>
                    <li>ProductSearchNode: Factory kullanÄ±yor (iyi!) âœ“</li>
                    <li>AIResponseNode: Hardcoded if/in_array (kÃ¶tÃ¼!) âœ—</li>
                </ul>
                <p><strong>Sorun:</strong> Neden tutarsÄ±z?</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Soru 3: Database Directives vs Hardcode Kurallar</h3>
                <p><strong>Mekanizmalar:</strong></p>
                <ul>
                    <li>Database: <span class="file-path">ai_tenant_directives</span> tablosu (panel'den dÃ¼zenlenebilir)</li>
                    <li>Hardcode: Tenant2PromptService.php (code yazÄ±lmasÄ± gerekir)</li>
                </ul>
                <p><strong>Soru:</strong> Kurallar database'e taÅŸÄ±nabilir mi?</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Soru 4: Muzik (Tenant 1001) Ä°Ã§in Neyi HazÄ±rlamak Gerekir?</h3>
                <p><strong>Gerekli Dosyalar:</strong></p>
                <ol>
                    <li>Tenant1001PromptService.php (mÃ¼zik kurallarÄ±)</li>
                    <li>Tenant1001ProductSearchService.php (ÅŸarkÄ± arama)</li>
                    <li>AIResponseNode.php gÃ¼ncelleme (hardcode kontrol)</li>
                    <li>PublicAIController.php gÃ¼ncelleme</li>
                    <li>DiÄŸer kontrollÃ¼ dosyalarÄ± gÃ¼ncelleme</li>
                </ol>
                <p><strong>Durum:</strong> Konsistent bir pattern yok!</p>
            </div>
        </section>

        <!-- Ã–NERILER -->
        <section>
            <h2>âœ… Ã–neriler & Ã‡Ã¶zÃ¼mler</h2>

            <h3>Ã–ncelik 1: Factory Pattern'i TÃ¼m Servislere YaygÄ±nlaÅŸtÄ±r (MUTLAKA)</h3>

            <div class="card success">
                <h3 style="margin-top: 0;">Ã‡Ã¶zÃ¼m: TenantServiceFactory</h3>
                <p>Merkezi bir factory sÄ±nÄ±fÄ± oluÅŸtur:</p>
                <div class="code-block">// app/Services/AI/TenantServiceFactory.php
class TenantServiceFactory {
    
    public static function getPromptService(?int $tenantId = null): TenantPromptServiceInterface {
        $tenantId = $tenantId ?? tenant('id');
        
        $serviceClass = "\\App\\Services\\Tenant\\Prompt\\Tenant{$tenantId}PromptService";
        
        if (class_exists($serviceClass)) {
            return app($serviceClass);
        }
        
        return app(DefaultPromptService::class);
    }
    
    public static function getSearchService(?int $tenantId = null) {
        $tenantId = $tenantId ?? tenant('id');
        
        $serviceClass = "\\App\\Services\\Tenant\\Search\\Tenant{$tenantId}ProductSearchService";
        
        if (class_exists($serviceClass)) {
            return app($serviceClass);
        }
        
        return app(DefaultProductSearchService::class);
    }
}</div>

                <p><strong>AvantajlarÄ±:</strong></p>
                <ul class="checklist">
                    <li>Merkezi kontrol noktasÄ±</li>
                    <li>Default service fallback</li>
                    <li>TutarlÄ± pattern</li>
                    <li>1000+ tenant iÃ§in Ã¶lÃ§eklenebilir</li>
                    <li>Test yapÄ±labilir</li>
                </ul>
            </div>

            <h3>Ã–ncelik 2: Interface TanÄ±mla (Contract-Based Design)</h3>

            <div class="card success">
                <h3 style="margin-top: 0;">Ã‡Ã¶zÃ¼m: Tenant Service Interfaces</h3>
                <div class="code-block">// app/Services/Tenant/Contracts/TenantPromptServiceInterface.php
interface TenantPromptServiceInterface {
    public function buildPrompt(): array;
    public function getTenantSpecificRules(): array;
    public function isApplicable(): bool;
}

// app/Services/Tenant/Contracts/TenantSearchServiceInterface.php
interface TenantSearchServiceInterface {
    public function search(string $query, int $limit): array;
    public function detectCategory(string $message): ?int;
}</div>

                <p><strong>FaydalarÄ±:</strong></p>
                <ul class="checklist">
                    <li>Standart contract saÄŸlar</li>
                    <li>Her servis aynÄ± metodlarÄ± implementer</li>
                    <li>Type hinting mÃ¼mkÃ¼n</li>
                    <li>Mock'lama kolay</li>
                </ul>
            </div>

            <h3>Ã–ncelik 3: Hardcoded Tenant Kontrollerini Temizle</h3>

            <div class="card warning">
                <h3 style="margin-top: 0;">Dosya: AIResponseNode.php (SatÄ±r 85-170)</h3>
                
                <p><strong>Eski Kod (Hardcoded):</strong></p>
                <div class="code-block">$tenantId = tenant('id') ?? null;
if (in_array($tenantId, [2, 3])) {
    try {
        $tenant2Service = new \Modules\AI\App\Services\Tenant\Tenant2PromptService();
        $tenantPrompt = implode("\n", $tenant2Service->buildPrompt());
        $systemPrompt = $tenantPrompt . "\n\n" . $systemPrompt;
    } catch (\Exception $e) {
        // ...
    }
}

// Ä°XTÄ°F Ã–ZEL KURALLARI (HARDCODED!)
if (in_array($tenantId, [2, 3])) {
    $ixtifRules = <<<'IXTIF'
    ...
    IXTIF;
    $systemPrompt = $ixtifRules . "\n\n" . $systemPrompt;
}</div>

                <p><strong>Yeni Kod (Factory):</strong></p>
                <div class="code-block">// Factory'den service al (otomatik!)
$promptService = TenantServiceFactory::getPromptService();

// Tenant-specific rules'u al
$tenantRules = $promptService->getTenantSpecificRules();
$systemPrompt = implode("\n", $tenantRules) . "\n\n" . $systemPrompt;</div>

                <p><strong>FaydalarÄ±:</strong></p>
                <ul class="checklist">
                    <li>Tenant 1001 eklenirse kod deÄŸiÅŸmez!</li>
                    <li>Service yoksa DefaultPromptService kullanÄ±lÄ±r</li>
                    <li>Tenant-specific kurallar hep serviste kalÄ±r</li>
                    <li>AIResponseNode saf kalÄ±r (tenant-neutral)</li>
                </ul>
            </div>

            <h3>Ã–ncelik 4: Database Directives YapÄ±sÄ±nÄ± GeniÅŸlet</h3>

            <div class="card info">
                <h3 style="margin-top: 0;">Struktur: AITenantDirective'ler</h3>
                <p>Tenant-specific kurallar database'e taÅŸÄ±n:</p>
                <table>
                    <tr>
                        <th>Directive Key</th>
                        <th>Tipi</th>
                        <th>Ã–rnek DeÄŸer</th>
                    </tr>
                    <tr>
                        <td>negative_response_handling</td>
                        <td>String</td>
                        <td>"positive" / "fallback"</td>
                    </tr>
                    <tr>
                        <td>ask_on_ambiguous_request</td>
                        <td>Boolean</td>
                        <td>true / false</td>
                    </tr>
                    <tr>
                        <td>max_questions</td>
                        <td>Integer</td>
                        <td>2, 3, unlimited</td>
                    </tr>
                    <tr>
                        <td>product_filter_rules</td>
                        <td>JSON</td>
                        <td>{"spare_parts": true, "categories": [1,2,3]}</td>
                    </tr>
                </table>
            </div>

            <h3>Ã–ncelik 5: Tenant 1001 (MÃ¼zik) Ä°Ã§in Yol HaritasÄ±</h3>

            <div class="card">
                <h3 style="margin-top: 0;">YapÄ±lacaklar</h3>
                <ol>
                    <li><strong>Tenant1001PromptService.php</strong> oluÅŸtur (mÃ¼zik kurallarÄ±)</li>
                    <li><strong>Tenant1001SearchService.php</strong> oluÅŸtur (ÅŸarkÄ±/albÃ¼m arama)</li>
                    <li><strong>Factory Pattern</strong> kullanarak dynamic load (hardcode YOK!)</li>
                    <li>Test et: Tenant 2 ve 1001 aynÄ± anda Ã§alÄ±ÅŸÄ±r mÄ±?</li>
                </ol>
            </div>
        </section>

        <!-- IMPLEMENTATION PLAN -->
        <section>
            <h2>ğŸ› ï¸ Uygulama PlanÄ± (AdÄ±m AdÄ±m)</h2>

            <div class="card">
                <h3 style="margin-top: 0;">FAZA 1: Foundation (Factory & Interfaces)</h3>
                <ol>
                    <li>TenantServiceFactory.php oluÅŸtur</li>
                    <li>TenantPromptServiceInterface tanÄ±mla</li>
                    <li>TenantSearchServiceInterface tanÄ±mla</li>
                    <li>DefaultPromptService (fallback)</li>
                    <li>DefaultSearchService (fallback)</li>
                </ol>
                <p><span class="badge badge-warning">TAHMÄ°N</span> 3-4 saat</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">FAZA 2: Mevcut KodlarÄ± Refactor</h3>
                <ol>
                    <li>AIResponseNode.php gÃ¼ncelle (factory kullan)</li>
                    <li>ProductSearchNode.php gÃ¼ncelle (interface uygun hale getir)</li>
                    <li>PublicAIController.php temizle</li>
                    <li>Tenant2 servisleri interface implement ettir</li>
                </ol>
                <p><span class="badge badge-warning">TAHMÄ°N</span> 4-5 saat</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">FAZA 3: Testing & Validation</h3>
                <ol>
                    <li>Tenant 2 (ixtif.com) test: Prompt kurallarÄ± Ã§alÄ±ÅŸÄ±r mÄ±?</li>
                    <li>Tenant 2 (ixtif.com.tr) test: AynÄ± servisi kullanÄ±r mÄ±?</li>
                    <li>Tenant 1001 (muzibu) test: Default rules kullanÄ±r mÄ±?</li>
                    <li>Unit test yazma</li>
                    <li>Production deployment</li>
                </ol>
                <p><span class="badge badge-warning">TAHMÄ°N</span> 2-3 saat</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">FAZA 4: Tenant 1001 (MÃ¼zik) HazÄ±rlanmasÄ±</h3>
                <ol>
                    <li>Tenant1001PromptService.php oluÅŸtur</li>
                    <li>Tenant1001SearchService.php oluÅŸtur (mÃ¼zik albÃ¼m/ÅŸarkÄ± arama)</li>
                    <li>Database directives (mÃ¼zik kurallarÄ±)</li>
                    <li>Test & Deploy</li>
                </ol>
                <p><span class="badge badge-warning">TAHMÄ°N</span> 8-10 saat</p>
            </div>

            <p style="margin-top: 30px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <strong>Toplam Zaman:</strong> ~17-22 saat
                <br><strong>Benefit:</strong> 1000+ tenant iÃ§in Ã¶lÃ§eklenebilir mimarÄ±
            </p>
        </section>

        <!-- RISK ANALIZI -->
        <section>
            <h2>âš ï¸ Risk Analizi</h2>

            <div class="card warning">
                <h3 style="margin-top: 0;">Risk 1: Tenant 2/3 KurallarÄ± KÄ±rÄ±labilir</h3>
                <p><strong>SenaryĞ¾:</strong> Factory'e geÃ§iÅŸ sÄ±rasÄ±nda Tenant2PromptService'den kural kaÃ§Ä±rÄ±lÄ±r.</p>
                <p><strong>Azaltma:</strong></p>
                <ul class="checklist">
                    <li>KapsamlÄ± unit test yazma</li>
                    <li>Staging ortamÄ±nda test etme</li>
                    <li>Sadece Tenant 2 ile baÅŸlama</li>
                </ul>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">Risk 2: Service YÃ¼kleme BaÅŸarÄ±sÄ±zlÄ±ÄŸÄ±</h3>
                <p><strong>SenaryĞ¾:</strong> Tenant1001PromptService.php syntax hatasÄ± var, default service karamak isteyeceÄŸi sÄ±rada da hata.</p>
                <p><strong>Azaltma:</strong></p>
                <ul class="checklist">
                    <li>Try-catch kodu ekle</li>
                    <li>Log'u kontrol et</li>
                    <li>Default service robust olmalÄ±</li>
                </ul>
            </div>

            <div class="card warning">
                <h3 style="margin-top: 0;">Risk 3: Performance</h3>
                <p><strong>SenaryĞ¾:</strong> Her request'te factory new service oluÅŸturur.</p>
                <p><strong>Azaltma:</strong></p>
                <ul class="checklist">
                    <li>Service container caching</li>
                    <li>TenantAwareCacheService kullan</li>
                </ul>
            </div>
        </section>

        <!-- Ã–ZET TABLO -->
        <section>
            <h2>ğŸ“‹ KÄ±sa Ã–zet - Hardcoded Tenant Kontrolleri</h2>

            <table>
                <tr>
                    <th>Dosya</th>
                    <th>Problem Tipi</th>
                    <th>SatÄ±rlar</th>
                    <th>Ã‡Ã¶zÃ¼m</th>
                </tr>
                <tr>
                    <td><span class="file-path">AIResponseNode.php</span></td>
                    <td>Hardcoded [2,3]</td>
                    <td>85, 126</td>
                    <td>Factory pattern</td>
                </tr>
                <tr>
                    <td><span class="file-path">AIResponseNode.php</span></td>
                    <td>Tenant-specific kurallar</td>
                    <td>125-170</td>
                    <td>Service'e taÅŸÄ±</td>
                </tr>
                <tr>
                    <td><span class="file-path">PublicAIController.php</span></td>
                    <td>Hardcoded [2,3]</td>
                    <td>~55</td>
                    <td>Factory pattern</td>
                </tr>
                <tr>
                    <td><span class="file-path">ShopSearchService.php</span></td>
                    <td>Hardcoded [2,3] Ã—3</td>
                    <td>Ã‡ok</td>
                    <td>Factory pattern</td>
                </tr>
                <tr>
                    <td><span class="file-path">OptimizedPromptService.php</span></td>
                    <td>Hardcoded [2,3]</td>
                    <td>84, +1</td>
                    <td>Factory pattern</td>
                </tr>
                <tr>
                    <td><span class="file-path">Tenant2PromptService.php</span></td>
                    <td>Ä°Ã§ kontrol</td>
                    <td>~47</td>
                    <td>Zaten doÄŸru</td>
                </tr>
            </table>
        </section>

        <footer>
            ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu - Tenant-Aware MimarÄ± Analizi
            <br>Tarih: 2025-11-23 | Versiyon: 1.0
        </footer>
    </div>
</body>
</html>
