<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot AyarlarÄ± Dinamik Senkronizasyon - Muzibu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .badge { @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium; }
        .badge-blue { @apply bg-blue-500/20 text-blue-300 border border-blue-500/30; }
        .badge-green { @apply bg-green-500/20 text-green-300 border border-green-500/30; }
        pre { @apply overflow-x-auto; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <!-- Header -->
    <header class="relative border-b border-white/10">
        <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 via-purple-600/10 to-transparent"></div>
        <div class="relative max-w-6xl mx-auto px-6 py-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="badge badge-blue"><i class="fas fa-sync-alt mr-1.5"></i>Dinamik Senkronizasyon</span>
                <span class="text-gray-500">â€¢</span>
                <span class="text-gray-500 text-sm">5 Ocak 2026</span>
            </div>
            <h1 class="text-3xl font-bold mb-2">Spot AyarlarÄ± Dinamik Senkronizasyon</h1>
            <p class="text-gray-400">Ã‡alma AralÄ±ÄŸÄ± ve Aktif/Pasif durumunu tÃ¼m cihazlarda otomatik gÃ¼ncelleme</p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8 space-y-8">

        <!-- ğŸ“ Basit AnlatÄ±m -->
        <section class="bg-green-900/20 border border-green-800 rounded-xl p-6">
            <div class="flex items-center gap-2 mb-4">
                <i class="fas fa-book-open text-green-400"></i>
                <h2 class="text-xl font-semibold text-green-300">Basit AnlatÄ±m (Herkes Ä°Ã§in)</h2>
            </div>

            <div class="space-y-4 text-gray-200">
                <p class="text-lg font-medium">Åu anda ne sorun var?</p>
                <ul class="space-y-2 ml-4">
                    <li class="flex items-start gap-2">
                        <i class="fas fa-times text-red-400 mt-1"></i>
                        <span>Ana ÅŸube "KaÃ§ ÅŸarkÄ±da bir anons Ã§alsÄ±n?" ayarÄ±nÄ± deÄŸiÅŸtiriyor (Ã¶rn: 10 â†’ 15 ÅŸarkÄ±)</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-times text-red-400 mt-1"></i>
                        <span>Åubeler ve ana ÅŸube player'larÄ± eski ayarÄ± kullanmaya devam ediyor</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-times text-red-400 mt-1"></i>
                        <span>DeÄŸiÅŸiklik iÃ§in sayfa yenileme (F5) gerekiyor</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-times text-red-400 mt-1"></i>
                        <span>10 ÅŸube var? 10 yerde F5 basmak gerekiyor!</span>
                    </li>
                </ul>

                <p class="text-lg font-medium mt-6">Ne yapacaÄŸÄ±z?</p>
                <ul class="space-y-2 ml-4">
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-400 mt-1"></i>
                        <span>Ana ÅŸube ayarÄ± deÄŸiÅŸtirdiÄŸinde â†’ TÃ¼m ÅŸubeler <strong>otomatik</strong> algÄ±layacak</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-400 mt-1"></i>
                        <span>Sayfa yenileme yok! Arka planda sessizce gÃ¼ncellenir</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-400 mt-1"></i>
                        <span>Hem "Ã‡alma AralÄ±ÄŸÄ±" hem "Anons Aktif/Pasif" durumu dinamik</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check text-green-400 mt-1"></i>
                        <span>30 saniyede bir kontrol eder (hafif, server'Ä± yormaz)</span>
                    </li>
                </ul>

                <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mt-4">
                    <p class="text-blue-200"><strong>Ã–rnek Senaryo:</strong></p>
                    <p class="text-gray-300 mt-2">
                        Ana ÅŸube "10 ÅŸarkÄ±da bir" ayarÄ±nÄ± "15 ÅŸarkÄ±da bir" yapar.
                        30 saniye iÃ§inde tÃ¼m ÅŸubeler yeni ayarÄ± alÄ±r.
                        Kimsenin sayfa yenilemesine gerek kalmaz!
                    </p>
                </div>
            </div>
        </section>

        <!-- ğŸ”§ Teknik Detaylar -->
        <section class="bg-blue-900/20 border border-blue-800 rounded-xl p-6">
            <div class="flex items-center gap-2 mb-4">
                <i class="fas fa-cogs text-blue-400"></i>
                <h2 class="text-xl font-semibold text-blue-300">Teknik Detaylar (GeliÅŸtiriciler Ä°Ã§in)</h2>
            </div>

            <div class="space-y-6">
                <!-- Mevcut Sistem -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i>Mevcut Sistem (Sorunlu)</h3>
                    <div class="bg-slate-800/50 rounded-lg p-4 space-y-3">
                        <div>
                            <p class="text-gray-400 text-sm mb-2">Player Init (spot-player.js:50-68)</p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded overflow-x-auto"><code>async function init() {
    loadCounter();              // localStorage'dan sayaÃ§ yÃ¼kle
    await fetchSettings();      // API'den ayarlarÄ± Ã‡EK (1 kez!)
}

async function fetchSettings() {
    const data = await fetch('/api/spot/settings').json();
    state.songsBetween = data.songs_between || 10;  // â† Bir kez ayarlanÄ±yor!

    // âŒ SORUN: Ayarlar deÄŸiÅŸse bile player tekrar kontrol etmiyor
}</code></pre>
                        </div>

                        <div class="bg-red-900/20 border border-red-700 rounded p-3">
                            <p class="text-red-300 text-sm"><strong>Sorun:</strong> Player init sÄ±rasÄ±nda ayarlarÄ± 1 kez alÄ±yor, bir daha kontrol etmiyor!</p>
                        </div>
                    </div>
                </div>

                <!-- Yeni Sistem -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-green-300"><i class="fas fa-check-circle mr-2"></i>Yeni Sistem (Ã‡Ã¶zÃ¼m)</h3>

                    <div class="space-y-4">
                        <!-- AdÄ±m 1: Database -->
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2 text-blue-300">1. Database: Settings Version Ekle</h4>
                            <p class="text-gray-400 text-sm mb-3">Dosya: <code class="text-amber-400">Modules/Muzibu/database/migrations/tenant/YYYY_MM_DD_add_spot_settings_version.php</code></p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>Schema::table('muzibu_corporate_accounts', function (Blueprint $table) {
    $table->unsignedInteger('spot_settings_version')->default(1)
          ->after('spot_is_paused')
          ->comment('Ayarlar her deÄŸiÅŸtiÄŸinde artÄ±rÄ±lÄ±r');
});</code></pre>
                        </div>

                        <!-- AdÄ±m 2: Controller -->
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2 text-blue-300">2. Controller: Version'Ä± ArtÄ±r</h4>
                            <p class="text-gray-400 text-sm mb-3">Dosya: <code class="text-amber-400">Modules/Muzibu/app/Http/Controllers/Front/CorporateFrontController.php:1726</code></p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>public function updateSpotSettings(Request $request)
{
    // ... (mevcut kod)

    if ($request->has('spot_songs_between') || $request->has('spot_enabled')) {
        // âœ… YENÄ°: Ayarlar deÄŸiÅŸti, versiyonu artÄ±r!
        $data['spot_settings_version'] = DB::raw('spot_settings_version + 1');
    }

    $account->update($data);

    return response()->json([
        'success' => true,
        'settings' => [
            'spot_enabled' => $account->spot_enabled,
            'spot_songs_between' => $account->spot_songs_between,
            'spot_settings_version' => $account->spot_settings_version  // âœ… DÃ¶n!
        ]
    ]);
}</code></pre>
                        </div>

                        <!-- AdÄ±m 3: API -->
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2 text-blue-300">3. API: Version Bilgisini Ekle</h4>
                            <p class="text-gray-400 text-sm mb-3">Dosya: <code class="text-amber-400">Modules/Muzibu/app/Http/Controllers/Api/SpotController.php</code></p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>public function settings(Request $request)
{
    // ... (mevcut kod)

    return response()->json([
        'enabled' => $effectiveEnabled,
        'songs_between' => $parentAccount->spot_songs_between ?? 10,
        'corporate_id' => $parentAccount->id,
        'branch_id' => $account->id,
        'spot_is_paused' => $account->spot_is_paused,
        'spot_settings_version' => $parentAccount->spot_settings_version ?? 1,  // âœ… YENÄ°!
    ]);
}</code></pre>
                        </div>

                        <!-- AdÄ±m 4: JavaScript -->
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2 text-blue-300">4. JavaScript: Periyodik Kontrol</h4>
                            <p class="text-gray-400 text-sm mb-3">Dosya: <code class="text-amber-400">public/themes/muzibu/js/player/features/spot-player.js:20-40</code></p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>const state = {
    enabled: false,
    songsBetween: 10,
    songsPlayed: 0,
    currentVersion: 1,           // âœ… YENÄ°: Mevcut versiyon
    checkInterval: null,         // âœ… YENÄ°: Interval ID
};

async function init() {
    await fetchSettings();

    // âœ… YENÄ°: Her 30 saniyede bir ayarlarÄ± kontrol et
    state.checkInterval = setInterval(checkSettingsUpdate, 30000);
}

// âœ… YENÄ°: Ayarlar deÄŸiÅŸmiÅŸ mi kontrol et
async function checkSettingsUpdate() {
    try {
        const response = await fetch('/api/spot/settings');
        const data = await response.json();

        // Version farklÄ±ysa gÃ¼ncelle!
        if (data.spot_settings_version !== state.currentVersion) {
            console.log('ğŸ™ï¸ SpotPlayer: Settings updated! Refreshing...');

            state.songsBetween = data.songs_between || 10;
            state.enabled = data.enabled;
            state.isPaused = data.spot_is_paused;
            state.currentVersion = data.spot_settings_version;

            // SayacÄ± sÄ±fÄ±rla (yeni aralÄ±k iÃ§in)
            resetCounter();

            // âœ… UI'Ä± gÃ¼ncelle (Alpine.js event)
            window.dispatchEvent(new CustomEvent('spot-settings-updated', {
                detail: { songsBetween: state.songsBetween, enabled: state.enabled }
            }));
        }
    } catch (e) {
        console.error('ğŸ™ï¸ SpotPlayer: Failed to check settings', e);
    }
}</code></pre>
                        </div>

                        <!-- AdÄ±m 5: Alpine Component -->
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2 text-blue-300">5. Alpine.js: UI Senkronizasyonu</h4>
                            <p class="text-gray-400 text-sm mb-3">Dosya: Player footer'daki anons toggle component</p>
                            <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>&lt;div x-data="{
    spotEnabled: true,
    init() {
        // âœ… YENÄ°: Spot settings update event'ini dinle
        window.addEventListener('spot-settings-updated', (e) => {
            this.spotEnabled = e.detail.enabled && !window.MuzibuSpotPlayer.isPaused();
            console.log('ğŸ¨ UI: Spot settings updated!', e.detail);
        });

        // BaÅŸlangÄ±Ã§ senkronizasyonu
        const syncState = () => {
            if (window.MuzibuSpotPlayer) {
                this.spotEnabled = !window.MuzibuSpotPlayer.isPaused();
            }
        };
        setTimeout(syncState, 500);
    },
    toggle() { /* ... mevcut kod ... */ }
}"&gt;
    &lt;!-- Anons toggle UI --&gt;
&lt;/div&gt;</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ğŸ“Š Ã‡Ã¶zÃ¼m KarÅŸÄ±laÅŸtÄ±rmasÄ± -->
        <section class="bg-slate-800/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-balance-scale text-purple-400 mr-2"></i>Ã‡Ã¶zÃ¼m SeÃ§enekleri</h2>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-700/50">
                        <tr>
                            <th class="text-left p-3 border border-white/10">Ã‡Ã¶zÃ¼m</th>
                            <th class="text-left p-3 border border-white/10">Avantajlar</th>
                            <th class="text-left p-3 border border-white/10">Dezavantajlar</th>
                            <th class="text-center p-3 border border-white/10">Ã–neri</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-green-900/10 border-l-4 border-green-500">
                            <td class="p-3 border border-white/10 font-semibold">
                                <span class="badge badge-green">SeÃ§ildi</span><br>
                                Settings Version + Polling
                            </td>
                            <td class="p-3 border border-white/10">
                                â€¢ Basit implementasyon<br>
                                â€¢ Ek teknoloji yok<br>
                                â€¢ Hafif (30s polling)<br>
                                â€¢ Laravel cache entegre
                            </td>
                            <td class="p-3 border border-white/10">
                                â€¢ GerÃ§ek zamanlÄ± deÄŸil (30s gecikme)<br>
                                â€¢ Minimal API yÃ¼kÃ¼
                            </td>
                            <td class="p-3 border border-white/10 text-center">
                                <i class="fas fa-check-circle text-green-400 text-2xl"></i>
                            </td>
                        </tr>
                        <tr>
                            <td class="p-3 border border-white/10 font-semibold">WebSocket/Pusher</td>
                            <td class="p-3 border border-white/10">
                                â€¢ AnÄ±nda gÃ¼ncelleme<br>
                                â€¢ GerÃ§ek zamanlÄ±<br>
                                â€¢ Polling yok
                            </td>
                            <td class="p-3 border border-white/10">
                                â€¢ Pusher Ã¼creti<br>
                                â€¢ Server konfigÃ¼rasyonu<br>
                                â€¢ KarmaÅŸÄ±k implementasyon
                            </td>
                            <td class="p-3 border border-white/10 text-center">
                                <i class="fas fa-times-circle text-red-400 text-2xl"></i>
                            </td>
                        </tr>
                        <tr>
                            <td class="p-3 border border-white/10 font-semibold">Redis Pub/Sub</td>
                            <td class="p-3 border border-white/10">
                                â€¢ Hafif<br>
                                â€¢ Laravel entegre
                            </td>
                            <td class="p-3 border border-white/10">
                                â€¢ Yine polling gerekir<br>
                                â€¢ Settings version'dan farkÄ± yok
                            </td>
                            <td class="p-3 border border-white/10 text-center">
                                <i class="fas fa-meh-blank text-gray-400 text-2xl"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ğŸ¯ Uygulama AdÄ±mlarÄ± -->
        <section class="bg-slate-800/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-list-check text-amber-400 mr-2"></i>Uygulama AdÄ±mlarÄ±</h2>

            <div class="space-y-4">
                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">1</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">Migration OluÅŸtur ve Ã‡alÄ±ÅŸtÄ±r</h3>
                        <p class="text-gray-400 text-sm mb-2">Database'e <code class="text-amber-400">spot_settings_version</code> field ekle</p>
                        <pre class="text-xs text-gray-300 bg-slate-900 p-3 rounded"><code>php artisan make:migration add_spot_settings_version_to_corporate_accounts --path=Modules/Muzibu/database/migrations/tenant
php artisan tenants:migrate</code></pre>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">2</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">Controller'Ä± GÃ¼ncelle</h3>
                        <p class="text-gray-400 text-sm">CorporateFrontController::updateSpotSettings() - Version artÄ±rma ekle</p>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">3</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">API'ye Version Ekle</h3>
                        <p class="text-gray-400 text-sm">SpotController::settings() - Version bilgisini response'a ekle</p>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">4</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">JavaScript Polling Ekle</h3>
                        <p class="text-gray-400 text-sm">spot-player.js - checkSettingsUpdate() fonksiyonu ve interval</p>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">5</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">Alpine Component GÃ¼ncelle</h3>
                        <p class="text-gray-400 text-sm">Anons toggle component - Event listener ekle</p>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 font-bold">6</div>
                    <div class="flex-1">
                        <h3 class="font-semibold mb-1">Test Et</h3>
                        <p class="text-gray-400 text-sm">Ana ÅŸubede ayarÄ± deÄŸiÅŸtir, 30 saniye bekle, ÅŸube player'Ä±nÄ± kontrol et</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- âš ï¸ Ã–nemli Notlar -->
        <section class="bg-amber-900/20 border border-amber-700 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-exclamation-triangle text-amber-400 mr-2"></i>Ã–nemli Notlar</h2>

            <ul class="space-y-3">
                <li class="flex items-start gap-3">
                    <i class="fas fa-clock text-amber-400 mt-1"></i>
                    <div>
                        <strong>30 Saniye Gecikme:</strong>
                        <p class="text-gray-400 text-sm">Bu normal ve kabul edilebilir. Anons sistemi iÃ§in gerÃ§ek zamanlÄ± olmasÄ± kritik deÄŸil.</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fas fa-memory text-amber-400 mt-1"></i>
                    <div>
                        <strong>localStorage Temizleme:</strong>
                        <p class="text-gray-400 text-sm">Version deÄŸiÅŸince localStorage'daki sayaÃ§ sÄ±fÄ±rlanÄ±r (yeni aralÄ±k iÃ§in).</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fas fa-server text-amber-400 mt-1"></i>
                    <div>
                        <strong>Server YÃ¼kÃ¼:</strong>
                        <p class="text-gray-400 text-sm">30 saniyede 1 API Ã§aÄŸrÄ±sÄ± = saatte 120 istek = hafif (cache'lenebilir).</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fas fa-broadcast-tower text-amber-400 mt-1"></i>
                    <div>
                        <strong>TÃ¼m Ayarlar KapsanÄ±yor:</strong>
                        <p class="text-gray-400 text-sm">Hem "Ã‡alma AralÄ±ÄŸÄ±" hem "Anons Aktif/Pasif" durumu dinamik Ã§alÄ±ÅŸacak.</p>
                    </div>
                </li>
            </ul>
        </section>

    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10 bg-slate-800/30 mt-12">
        <div class="max-w-6xl mx-auto px-6 py-6 text-center text-gray-500 text-sm">
            <p>ğŸ¤– Generated with <a href="https://claude.com/claude-code" class="text-blue-400 hover:text-blue-300">Claude Code</a></p>
            <p class="mt-1">Co-Authored-By: Claude Sonnet 4.5</p>
        </div>
    </footer>

</body>
</html>