<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mevcut Sistem - HLS Fallback MP3 Sorunu ve Ã‡Ã¶zÃ¼m</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #4338ca;
        }

        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        section {
            margin-bottom: 50px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #818cf8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #fbbf24;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .alert-title {
            color: #ef4444;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-danger p {
            color: #fca5a5;
            margin-bottom: 10px;
            line-height: 1.8;
        }

        .code-example {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .code-example .comment { color: #6b7280; }
        .code-example .keyword { color: #c084fc; }
        .code-example .string { color: #10b981; }
        .code-example .error { color: #ef4444; }
        .code-example .success { color: #10b981; }

        .priority-list {
            display: grid;
            gap: 20px;
        }

        .priority-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 30px;
            border-radius: 12px;
            border-left: 5px solid #6366f1;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .priority-item:hover {
            transform: translateX(5px);
            background: rgba(30, 41, 59, 0.7);
        }

        .priority-item.critical {
            border-left-color: #ef4444;
        }

        .priority-item.important {
            border-left-color: #f59e0b;
        }

        .priority-item.medium {
            border-left-color: #3b82f6;
        }

        .priority-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .priority-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #a5b4fc;
        }

        .priority-item.critical .priority-title { color: #fca5a5; }
        .priority-item.important .priority-title { color: #fcd34d; }

        .priority-badge {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-critical { background: #dc2626; color: white; }
        .badge-important { background: #f59e0b; color: white; }
        .badge-medium { background: #3b82f6; color: white; }

        .time-badge {
            background: rgba(129, 140, 248, 0.2);
            color: #c7d2fe;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .priority-content p {
            color: #cbd5e1;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .priority-content ul {
            list-style: none;
            margin-top: 15px;
        }

        .priority-content li {
            color: #cbd5e1;
            padding-left: 25px;
            margin-bottom: 10px;
            position: relative;
        }

        .priority-content li:before {
            content: "â†’";
            color: #818cf8;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .comparison-card {
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            border-radius: 12px;
            border-top: 4px solid #ef4444;
        }

        .comparison-card.after {
            border-top-color: #10b981;
        }

        .comparison-card h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .comparison-card.before h4 { color: #fca5a5; }
        .comparison-card.after h4 { color: #6ee7b7; }

        .comparison-card ul {
            list-style: none;
        }

        .comparison-card li {
            padding-left: 25px;
            margin-bottom: 10px;
            position: relative;
            color: #cbd5e1;
        }

        .comparison-card.before li:before {
            content: "âœ—";
            color: #ef4444;
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .comparison-card.after li:before {
            content: "âœ“";
            color: #10b981;
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            background: rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-critical { 
            color: #fca5a5; 
            font-weight: bold;
        }

        .status-important { 
            color: #fcd34d; 
            font-weight: bold;
        }

        .status-medium { 
            color: #93c5fd; 
            font-weight: bold;
        }

        .summary-box {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid #6366f1;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }

        .summary-title {
            color: #c7d2fe;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .summary-list {
            list-style: none;
        }

        .summary-list li {
            color: #cbd5e1;
            padding: 12px 0;
            padding-left: 35px;
            position: relative;
            font-size: 1.05rem;
        }

        .summary-list li:before {
            content: "âœ“";
            color: #10b981;
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.4rem;
        }

        .tech-term {
            color: #fbbf24;
            font-weight: 500;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #4338ca;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”´ Mevcut Sistem - HLS Fallback MP3 Sorunu</h1>
            <div class="meta">
                <span>ğŸ“… Tarih: 2025-12-04</span>
                <span>ğŸ¯ Tenant: muzibu.com (1001)</span>
                <span>ğŸ”’ Odak: MP3 Fallback GÃ¼venlik Riski</span>
                <span>ğŸ‘¤ Hedef: Guest/Normal User iÃ§in 30 saniye HLS preview</span>
            </div>
        </header>

        <!-- Kritik Sorun -->
        <section>
            <h2>ğŸš¨ Kritik GÃ¼venlik Sorunu</h2>

            <div class="alert-danger">
                <div class="alert-title">
                    âš ï¸ MP3 FALLBACK RÄ°SKÄ° - ACÄ°L MÃœDAHALE GEREKLÄ°!
                </div>
                <p><strong>Sorun:</strong> HLS dÃ¶nÃ¼ÅŸÃ¼mÃ¼ tamamlanmamÄ±ÅŸ ÅŸarkÄ±lar iÃ§in sistem <span class="tech-term">MP3 fallback</span> kullanÄ±yor. Bu ÅŸifresiz MP3 dosyasÄ±nÄ± direkt serve ediyor!</p>
                <p><strong>Risk:</strong> MP3 URL'si paylaÅŸÄ±lÄ±rsa, kimlik doÄŸrulamasÄ± olmadan tÃ¼m ÅŸarkÄ± indirilebilir.</p>
                <p><strong>Etkilenen KullanÄ±cÄ±lar:</strong> Guest (Ã¼ye olmayan) + Normal User (premium olmayan)</p>
                <p><strong>Etki AlanÄ±:</strong> HenÃ¼z HLS'e dÃ¶nÃ¼ÅŸmemiÅŸ tÃ¼m ÅŸarkÄ±lar (lazy conversion bekleyen)</p>
            </div>

            <div class="code-example">
<span class="comment">// SongStreamController.php - Mevcut Kod (SORUNLU!)</span>

<span class="comment">// Guest kullanÄ±cÄ± iÃ§in:</span>
<span class="keyword">if</span> (<span class="variable">$song</span>-&gt;hls_converted &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$song</span>-&gt;hls_path)) {
    <span class="success">// âœ… HLS dÃ¶nÃ¼ÅŸmÃ¼ÅŸ â†’ GÃ¼venli (AES-128 ÅŸifreli)</span>
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">60</span>);
    <span class="variable">$streamType</span> = <span class="string">'hls'</span>;
} <span class="keyword">else</span> {
    <span class="error">// âŒ HLS dÃ¶nÃ¼ÅŸmemiÅŸ â†’ MP3 serve et (GÃœVENLÄ°K RÄ°SKÄ°!)</span>
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateStreamUrl</span>(<span class="variable">$songId</span>, <span class="string">30</span>);
    <span class="variable">$streamType</span> = <span class="string">'mp3'</span>;  <span class="error">â† SORUN BURADA!</span>
}
            </div>
        </section>

        <!-- Mevcut vs Hedef Durum -->
        <section>
            <h2>ğŸ“Š Mevcut Durum vs Hedef Durum</h2>

            <div class="comparison-grid">
                <div class="comparison-card before">
                    <h4>âŒ MEVCUT DURUM (Sorunlu)</h4>
                    <ul>
                        <li>HLS dÃ¶nÃ¼ÅŸmemiÅŸse MP3 serve edilir</li>
                        <li>MP3 URL'si ÅŸifresiz eriÅŸim saÄŸlar</li>
                        <li>URL paylaÅŸÄ±lÄ±rsa indirme riski</li>
                        <li>Guest user MP3'e eriÅŸebilir</li>
                        <li>30 saniye kontrolÃ¼ sadece client-side</li>
                    </ul>
                </div>

                <div class="comparison-card after">
                    <h4>âœ… HEDEF DURUM (GÃ¼venli)</h4>
                    <ul>
                        <li>Sadece HLS serve edilir (MP3 fallback yok)</li>
                        <li>TÃ¼m ÅŸarkÄ±lar AES-128 ÅŸifreli</li>
                        <li>URL paylaÅŸÄ±mÄ± iÅŸe yaramaz</li>
                        <li>Guest user sadece HLS preview (30 saniye)</li>
                        <li>6 chunk (5 saniye/chunk) hassas kontrol</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Ã–neri Listesi -->
        <section>
            <h2>ğŸ¯ Ã–neri Listesi - Ã–ncelik SÄ±rasÄ±yla</h2>

            <div class="priority-list">
                <!-- Ã–neri 1 -->
                <div class="priority-item critical">
                    <div class="priority-header">
                        <div class="priority-title">1ï¸âƒ£ Test MÃ¼ziklerini HLS'e DÃ¶nÃ¼ÅŸtÃ¼r</div>
                        <div class="priority-badge">
                            <span class="badge badge-critical">KRÄ°TÄ°K</span>
                            <span class="time-badge">â±ï¸ 5 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> Åu anki test ÅŸarkÄ±larÄ±nÄ± (deneme datalarÄ±) toplu olarak HLS + AES-128 ile dÃ¶nÃ¼ÅŸtÃ¼r.
                        </p>
                        <p><strong>NasÄ±l:</strong></p>
                        <div class="code-example">
<span class="comment"># 1. KaÃ§ ÅŸarkÄ± HLS'e dÃ¶nÃ¼ÅŸmemiÅŸ kontrol et</span>
mysql -u root -p tuufi_4ekim -e <span class="string">"
SELECT 
    COUNT(*) as toplam_sarki,
    SUM(hls_converted = 0) as hls_olmayan,
    SUM(hls_converted = 1) as hls_olan
FROM tenant_muzibu_1528d0.muzibu_songs 
WHERE is_active = 1;
"</span>

<span class="comment"># 2. Manuel toplu dÃ¶nÃ¼ÅŸÃ¼m baÅŸlat (Tinker ile)</span>
php artisan tinker

<span class="comment"># 3. Tinker iÃ§inde:</span>
&gt;&gt;&gt; <span class="variable">$songs</span> = \Modules\Muzibu\App\Models\Song::<span class="function">where</span>(<span class="string">'hls_converted'</span>, <span class="string">0</span>)-&gt;<span class="function">get</span>();
&gt;&gt;&gt; <span class="keyword">foreach</span>(<span class="variable">$songs</span> <span class="keyword">as</span> <span class="variable">$song</span>) { 
    \Modules\Muzibu\App\Jobs\ConvertToHLSJob::<span class="function">dispatch</span>(<span class="variable">$song</span>); 
}
&gt;&gt;&gt; <span class="function">echo</span> <span class="string">"Toplam {$songs-&gt;count()} ÅŸarkÄ± kuyruÄŸa eklendi"</span>;
                        </div>
                        <p><strong>Beklenen SonuÃ§:</strong> TÃ¼m test ÅŸarkÄ±larÄ± 5-10 dakika iÃ§inde HLS + AES-128'e dÃ¶nÃ¼ÅŸecek.</p>
                    </div>
                </div>

                <!-- Ã–neri 2 -->
                <div class="priority-item critical">
                    <div class="priority-header">
                        <div class="priority-title">2ï¸âƒ£ MP3 Fallback'i KaldÄ±r</div>
                        <div class="priority-badge">
                            <span class="badge badge-critical">KRÄ°TÄ°K</span>
                            <span class="time-badge">â±ï¸ 10 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> HLS dÃ¶nÃ¼ÅŸmemiÅŸse MP3 serve etme, bunun yerine "hazÄ±rlanÄ±yor" mesajÄ± gÃ¶ster.
                        </p>
                        <p><strong>Dosya:</strong> <code>SongStreamController.php</code> (Guest + Normal User bÃ¶lÃ¼mleri)</p>
                        <div class="code-example">
<span class="comment">// âŒ ESKÄ° KOD (SongStreamController.php - Line 64-75 ve 109-120)</span>
<span class="keyword">if</span> (<span class="variable">$song</span>-&gt;hls_converted &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$song</span>-&gt;hls_path)) {
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">60</span>);
    <span class="variable">$streamType</span> = <span class="string">'hls'</span>;
} <span class="keyword">else</span> {
    <span class="error">// MP3 fallback - KALDIRILACAK!</span>
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateStreamUrl</span>(<span class="variable">$songId</span>, <span class="string">30</span>);
    <span class="variable">$streamType</span> = <span class="string">'mp3'</span>;
}

<span class="comment">// âœ… YENÄ° KOD</span>
<span class="keyword">if</span> (<span class="variable">$song</span>-&gt;hls_converted &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$song</span>-&gt;hls_path)) {
    <span class="success">// HLS hazÄ±r â†’ Serve et</span>
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">60</span>);
    <span class="variable">$streamType</span> = <span class="string">'hls'</span>;
    <span class="variable">$fallbackUrl</span> = <span class="keyword">null</span>;
    
    <span class="keyword">return</span> <span class="function">response</span>()-&gt;<span class="function">json</span>([
        <span class="string">'status'</span> =&gt; <span class="string">'preview'</span>,
        <span class="string">'message'</span> =&gt; <span class="string">'KayÄ±t olun, tam dinleyin'</span>,
        <span class="string">'stream_url'</span> =&gt; <span class="variable">$streamUrl</span>,
        <span class="string">'stream_type'</span> =&gt; <span class="string">'hls'</span>,
        <span class="string">'preview_duration'</span> =&gt; <span class="string">30</span>,
        <span class="string">'preview_chunks'</span> =&gt; <span class="string">6</span>,
        <span class="string">'is_premium'</span> =&gt; <span class="keyword">false</span>,
    ]);
} <span class="keyword">else</span> {
    <span class="success">// HLS hazÄ±r deÄŸil â†’ DÃ¶nÃ¼ÅŸÃ¼m baÅŸlat + "hazÄ±rlanÄ±yor" mesajÄ±</span>
    ConvertToHLSJob::<span class="function">dispatch</span>(<span class="variable">$song</span>);
    
    <span class="keyword">return</span> <span class="function">response</span>()-&gt;<span class="function">json</span>([
        <span class="string">'status'</span> =&gt; <span class="string">'converting'</span>,
        <span class="string">'message'</span> =&gt; <span class="string">'ÅarkÄ± hazÄ±rlanÄ±yor, lÃ¼tfen 30 saniye bekleyip tekrar deneyin'</span>,
        <span class="string">'retry_after'</span> =&gt; <span class="string">30</span>,
        <span class="string">'preview_duration'</span> =&gt; <span class="string">30</span>,
        <span class="string">'is_premium'</span> =&gt; <span class="keyword">false</span>,
    ], <span class="string">202</span>); <span class="comment">// HTTP 202 Accepted</span>
}
                        </div>
                        <p><strong>Beklenen SonuÃ§:</strong> HiÃ§bir ÅŸarkÄ± ÅŸifresiz MP3 olarak serve edilmeyecek!</p>
                    </div>
                </div>

                <!-- Ã–neri 3 -->
                <div class="priority-item important">
                    <div class="priority-header">
                        <div class="priority-title">3ï¸âƒ£ Chunk SÃ¼resi Optimizasyonu (10s â†’ 5s)</div>
                        <div class="priority-badge">
                            <span class="badge badge-important">Ã–NEMLÄ°</span>
                            <span class="time-badge">â±ï¸ 15 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> 30 saniye preview iÃ§in daha hassas kontrol. 3 chunk Ã§ok az!
                        </p>
                        <p><strong>Åu an:</strong> 10 saniye/chunk â†’ 30 saniye = 3 chunk</p>
                        <p><strong>Yeni:</strong> 5 saniye/chunk â†’ 30 saniye = <strong>6 chunk</strong> (2x daha hassas!)</p>
                        <p><strong>Dosya:</strong> <code>ConvertToHLSJob.php</code></p>
                        <div class="code-example">
<span class="comment">// Line 123: FFmpeg command</span>

<span class="comment">// âŒ ESKÄ°: -hls_time 10 (10 saniye/chunk)</span>
<span class="variable">$command</span> = <span class="function">sprintf</span>(
    <span class="string">'ffmpeg -i %s -map 0:a -c:a aac -b:a %dk -af %s -start_number 0 -hls_time 10 ...'</span>
);

<span class="comment">// âœ… YENÄ°: -hls_time 5 (5 saniye/chunk)</span>
<span class="variable">$command</span> = <span class="function">sprintf</span>(
    <span class="string">'ffmpeg -i %s -map 0:a -c:a aac -b:a %dk -af %s -start_number 0 -hls_time 5 ...'</span>
);
                        </div>
                        <p><strong>Beklenen SonuÃ§:</strong></p>
                        <ul>
                            <li>30 saniye preview = 6 chunk (segment-000.ts ... segment-005.ts)</li>
                            <li>Server-side chunk kontrolÃ¼ daha hassas</li>
                            <li>Guest user 7. chunk'Ä± isterse â†’ 403 Forbidden</li>
                        </ul>
                        <p><strong>Not:</strong> Bu deÄŸiÅŸiklik sonrasÄ± yeni yÃ¼klenen ÅŸarkÄ±lar 5 saniye chunk ile dÃ¶nÃ¼ÅŸecek. Mevcut HLS'li ÅŸarkÄ±lar 10 saniye olarak kalÄ±r (sorun deÄŸil).</p>
                    </div>
                </div>

                <!-- Ã–neri 4 -->
                <div class="priority-item important">
                    <div class="priority-header">
                        <div class="priority-title">4ï¸âƒ£ Preview Limiti 30 Saniye Net Ayarla</div>
                        <div class="priority-badge">
                            <span class="badge badge-important">Ã–NEMLÄ°</span>
                            <span class="time-badge">â±ï¸ 5 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> Response'ta <code>preview_chunks</code> parametresi ekle, frontend'de chunk sayÄ±sÄ± kontrolÃ¼ yap.
                        </p>
                        <p><strong>Dosya:</strong> <code>SongStreamController.php</code></p>
                        <div class="code-example">
<span class="comment">// Guest User Response</span>
<span class="keyword">return</span> <span class="function">response</span>()-&gt;<span class="function">json</span>([
    <span class="string">'status'</span> =&gt; <span class="string">'preview'</span>,
    <span class="string">'message'</span> =&gt; <span class="string">'KayÄ±t olun, tam dinleyin'</span>,
    <span class="string">'stream_url'</span> =&gt; <span class="variable">$streamUrl</span>,
    <span class="string">'stream_type'</span> =&gt; <span class="string">'hls'</span>,
    <span class="string">'preview_duration'</span> =&gt; <span class="string">30</span>,        <span class="success">â† 30 saniye sabit</span>
    <span class="string">'preview_chunks'</span> =&gt; <span class="string">6</span>,            <span class="success">â† 6 chunk (5 saniye/chunk)</span>
    <span class="string">'chunk_duration'</span> =&gt; <span class="string">5</span>,            <span class="success">â† Her chunk 5 saniye</span>
    <span class="string">'is_premium'</span> =&gt; <span class="keyword">false</span>,
]);

<span class="comment">// Normal User (Premium deÄŸil) Response</span>
<span class="keyword">return</span> <span class="function">response</span>()-&gt;<span class="function">json</span>([
    <span class="string">'status'</span> =&gt; <span class="string">'preview'</span>,
    <span class="string">'message'</span> =&gt; <span class="string">'Premium'a geÃ§in, sÄ±nÄ±rsÄ±z dinleyin'</span>,
    <span class="string">'stream_url'</span> =&gt; <span class="variable">$streamUrl</span>,
    <span class="string">'stream_type'</span> =&gt; <span class="string">'hls'</span>,
    <span class="string">'preview_duration'</span> =&gt; <span class="string">30</span>,
    <span class="string">'preview_chunks'</span> =&gt; <span class="string">6</span>,
    <span class="string">'chunk_duration'</span> =&gt; <span class="string">5</span>,
    <span class="string">'is_premium'</span> =&gt; <span class="keyword">false</span>,
]);
                        </div>
                        <p><strong>Frontend Implementation (Opsiyonel):</strong> HLS player'da chunk sayÄ±sÄ±nÄ± kontrol et, 6. chunk'tan sonra durmasÄ±nÄ± saÄŸla.</p>
                    </div>
                </div>

                <!-- Ã–neri 5 -->
                <div class="priority-item medium">
                    <div class="priority-header">
                        <div class="priority-title">5ï¸âƒ£ Key Endpoint Token Validation</div>
                        <div class="priority-badge">
                            <span class="badge badge-medium">ORTA</span>
                            <span class="time-badge">â±ï¸ 20 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> Encryption key endpoint'ine ek gÃ¼venlik katmanlarÄ± ekle.
                        </p>
                        <p><strong>Dosya:</strong> <code>SongController.php - serveEncryptionKey()</code></p>
                        <div class="code-example">
<span class="keyword">public function</span> <span class="function">serveEncryptionKey</span>(<span class="keyword">int</span> <span class="variable">$id</span>, Request <span class="variable">$request</span>)
{
    <span class="success">// 1. Referer Check (Hotlink engelleme)</span>
    <span class="variable">$referer</span> = <span class="variable">$request</span>-&gt;<span class="function">header</span>(<span class="string">'Referer'</span>);
    <span class="variable">$allowedDomain</span> = <span class="function">tenant</span>()-&gt;domains-&gt;<span class="function">first</span>()-&gt;domain;
    
    <span class="keyword">if</span> (!<span class="variable">$referer</span> || !<span class="function">str_contains</span>(<span class="variable">$referer</span>, <span class="variable">$allowedDomain</span>)) {
        Log::<span class="function">warning</span>(<span class="string">'Invalid referer for key request'</span>, [
            <span class="string">'song_id'</span> =&gt; <span class="variable">$id</span>,
            <span class="string">'referer'</span> =&gt; <span class="variable">$referer</span>
        ]);
        <span class="function">abort</span>(<span class="string">403</span>, <span class="string">'Invalid referer'</span>);
    }
    
    <span class="success">// 2. User Agent Check (Bot filtresi)</span>
    <span class="variable">$userAgent</span> = <span class="variable">$request</span>-&gt;<span class="function">userAgent</span>();
    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$userAgent</span>) || <span class="function">str_contains</span>(<span class="function">strtolower</span>(<span class="variable">$userAgent</span>), <span class="string">'bot'</span>)) {
        <span class="function">abort</span>(<span class="string">403</span>, <span class="string">'Invalid user agent'</span>);
    }
    
    <span class="success">// 3. Rate Limiting (zaten route'ta var ama double-check)</span>
    <span class="success">// 4. Song + encryption key kontrolÃ¼ (mevcut kod)</span>
    <span class="variable">$song</span> = Song::<span class="function">where</span>(<span class="string">'song_id'</span>, <span class="variable">$id</span>)-&gt;<span class="function">where</span>(<span class="string">'is_active'</span>, <span class="string">1</span>)-&gt;<span class="function">first</span>();
    <span class="comment">// ... rest of the code</span>
}
                        </div>
                        <p><strong>Beklenen SonuÃ§:</strong> Encryption key sadece yetkili stream istekleri iÃ§in serve edilir, bot/hotlink engellenir.</p>
                    </div>
                </div>

                <!-- Ã–neri 6 -->
                <div class="priority-item medium">
                    <div class="priority-header">
                        <div class="priority-title">6ï¸âƒ£ Signed URL SÃ¼resi KÄ±saltma</div>
                        <div class="priority-badge">
                            <span class="badge badge-medium">ORTA</span>
                            <span class="time-badge">â±ï¸ 5 dakika</span>
                        </div>
                    </div>
                    <div class="priority-content">
                        <p>
                            <strong>AmaÃ§:</strong> Guest/Normal user iÃ§in token sÃ¼relerini kÄ±salt, URL paylaÅŸÄ±m riskini azalt.
                        </p>
                        <p><strong>Dosya:</strong> <code>SongStreamController.php</code></p>
                        <div class="code-example">
<span class="comment">// âŒ ESKÄ° SÃœRE (TÃ¼m user tipleri iÃ§in aynÄ±)</span>
<span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">60</span>); <span class="comment">// 60 dakika</span>

<span class="comment">// âœ… YENÄ° SÃœRE (User tipine gÃ¶re)</span>

<span class="comment">// Guest User (Ã¼ye deÄŸil)</span>
<span class="keyword">if</span> (!<span class="variable">$user</span>) {
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">10</span>); <span class="success">// 10 dakika</span>
}

<span class="comment">// Normal User (premium deÄŸil)</span>
<span class="keyword">if</span> (!<span class="variable">$user</span>-&gt;<span class="function">isPremium</span>()) {
    <span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">15</span>); <span class="success">// 15 dakika</span>
}

<span class="comment">// Premium User</span>
<span class="variable">$streamUrl</span> = <span class="variable">$this</span>-&gt;signedUrlService-&gt;<span class="function">generateHlsUrl</span>(<span class="variable">$songId</span>, <span class="string">60</span>); <span class="success">// 60 dakika (deÄŸiÅŸmez)</span>
                        </div>
                        <p><strong>Beklenen SonuÃ§:</strong> Guest user URL'i paylaÅŸsa bile 10 dakika sonra geÃ§ersiz olur.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ã–ncelik Tablosu -->
        <section>
            <h2>ğŸ“‹ Implementation Ã–ncelik Tablosu</h2>

            <table>
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 40%;">Ä°ÅŸlem</th>
                        <th style="width: 15%;">SÃ¼re</th>
                        <th style="width: 20%;">Kritiklik</th>
                        <th style="width: 20%;">Dosya</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>Test mÃ¼ziklerini HLS'e dÃ¶nÃ¼ÅŸtÃ¼r</td>
                        <td>5 dk</td>
                        <td class="status-critical">ğŸ”´ KRÄ°TÄ°K</td>
                        <td>Tinker</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>MP3 fallback'i kaldÄ±r</td>
                        <td>10 dk</td>
                        <td class="status-critical">ğŸ”´ KRÄ°TÄ°K</td>
                        <td>SongStreamController.php</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Chunk sÃ¼resini 5 saniye yap</td>
                        <td>15 dk</td>
                        <td class="status-important">ğŸŸ¡ Ã–NEMLÄ°</td>
                        <td>ConvertToHLSJob.php</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Preview limiti 30 saniye ayarla</td>
                        <td>5 dk</td>
                        <td class="status-important">ğŸŸ¡ Ã–NEMLÄ°</td>
                        <td>SongStreamController.php</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Key endpoint gÃ¼venliÄŸi</td>
                        <td>20 dk</td>
                        <td class="status-medium">ğŸŸ¢ ORTA</td>
                        <td>SongController.php</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>Signed URL sÃ¼resi kÄ±salt</td>
                        <td>5 dk</td>
                        <td class="status-medium">ğŸŸ¢ ORTA</td>
                        <td>SongStreamController.php</td>
                    </tr>
                    <tr style="background: rgba(99, 102, 241, 0.1); font-weight: bold;">
                        <td colspan="2"><strong>TOPLAM</strong></td>
                        <td><strong>~1 saat</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Beklenen SonuÃ§lar -->
        <section>
            <h2>ğŸ‰ Beklenen SonuÃ§lar</h2>

            <div class="summary-box">
                <div class="summary-title">âœ… Bu DeÄŸiÅŸiklikler UygulandÄ±ktan Sonra:</div>
                <ul class="summary-list">
                    <li><strong>%100 HLS Streaming:</strong> HiÃ§bir ÅŸarkÄ± ÅŸifresiz MP3 olarak serve edilmeyecek</li>
                    <li><strong>30 Saniye Preview:</strong> Guest/Normal user sadece 6 chunk (30 saniye) dinleyebilecek</li>
                    <li><strong>Hassas Kontrol:</strong> 5 saniye/chunk â†’ Server-side chunk index kontrolÃ¼ kolaylaÅŸacak</li>
                    <li><strong>URL PaylaÅŸÄ±mÄ± Ä°ÅŸe Yaramaz:</strong> Guest iÃ§in 10 dakika, Normal user iÃ§in 15 dakika token sÃ¼resi</li>
                    <li><strong>Key Endpoint KorumalÄ±:</strong> Referer + User Agent + Rate limiting ile gÃ¼Ã§lendirilecek</li>
                    <li><strong>Premium AvantajÄ± Net:</strong> Sadece premium user'lar sÄ±nÄ±rsÄ±z dinleyebilir</li>
                </ul>
            </div>
        </section>

        <!-- SÄ±radaki AdÄ±m -->
        <section>
            <h2>ğŸš€ SÄ±radaki AdÄ±m</h2>

            <div class="alert-danger">
                <div class="alert-title">ğŸ’¬ KullanÄ±cÄ± OnayÄ± Bekleniyor</div>
                <p><strong>SeÃ§enek 1:</strong> TÃ¼m Ã¶nerileri sÄ±rayla uygula (1-2-3-4-5-6)</p>
                <p><strong>SeÃ§enek 2:</strong> Sadece kritik olanlarÄ± uygula (1-2), ardÄ±ndan test et</p>
                <p><strong>SeÃ§enek 3:</strong> Ã–nce X numaralÄ± Ã¶neriyi uygula</p>
                <p style="margin-top: 20px; font-size: 1.1rem;"><strong>ğŸ‘‰ Hangi yaklaÅŸÄ±mÄ± tercih ediyorsun?</strong></p>
            </div>
        </section>

        <footer>
            ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu | ğŸ“… 2025-12-04 | ğŸ¯ MÃ¼zibu Tenant 1001
        </footer>
    </div>
</body>
</html>
