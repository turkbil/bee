<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muzibu Platform - Master DÃ¼zenleme PlanÄ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0f172a;
            color: #e2e8f0;
            font-family: "Courier New", monospace;
            padding: 40px 20px;
            line-height: 1.8;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #f87171, #fb923c, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .box {
            border: 2px solid #334155;
            padding: 20px;
            margin: 30px 0;
            background: #1e293b;
            border-radius: 8px;
        }

        .box-title {
            color: #fbbf24;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .ascii-box {
            background: #0f172a;
            border: 1px solid #475569;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre;
            color: #cbd5e1;
        }

        .error {
            background: #7f1d1d;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
        }

        .error-title {
            color: #fca5a5;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .solution {
            background: #064e3b;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
        }

        .solution-title {
            color: #6ee7b7;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .code {
            background: #1e293b;
            padding: 2px 6px;
            border-radius: 3px;
            color: #60a5fa;
            font-size: 0.95em;
        }

        .warning {
            background: #713f12;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-title {
            color: #fcd34d;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .flow-step {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #475569;
            margin-bottom: 10px;
        }

        .check { color: #10b981; }
        .cross { color: #ef4444; }
        .arrow { color: #fbbf24; }

        a { color: #60a5fa; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">

        <h1>ğŸµ MUZÄ°BU MÃœZÄ°K PLATFORMU</h1>
        <div class="subtitle">SUBSCRIPTION & DEVICE LIMIT SÄ°STEMÄ° - MASTER DÃœZENLEME PLANI</div>

        <!-- 1. ÃœYELÄ°K HÄ°YERARÅÄ°SÄ° -->
        <div class="box">
            <div class="box-title">1. ÃœYELÄ°K HÄ°YERARÅÄ°SÄ° VE DÄ°NLEME HAKLARI</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KULLANICI TÃœRLERÄ°                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GUEST (Ãœye deÄŸil)          â†’ 30 saniye preview                 â”‚
â”‚  ÃœCRETSÄ°Z ÃœYE               â†’ 30 saniye preview                 â”‚
â”‚  PREMIUM / TRIAL ÃœYE        â†’ SÄ±nÄ±rsÄ±z dinleme                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA:</div>
                <div>Guest ve Ã¼cretsiz Ã¼ye ayrÄ±mÄ± kodda tam yapÄ±lmamÄ±ÅŸ!</div>
                <div style="margin-top: 10px;">
                    <strong>Dosya:</strong> <span class="code">SongStreamController.php</span><br>
                    <strong>SatÄ±r:</strong> 52-149<br>
                    <strong>Sorun:</strong> Guest ($user == null) ve non-premium ($user->isPremiumOrTrial() == false) iÃ§in AYNI kod bloÄŸu tekrarlanÄ±yor.
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM:</div>
                <div>Helper method oluÅŸtur: <span class="code">getPreviewStreamResponse($song, $userType)</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">protected function getPreviewStreamResponse(Song $song, string $userType): JsonResponse
{
    // HLS conversion baÅŸlat
    if ($song->needsHlsConversion()) {
        ConvertToHLSJob::dispatch($song);
    }

    // Stream URL hazÄ±rla
    if (!empty($song->hls_path)) {
        $streamUrl = route('api.muzibu.songs.dynamic-playlist', ['id' => $song->song_id]);
        $streamType = 'hls';
        $fallbackUrl = $this->signedUrlService->generateStreamUrl($song->song_id, 30, true);
    } else {
        $streamUrl = $this->signedUrlService->generateStreamUrl($song->song_id, 30);
        $streamType = 'mp3';
        $fallbackUrl = null;
    }

    $message = $userType === 'guest'
        ? 'KayÄ±t olun, tam dinleyin'
        : 'Premium\'a geÃ§in, sÄ±nÄ±rsÄ±z dinleyin';

    return response()->json([
        'status' => 'preview',
        'message' => $message,
        'stream_url' => $streamUrl,
        'stream_type' => $streamType,
        'fallback_url' => $fallbackUrl,
        'preview_duration' => 30,
        'is_premium' => false,
    ]);
}</pre>
                </div>
            </div>
        </div>

        <!-- 2. CÄ°HAZ LÄ°MÄ°TÄ° FALLBACK -->
        <div class="box">
            <div class="box-title">2. CÄ°HAZ LÄ°MÄ°TÄ° FALLBACK SÄ°STEMÄ° (3 Seviyeli)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CÄ°HAZ LÄ°MÄ°TÄ° BELÄ°RLEME SIRASI                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. User->device_limit      â†’ VIP/Test/Ban Ã¶zel durumlar        â”‚
â”‚  2. SubscriptionPlan->device_limit â†’ Premium plan limiti        â”‚
â”‚  3. Setting('auth_device_limit')   â†’ Tenant global ayar         â”‚
â”‚  4. Fallback: 1 cihaz       â†’ HiÃ§biri yoksa                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="solution">
                <div class="solution-title">âœ… DOÄRU UYGULAMA (MEVCUT):</div>
                <div>
                    <strong>Dosya:</strong> <span class="code">DeviceService.php:220-252</span><br>
                    <strong>Method:</strong> <span class="code">getDeviceLimit(User $user)</span>
                </div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">public function getDeviceLimit(User $user): int
{
    // 1. User override (VIP/Test/Ban)
    if ($user->device_limit !== null && $user->device_limit > 0) {
        return $user->device_limit;
    }

    // 2. Subscription Plan device_limit
    $subscription = $user->subscriptions()
        ->whereIn('status', ['active', 'trial'])
        ->where(function($q) {
            $q->whereNull('current_period_end')
              ->orWhere('current_period_end', '>', now());
        })
        ->with('plan')
        ->first();

    if ($subscription && $subscription->plan && $subscription->plan->device_limit) {
        return (int) $subscription->plan->device_limit;
    }

    // 3. Tenant setting fallback
    if (function_exists('setting') && setting('auth_device_limit')) {
        return (int) setting('auth_device_limit');
    }

    // 4. Ultimate fallback
    return 1;
}</pre>
                </div>
            </div>

            <div class="warning">
                <div class="warning-title">âš ï¸ DÄ°KKAT:</div>
                <div><strong>BROWSER + SÄ°STEM ANIMI:</strong> Mevcut sistemde device detection <span class="code">Jenssegers\Agent</span> ile yapÄ±lÄ±yor.</div>
                <div style="margin-top: 8px;"><strong>KayÄ±t Edilen Bilgiler:</strong></div>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>device_type: desktop / mobile / tablet</li>
                    <li>device_name: "Windows 11 - Chrome"</li>
                    <li>browser: Chrome, Firefox, Safari</li>
                    <li>platform: Windows, macOS, Android, iOS</li>
                    <li>ip_address: KullanÄ±cÄ± IP</li>
                </ul>
            </div>
        </div>

        <!-- 3. LOGIN AKIÅI -->
        <div class="box">
            <div class="box-title">3. LOGIN AKIÅI (Cihaz Limit KontrolÃ¼)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. KullanÄ±cÄ± email/password girer                              â”‚
â”‚  2. Credentials doÄŸrulanÄ±r                                       â”‚
â”‚  3. DeviceService.checkDeviceLimitBeforeLogin() Ã§aÄŸrÄ±lÄ±r        â”‚
â”‚     â”œâ”€â”€ Limit AÅILMADI â†’ Normal login devam                     â”‚
â”‚     â””â”€â”€ Limit AÅILDI   â†’ 403 + device_limit_exceeded response   â”‚
â”‚  4. Frontend Device Selection Modal aÃ§ar                         â”‚
â”‚     â”œâ”€â”€ Aktif cihazlar listelenir (IP, Browser, Platform, Son)  â”‚
â”‚     â””â”€â”€ KullanÄ±cÄ± Ã§Ä±karmak istediÄŸi cihazÄ± seÃ§er               â”‚
â”‚  5. terminateDevice() API Ã§aÄŸrÄ±lÄ±r (credential-based)           â”‚
â”‚  6. SeÃ§ilen cihazÄ±n session'Ä± silinir                           â”‚
â”‚  7. KullanÄ±cÄ± tekrar login yapar (artÄ±k limit altÄ±nda)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA 1: CSRF Token Mismatch</div>
                <div><strong>Sorun:</strong> SPA (Single Page Application) yapÄ±sÄ±nda CSRF token yenilenmesi eksik!</div>
                <div style="margin-top: 10px;">
                    <strong>Senaryo:</strong><br>
                    1. KullanÄ±cÄ± sayfayÄ± aÃ§ar (CSRF token alÄ±r)<br>
                    2. Uzun sÃ¼re bekler (session timeout)<br>
                    3. Login yapmaya Ã§alÄ±ÅŸÄ±r<br>
                    4. <span class="cross">âŒ</span> CSRF token mismatch hatasÄ±!
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Otomatik CSRF Token Yenileme</div>
                <div><strong>Dosya:</strong> <span class="code">resources/views/themes/muzibu/layouts/app.blade.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">// CSRF token yenileme interceptor ekle
axios.interceptors.response.use(
    response => response,
    error => {
        // CSRF token mismatch hatasÄ±
        if (error.response?.status === 419) {
            console.warn('CSRF token expired, refreshing...');

            // Yeni token al
            return axios.get('/sanctum/csrf-cookie').then(() => {
                // Token yenilendi, isteÄŸi tekrar gÃ¶nder
                return axios(error.config);
            });
        }
        return Promise.reject(error);
    }
);</pre>
                </div>
            </div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA 2: Device Selection Modal Eksik</div>
                <div><strong>Sorun:</strong> <span class="code">checkDeviceLimitBeforeLogin()</span> backend'de var ama frontend modal entegrasyonu yok!</div>
                <div style="margin-top: 10px;">
                    <strong>Dosya:</strong> <span class="code">DeviceService.php:282-321</span><br>
                    <strong>Return:</strong> <span class="code">can_login, devices[], limit</span> dÃ¶ndÃ¼rÃ¼yor ama frontend kullanmÄ±yor!
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Frontend Login Flow GÃ¼ncelle</div>
                <div><strong>Dosya:</strong> <span class="code">public/themes/muzibu/js/features/auth.js</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">async login() {
    try {
        const response = await axios.post('/api/login', this.loginForm);

        // Login baÅŸarÄ±lÄ±
        window.location.reload();

    } catch (error) {
        // CSRF token yenileme zaten interceptor'da

        // Device limit kontrolÃ¼
        if (error.response?.status === 403 &&
            error.response?.data?.error === 'device_limit_exceeded') {

            // Device selection modal aÃ§
            this.activeDevices = error.response.data.devices;
            this.deviceLimit = error.response.data.limit;
            this.showDeviceSelectionModal = true;
            return;
        }

        // DiÄŸer hatalar
        this.authError = error.response?.data?.message || 'GiriÅŸ baÅŸarÄ±sÄ±z';
    }
}</pre>
                </div>
            </div>
        </div>

        <!-- 4. SESSION POLLING -->
        <div class="box">
            <div class="box-title">4. SESSION POLLING SÄ°STEMÄ° (30 Saniye)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             SESSION POLLING AKIÅI (Her 30 Saniye)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. KullanÄ±cÄ± giriÅŸ yapar â†’ Redis session baÅŸlar                â”‚
â”‚  2. Frontend setInterval(30000) baÅŸlatÄ±r                         â”‚
â”‚  3. Her 30 saniyede /api/device/ping Ã§aÄŸrÄ±lÄ±r                   â”‚
â”‚  4. DeviceService::updateSessionActivity() Ã§alÄ±ÅŸÄ±r              â”‚
â”‚     â”œâ”€â”€ user_active_sessions.last_activity gÃ¼ncellenir          â”‚
â”‚     â””â”€â”€ Redis session TTL yenilenir (120 dakika)                â”‚
â”‚  5. Response: { device_limit_status, active_devices }           â”‚
â”‚  6. EÄŸer device_limit_exceeded â†’ Modal gÃ¶ster                   â”‚
â”‚  7. KullanÄ±cÄ± logout olursa â†’ Polling durdur                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="solution">
                <div class="solution-title">âœ… DOÄRU UYGULAMA (MEVCUT):</div>
                <div>
                    <strong>Dosya:</strong> <span class="code">DeviceService.php:110-151</span><br>
                    <strong>Method:</strong> <span class="code">updateSessionActivity()</span>
                </div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">public function updateSessionActivity(): array
{
    $user = auth('web')->user() ?? auth('sanctum')->user();

    if (!$user) {
        return ['status' => 'unauthenticated'];
    }

    $sessionId = session()->getId();

    // MySQL: last_activity gÃ¼ncelle
    UserActiveSession::where('session_id', $sessionId)
        ->where('user_id', $user->id)
        ->update(['last_activity' => now()]);

    // Redis: Session TTL yenile (120 dakika)
    Redis::expire("laravel_session:{$sessionId}", 7200);

    // Mevcut cihaz limiti kontrol
    $deviceLimit = $this->getDeviceLimit($user);
    $activeDevices = $this->getActiveDevicesCount($user);

    return [
        'status' => 'active',
        'device_limit' => $deviceLimit,
        'active_devices' => $activeDevices,
        'device_limit_exceeded' => $activeDevices > $deviceLimit,
    ];
}</pre>
                </div>
            </div>

            <div class="warning">
                <div class="warning-title">âš ï¸ DÄ°KKAT: HARDCODED DEÄER!</div>
                <div>
                    <strong>Sorun:</strong> Polling interval frontend'de hardcoded: <span class="code">30000 ms</span><br>
                    <strong>Dosya:</strong> <span class="code">public/themes/muzibu/js/player/core/player-core.js</span><br>
                    <strong>SatÄ±r:</strong> ~850 (setInterval iÃ§inde)
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Config DosyasÄ±na TaÅŸÄ±</div>
                <div><strong>Yeni Dosya:</strong> <span class="code">config/muzibu.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">return [
    'session' => [
        'polling_interval' => env('MUZIBU_SESSION_POLLING', 30000), // ms
        'ttl' => env('MUZIBU_SESSION_TTL', 7200), // saniye
    ],
];</pre>
                </div>
                <div style="margin-top: 10px;"><strong>Blade Template:</strong></div>
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">window.muzibuPlayerConfig = {
    sessionPollingInterval: {{ config('muzibu.session.polling_interval') }},
};</pre>
            </div>
        </div>

        <!-- 5. STREAM AKIÅI -->
        <div class="box">
            <div class="box-title">5. STREAM AKIÅI (HLS + MP3 Fallback)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STREAM URL Ä°STEÄÄ° AKIÅI                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Frontend /api/muzibu/songs/{id}/stream Ã§aÄŸrÄ±sÄ± yapar        â”‚
â”‚  2. SongStreamController::stream() method Ã§alÄ±ÅŸÄ±r               â”‚
â”‚  3. User kontrolÃ¼:                                               â”‚
â”‚     â”œâ”€â”€ Guest ($user == null)                                   â”‚
â”‚     â”‚   â””â”€â†’ getPreviewStreamResponse($song, 'guest')           â”‚
â”‚     â”œâ”€â”€ Free Member (!isPremiumOrTrial())                       â”‚
â”‚     â”‚   â””â”€â†’ getPreviewStreamResponse($song, 'free')            â”‚
â”‚     â””â”€â”€ Premium/Trial Member (isPremiumOrTrial())               â”‚
â”‚         â””â”€â†’ Full stream access                                  â”‚
â”‚  4. HLS kontrolÃ¼:                                                â”‚
â”‚     â”œâ”€â”€ hls_path VARSA â†’ HLS playlist dÃ¶ndÃ¼r                    â”‚
â”‚     â”‚   â”œâ”€â”€ Timeout: 6 saniye                                   â”‚
â”‚     â”‚   â””â”€â”€ Fallback: MP3 signed URL                            â”‚
â”‚     â””â”€â”€ hls_path YOKSA â†’ ConvertToHLSJob dispatch et            â”‚
â”‚  5. Response: stream_url, stream_type, fallback_url             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA: DUPLICATE CODE</div>
                <div>Guest ve Free Member iÃ§in aynÄ± kod bloÄŸu tekrarlanÄ±yor!</div>
                <div style="margin-top: 10px;">
                    <strong>Dosya:</strong> <span class="code">SongStreamController.php</span><br>
                    <strong>SatÄ±r 52-96:</strong> Guest user stream logic (48 satÄ±r)<br>
                    <strong>SatÄ±r 100-149:</strong> Non-premium user stream logic (49 satÄ±r)<br>
                    <strong>Sorun:</strong> AYNI kod bloÄŸu kopyalanmÄ±ÅŸ! (DRY ihlali)
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Helper Method OluÅŸtur</div>
                <div><strong>Yeni Method:</strong> <span class="code">getPreviewStreamResponse()</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">public function stream(Song $song)
{
    $user = auth('web')->user() ?? auth('sanctum')->user();

    // 1. Guest user
    if (!$user) {
        return $this->getPreviewStreamResponse($song, 'guest');
    }

    // 2. Free member
    if (!$user->isPremiumOrTrial()) {
        return $this->getPreviewStreamResponse($song, 'free');
    }

    // 3. Premium/Trial member
    return $this->getFullStreamResponse($song, $user);
}

protected function getPreviewStreamResponse(Song $song, string $userType): JsonResponse
{
    // HLS conversion
    if ($song->needsHlsConversion()) {
        ConvertToHLSJob::dispatch($song);
    }

    // Stream URL (30 saniye limit)
    if (!empty($song->hls_path)) {
        $streamUrl = route('api.muzibu.songs.dynamic-playlist', [
            'id' => $song->song_id
        ]);
        $streamType = 'hls';
        $fallbackUrl = $this->signedUrlService->generateStreamUrl(
            $song->song_id, 30, true
        );
    } else {
        $streamUrl = $this->signedUrlService->generateStreamUrl(
            $song->song_id, 30
        );
        $streamType = 'mp3';
        $fallbackUrl = null;
    }

    $message = $userType === 'guest'
        ? 'KayÄ±t olun, tam dinleyin'
        : 'Premium\'a geÃ§in, sÄ±nÄ±rsÄ±z dinleyin';

    return response()->json([
        'status' => 'preview',
        'message' => $message,
        'stream_url' => $streamUrl,
        'stream_type' => $streamType,
        'fallback_url' => $fallbackUrl,
        'preview_duration' => 30,
        'is_premium' => false,
    ]);
}

protected function getFullStreamResponse(Song $song, User $user): JsonResponse
{
    // Full stream logic (sÄ±nÄ±rsÄ±z)
    // ...
}</pre>
                </div>
            </div>

            <div class="warning">
                <div class="warning-title">âš ï¸ DÄ°KKAT: HARDCODED DEÄER!</div>
                <div>
                    <strong>Preview duration:</strong> 30 saniye hardcoded (4 yerde!)<br>
                    <strong>HLS timeout:</strong> 6 saniye hardcoded<br>
                    <strong>Chunk count:</strong> 3 chunk hardcoded
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Config DosyasÄ±na TaÅŸÄ±</div>
                <div><strong>Dosya:</strong> <span class="code">config/muzibu.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">return [
    'stream' => [
        'preview_duration' => env('MUZIBU_PREVIEW_DURATION', 30), // saniye
        'hls_timeout' => env('MUZIBU_HLS_TIMEOUT', 6), // saniye
        'preview_chunks' => env('MUZIBU_PREVIEW_CHUNKS', 3), // adet
    ],
];</pre>
                </div>
                <div style="margin-top: 10px;"><strong>KullanÄ±m:</strong></div>
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">$previewDuration = config('muzibu.stream.preview_duration');
$this->signedUrlService->generateStreamUrl($song->song_id, $previewDuration);</pre>
            </div>
        </div>

        <!-- 6. PREMIUM STATUS DEÄÄ°ÅÄ°KLÄ°ÄÄ° -->
        <div class="box">
            <div class="box-title">6. PREMIUM STATUS DEÄÄ°ÅÄ°KLÄ°ÄÄ° (Cache Invalidation)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PREMIUM STATUS CACHE AKIÅI                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. User::isPremiumOrTrial() Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±r                    â”‚
â”‚  2. Cache key: premium_status_{user_id}_{tenant_id}             â”‚
â”‚  3. Cache TTL: 5 dakika (300 saniye)                            â”‚
â”‚  4. Cache HIT â†’ Direkt return                                   â”‚
â”‚  5. Cache MISS â†’ DB sorgusu + Cache write                       â”‚
â”‚                                                                  â”‚
â”‚  SORUN: Subscription deÄŸiÅŸtiÄŸinde cache SÄ°LÄ°NMÄ°YOR!             â”‚
â”‚  â”œâ”€â†’ Yeni Ã¼yelik baÅŸlatÄ±lÄ±r â†’ 5 dakika premium gÃ¶rmez!          â”‚
â”‚  â”œâ”€â†’ Ãœyelik iptal edilir â†’ 5 dakika premium gÃ¶rmeye devam!      â”‚
â”‚  â””â”€â†’ Ãœyelik sÃ¼resi biter â†’ 5 dakika premium gÃ¶rmeye devam!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA: SUBSCRIPTION OBSERVER EKSÄ°K!</div>
                <div><strong>Sorun:</strong> Subscription deÄŸiÅŸikliklerinde cache otomatik silinmiyor!</div>
                <div style="margin-top: 10px;">
                    <strong>Eksik Dosya:</strong> <span class="code">app/Observers/SubscriptionObserver.php</span><br>
                    <strong>SonuÃ§:</strong> Premium status 5 dakika gecikmeyle gÃ¼ncelleniyor!
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: SubscriptionObserver OluÅŸtur</div>
                <div><strong>Yeni Dosya:</strong> <span class="code">app/Observers/SubscriptionObserver.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">namespace App\Observers;

use Modules\Subscription\app\Models\Subscription;
use Illuminate\Support\Facades\Cache;

class SubscriptionObserver
{
    public function created(Subscription $subscription)
    {
        $this->flushPremiumCache($subscription->user_id);
    }

    public function updated(Subscription $subscription)
    {
        $this->flushPremiumCache($subscription->user_id);
    }

    public function deleted(Subscription $subscription)
    {
        $this->flushPremiumCache($subscription->user_id);
    }

    protected function flushPremiumCache(int $userId)
    {
        $tenantId = tenant() ? tenant()->id : 1;
        $cacheKey = "premium_status_{$userId}_{$tenantId}";

        Cache::forget($cacheKey);

        \Log::info("Premium cache flushed", [
            'user_id' => $userId,
            'tenant_id' => $tenantId,
            'cache_key' => $cacheKey,
        ]);
    }
}</pre>
                </div>
                <div style="margin-top: 10px;"><strong>Register Observer:</strong></div>
                <div><strong>Dosya:</strong> <span class="code">app/Providers/AppServiceProvider.php</span></div>
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">use Modules\Subscription\app\Models\Subscription;
use App\Observers\SubscriptionObserver;

public function boot()
{
    Subscription::observe(SubscriptionObserver::class);
}</pre>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… EK Ã‡Ã–ZÃœM: Logout'ta da Cache Temizle</div>
                <div><strong>Dosya:</strong> <span class="code">app/Http/Controllers/Api/Auth/AuthController.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">public function logout()
{
    $user = auth('web')->user() ?? auth('sanctum')->user();

    if ($user) {
        // Premium cache temizle
        $tenantId = tenant() ? tenant()->id : 1;
        $cacheKey = "premium_status_{$user->id}_{$tenantId}";
        Cache::forget($cacheKey);

        // Device session temizle
        app(DeviceService::class)->unregisterSession();

        // Auth logout
        Auth::logout();
    }

    return response()->json(['message' => 'Logged out']);
}</pre>
                </div>
            </div>
        </div>

        <!-- 7. HARDCODED DEÄERLER -->
        <div class="box">
            <div class="box-title">7. HARDCODED DEÄERLER (Config'e TaÅŸÄ±nacaklar)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  HARDCODED DEÄERLER LÄ°STESÄ°                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Preview Duration: 30 saniye (4 yerde hardcoded!)            â”‚
â”‚  2. HLS Timeout: 6 saniye                                        â”‚
â”‚  3. Preview Chunks: 3 adet                                       â”‚
â”‚  4. Session Polling: 30000 ms (frontend)                         â”‚
â”‚  5. Session TTL: 7200 saniye (Redis)                             â”‚
â”‚  6. Premium Cache TTL: 300 saniye (5 dakika)                     â”‚
â”‚  7. Device Limit Fallback: 1 cihaz                               â”‚
â”‚  8. Frontend deviceLimit: 1 (hardcoded!)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="error">
                <div class="error-title">âŒ MEVCUT HATA 1: Frontend Device Limit Hardcoded</div>
                <div>
                    <strong>Dosya:</strong> <span class="code">public/themes/muzibu/js/player/core/player-core.js</span><br>
                    <strong>SatÄ±r:</strong> ~40<br>
                    <strong>Kod:</strong> <span class="code">deviceLimit: 1</span>
                </div>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Backend'den Ä°njection</div>
                <div><strong>Dosya:</strong> <span class="code">resources/views/themes/muzibu/layouts/app.blade.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">@auth
    @php
        $deviceService = app(\Modules\Muzibu\app\Services\DeviceService::class);
        $deviceLimit = $deviceService->getDeviceLimit(auth()->user());
    @endphp

    window.muzibuPlayerConfig = {
        deviceLimit: {{ $deviceLimit }},
        sessionPollingInterval: {{ config('muzibu.session.polling_interval') }},
        previewDuration: {{ config('muzibu.stream.preview_duration') }},
    };
@endauth</pre>
                </div>
                <div style="margin-top: 10px;"><strong>Frontend KullanÄ±mÄ±:</strong></div>
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">// player-core.js
const playerConfig = {
    deviceLimit: window.muzibuPlayerConfig?.deviceLimit || 1,
    sessionPollingInterval: window.muzibuPlayerConfig?.sessionPollingInterval || 30000,
    previewDuration: window.muzibuPlayerConfig?.previewDuration || 30,
};</pre>
            </div>

            <div class="solution">
                <div class="solution-title">âœ… Ã‡Ã–ZÃœM: Merkezi Config DosyasÄ± OluÅŸtur</div>
                <div><strong>Yeni Dosya:</strong> <span class="code">config/muzibu.php</span></div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">return [
    // Stream Settings
    'stream' => [
        'preview_duration' => env('MUZIBU_PREVIEW_DURATION', 30),
        'hls_timeout' => env('MUZIBU_HLS_TIMEOUT', 6),
        'preview_chunks' => env('MUZIBU_PREVIEW_CHUNKS', 3),
    ],

    // Session Settings
    'session' => [
        'polling_interval' => env('MUZIBU_SESSION_POLLING', 30000),
        'ttl' => env('MUZIBU_SESSION_TTL', 7200),
    ],

    // Cache Settings
    'cache' => [
        'premium_status_ttl' => env('MUZIBU_PREMIUM_CACHE_TTL', 300),
    ],

    // Device Settings
    'device' => [
        'default_limit' => env('MUZIBU_DEVICE_LIMIT_FALLBACK', 1),
    ],
];</pre>
                </div>
            </div>
        </div>

        <!-- 8. SETTINGS ENTEGRASYONU -->
        <div class="box">
            <div class="box-title">8. SETTINGS ENTEGRASYONU (Tenant AyarlarÄ±)</div>
            <div class="ascii-box">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TENANT SETTINGS SÄ°STEMÄ°                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MEVCUT SETTINGS (KullanÄ±lÄ±yor):                                â”‚
â”‚  â”œâ”€ ID: 23 â†’ auth_device_limit (Cihaz limit)                    â”‚
â”‚  â””â”€ ID: 21 â†’ auth_session_lifetime (Session sÃ¼re)               â”‚
â”‚                                                                  â”‚
â”‚  EKLENECEK SETTINGS:                                             â”‚
â”‚  â”œâ”€ muzibu_preview_duration (Preview sÃ¼re)                      â”‚
â”‚  â”œâ”€ muzibu_hls_timeout (HLS timeout)                            â”‚
â”‚  â”œâ”€ muzibu_session_polling (Polling interval)                   â”‚
â”‚  â””â”€ muzibu_premium_cache_ttl (Premium cache TTL)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

            <div class="solution">
                <div class="solution-title">âœ… DOÄRU KULLANIM:</div>
                <div>Settings deÄŸerleri <span class="code">setting()</span> helper ile Ã§ekilmeli.</div>
                <div style="margin-top: 10px;">
<pre style="color: #a5b4fc; font-size: 0.85rem; line-height: 1.6;">// DeviceService.php (MEVCUT - DOÄRU)
if (function_exists('setting') && setting('auth_device_limit')) {
    return (int) setting('auth_device_limit');
}

// SongStreamController.php (EKLENMELÄ°)
$previewDuration = setting('muzibu_preview_duration')
    ?? config('muzibu.stream.preview_duration');

// Session Polling (EKLENMELÄ°)
$pollingInterval = setting('muzibu_session_polling')
    ?? config('muzibu.session.polling_interval');</pre>
                </div>
            </div>

            <div class="warning">
                <div class="warning-title">âš ï¸ DÄ°KKAT: Ã–ncelik SÄ±rasÄ±</div>
                <div style="margin-top: 8px;">
                    <strong>1. Setting deÄŸeri:</strong> setting('key') - Tenant Ã¶zel ayar<br>
                    <strong>2. Config deÄŸeri:</strong> config('muzibu.key') - Uygulama varsayÄ±lanÄ±<br>
                    <strong>3. Fallback:</strong> Hardcoded (son Ã§are!)
                </div>
            </div>
        </div>

        <!-- 9. Ã–ZET: YAPILACAKLAR -->
        <div class="box">
            <div class="box-title">9. Ã–ZET: TÃœM DÃœZELTMELER (Ã–ncelik SÄ±rasÄ±)</div>

            <div class="error">
                <div class="error-title">ğŸ”´ YÃœK SEK Ã–NCELÄ°K (Kritik Hatalar)</div>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>1.</strong> CSRF Token Auto-Renewal (419 hatasÄ± dÃ¼zelt)</li>
                    <li><strong>2.</strong> SongStreamController Duplicate Code (DRY ihlali)</li>
                    <li><strong>3.</strong> SubscriptionObserver OluÅŸtur (Premium cache)</li>
                    <li><strong>4.</strong> Device Selection Modal Frontend Entegrasyonu</li>
                </ul>
            </div>

            <div class="warning">
                <div class="warning-title">ğŸŸ¡ ORTA Ã–NCELÄ°K (Ä°yileÅŸtirmeler)</div>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>5.</strong> config/muzibu.php OluÅŸtur (Hardcoded deÄŸerler)</li>
                    <li><strong>6.</strong> Frontend Device Limit Injection (Backend'den al)</li>
                    <li><strong>7.</strong> Settings Entegrasyonu (Yeni ayarlar ekle)</li>
                    <li><strong>8.</strong> Logout'ta Premium Cache Temizle</li>
                </ul>
            </div>

            <div class="solution">
                <div class="solution-title">ğŸŸ¢ DÃœÅÃœK Ã–NCELÄ°K (DokÃ¼mantasyon)</div>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>9.</strong> API Response Standardizasyonu</li>
                    <li><strong>10.</strong> Loglama Ä°yileÅŸtirme (Session, Device, Stream)</li>
                    <li><strong>11.</strong> Unit Test Yazma (DeviceService, Stream)</li>
                </ul>
            </div>
        </div>

        <!-- FOOTER -->
        <div style="margin-top: 60px; padding-top: 30px; border-top: 2px solid #334155; text-align: center; color: #64748b;">
            <p>ğŸ“Š <strong>RAPOR TAMAMLANDI</strong></p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                TÃ¼m sistem akÄ±ÅŸlarÄ± analiz edildi â€¢ Hatalar tespit edildi â€¢ Ã‡Ã¶zÃ¼mler dokÃ¼mante edildi
            </p>
            <p style="margin-top: 10px; font-size: 0.85rem; color: #475569;">
                ğŸµ Muzibu Music Platform â€¢ Master Plan v1.0 â€¢ 7 AralÄ±k 2025
            </p>
        </div>

    </div>
</body>
</html>
