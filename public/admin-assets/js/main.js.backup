
// SOLID Management System - Global JavaScript
class PageManagementSystem {
    constructor() {
        this.tabManager = null;
        this.seoManager = null;
        this.init();
    }

    init() {
        this.waitForDependencies(() => {
            this.initializeTabSystem();
            this.initializeSeoSystem();
            this.bindGlobalEvents();
        });
    }

    waitForDependencies(callback) {
        if (typeof $ !== 'undefined') {
            $(document).ready(callback);
        } else {
            setTimeout(() => this.waitForDependencies(callback), 100);
        }
    }

    initializeTabSystem() {
        // TabManager object'i alt kısımda tanımlandı - initialize edilecek
        this.tabManager = null; // Will be set after TabManager object is defined
    }

    initializeSeoSystem() {
        this.seoManager = new SeoManager();
    }

    bindGlobalEvents() {
        // Form submissions
        $(document).on('submit', 'form', () => {
            this.tabManager?.saveActiveTab();
        });

        // Language switches
        $(document).on('click', '.language-switch-btn', (e) => {
            e.preventDefault();
            const language = $(e.target).data('language');
            this.handleLanguageSwitch(language);
        });
    }

    handleLanguageSwitch(language) {
        // Update active states
        $('.language-switch-btn').removeClass('text-primary').addClass('text-muted');
        $('.language-switch-btn').css('border-bottom', '2px solid transparent');
        
        $(event.target).removeClass('text-muted').addClass('text-primary');
        $(event.target).css('border-bottom', '2px solid var(--primary-color)');
        
        // Update SEO fields if available
        this.seoManager?.updateForLanguage?.(language);
    }
}

// Tab Management (Class removed - const TabManager used below)

// SEO Management Class  
class SeoManager {
    constructor() {
        this.init();
    }

    init() {
        this.bindEvents();
        this.updateAllCounters();
    }

    bindEvents() {
        // Character counters
        $(document).on('input', '[data-seo-field]', (e) => {
            const field = $(e.target).data('seo-field');
            this.updateCharacterCounter(field, e.target.value);
        });

        // Keyword system
        this.bindKeywordEvents();
    }

    updateCharacterCounter(field, value) {
        const counter = $(`[data-counter-for="${field}"]`);
        const limit = parseInt(counter.data('limit')) || 160;
        const length = value.length;
        const percentage = (length / limit) * 100;
        
        if (counter.length) {
            counter.text(`${length}/${limit}`);
            
            counter.removeClass('warning danger');
            if (percentage > 100) {
                counter.addClass('danger');
            } else if (percentage > 80) {
                counter.addClass('warning');
            }
        }
    }

    updateAllCounters() {
        $('[data-seo-field]').each((index, element) => {
            const field = $(element).data('seo-field');
            const value = $(element).val() || '';
            this.updateCharacterCounter(field, value);
        });
    }

    bindKeywordEvents() {
        // Keyword input
        $(document).on('keypress', '.keyword-input', (e) => {
            if (e.which === 13 || e.which === 188) { // Enter or comma
                e.preventDefault();
                this.addKeyword(e.target);
            }
        });

        // Keyword removal
        $(document).on('click', '.keyword-remove', (e) => {
            this.removeKeyword(e.target);
        });
    }

    addKeyword(input) {
        const $input = $(input);
        const keyword = $input.val().trim();
        
        if (!keyword) return;

        const container = $input.closest('.keyword-input-container');
        const badgeContainer = container.find('.keyword-badges');
        
        // Create badge (Tabler.io badge sistemi)
        const badge = $(`
            <span class="badge badge-outline me-1 mb-1">
                <span class="keyword-text">${keyword}</span>
                <span class="keyword-remove ms-1" style="cursor: pointer;">&times;</span>
            </span>
        `);
        
        badgeContainer.append(badge);
        $input.val('');
    }

    removeKeyword(removeButton) {
        $(removeButton).closest('.keyword-badge').remove();
    }
}

// Initialize global system
document.addEventListener('DOMContentLoaded', function() {
    window.pageManagement = new PageManagementSystem();
});

// Theme Builder CSS Specificity Fix
document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap Offcanvas manual initialization for theme builder
    const offcanvasElement = document.getElementById('offcanvasTheme');
    if (offcanvasElement) {
        // Bootstrap Offcanvas'ı manuel olarak başlat
        if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
            const themeOffcanvas = new bootstrap.Offcanvas(offcanvasElement);
            
            // Theme builder açıldığında form update
            offcanvasElement.addEventListener('shown.bs.offcanvas', function() {
                // Form state güncelleme
                if (typeof updateThemeBuilderForm === 'function') {
                    updateThemeBuilderForm();
                }
                
                // Real-time listener'ları attach et
                if (typeof attachRealTimeListeners === 'function') {
                    attachRealTimeListeners();
                }
                
                // CSS değişkenlerini zorla güncelle
                setTimeout(() => {
                    forceUpdateThemeState();
                }, 100);
            });
        }
    }
    
    // Theme mode switch için fallback event handling
    const themeSwitch = document.getElementById('switch');
    if (themeSwitch) {
        // Eğer tema sistemi yüklenmemişse fallback
        setTimeout(() => {
            if (typeof initThemeSwitch !== 'function') {
                initFallbackThemeSwitch();
            }
        }, 1000);
    }
});

// Fallback theme switch sistemi
function initFallbackThemeSwitch() {
    const themeSwitch = document.getElementById('switch');
    if (!themeSwitch) return;
    
    themeSwitch.addEventListener('change', function() {
        const isChecked = this.checked;
        const newTheme = isChecked ? '1' : '0';
        
        document.cookie = `dark=${newTheme};path=/;max-age=31536000`;
        
        // Tema uygula
        applyThemeModeFallback(newTheme);
        
        // Switch ve container state güncelle
        updateThemeSwitchState(newTheme);
    });
}

// Fallback tema modu uygulama
function applyThemeModeFallback(themeMode) {
    const body = document.body;
    
    if (themeMode === '1') {
        body.setAttribute('data-bs-theme', 'dark');
        body.classList.remove('light');
        body.classList.add('dark');
        // AI Profile Wizard için özel force sınıfı
        forceAIProfileWizardTheme('dark');
    } else {
        body.setAttribute('data-bs-theme', 'light');
        body.classList.remove('dark');
        body.classList.add('light');
        // AI Profile Wizard için özel force sınıfı
        forceAIProfileWizardTheme('light');
    }
}

// AI Profile Wizard tema zorla güncelleme
function forceAIProfileWizardTheme(mode) {
    const wizardContainer = document.querySelector('.ai-profile-wizard-container');
    if (!wizardContainer) return;
    
    // Önce mevcut force sınıflarını temizle
    wizardContainer.classList.remove('force-light-mode', 'force-dark-mode');
    
    // Yeni force sınıfını ekle
    if (mode === 'dark') {
        wizardContainer.classList.add('force-dark-mode');
    } else {
        wizardContainer.classList.add('force-light-mode');
    }
    
    // Reflow tetikle - form elemanlarını zorla güncelle
    const formElements = wizardContainer.querySelectorAll('.form-selectgroup-label');
    formElements.forEach(element => {
        element.style.display = 'none';
        element.offsetHeight; // reflow trigger
        element.style.display = '';
    });
    
    // Smooth transition sonrası force sınıflarını kaldır
    setTimeout(() => {
        wizardContainer.classList.remove('force-light-mode', 'force-dark-mode');
    }, 500);
}

// Theme switch state güncelleme
function updateThemeSwitchState(themeMode) {
    const themeContainer = document.querySelector('.theme-mode');
    const themeSwitch = document.getElementById('switch');
    
    if (themeContainer && themeSwitch) {
        if (themeMode === '1') {
            themeContainer.setAttribute('data-theme', 'dark');
            themeSwitch.checked = true;
        } else {
            themeContainer.setAttribute('data-theme', 'light');
            themeSwitch.checked = false;
        }
    }
}

// Theme state'i zorla güncelleme
function forceUpdateThemeState() {
    // CSS Custom Properties zorla yenile
    const root = document.documentElement;
    const currentTheme = getCookieValue('dark') || 'auto';
    const currentColor = getCookieValue('siteColor') || '#066fd1';
    
    // Primary color CSS değişkenlerini zorla uygula
    root.style.setProperty('--tblr-primary', currentColor, 'important');
    root.style.setProperty('--tblr-primary-rgb', hexToRgbString(currentColor), 'important');
    
    // Body class'larını zorla güncelle
    const body = document.body;
    if (currentTheme === '1') {
        body.classList.add('dark');
        body.classList.remove('light');
    } else if (currentTheme === '0') {
        body.classList.add('light');
        body.classList.remove('dark');
    } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        body.classList.add(prefersDark ? 'dark' : 'light');
        body.classList.remove(prefersDark ? 'light' : 'dark');
    }
    
    // Theme container state güncelle
    updateThemeSwitchState(currentTheme);
}

// Cookie okuma helper
function getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// HEX to RGB string helper
function hexToRgbString(hex) {
    if (!hex || !hex.startsWith('#')) return '6, 111, 209'; // Fallback
    
    // Hex uzunluk kontrolü
    if (hex.length !== 7) {
        console.warn('Geçersiz hex uzunluğu:', hex, '- varsayılan değer kullanılıyor');
        return '6, 111, 209'; // Fallback
    }
    
    const r = parseInt(hex.substring(1, 3), 16);
    const g = parseInt(hex.substring(3, 5), 16);
    const b = parseInt(hex.substring(5, 7), 16);
    
    // NaN kontrolü
    if (isNaN(r) || isNaN(g) || isNaN(b)) {
        console.warn('RGB dönüşümünde NaN değeri main.js\'te:', {hex, r, g, b}, '- varsayılan değer kullanılıyor');
        return '6, 111, 209'; // Fallback
    }
    
    return `${r}, ${g}, ${b}`;
}

// Translation function
function t(key, params = {}) {
    if (typeof window.jsTranslations === 'undefined') {
        console.warn('jsTranslations not loaded, using fallback');
        return key;
    }
    
    const locale = document.documentElement.lang || 'tr';
    const translations = window.jsTranslations[locale] || window.jsTranslations['tr'] || {};
    
    let text = translations[key] || key;
    
    // Parameter replacement
    if (params && Object.keys(params).length > 0) {
        Object.keys(params).forEach(param => {
            text = text.replace(`{${param}}`, params[param]);
        });
    }
    
    return text;
}

// Bootstrap kontrolü ve fallback
function ensureBootstrap() {
    // Tabler.min.js Bootstrap'ı içerir, ancak yüklenmesi biraz zaman alabilir
    if (typeof bootstrap === 'undefined' && typeof window.bootstrap === 'undefined') {
        // Bootstrap yüklenmemişse basit fallback
        window.bootstrap = {
            Offcanvas: function(element) {
                return {
                    show: function() { 
                        element.classList.add('show'); 
                        element.style.visibility = 'visible';
                    },
                    hide: function() { 
                        element.classList.remove('show'); 
                        element.style.visibility = 'hidden';
                    },
                    toggle: function() {
                        if (element.classList.contains('show')) {
                            this.hide();
                        } else {
                            this.show();
                        }
                    }
                };
            },
            Modal: function(element) {
                return {
                    show: function() { element.style.display = 'block'; },
                    hide: function() { element.style.display = 'none'; }
                };
            }
        };
        // Bootstrap fallback aktif
    }
}

// Bootstrap'ı hemen kontrol et
ensureBootstrap();

// Sayfa yüklendikten sonra da kontrol et
document.addEventListener('DOMContentLoaded', function() {
    ensureBootstrap();
});

// Choices.js Sistemi
function initializeChoices() {
    const choicesElements = document.querySelectorAll('[data-choices]');
    
    choicesElements.forEach(function(element) {
        if (element.dataset.choicesInitialized) {
            return;
        }
        
        // Listeleme sayfalarındaki TÜM filtreleme selectbox'larını atla - normal select olarak kalsın
        const wireModel = element.getAttribute('wire:model.live') || element.getAttribute('wire:model');
        const listingFilters = [
            'perPage', 'selectedCategory', 'roleFilter', 'statusFilter', 'viewType',
            'typeFilter', 'parentCategoryFilter', 'categoryFilter', 'theme_id'
        ];
        
        if (listingFilters.includes(wireModel)) {
            return;
        }
        
        element.dataset.choicesInitialized = 'true';
        
        const options = {
            searchEnabled: true,
            searchPlaceholderValue: t('search_placeholder'),
            noResultsText: t('no_results'),
            noChoicesText: t('no_choices'),
            itemSelectText: t('item_select'),
            removeItemButton: false,
            duplicateItemsAllowed: false,
            placeholder: true,
            placeholderValue: t('select_placeholder'),
            searchResultLimit: 10,
            shouldSort: true,
            position: 'bottom',
            loadingText: t('loading'),
            addItemText: (value) => `"${value}" ${t('add_item')}`,
            maxItemText: (maxItemCount) => t('max_items', {count: maxItemCount}),
            uniqueItemText: t('duplicate_item'),
            customAddItemText: t('invalid_comma'),
        };
        
        // Data attribute'lardan özel ayarları al
        if (element.dataset.choicesMultiple === 'true') {
            options.removeItemButton = true;
            options.addItems = true;
            // Virgül karakterini engelle
            options.addItemFilter = (value) => {
                return !value.includes(',');
            };
        }
        
        // Filter selectbox'ları için özel ayarlar
        if (element.dataset.choicesFilter === 'true') {
            options.itemSelectText = '';
            options.searchEnabled = false;
            options.placeholderValue = null;
            options.allowHTML = true;
        }
        
        if (element.dataset.choicesSearch === 'false') {
            options.searchEnabled = false;
        }
        
        if (element.dataset.choicesPlaceholder) {
            options.placeholderValue = element.dataset.choicesPlaceholder;
        }
        
        if (element.dataset.choicesMaxItems) {
            options.maxItemCount = parseInt(element.dataset.choicesMaxItems);
        }
        
        // Choices.js'i başlat
        const choices = new Choices(element, options);
        
        // Filter selectbox'ları için genişlik ayarla
        if (element.dataset.choicesFilter === 'true') {
            const container = choices.containerOuter.element;
            container.style.width = '100%';
            container.style.minWidth = '100%';
        }
        
        // Element'a choices instance'ını ekle
        element.choicesInstance = choices;
        
        
        // Choices.js'in name attribute'unu düzelt
        if (element.getAttribute('wire:model.live') === 'selectedCategory') {
            element.name = 'selectedCategory';
            element.setAttribute('name', 'selectedCategory');
            
            // Choices'ın passedElement'ini de kontrol et
            if (choices.passedElement && choices.passedElement.element) {
                choices.passedElement.element.name = 'selectedCategory';
                choices.passedElement.element.setAttribute('name', 'selectedCategory');
            }
            
        }
        
        // Choices.js getValue metodunu override et - Livewire için
        const originalGetValue = choices.getValue.bind(choices);
        choices.getValue = function(valueOnly = false) {
            const result = originalGetValue(valueOnly);
            
            // Eğer sonuç object ise ve value property'si varsa, sadece value'yu döndür
            if (typeof result === 'object' && result !== null && result.hasOwnProperty('value')) {
                return result.value;
            }
            
            return result;
        };
        
        // Livewire değeri varsa hemen set et
        if (element.hasAttribute('wire:model') || element.hasAttribute('wire:model.live')) {
            setTimeout(() => {
                const currentValue = element.value;
                const finalValue = currentValue; // Normal choices için sadece mevcut değer
                
                
                if (finalValue && choices.getValue(true) !== finalValue) {
                    choices.setChoiceByValue(finalValue);
                }
            }, 50);
        }
        
        // Livewire entegrasyonu
        if (element.hasAttribute('wire:model')) {
            // Değişiklik dinleme - Livewire için özelleştirilmiş
            choices.passedElement.element.addEventListener('change', function(e) {
                // Override edilmiş getValue metodunu kullan (artık her zaman string döner)
                const selectedValue = choices.getValue(true);
                this.value = selectedValue;
                
                // Livewire'a temiz input event'i gönder
                this.dispatchEvent(new Event('input', { bubbles: true }));
                
                // URL'deki [value] eklerini temizle
                setTimeout(() => {
                    const url = new URL(window.location);
                    const params = new URLSearchParams(url.search);
                    
                    // [value] içeren parametreleri bul ve temizle
                    for (const [key, value] of params.entries()) {
                        if (key.includes('[value]')) {
                            const cleanKey = key.replace('[value]', '');
                            params.delete(key);
                            if (value) {
                                params.set(cleanKey, value);
                            }
                        }
                    }
                    
                    // URL'yi güncelle
                    url.search = params.toString();
                    window.history.replaceState({}, '', url);
                }, 100);
            });
            
            // Livewire'dan gelen değer değişikliklerini dinle
            const wireName = element.getAttribute('wire:model') || element.getAttribute('wire:model.live') || element.getAttribute('wire:model.defer');
            if (wireName) {
                // Element'in değerini kontrol et ve choices'ı güncelle
                const updateChoicesValue = () => {
                    const currentValue = element.value;
                    if (currentValue && choices.getValue(true) !== currentValue) {
                        choices.setChoiceByValue(currentValue);
                    }
                };
                
                // İlk yüklemede değeri kontrol et
                setTimeout(updateChoicesValue, 100);
                
                // Livewire güncellemelerini dinle
                document.addEventListener('livewire:updated', updateChoicesValue);
                document.addEventListener('livewire:morph.updated', updateChoicesValue);
            }
        }
    });
}

// Tags Input Sistemi
function initializeTagsInput() {
    const tagInputs = document.querySelectorAll('.tags-input');
    
    tagInputs.forEach(function(container) {
        if (container.dataset.initialized) return;
        container.dataset.initialized = 'true';
        
        const hiddenInput = container.querySelector('input[type="hidden"]');
        const tagsContainer = container.querySelector('.tags-container');
        const tagInput = container.querySelector('.tag-input');
        
        if (!hiddenInput || !tagsContainer || !tagInput) return;
        
        // Mevcut değerleri yükle
        loadExistingTags();
        
        // Enter veya virgül ile tag ekleme
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTag(this.value.trim());
                this.value = '';
            }
        });
        
        // Focus kaybında tag ekleme
        tagInput.addEventListener('blur', function() {
            if (this.value.trim()) {
                addTag(this.value.trim());
                this.value = '';
            }
        });
        
        // Container'a tıklayınca input'a focus
        tagsContainer.addEventListener('click', function() {
            tagInput.focus();
        });
        
        function addTag(value) {
            if (!value || getCurrentTags().includes(value)) return;
            
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-item';
            tagElement.innerHTML = `
                ${value}
                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
            `;
            
            tagsContainer.insertBefore(tagElement, tagInput);
            updateHiddenInput();
        }
        
        function getCurrentTags() {
            return Array.from(tagsContainer.querySelectorAll('.tag-item'))
                .map(tag => tag.textContent.replace('×', '').trim());
        }
        
        function updateHiddenInput() {
            const tags = getCurrentTags();
            hiddenInput.value = tags.join(',');
            
            // Livewire entegrasyonu
            if (hiddenInput.hasAttribute('wire:model')) {
                hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
        
        function loadExistingTags() {
            const existingValue = hiddenInput.value;
            if (existingValue) {
                const tags = existingValue.split(',').map(tag => tag.trim()).filter(tag => tag);
                tags.forEach(tag => addTag(tag));
            }
        }
        
        // Global removeTag fonksiyonu
        window.removeTag = function(button) {
            button.parentElement.remove();
            updateHiddenInput();
        };
    });
}

// Tooltip Sistemi
function initializeTooltips() {
    // Mevcut tooltip'leri dispose et
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(element) {
        if (element._tooltip) {
            element._tooltip.dispose();
        }
    });
    
    // Yeni tooltip'leri başlat
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"], [title]');
    
    tooltips.forEach(function (tooltipElement) {
        // Sadece title attribute'u olan elementler için tooltip oluştur
        if (tooltipElement.getAttribute('title') && 
            !tooltipElement.hasAttribute('data-bs-toggle')) {
            tooltipElement.setAttribute('data-bs-toggle', 'tooltip');
        }
        
        if (tooltipElement.hasAttribute('data-bs-toggle') && 
            tooltipElement.getAttribute('data-bs-toggle') === 'tooltip') {
            
            // Bootstrap 5 kullanımı
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                const tooltip = new bootstrap.Tooltip(tooltipElement, {
                    trigger: 'hover focus',
                    placement: 'bottom'
                });
                tooltipElement._tooltip = tooltip;
            }
        }
    });
}

// Document Ready
document.addEventListener("DOMContentLoaded", function () {
    // Choices.js'i başlat
    initializeChoices();
    
    // Tags Input'ları başlat
    initializeTagsInput();

    // Livewire entegrasyonu
    document.addEventListener("livewire:navigated", function () {
        setTimeout(function() {
            initializeChoices();
            initializeTagsInput();
            initializeTooltips();
        }, 100);
    });

    document.addEventListener("livewire:load", function () {
        setTimeout(function() {
            initializeChoices();
            initializeTagsInput();
            initializeTooltips();
        }, 100);
    });

    // DOM değişikliklerini gözlemle
    const observer = new MutationObserver(function(mutations) {
        let shouldReinit = false;
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        if (node.matches && (node.matches('.tags-input') || node.matches('[data-choices]') || node.matches('[title]') || node.matches('[data-bs-toggle="tooltip"]'))) {
                            shouldReinit = true;
                        }
                        if (node.querySelectorAll && (node.querySelectorAll('.tags-input').length > 0 || node.querySelectorAll('[data-choices]').length > 0 || node.querySelectorAll('[title]').length > 0 || node.querySelectorAll('[data-bs-toggle="tooltip"]').length > 0)) {
                            shouldReinit = true;
                        }
                    }
                });
            }
        });
        if (shouldReinit) {
            setTimeout(function() {
                initializeChoices();
                initializeTagsInput();
                initializeTooltips();
            }, 50);
        }
    });

    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // Tooltip başlat
    initializeTooltips();

    // Module menu
    const dropdowns = document.querySelectorAll(".module-menu .dropdown");
    dropdowns.forEach(function (dropdown) {
        dropdown.addEventListener("click", function (event) {
            dropdown.classList.add("open");
            event.stopPropagation();
        });
    });

    document.addEventListener("click", function (e) {
        if (!e.target.closest(".module-menu .dropdown")) {
            dropdowns.forEach(function (dropdown) {
                dropdown.classList.remove("open");
            });
        }
    });

    const moduleItems = document.querySelectorAll(
        ".module-menu .dropdown-module-item"
    );
    moduleItems.forEach(function (item) {
        item.addEventListener("click", function (e) {
            e.stopPropagation();
        });
    });

    // Datepicker
    const litepickerLocale = {
        months: t('months'),
        weekdaysShort: t('weekdays_short'),
    };

    const datepickers = document.querySelectorAll(".datepicker");
    datepickers.forEach(function (datepicker) {
        const picker = new Litepicker({
            element: datepicker,
            format: "YYYY-MM-DD",
            singleMode: true,
            dropdowns: {
                months: true,
                years: true,
            },
            numberOfMonths: 1,
            numberOfColumns: 1,
            resetButton: true,
            lang: "tr-TR",
            locale: litepickerLocale,
            setup: function (picker) {
                picker.on("selected", function (date) {
                    if (datepicker.classList.contains("datepicker-start")) {
                        // Livewire.emit("setFilter", "date_start", date.format("YYYY-MM-DD"));
                    } else if (
                        datepicker.classList.contains("datepicker-end")
                    ) {
                        // Livewire.emit("setFilter", "date_end", date.format("YYYY-MM-DD"));
                    }
                });
            },
        });
    });
});

// CSRF Token ayarla
$.ajaxSetup({
    headers: {
        "X-CSRF-TOKEN": document
            .querySelector('meta[name="csrf-token"]')
            ?.getAttribute("content"),
    },
});

// Modal kapatıldığında formu sıfırla
document.addEventListener("hidden.bs.modal", function (event) {
    const modal = event.target;
    if (!modal) return;

    const forms = modal.querySelectorAll("form");
    forms.forEach(function (form) {
        form.reset();
    });

    const inputs = modal.querySelectorAll(
        'input[type="text"], input[type="email"], input[type="number"], textarea'
    );
    inputs.forEach(function (input) {
        input.value = "";
    });

    const checkboxes = modal.querySelectorAll(
        'input[type="checkbox"], input[type="radio"]'
    );
    checkboxes.forEach(function (input) {
        input.checked = false;
    });

    const selects = modal.querySelectorAll("select");
    selects.forEach(function (select) {
        select.selectedIndex = 0;
    });
});

// Sayfa yüklendiğinde başlat
document.addEventListener('DOMContentLoaded', function() {
    initializeChoices();
    initializeTagsInput();
    initializeTooltips();
});

// Livewire güncellemelerinden sonra yeniden başlat
document.addEventListener('livewire:updated', function() {
    initializeChoices();
    initializeTagsInput();
    initializeTooltips();
});

// Livewire component'ler mount olduğunda kontrol et
document.addEventListener('livewire:init', function() {
    // URL parametrelerinden perPage değerini al
    const urlParams = new URLSearchParams(window.location.search);
    const perPageFromUrl = urlParams.get('perPage');
    
    if (perPageFromUrl) {
        // perPage select'ini bul ve değerini güncelle
        setTimeout(() => {
            const perPageSelects = document.querySelectorAll('select[wire\\:model\\.live="perPage"], select[wire\\:model="perPage"]');
            perPageSelects.forEach(select => {
                if (select.choicesInstance) {
                    select.choicesInstance.setChoiceByValue(perPageFromUrl);
                } else {
                    // Choices henüz init olmamışsa değeri direkt set et
                    select.value = perPageFromUrl;
                }
            });
        }, 200);
    }
});

// Livewire navigated event'ini dinle (daha güvenli)
document.addEventListener('livewire:navigated', function() {
    setTimeout(() => {
        // Tüm select elementlerini kontrol et
        const allSelects = document.querySelectorAll('select[wire\\:model\\.live="perPage"], select[wire\\:model="perPage"]');
        allSelects.forEach(select => {
            const currentValue = select.value;
            if (select.choicesInstance && currentValue) {
                // Choices instance varsa ve değer varsa güncelle
                select.choicesInstance.setChoiceByValue(currentValue);
            }
        });
    }, 100);
});

// Cache Clear İşlevselliği
document.addEventListener('DOMContentLoaded', function() {
    // Cache clear butonları için event listener
    const cacheClearBtns = document.querySelectorAll('.cache-clear-btn, .cache-clear-all-btn');
    
    cacheClearBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const action = this.dataset.action;
            const isAllClear = action === 'clear-all';
            
            // Dropdown menüdeki hızlı işlemler grid iconunu bul ve loading state yap
            const quickActionsDropdown = document.querySelector('[data-bs-toggle="dropdown"] .fa-grid-2');
            let originalGridIcon = '';
            if (quickActionsDropdown) {
                originalGridIcon = quickActionsDropdown.className;
                quickActionsDropdown.className = 'fa-solid fa-spinner fa-spin';
            }
            
            // Cache clear butonundaki icon'u da loading state yap
            const iconElement = this.querySelector('i');
            const originalIcon = iconElement.className;
            iconElement.className = 'fa-solid fa-spinner fa-spin';
            this.style.pointerEvents = 'none';
            
            // AJAX isteği
            const baseUrl = window.location.origin;
            const url = isAllClear ? `${baseUrl}/admin/cache/clear-all` : `${baseUrl}/admin/cache/clear`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Başarı toast'ı göster
                    if (typeof showToast === 'function') {
                        showToast(t('success'), data.message, 'success');
                    }
                    
                } else {
                    // Hata toast'ı göster
                    if (typeof showToast === 'function') {
                        showToast(t('error'), data.message, 'error');
                    }
                }
            })
            .catch(error => {
                if (typeof showToast === 'function') {
                    showToast(t('error'), t('cache_error'), 'error');
                }
            })
            .finally(() => {
                // Grid icon'u tekrar normale döndür
                if (quickActionsDropdown && originalGridIcon) {
                    quickActionsDropdown.className = originalGridIcon;
                }
                
                // Buton icon'u tekrar normale döndür
                iconElement.className = originalIcon;
                this.style.pointerEvents = 'auto';
            });
        });
    });
});


// Global save button handler - form submit öncesi tab'ı kaydet
// !! ÇÖZÜM: Livewire submit öncesi ve sonrası tab state management !!
window.preSubmitTabState = null; // Global state tracker

window.saveActiveTabBeforeSubmit = function() {
    // !! ÇÖZÜM: Dynamic storage key - TabManager ile aynı key kullan !!
    const currentRoute = window.location.pathname;
    let storageKey = 'page-manage-active-tab'; // Fallback
    
    // Route-based key generation (layout.blade.php ile aynı mantık)
    if (currentRoute.includes('/admin/page/manage/')) {
        storageKey = 'adminpagemanageActiveTab'; // admin.page.manage -> adminpagemanageActiveTab (global replace)
    }
    
    console.log('🔑 Storage Key:', storageKey);
    
    // ÇÖZÜM 1: Submit öncesi gerçek user tab state'ini localStorage'dan al
    const userSelectedTab = localStorage.getItem(storageKey) || 'tabs-1';
    
    console.log('🎯 USER SELECTED TAB (LocalStorage):', userSelectedTab);
    
    // ÇÖZÜM 2: DOM'dan güncel durumu da kontrol et ama LocalStorage'a öncelik ver
    const domActiveNav = document.querySelector('.nav-link[data-bs-toggle="tab"].active');
    const domActiveTab = domActiveNav ? domActiveNav.getAttribute('href').substring(1) : 'none';
    
    console.log('🎯 DOM ACTIVE TAB:', domActiveTab);
    
    // ÇÖZÜM 3: LocalStorage kullanıcının gerçek seçimi, DOM bozulmuş olabilir
    const finalTab = userSelectedTab; // LocalStorage'a güven
    
    // Global state'e kaydet (Livewire sonrası restore için)
    window.preSubmitTabState = finalTab;
    
    console.log('🎯 FINAL DECISION:', finalTab);
    
    // CONSOLE LOG: Kullanıcı hangi tab'da olduğunu sanıyor vs gerçekte ne kaydediliyor
    console.log(`📋 KAYDET ÖNCESİ: Sen hangi tab'daydın: ${userSelectedTab}, DOM'da aktif: ${domActiveTab}, Kaydedilecek: ${finalTab}`);
    
    // Laravel log
    console.log('💾 KAYDET ÖNCESİ - Tab durumu:', finalTab);
    
    return finalTab; // Return değeri önemli değil ama tutarlılık için
};

// Tab State Management for Admin Forms
const TabManager = {
    storageKey: 'adminFormActiveTab',
    
    init(customKey = null) {
        if (customKey) {
            this.storageKey = customKey;
        }
        // Page modülü AI tab kaldırma sonrası localStorage temizliği
        if (this.storageKey === 'page-manage-active-tab') {
            const storedTab = localStorage.getItem(this.storageKey);
            if (storedTab === 'tabs-4') {
                localStorage.removeItem(this.storageKey);
            }
        }
        // Sadece sayfa ilk yüklendiğinde restore et
        this.restoreActiveTab();
        this.bindTabEvents();
    },
    
    getActiveTab() {
        const storedTab = localStorage.getItem(this.storageKey) || 'tabs-1';
        // AI tab kaldırıldığı için tabs-4'ü tabs-1'e yönlendir
        if (storedTab === 'tabs-4') {
            return 'tabs-1';
        }
        return storedTab;
    },
    
    setActiveTab(tabId) {
        localStorage.setItem(this.storageKey, tabId);
    },
    
    restoreActiveTab() {
        const activeTab = this.getActiveTab();
        
        // Zaten doğru tab aktifse işlem yapma
        const currentActiveNav = document.querySelector('.nav-link[data-bs-toggle="tab"].active');
        const expectedActiveNav = document.querySelector(`.nav-link[href="#${activeTab}"]`);
        
        if (currentActiveNav === expectedActiveNav && currentActiveNav) {
            // Tab zaten doğru, gereksiz işlem yapma
            return;
        }
        
        console.log('🔄 Tab restore başlatılıyor, aktif tab:', activeTab);
        
        if (activeTab) {
            try {
                // Tab element var mı kontrol et
                const tabElement = document.getElementById(activeTab);
                const navElement = document.querySelector(`.nav-link[href="#${activeTab}"]`);
                
                if (tabElement && navElement) {
                    // Önce tüm nav-link'leri inactive yap
                    document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(link => {
                        if (link !== navElement) { // Kendisi hariç
                            link.classList.remove('active');
                            link.setAttribute('aria-selected', 'false');
                        }
                    });
                    
                    // Aktif nav-link'i active yap
                    navElement.classList.add('active');
                    navElement.setAttribute('aria-selected', 'true');
                    
                    // Tüm tab-pane'leri inactive yap
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        if (pane !== tabElement) { // Kendisi hariç
                            pane.classList.remove('active', 'show');
                        }
                    });
                    
                    // Aktif tab-pane'i active yap
                    tabElement.classList.add('active', 'show');
                    
                    console.log('✅ Tab başarıyla restore edildi:', activeTab);
                } else {
                    console.warn('❌ Tab element bulunamadı:', activeTab);
                    this.fallbackToFirstTab();
                }
            } catch (error) {
                console.error('❌ Tab restore hatası:', error);
                this.fallbackToFirstTab();
            }
        } else {
            this.fallbackToFirstTab();
        }
    },
    
    fallbackToFirstTab() {
        console.log('🔄 Fallback: İlk tab aktif yapılıyor...');
        try {
            document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active', 'show');
            });
            
            const firstNavLink = document.querySelector('.nav-link[href="#tabs-1"]');
            const firstTabPane = document.getElementById('tabs-1');
            
            if (firstNavLink && firstTabPane) {
                firstNavLink.classList.add('active');
                firstTabPane.classList.add('active', 'show');
                this.setActiveTab('tabs-1');
                console.log('✅ İlk tab aktif yapıldı');
            }
        } catch (error) {
            console.error('❌ Fallback tab hatası:', error);
        }
    },
    
    bindTabEvents() {
        const self = this;
        
        // ENHANCED Tab click ile localStorage'a kaydet - hem click hem shown event
        $('.nav-link[data-bs-toggle="tab"]').on('click', function(e) {
            const targetTab = $(this).attr('href').substring(1);
            const previousTab = localStorage.getItem(self.storageKey);
            
            console.log('👆 Tab CLICKED:', targetTab + ' (önceki: ' + previousTab + ')');
            
            // Laravel log'una tıklama anında yaz
            console.log('TAB_CLICKED', {
                clicked_tab: targetTab,
                previous_tab: previousTab,
                storage_key: self.storageKey,
                message: 'Tab tıklandı - henüz switch olmadı'
            });
        });
        
        $('.nav-link[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
            const activeTab = $(e.target).attr('href').substring(1);
            const previousTab = localStorage.getItem(self.storageKey);
            self.setActiveTab(activeTab);
            
            console.log('🔄 Tab değişti ve kaydedildi:', activeTab);
            
            // Laravel log'una yaz
            console.log('TAB_SWITCHED', {
                previous_tab: previousTab,
                new_tab: activeTab,
                storage_key: self.storageKey,
                message: 'Kullanıcı tab değiştirdi - switch tamamlandı'
            });
        });
        
        // !! ÇÖZÜM: LIVEWIRE HOOK ile FORCED TAB RESTORE !!
        if (typeof Livewire !== 'undefined') {
            // Submit öncesi hook - saveActiveTabBeforeSubmit'i çağır
            Livewire.hook('message.sent', function() {
                console.log('🚀 Livewire message.sent - saveActiveTabBeforeSubmit çağrılıyor');
                if (typeof window.saveActiveTabBeforeSubmit === 'function') {
                    window.saveActiveTabBeforeSubmit();
                }
            });
            
            Livewire.hook('message.processed', function() {
                // Pre-submit state'ini kullan (eğer varsa)
                const targetTab = window.preSubmitTabState || self.getActiveTab();
                const currentDomTab = document.querySelector('.nav-link[data-bs-toggle="tab"].active')?.getAttribute('href')?.substring(1);
                
                console.log('🚨 Livewire hook! Target:', targetTab, 'Current DOM:', currentDomTab);
                
                // !! FORCED RESTORE - Hiç tereddüt etme !!
                setTimeout(() => {
                    console.log('🔧 ZORLA TAB RESTORE:', targetTab);
                    
                    // 1. Tüm tab'ları deaktif et
                    document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(link => {
                        link.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active', 'show');
                    });
                    
                    // 2. Target tab'ı zorla aktif et  
                    const targetNavLink = document.querySelector(`.nav-link[href="#${targetTab}"]`);
                    const targetPane = document.getElementById(targetTab);
                    
                    if (targetNavLink && targetPane) {
                        targetNavLink.classList.add('active');
                        targetPane.classList.add('active', 'show');
                        
                        // LocalStorage'ı da güncelle - dynamic key kullan
                        const currentRoute = window.location.pathname;
                        let restoreStorageKey = 'page-manage-active-tab'; // Fallback
                        if (currentRoute.includes('/admin/page/manage/')) {
                            restoreStorageKey = 'adminpagemanageActiveTab'; // admin.page.manage -> adminpagemanageActiveTab (global replace)
                        }
                        localStorage.setItem(restoreStorageKey, targetTab);
                        
                        console.log('✅ FORCED RESTORE SUCCESS:', targetTab);
                        
                        // Console feedback
                        console.log(`🎯 TAB RESTORE: ${targetTab} tab'ına geri döndüldü!`);
                        
                        // Laravel log
                        console.log('FORCED_TAB_RESTORE', {
                            target_tab: targetTab,
                            dom_before: currentDomTab,
                            dom_after: targetTab,
                            message: 'Forced tab restore başarılı'
                        });
                    } else {
                        console.error('❌ Target tab elements bulunamadı:', targetTab);
                        console.error('TAB RESTORE HATASI: ' + targetTab + ' bulunamadı!');
                    }
                    
                    // Reset global state
                    window.preSubmitTabState = null;
                }, 10); // Biraz daha uzun timeout
            });
        } else {
            console.warn('❌ Livewire bulunamadı, hook kurulum başarısız!');
        }
    }
};

// Language Switcher for Multi-Language Forms
const MultiLangFormSwitcher = {
    init() {
        this.bindLanguageSwitch();
    },
    
    bindLanguageSwitch() {
        $(document).on('click', '.language-switch-item', function(e) {
            e.preventDefault();
            
            const $item = $(this);
            const selectedLanguage = $item.data('language');
            const selectedFlag = $item.data('flag');
            const selectedName = $item.data('name');
            
            // UI güncelle
            $('#currentLanguageFlag').text(selectedFlag);
            $('#currentLanguageName').text(selectedName);
            
            // Dropdown active state
            $('.language-switch-item').removeClass('active');
            $('.language-switch-item .fa-check').remove();
            $item.addClass('active');
            $item.append('<i class="fas fa-check ms-auto text-success"></i>');
            
            // Tüm dil içeriklerini gizle ve seçili olanı göster
            $('.language-content').hide();
            $(`.language-content[data-language="${selectedLanguage}"]`).show();
            
            // Session'a kaydet
            const currentPath = window.location.pathname;
            const module = currentPath.split('/')[2]; // /admin/{module}/...
            
            $.post(`/admin/${module}/set-editing-language`, {
                language: selectedLanguage,
                _token: $('meta[name="csrf-token"]').attr('content')
            });
        });
    },
    
    switchLanguage(selectedLanguage) {
        // Tüm dil içeriklerini gizle ve seçili olanı göster
        $('.language-content').hide();
        $(`.language-content[data-language="${selectedLanguage}"]`).show();
        
        // Session'a kaydet
        const currentPath = window.location.pathname;
        const module = currentPath.split('/')[2]; // /admin/{module}/...
        
        $.post(`/admin/${module}/set-editing-language`, {
            language: selectedLanguage,
            _token: $('meta[name="csrf-token"]').attr('content')
        });
    }
};

// TinyMCE Config for Multi-Language Forms
const TinyMCEMultiLang = {
    configs: {},
    
    getConfig(selector, options = {}) {
        const defaultConfig = {
            selector: selector,
            height: 400,
            menubar: true,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px }',
            setup: function(editor) {
                editor.on('change', function() {
                    editor.save();
                });
            }
        };
        
        return {...defaultConfig, ...options};
    },
    
    initAll(languages = ['tr', 'en', 'ar']) {
        languages.forEach(lang => {
            if (document.getElementById(`editor_${lang}`)) {
                tinymce.init(this.getConfig(`#editor_${lang}`));
            }
        });
    },
    
    destroy() {
        tinymce.remove();
    }
};

// Theme Builder Offcanvas Manuel Açma Fonksiyonu
document.addEventListener('DOMContentLoaded', function() {
    // Theme Builder DOMContentLoaded started
    
    // Theme builder button'ları bul ve manuel event ekle
    const themeBuilderButtons = document.querySelectorAll('[data-bs-target="#offcanvasTheme"]');
    // Theme builder button count check
    
    themeBuilderButtons.forEach(function(button, index) {
        // Theme builder button event listener
        
        button.addEventListener('click', function(e) {
            // Theme builder button clicked
            e.preventDefault();
            
            // Offcanvas elementini bul
            const offcanvasElement = document.getElementById('offcanvasTheme');
            console.log('🏗️ OffcanvasTheme elementi:', offcanvasElement ? 'bulundu' : 'bulunamadı');
            
            if (offcanvasElement) {
                // Bootstrap yüklenmişse Offcanvas instance'ını oluştur veya al
                console.log('🏗️ Bootstrap kontrolü yapılıyor...');
                console.log('🏗️ Bootstrap tanımlı mı:', typeof bootstrap !== 'undefined');
                console.log('🏗️ Bootstrap.Offcanvas var mı:', typeof bootstrap !== 'undefined' && !!bootstrap.Offcanvas);
                console.log('🏗️ getInstance fonksiyonu var mı:', typeof bootstrap !== 'undefined' && bootstrap.Offcanvas && typeof bootstrap.Offcanvas.getInstance === 'function');
                
                if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas && typeof bootstrap.Offcanvas.getInstance === 'function') {
                    console.log('✅ Bootstrap Offcanvas kullanılıyor');
                    
                    let offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
                    console.log('🏗️ Mevcut instance:', offcanvasInstance ? 'var' : 'yok');
                    
                    if (!offcanvasInstance) {
                        console.log('🏗️ Yeni Offcanvas instance oluşturuluyor...');
                        offcanvasInstance = new bootstrap.Offcanvas(offcanvasElement);
                    }
                    
                    // Offcanvas'ı aç
                    console.log('🏗️ Offcanvas açılıyor...');
                    offcanvasInstance.show();
                    console.log('✅ Offcanvas açıldı!');
                } else {
                    console.warn('⚠️ Bootstrap Offcanvas bulunamadı, fallback kullanılıyor');
                    // Fallback olarak direkt show/hide class'ları
                    if (offcanvasElement.classList.contains('show')) {
                        console.log('🏗️ Fallback: Offcanvas kapatılıyor');
                        offcanvasElement.classList.remove('show');
                    } else {
                        console.log('🏗️ Fallback: Offcanvas açılıyor');
                        offcanvasElement.classList.add('show');
                        
                        // Manuel olarak shown.bs.offcanvas eventini tetikle
                        console.log('🏗️ Manuel shown.bs.offcanvas eventi tetikleniyor...');
                        const shownEvent = new CustomEvent('shown.bs.offcanvas');
                        offcanvasElement.dispatchEvent(shownEvent);
                    }
                    return;
                }
            } else {
                console.error('❌ OffcanvasTheme elementi bulunamadı!');
            }
        });
    });
    
    // Theme Builder açıldıkında mevcut ayarları yükle
    const offcanvasTheme = document.getElementById('offcanvasTheme');
    if (offcanvasTheme) {
        offcanvasTheme.addEventListener('shown.bs.offcanvas', function() {
            // Mevcut tema ayarlarını form'a yansıt
            updateThemeBuilderForm();
        });
    }
});

// Theme Builder form güncellemesi
function updateThemeBuilderForm() {
    // Mevcut tema cookie'lerini oku ve form'u güncelle
    const cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.split('=').map(c => c.trim());
        acc[key] = value;
        return acc;
    }, {});
    
    // Dark mode radio'larını güncelle
    const darkCookie = cookies.dark || 'auto';
    const themeRadios = document.querySelectorAll('input[name="theme"]');
    themeRadios.forEach(radio => {
        if (darkCookie === '1' && radio.value === 'dark') {
            radio.checked = true;
        } else if (darkCookie === '0' && radio.value === 'light') {
            radio.checked = true;
        } else if (darkCookie === 'auto' && radio.value === 'auto') {
            radio.checked = true;
        }
    });
    
    // Primary color'u güncelle
    const primaryColor = cookies.siteColor || '#066fd1';
    const colorRadios = document.querySelectorAll('input[name="theme-primary"]');
    colorRadios.forEach(radio => {
        if (radio.value === primaryColor) {
            radio.checked = true;
        }
    });
    
    // Font seçimini güncelle
    const themeFont = cookies.themeFont;
    if (themeFont) {
        const fontRadios = document.querySelectorAll('input[name="theme-font"]');
        fontRadios.forEach(radio => {
            if (decodeURIComponent(themeFont) === radio.value) {
                radio.checked = true;
            }
        });
    }
    
    // Font size güncelle
    const fontSize = cookies.themeFontSize || 'small';
    const fontSizeRadios = document.querySelectorAll('input[name="theme-font-size"]');
    fontSizeRadios.forEach(radio => {
        if (radio.value === fontSize) {
            radio.checked = true;
        }
    });
    
    // Radius slider güncelle
    const radiusValue = cookies.themeRadius || '0.375rem';
    const radiusSlider = document.getElementById('radius-slider');
    if (radiusSlider) {
        const radiusMap = ['0', '0.25rem', '0.375rem', '0.5rem', '0.75rem', '1rem'];
        const radiusIndex = radiusMap.indexOf(radiusValue);
        if (radiusIndex !== -1) {
            radiusSlider.value = radiusIndex;
            
            // Radius examples'ı güncelle
            const radiusExamples = document.querySelectorAll('.radius-example');
            radiusExamples.forEach((example, index) => {
                if (index === radiusIndex) {
                    example.classList.add('active');
                } else {
                    example.classList.remove('active');
                }
            });
        }
    }
    
    // Table compact güncelle
    const tableCompact = cookies.tableCompact || '0';
    const tableRadios = document.querySelectorAll('input[name="table-compact"]');
    tableRadios.forEach(radio => {
        if (radio.value === tableCompact) {
            radio.checked = true;
        }
    });
    
    // Base theme güncelle
    const themeBase = cookies.themeBase || 'neutral';
    const baseRadios = document.querySelectorAll('input[name="theme-base"]');
    baseRadios.forEach(radio => {
        if (radio.value === themeBase) {
            radio.checked = true;
        }
    });
};

// Bootstrap event entegrasyonu - Theme switcher için
document.addEventListener('DOMContentLoaded', function() {
    // Dark mode toggle için click event listener
    const darkModeSwitch = document.getElementById('switch');
    if (darkModeSwitch) {
        // Theme switch'e manuel event ekle
        darkModeSwitch.addEventListener('click', function(e) {
            // Eğer tema sistemi yüklenmişse, onun change event'ini kullan
            if (typeof initThemeSwitch === 'function') {
                // Theme.js'deki change event'i tetiklenir
                return;
            }
            
            // Fallback: Basit toggle
            const isChecked = this.checked;
            const newTheme = isChecked ? '1' : '0';
            document.cookie = `dark=${newTheme};path=/;max-age=31536000`;
            
            // Body theme'ini güncelle
            if (isChecked) {
                document.body.setAttribute('data-bs-theme', 'dark');
                document.body.classList.add('dark');
                document.body.classList.remove('light');
            } else {
                document.body.setAttribute('data-bs-theme', 'light');
                document.body.classList.add('light');
                document.body.classList.remove('dark');
            }
        });
    }
    
    // Offcanvas events için theme builder entegrasyonu
    const offcanvasTheme = document.getElementById('offcanvasTheme');
    if (offcanvasTheme) {
        // Offcanvas açıldığında
        offcanvasTheme.addEventListener('shown.bs.offcanvas', function() {
            // Form güncellemesini tetikle
            if (typeof updateThemeBuilderForm === 'function') {
                updateThemeBuilderForm();
            }
            
            // Focus management
            const firstInput = this.querySelector('input[type="radio"]:checked, input[type="radio"]');
            if (firstInput) {
                firstInput.focus();
            }
        });
        
        // Offcanvas kapandığında
        offcanvasTheme.addEventListener('hidden.bs.offcanvas', function() {
            // Theme değişikliklerini kaydet veya uygula
            if (typeof forceUpdateThemeVariables === 'function') {
                forceUpdateThemeVariables();
            }
        });
    }
    
    // Theme değişikliklerini dinle ve toast mesajı göster
    document.addEventListener('change', function(e) {
        if (e.target.matches('input[name="theme"], input[name="theme-primary"], input[name="theme-font"], input[name="theme-font-size"], input[name="theme-base"], input[name="table-compact"]')) {
            // Theme değişikliği tespit edildi
            if (typeof showToast === 'function') {
                showToast(t('success'), t('theme_updated'), 'success');
            }
        }
    });
});

/* ====================================== */
/* GLOBAL HELPER FUNCTIONS - From Page Module */
/* ====================================== */

// Character counting fonksiyonu - Real-time + Loader + Renk
function setupCharacterCounting() {
    console.log('🔢 Real-time character counting başlatılıyor...');
    
    // Tüm SEO character counter'ları bul
    const counters = document.querySelectorAll('.seo-character-counter');
    
    counters.forEach(function(counter) {
        const fieldName = counter.getAttribute('data-counter-for');
        const limit = parseInt(counter.getAttribute('data-limit'));
        const input = document.getElementById(fieldName === 'seo_title' ? 'seo-title' : 
                                          fieldName === 'seo_description' ? 'seo-description' : 
                                          fieldName === 'canonical_url' ? 'canonical-url' : fieldName);
        
        if (!input || !limit) return;
        
        console.log('✅ Counter aktif:', fieldName, 'limit:', limit);
        
        // Progress bar'ı da bul
        const progressBar = document.querySelector(`.seo-progress-bar[data-field="${fieldName}"]`);
        
        // Real-time update fonksiyonu
        function updateCounter() {
            const currentLength = input.value.length;
            const percentage = (currentLength / limit) * 100;
            
            // Mini loader göster
            counter.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sayılıyor...';
            
            // 100ms sonra sonucu göster (hızlı)
            setTimeout(() => {
                // Renk sistemi (Tabler.io colors)
                let colorClass = '';
                let progressColorClass = '';
                
                if (percentage > 90) {
                    colorClass = 'text-danger';
                    progressColorClass = 'bg-danger';
                } else if (percentage > 75) {
                    colorClass = 'text-warning';
                    progressColorClass = 'bg-warning';
                } else {
                    colorClass = 'text-success';
                    progressColorClass = 'bg-success';
                }
                
                // Counter güncelle
                counter.className = `seo-character-counter ${colorClass}`;
                counter.innerHTML = `${currentLength}/${limit}`;
                
                // Progress bar güncelle
                if (progressBar) {
                    progressBar.style.width = `${Math.min(100, percentage)}%`;
                    progressBar.className = `progress-bar seo-progress-bar ${progressColorClass}`;
                }
            }, 100);
        }
        
        // Event listeners
        input.addEventListener('input', updateCounter);
        input.addEventListener('keyup', updateCounter);
        input.addEventListener('paste', () => setTimeout(updateCounter, 10));
        
        // İlk load
        updateCounter();
    });
    
    console.log('🔢 Real-time character counting tamamlandı!');

// Keyword ekleme/silme sistemi - Global - Vanilla JS
function setupKeywordSystem() {
    console.log('🔑 setupKeywordSystem çalışıyor...');
    
    const input = document.getElementById('keyword-input');
    const button = document.getElementById('add-keyword');
    const display = document.getElementById('keyword-display');
    const hiddenInput = document.getElementById('seo-keywords-hidden');
    
    console.log('🔍 Keyword elementleri:', {
        input: !!input,
        button: !!button, 
        display: !!display,
        hidden: !!hiddenInput
    });
    
    if (!input || !button || !display || !hiddenInput) {
        console.warn('❌ Keyword elementleri bulunamadı!');
        return;
    }
    
    console.log('✅ Keyword sistemi aktif!');
    
    // Mevcut keyword silme butonlarına event listener ekle
    const existingRemoveButtons = display.querySelectorAll('.keyword-remove');
    existingRemoveButtons.forEach(function(removeButton) {
        removeButton.onclick = function() {
            const badge = removeButton.closest('.badge');
            if (badge) {
                badge.remove();
                updateHiddenKeywords();
            }
        };
    });
    
    // Enter tuşu
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addKeyword();
        }
    });
    
    // Plus butonu
    button.addEventListener('click', function(e) {
        e.preventDefault();
        addKeyword();
    });
    
    // Keyword ekleme fonksiyonu
    function addKeyword() {
        const keyword = input.value.trim();
        
        if (keyword === '') {
            console.warn('Boş keyword eklenemez!');
            return;
        }
        
        // Duplicate kontrolü
        const existingKeywords = display.querySelectorAll('.keyword-text');
        for (let elem of existingKeywords) {
            if (elem.textContent.trim() === keyword) {
                console.warn('Bu keyword zaten mevcut: ' + keyword);
                input.value = '';
                input.focus();
                return;
            }
        }
        
        // Badge oluştur (Tabler.io badge sistemi)
        const badge = document.createElement('span');
        badge.className = 'badge badge-outline me-1 mb-1';
        
        // İçerik ekle
        badge.innerHTML = `<span class="keyword-text">${keyword}</span><span class="keyword-remove ms-1" style="cursor: pointer;">&times;</span>`;
        
        // Yeni eklenen butonuna da event listener ekle
        const newRemoveBtn = badge.querySelector('.keyword-remove');
        newRemoveBtn.onclick = function() {
            badge.remove();
            updateHiddenKeywords();
        };
        
        // Badge'i ekle
        display.appendChild(badge);
        
        // Hidden input'u güncelle
        updateHiddenKeywords();
        
        // Input'u temizle
        input.value = '';
        input.focus();
    }
    
    // Hidden field'ı güncelle ve Livewire'a event gönder
    function updateHiddenKeywords() {
        const keywordTexts = Array.from(display.querySelectorAll('.keyword-text'))
            .map(elem => elem.textContent.trim())
            .filter(text => text.length > 0);
        
        const keywordsString = keywordTexts.join(', ');
        hiddenInput.value = keywordsString;
        
        // Livewire'a input event gönder
        hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        console.log('🔄 Keywords güncellendi:', keywordsString);
    }
    
    console.log('🔑 setupKeywordSystem tamamlandı!');
}

// Real-time slug üretimi - jQuery ile eşzamanlı
function setupRealTimeSlugGeneration() {
    console.log('🔗 Real-time slug generation başlatılıyor...');
    
    // Title input'larını dinle (wire:model pattern'i)
    $(document).on('input keyup', '[wire\\:model*=".title"]', function() {
        const titleInput = $(this);
        const wireModel = titleInput.attr('wire:model');
        
        // Lang kodunu çıkar (örn: multiLangInputs.tr.title -> tr)
        const langMatch = wireModel.match(/multiLangInputs\.(\w+)\.title/);
        if (langMatch) {
            const lang = langMatch[1];
            const titleValue = titleInput.val().trim();
            const slugInput = $(`[wire\\:model="multiLangInputs.${lang}.slug"]`);
            
            if (slugInput.length && titleValue !== '') {
                // Real-time Türkçe slug üretimi
                const slug = generateTurkishSlug(titleValue);
                
                // Sadece slug alanı boşsa doldur (manuel düzenlemeyi bozma)
                if (slugInput.val().trim() === '') {
                    slugInput.val(slug);
                    
                    // Livewire'a bildir
                    slugInput.trigger('input');
                    
                    console.log('🔗 Real-time slug:', lang, slug);
                }
            }
        }
    });
    
    // Slug alanını temizlediğinde tekrar otomatik doldur
    $(document).on('blur', '[wire\\:model*=".slug"]', function() {
        const slugInput = $(this);
        const wireModel = slugInput.attr('wire:model');
        
        if (slugInput.val().trim() === '') {
            const langMatch = wireModel.match(/multiLangInputs\.(\w+)\.slug/);
            if (langMatch) {
                const lang = langMatch[1];
                const titleInput = $(`[wire\\:model="multiLangInputs.${lang}.title"]`);
                const titleValue = titleInput.val().trim();
                
                if (titleValue !== '') {
                    const slug = generateTurkishSlug(titleValue);
                    slugInput.val(slug);
                    slugInput.trigger('input');
                    console.log('🔗 Slug yeniden oluşturuldu:', lang, slug);
                }
            }
        }
    });
    
    console.log('🔗 Real-time slug generation hazır!');
}

// Türkçe karakter dönüşümlü slug üretimi
function generateTurkishSlug(text) {
    // Türkçe karakter dönüşüm tablosu
    const turkishChars = {
        'Ç': 'C', 'ç': 'c',
        'Ğ': 'G', 'ğ': 'g', 
        'I': 'I', 'ı': 'i',
        'İ': 'I', 'i': 'i',
        'Ö': 'O', 'ö': 'o',
        'Ş': 'S', 'ş': 's',
        'Ü': 'U', 'ü': 'u'
    };
    
    return text
        // Türkçe karakterleri çevir
        .replace(/[ÇçĞğIıİiÖöŞşÜü]/g, function(match) {
            return turkishChars[match] || match;
        })
        // Küçük harfe çevir
        .toLowerCase()
        // Özel karakterleri temizle (sadece harf, rakam ve boşluk kalsın)
        .replace(/[^a-z0-9\s\-]/g, '')
        // Birden fazla boşluk/tire varsa tek tire yap
        .replace(/[\s\-]+/g, '-')
        // Başındaki ve sonundaki tireleri kaldır
        .replace(/^-+|-+$/g, '');
}


// Global helper fonksiyonlarını sayfa yüklendiğinde çalıştır - SADECE MANAGE SAYFALARINDA
document.addEventListener('DOMContentLoaded', function() {
    // Sadece manage sayfalarında çalıştır
    if (window.location.pathname.includes('/manage')) {
        // System başlatıldı log'u
        console.log('🔄 Manage sayfası yüklendi:', window.location.pathname);
        
        // Delay'i kaldırdık - hemen çalışsın
        setupCharacterCounting();
        setupKeywordSystem();
        setupRealTimeSlugGeneration(); // Real-time slug üretimi
        
        // Tüm input'ları dinle
        setupInputLogging();
    }
});

// Input logging sistemi
function setupInputLogging() {
    // Tüm input, textarea ve select elementlerini dinle
    document.addEventListener('input', function(e) {
        if (e.target.matches('input, textarea, select')) {
            const element = e.target;
            console.log('INPUT_CHANGED', {
                element_id: element.id || 'no-id',
                element_name: element.name || 'no-name',
                element_type: element.type || element.tagName.toLowerCase(),
                value_length: element.value ? element.value.length : 0,
                wire_model: element.getAttribute('wire:model') || element.getAttribute('wire:model.live') || 'none',
                message: `Input değişti: ${element.id || element.name || 'unknown'}`
            });
        }
    });
    
    // Tüm button click'leri dinle
    document.addEventListener('click', function(e) {
        if (e.target.matches('button, .btn, [role="button"]')) {
            const button = e.target;
            console.log('BUTTON_CLICKED', {
                button_text: button.textContent?.trim() || 'no-text',
                button_id: button.id || 'no-id',
                button_class: button.className || 'no-class',
                wire_click: button.getAttribute('wire:click') || 'none',
                message: `Button tıklandı: ${button.textContent?.trim() || button.id || 'unknown'}`
            });
        }
    });
    
    console.log('🎯 Event listeners kuruldu: input ve button tracking aktif');
}

// Livewire güncellemelerinden sonra da çalıştır - SADECE MANAGE SAYFALARINDA
document.addEventListener('livewire:updated', function() {
    if (window.location.pathname.includes('/manage')) {
        // 100ms delay ile hızlı response
        setTimeout(function() {
            setupCharacterCounting();
            setupKeywordSystem();
            syncHugeRTEWithLivewire(); // HugeRTE sync eklendi
        }, 100);
    }
});

// HugeRTE içeriğini Livewire ile senkronize et
function syncHugeRTEWithLivewire() {
    console.log('🔄 HugeRTE sync başlatılıyor...');
    
    // Tüm HugeRTE editörlerini bul
    const editors = document.querySelectorAll('.hugerte-editor');
    
    editors.forEach(function(editor) {
        const wireModel = editor.getAttribute('data-wire-model');
        if (wireModel) {
            const lang = editor.id.replace('editor_', '');
            const hiddenInput = document.getElementById('hidden_body_' + lang);
            
            if (hiddenInput) {
                let editorContent = '';
                
                // HugeRTE API kullanarak content al
                if (typeof hugerte !== 'undefined') {
                    const hugerteEditor = hugerte.get(editor.id);
                    if (hugerteEditor) {
                        editorContent = hugerteEditor.getContent();
                        console.log('📝 HugeRTE API ile content alındı:', lang);
                    } else {
                        // Fallback: textarea value
                        editorContent = editor.value || '';
                        console.log('📝 Textarea value ile content alındı:', lang);
                    }
                } else {
                    // HugeRTE yüklü değilse normal textarea
                    editorContent = editor.value || editor.innerHTML || '';
                    console.log('📝 Normal textarea ile content alındı:', lang);
                }
                
                // Hidden input'a aktar
                hiddenInput.value = editorContent;
                
                // Livewire'a input event gönder
                hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                console.log('✅ HugeRTE sync:', lang, editorContent.length + ' karakter');
            }
        }
    });
}

// Form submit öncesi HugeRTE sync
document.addEventListener('livewire:before-save', function() {
    syncHugeRTEWithLivewire();
});

// Save butonu tıklanmadan önce sync
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-save-btn]') || e.target.closest('[data-save-btn]') || 
        e.target.matches('[wire\\:click*="save"]') || e.target.closest('[wire\\:click*="save"]')) {
        
        console.log('💾 Save işlemi başlıyor - tüm alanları sync ediyoruz...');
        
        // Keyword sistemini güncelle
        const keywordDisplay = document.getElementById('keyword-display');
        const keywordHidden = document.getElementById('seo-keywords-hidden');
        if (keywordDisplay && keywordHidden) {
            const keywordTexts = Array.from(keywordDisplay.querySelectorAll('.keyword-text'))
                .map(elem => elem.textContent.trim())
                .filter(text => text.length > 0);
            keywordHidden.value = keywordTexts.join(', ');
            keywordHidden.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // HugeRTE editörlerini sync et
        syncHugeRTEWithLivewire();
        
        console.log('✅ Tüm alanlar sync edildi!');
    }
});

// SEO alanlarını Livewire ile senkronize et - EVENT BAZLI SİSTEM
function syncSEOFieldsWithLivewire() {
    console.log('🔄 SEO Fields sync başlatılıyor...');
    
    // Tüm SEO alanlarını bul
    const seoFields = document.querySelectorAll('.seo-field');
    
    seoFields.forEach(function(field) {
        const livewireTarget = field.getAttribute('data-livewire-target');
        const value = field.value;
        
        if (livewireTarget && window.Livewire) {
            // Livewire component'ine event gönder
            Livewire.dispatch('seo-field-updated', {
                field: livewireTarget,
                value: value
            });
            
            console.log('✅ SEO Field sync:', livewireTarget, value.length + ' karakter');
        }
    });
    
    // Anahtar kelimeler hidden field'dan al
    const keywordsField = document.getElementById('seo-keywords-hidden');
    if (keywordsField && window.Livewire) {
        Livewire.dispatch('seo-field-updated', {
            field: 'seo_keywords',
            value: keywordsField.value
        });
        console.log('✅ SEO Keywords sync:', keywordsField.value);
    }
}

// SEO alanlarında değişiklik olduğunda real-time sync
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('seo-field')) {
        const livewireTarget = e.target.getAttribute('data-livewire-target');
        const value = e.target.value;
        
        if (livewireTarget && window.Livewire) {
            // Debounce ile performance optimize
            clearTimeout(window.seoSyncTimeout);
            window.seoSyncTimeout = setTimeout(function() {
                Livewire.dispatch('seo-field-updated', {
                    field: livewireTarget,
                    value: value
                });
            }, 300); // 300ms debounce
        }
    }
});

// Global objects için window'a export et (Cache Buster)
window.TabManager = TabManager;
window.setupKeywordSystem = setupKeywordSystem;
window.setupCharacterCounting = setupCharacterCounting;
