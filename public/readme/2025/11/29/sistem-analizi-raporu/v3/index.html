<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Analizi Raporu - v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --radius: 0.75rem;
            --accent-blue: #0d6efd;
            --accent-red: #dc3545;
            --accent-green: #198754;
            --accent-yellow: #ffc107;
        }
        [data-theme="dark"] {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: #30363d;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1.5rem; }
        .header { text-align: center; margin-bottom: 3rem; }
        .header h1 { font-size: 2.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header .meta { font-size: 1rem; color: var(--text-secondary); }
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.75rem;
            margin-bottom: 2rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        .card h2, .card h3 { font-weight: 600; margin-bottom: 1rem; }
        .card h2 { font-size: 1.75rem; color: var(--accent-blue); display: flex; align-items: center; gap: 0.75rem; }
        .card h3 { font-size: 1.25rem; }
        .summary-card { text-align: center; }
        .summary-card p { font-size: 1.1rem; color: var(--text-secondary); max-width: 800px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .icon { width: 28px; height: 28px; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: center; }
        .comparison-box { padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color); }
        .comparison-box h3 { display: flex; align-items: center; gap: 0.5rem; }
        .comparison-box ul { padding-left: 1.5rem; color: var(--text-secondary); }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-green { background-color: var(--accent-green); }
        .dot-red { background-color: var(--accent-red); }
        .risk-card { border-left: 5px solid var(--accent-red); }
        .risk-card h3 { color: var(--accent-red); }
        .solution-card { border-left: 5px solid var(--accent-green); }
        .solution-card h3 { color: var(--accent-green); }
        code {
            background-color: rgba(13, 110, 253, 0.1);
            color: var(--accent-blue);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
        }
        .theme-toggle { position: fixed; top: 20px; right: 20px; cursor: pointer; padding: 8px; border-radius: 50%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); }
    </style>
</head>
<body data-theme="dark">

    <div class="theme-toggle" onclick="toggleTheme()">
        <svg class="icon" id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.836 17.836a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.864 6.106a.75.75 0 00-1.06 1.06l1.59 1.591a.75.75 0 101.061-1.06l-1.59-1.591zM4.25 12a.75.75 0 01-.75.75H1.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM6.106 17.836a.75.75 0 001.06 1.06l1.591-1.59a.75.75 0 10-1.06-1.061l-1.591 1.59z"></path></svg>
        <svg class="icon" id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 004.463-1.428.75.75 0 01.98.633A10.5 10.5 0 0112 21a10.5 10.5 0 01-10.5-10.5c0-4.306 2.56-8.007 6.3-9.662a.75.75 0 01.696-.62z" clip-rule="evenodd"></path></svg>
    </div>

    <div class="container">
        <div class="header">
            <h1>Sistem Analizi Raporu</h1>
            <p class="meta">Versiyon 3.0 | Tarih: 2025-11-29 | Analiz Motoru: Gemini</p>
        </div>

        <div class="card summary-card">
            <h2>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.62-3.749A11.959 11.959 0 0112 2.25z" /></svg>
                Yönetici Özeti: Bilinmesi Gerekenler
            </h2>
            <p>
                Sistem, **"Split-Brain" (Bölünmüş Beyin)** olarak adlandırabileceğimiz temel bir mimari çelişki yaşamaktadır. Dökümantasyon, kullanıcıların **merkezi** bir sistemde olduğunu söylerken, kod her bir kiracı (tenant) için **ayrı bir kullanıcı tablosu** oluşturmaktadır. Bu durum, hem geliştirme sürecinde kafa karışıklığına hem de ciddi veri bütünlüğü ve güvenlik risklerine yol açmaktadır. Raporun devamında bu çelişkinin kanıtları ve çözüm stratejileri sunulmaktadır.
            </p>
        </div>

        <div class="card">
            <h2>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                Ana Keşif: Döküman ve Kod Arasındaki Çelişki
            </h2>
            <div class="comparison-grid">
                <div class="comparison-box">
                    <h3><span class="status-dot dot-green"></span> Döküman Ne Diyor?</h3>
                    <p><code>CLAUDE.md</code> dosyasına göre, <code>users</code>, <code>roles</code>, ve <code>permissions</code> tabloları tüm kiracılar için **ortaktır** ve merkezi veritabanında yer alır.</p>
                    <ul>
                        <li>Veri Bütünlüğü</li>
                        <li>Tekil Kullanıcı Yönetimi</li>
                        <li>Merkezi Yetkilendirme</li>
                    </ul>
                </div>
                <div class="comparison-box">
                     <h3><span class="status-dot dot-red"></span> Kod Ne Yapıyor?</h3>
                    <p>Veritabanı migration dosyaları incelendiğinde, <code>create_users_table.php</code> dosyasının hem **merkezi** hem de **kiracı** klasörlerinde olduğu görülmüştür.</p>
                    <ul>
                        <li><code>database/migrations/</code> ➔ users tablosu var</li>
                        <li><code>database/migrations/tenant/</code> ➔ users tablosu var</li>
                        <li>**Sonuç:** Her kiracının kendi izole kullanıcı tablosu var.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="risk-card card">
            <h3>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                Bu Çelişkinin Doğurduğu Riskler
            </h3>
            <div class="grid">
                <div>
                    <h4>Geliştirici Kafa Karışıklığı</h4>
                    <p>Dökümana güvenen bir geliştirici, kullanıcı işlemlerini merkezi varsayarak kod yazar ve farkında olmadan ciddi hatalara yol açar. Bu, geliştirme sürecini yavaşlatır ve güvenilirliğini azaltır.</p>
                </div>
                <div>
                    <h4>Model Belirsizliği</h4>
                    <p><code>app/Models/User.php</code> modeli, hem merkezi hem de kiracı veritabanındaki `users` tablolarına aynı anda hizmet edemez. Bu durum, hangi veritabanına bağlanacağını şaşırmasına ve beklenmedik hatalara neden olur.</p>
                </div>
                <div>
                    <h4>Kimlik Doğrulama Kaosu</h4>
                    <p>Bir kullanıcı giriş yapmaya çalıştığında sistem hangi `users` tablosunu kullanmalı? Merkezi mi, kiracınınkini mi? Bu belirsizlik, kullanıcıların sisteme giriş yapamamasına veya yanlış yetkilerle işlem yapmasına neden olabilir.</p>
                </div>
            </div>
        </div>

        <div class="solution-card card">
            <h3>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Çözüm Stratejisi: Netliğe Giden Yol
            </h3>
            <p style="margin-bottom: 1.5rem;">Sistemin sağlığı ve geleceği için bu mimari çelişkinin çözülmesi şarttır. İki olası yol vardır, ancak biri şiddetle tavsiye edilir:</p>
            <div class="comparison-grid">
                <div class="comparison-box" style="border-color: var(--accent-green);">
                    <h4>Yol A: Merkezi Mimarıyı Benimse (Tavsiye Edilen)</h4>
                    <p>Kod, dökümantasyona uydurulur. Bu, modern SaaS uygulamaları için en iyi pratiktir.</p>
                    <ol>
                        <li>Kiracı migration klasöründen (<code>/tenant/</code>) <code>create_users_table.php</code> ve ilgili migration'lar **kaldırılır.**</li>
                        <li><code>User</code>, <code>Role</code>, <code>Permission</code> gibi tüm merkezi modellerin her zaman <code>protected $connection = 'central';</code> kullanması **garanti altına alınır.**</li>
                        <li>Sistem, tek bir merkezi kullanıcı tablosundan çalışacak şekilde düzenlenir.</li>
                    </ol>
                </div>
                <div class="comparison-box" style="border-color: var(--accent-yellow);">
                     <h4>Yol B: Kiracıya Özel Mimarıyı Benimse</h4>
                    <p>Dökümantasyon, koda uydurulur. Bu, her kiracının tamamen izole olmasını gerektiren senaryolarda geçerlidir.</p>
                    <ol>
                        <li><code>CLAUDE.md</code> dökümanı, kullanıcıların kiracıya özel olduğunu belirtecek şekilde **güncellenir.**</li>
                        <li><code>app/Models/User.php</code> gibi merkezi modeller yerine, kiracı context'inde çalışacak <code>app/Models/Tenant/User.php</code> gibi yeni modeller oluşturulur.</li>
                        <li>Sistemin kimlik doğrulama mekanizması, kiracıya özel kullanıcıları tanıyacak şekilde yeniden yapılandırılır.</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                Diğer Bulgular (İkincil Öncelik)
            </h2>
            <div class="grid">
                <div>
                    <h4>"Şişman Model" Sorunu</h4>
                    <p><code>User</code> modeli, sadece "Muzibu" kiracısına özel işlevler içeriyor. Bu, modelin temizliğini ve bakımını zorlaştırıyor. Bu mantık, Muzibu modülü içine taşınmalıdır.</p>
                </div>
                <div>
                    <h4>Riskli Dosya İzinleri</h4>
                    <p>Yeni kiracı klasörleri oluşturulurken dosya izin hatalarının <code>@</code> operatörü ile gizlenmesi, olası sorunların fark edilmesini engeller. Bu operatör kaldırılmalı ve hatalar loglanmalıdır.</p>
                </div>
                <div>
                    <h4>"Şişman Kontrolcü"</h4>
                    <p><code>DebugDashboardController</code> gibi kontrolcüler, içinde karmaşık veri sorguları barındırıyor. Bu sorgular, kodun okunabilirliğini azaltır ve test edilmesini zorlaştırır. İş mantığı, servis katmanlarına taşınmalıdır.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon-sun').style.display = newTheme === 'dark' ? 'none' : 'block';
            document.getElementById('theme-icon-moon').style.display = newTheme === 'dark' ? 'block' : 'none';
        }
        // Set initial icon state
        document.getElementById('theme-icon-moon').style.display = 'block';
    </script>
</body>
</html>
