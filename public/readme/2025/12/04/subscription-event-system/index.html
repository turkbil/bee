<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Event System - Ortak Dil</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-align: center;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .section {
            background: rgba(30, 41, 59, 0.5);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border-left: 5px solid #3b82f6;
        }
        
        h2 {
            font-size: 1.7rem;
            color: #60a5fa;
            margin-bottom: 20px;
        }
        
        h3 {
            font-size: 1.3rem;
            color: #fbbf24;
            margin: 25px 0 15px 0;
        }
        
        .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .event-card {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 12px;
            border-top: 4px solid;
        }
        
        .event-card.trial { border-color: #10b981; }
        .event-card.premium { border-color: #3b82f6; }
        .event-card.device { border-color: #f59e0b; }
        .event-card.payment { border-color: #8b5cf6; }
        
        .event-card h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        ul { padding-left: 25px; margin: 15px 0; }
        li { margin: 8px 0; color: #cbd5e1; }
        
        .code-block {
            background: rgba(15, 23, 42, 0.95);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            color: #e5e7eb;
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.15);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .winner {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.15));
            padding: 25px;
            border-radius: 12px;
            border: 3px solid #10b981;
            text-align: center;
            margin: 25px 0;
        }
        
        .winner h3 {
            color: #10b981;
            font-size: 1.6rem;
            margin-bottom: 10px;
        }
        
        .flow-diagram {
            background: rgba(15, 23, 42, 0.8);
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .flow-number {
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .flow-content h4 {
            color: #60a5fa;
            margin-bottom: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        th {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            font-weight: 600;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comp-card {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 12px;
        }
        
        .comp-card.bad {
            border: 2px solid #ef4444;
        }
        
        .comp-card.good {
            border: 2px solid #10b981;
        }
        
        .comp-card h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .comparison { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Subscription Event System</h1>
        <p class="subtitle">Ortak Dil - TÃ¼m Olaylar Ä°Ã§in Tek Sistem</p>

        <!-- Mevcut Durum -->
        <div class="section">
            <h2>âŒ Mevcut Durum: DaÄŸÄ±nÄ±k Sistem</h2>
            
            <div class="event-grid">
                <div class="event-card trial">
                    <h4 style="color: #10b981;">ğŸ Trial BitiÅŸi</h4>
                    <p><strong>Åu an:</strong> Cron job (gÃ¼nlÃ¼k)</p>
                    <p><strong>Sorun:</strong> Cron Ã§alÄ±ÅŸmazsa bitmez!</p>
                </div>

                <div class="event-card premium">
                    <h4 style="color: #3b82f6;">â­ Premium BitiÅŸi</h4>
                    <p><strong>Åu an:</strong> isPremium() iÃ§inde tarih kontrolÃ¼</p>
                    <p><strong>Sorun:</strong> Lazy check, status gÃ¼ncellenmez!</p>
                </div>

                <div class="event-card device">
                    <h4 style="color: #f59e0b;">ğŸ“± Device Limit</h4>
                    <p><strong>Åu an:</strong> GiriÅŸ sÄ±rasÄ±nda kontrol</p>
                    <p><strong>Sorun:</strong> Eski cihaz otomatik Ã§Ä±kmaz!</p>
                </div>

                <div class="event-card payment">
                    <h4 style="color: #8b5cf6;">ğŸ’³ Ã–deme HatasÄ±</h4>
                    <p><strong>Åu an:</strong> Payment gateway callback</p>
                    <p><strong>Sorun:</strong> Webhook gelmezse bilinmez!</p>
                </div>
            </div>

            <div class="info-box">
                <strong style="color: #60a5fa; display: block; margin-bottom: 10px; font-size: 1.1rem;">âš ï¸ Sorun:</strong>
                <ul>
                    <li>Her olay iÃ§in farklÄ± yÃ¶ntem</li>
                    <li>BazÄ±larÄ± cron, bazÄ±larÄ± lazy check</li>
                    <li>Hepsi farklÄ± yerlerde kontrol ediliyor</li>
                    <li>Ortak mantÄ±k yok!</li>
                </ul>
            </div>
        </div>

        <!-- Ã‡Ã¶zÃ¼m: Event-Based System -->
        <div class="section">
            <h2>âœ… Ã‡Ã¶zÃ¼m: Event-Based System (Ortak Dil)</h2>

            <div class="winner">
                <h3>ğŸ¯ Tek Prensip: Lazy Check + Event Dispatch</h3>
                <p style="color: #cbd5e1; margin-top: 10px;">
                    TÃ¼m kontroller <strong>kullanÄ±lÄ±rken</strong> yapÄ±lÄ±r, <strong>event dispatch</strong> edilir!
                </p>
            </div>

            <h3>ğŸ“‹ NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h3>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-number">1</div>
                    <div class="flow-content">
                        <h4>KullanÄ±cÄ± Bir Åey Yapar</h4>
                        <p>MÃ¼zik Ã§alar, giriÅŸ yapar, sayfa aÃ§ar...</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-number">2</div>
                    <div class="flow-content">
                        <h4>Sistem KontrolÃ¼ (Lazy Check)</h4>
                        <p>isPremium(), checkDeviceLimit(), vb.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-number">3</div>
                    <div class="flow-content">
                        <h4>Durum DeÄŸiÅŸikliÄŸi mi?</h4>
                        <p>Trial bitti mi? Premium bitti mi? Limit aÅŸÄ±ldÄ± mÄ±?</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-number">4</div>
                    <div class="flow-content">
                        <h4>Event Dispatch!</h4>
                        <p>TrialExpired, PremiumExpired, DeviceLimitExceeded</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-number">5</div>
                    <div class="flow-content">
                        <h4>Listeners Ã‡alÄ±ÅŸÄ±r</h4>
                        <p>Email gÃ¶nder, bildirim at, log tut, webhook tetikle</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TÃ¼m Olaylar -->
        <div class="section">
            <h2>ğŸª TÃ¼m Subscription OlaylarÄ±</h2>

            <table>
                <thead>
                    <tr>
                        <th>Olay</th>
                        <th>Tetikleyici</th>
                        <th>Event</th>
                        <th>Aksiyon</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>ğŸ Trial BitiÅŸi</strong></td>
                        <td><code>isPremium()</code> Ã§aÄŸrÄ±sÄ±</td>
                        <td><code>TrialExpired</code></td>
                        <td>Status â†’ expired, Email, Bildirim</td>
                    </tr>
                    <tr>
                        <td><strong>â­ Premium BitiÅŸi</strong></td>
                        <td><code>isPremium()</code> Ã§aÄŸrÄ±sÄ±</td>
                        <td><code>SubscriptionExpired</code></td>
                        <td>Status â†’ expired, Email, Banner</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ“± Device Limit</strong></td>
                        <td>GiriÅŸ / Token refresh</td>
                        <td><code>DeviceLimitExceeded</code></td>
                        <td>Eski cihazÄ± Ã§Ä±kar, Bildirim</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ’³ Ã–deme HatasÄ±</strong></td>
                        <td>Webhook / Manual check</td>
                        <td><code>PaymentFailed</code></td>
                        <td>KullanÄ±cÄ±ya bildir, Retry</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ”„ Otomatik Yenileme</strong></td>
                        <td>Cron (gÃ¼nlÃ¼k)</td>
                        <td><code>SubscriptionRenewed</code></td>
                        <td>Ã–deme al, Email, Extend</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸš« Manuel Ä°ptal</strong></td>
                        <td>KullanÄ±cÄ± butonu</td>
                        <td><code>SubscriptionCancelled</code></td>
                        <td>Status â†’ cancelled, Email</td>
                    </tr>
                    <tr>
                        <td><strong>âš ï¸ Grace Period</strong></td>
                        <td>Ã–deme hatasÄ± + 3 gÃ¼n</td>
                        <td><code>GracePeriodStarted</code></td>
                        <td>KullanÄ±cÄ±ya uyarÄ±, Retry</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Kod Ã–rnekleri -->
        <div class="section">
            <h2>ğŸ’» Kod Ã–rnekleri - Ortak Sistem</h2>

            <h3>1ï¸âƒ£ isPremium() - Trial & Premium Lazy Check</h3>
            <div class="code-block">// app/Models/User.php
public function isPremium(): bool
{
    if (!$this->isMuzibuTenant()) {
        return false;
    }
    
    $subscription = $this->subscriptions()
        -&gt;where('status', 'active')
        -&gt;where('ends_at', '&gt;', now())
        -&gt;first();
    
    // ğŸ”¥ LAZY CHECK: BitmiÅŸ subscription var mÄ±?
    $expiredSubscription = $this->subscriptions()
        -&gt;where('status', 'active')
        -&gt;where('ends_at', '&lt;=', now())
        -&gt;first();
    
    if ($expiredSubscription) {
        // Status gÃ¼ncelle
        $expiredSubscription-&gt;update(['status' =&gt; 'expired']);
        
        // ğŸ‰ EVENT DISPATCH!
        if ($expiredSubscription-&gt;plan-&gt;is_trial) {
            event(new \\App\\Events\\TrialExpired($this, $expiredSubscription));
        } else {
            event(new \\App\\Events\\SubscriptionExpired($this, $expiredSubscription));
        }
    }
    
    return $subscription ? true : false;
}</div>

            <h3>2ï¸âƒ£ Device Limit Check - GiriÅŸ SÄ±rasÄ±nda</h3>
            <div class="code-block">// Modules/Muzibu/app/Services/DeviceService.php
public function checkDeviceLimit(User $user): bool
{
    $limit = $this->getDeviceLimit($user);
    $activeCount = $this->getActiveDeviceCount($user);
    
    // Limit aÅŸÄ±ldÄ± mÄ±?
    if ($activeCount >= $limit) {
        // ğŸ‰ EVENT DISPATCH!
        event(new \\App\\Events\\DeviceLimitExceeded($user, $activeCount, $limit));
        
        // En eski cihazÄ± Ã§Ä±kar (opsiyonel - listener'da da yapÄ±labilir)
        $this->logoutOldestDevice($user);
        
        return false;
    }
    
    return true;
}</div>

            <h3>3ï¸âƒ£ Event Listener - Email & Bildirim</h3>
            <div class="code-block">// app/Listeners/SendTrialExpiredNotification.php
class SendTrialExpiredNotification
{
    public function handle(TrialExpired $event)
    {
        $user = $event->user;
        $subscription = $event->subscription;
        
        // 1. Email gÃ¶nder
        Mail::to($user-&gt;email)
            -&gt;send(new TrialExpiredMail($user));
        
        // 2. Push bildirim
        $user-&gt;notify(new TrialExpiredNotification());
        
        // 3. Log
        Log::info("Trial expired", [
            'user_id' =&gt; $user-&gt;id,
            'subscription_id' =&gt; $subscription-&gt;id,
        ]);
        
        // 4. Analytics
        Analytics::track('trial_expired', [
            'user_id' =&gt; $user-&gt;id,
        ]);
    }
}</div>

            <h3>4ï¸âƒ£ Cron Job - Yedek Temizlik (Hala Gerekli!)</h3>
            <div class="code-block">// app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    // YEDEK: Siteye hiÃ§ girmeyen kullanÄ±cÄ±lar iÃ§in toplu temizlik
    $schedule-&gt;call(function () {
        $expired = Subscription::where('status', 'active')
            -&gt;where('ends_at', '&lt;=', now())
            -&gt;get();
        
        foreach ($expired as $subscription) {
            $subscription-&gt;update(['status' =&gt; 'expired']);
            
            // ğŸ‰ EVENT DISPATCH!
            if ($subscription-&gt;plan-&gt;is_trial) {
                event(new TrialExpired($subscription-&gt;user, $subscription));
            } else {
                event(new SubscriptionExpired($subscription-&gt;user, $subscription));
            }
        }
        
        Log::info("Cron expired {$expired->count()} subscriptions");
    })-&gt;daily();
}</div>
        </div>

        <!-- KarÅŸÄ±laÅŸtÄ±rma -->
        <div class="section">
            <h2>ğŸ“Š Eski vs Yeni Sistem</h2>

            <div class="comparison">
                <div class="comp-card bad">
                    <h4 style="color: #ef4444;">âŒ Eski Sistem (DaÄŸÄ±nÄ±k)</h4>
                    <ul>
                        <li>Trial â†’ Cron job</li>
                        <li>Premium â†’ Lazy check</li>
                        <li>Device â†’ GiriÅŸ kontrolÃ¼</li>
                        <li>Payment â†’ Webhook</li>
                        <li><strong>Sorun:</strong> Her biri farklÄ±!</li>
                        <li><strong>Sorun:</strong> Email/bildirim mantÄ±ÄŸÄ± daÄŸÄ±nÄ±k</li>
                        <li><strong>Sorun:</strong> Log tutma manuel</li>
                    </ul>
                </div>

                <div class="comp-card good">
                    <h4 style="color: #10b981;">âœ… Yeni Sistem (Event-Based)</h4>
                    <ul>
                        <li>TÃ¼m kontroller â†’ Lazy check</li>
                        <li>Durum deÄŸiÅŸince â†’ Event dispatch</li>
                        <li>Event â†’ Listener'lar Ã§alÄ±ÅŸÄ±r</li>
                        <li>Email/bildirim â†’ Listener'da</li>
                        <li><strong>ArtÄ±:</strong> Ortak mantÄ±k!</li>
                        <li><strong>ArtÄ±:</strong> Kolay geniÅŸletme</li>
                        <li><strong>ArtÄ±:</strong> Test edilebilir</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Avantajlar -->
        <div class="section">
            <h2>ğŸ Event-Based Sistemin AvantajlarÄ±</h2>

            <div class="event-grid">
                <div class="event-card trial">
                    <h4 style="color: #10b981;">1. Ortak Dil</h4>
                    <p>TÃ¼m olaylar aynÄ± mantÄ±kla Ã§alÄ±ÅŸÄ±r: Lazy check â†’ Event â†’ Listeners</p>
                </div>

                <div class="event-card premium">
                    <h4 style="color: #3b82f6;">2. Kolay GeniÅŸletme</h4>
                    <p>Yeni listener ekle: Webhook, SMS, Analytics, vb.</p>
                </div>

                <div class="event-card device">
                    <h4 style="color: #f59e0b;">3. Test Edilebilir</h4>
                    <p>Event'larÄ± mock'layarak test et, gerÃ§ek email gÃ¶ndermeden</p>
                </div>

                <div class="event-card payment">
                    <h4 style="color: #8b5cf6;">4. Merkezi Log</h4>
                    <p>TÃ¼m olaylar aynÄ± listener'dan geÃ§er, tek yerden log</p>
                </div>

                <div class="event-card trial">
                    <h4 style="color: #ef4444;">5. Async Ä°ÅŸlem</h4>
                    <p>Event'larÄ± queue'ya at, arka planda iÅŸle (performans)</p>
                </div>

                <div class="event-card premium">
                    <h4 style="color: #10b981;">6. Cron BaÄŸÄ±msÄ±z</h4>
                    <p>Cron Ã§alÄ±ÅŸmasa bile lazy check devreye girer</p>
                </div>
            </div>
        </div>

        <!-- Event Listesi -->
        <div class="section">
            <h2>ğŸ“‹ TÃ¼m Event'lar</h2>

            <div class="code-block">// app/Events/TrialExpired.php
class TrialExpired
{
    public $user;
    public $subscription;
    
    public function __construct(User $user, Subscription $subscription)
    {
        $this-&gt;user = $user;
        $this-&gt;subscription = $subscription;
    }
}

// app/Events/SubscriptionExpired.php
class SubscriptionExpired { ... }

// app/Events/DeviceLimitExceeded.php
class DeviceLimitExceeded
{
    public $user;
    public $currentCount;
    public $limit;
}

// app/Events/PaymentFailed.php
class PaymentFailed { ... }

// app/Events/SubscriptionRenewed.php
class SubscriptionRenewed { ... }

// app/Events/SubscriptionCancelled.php
class SubscriptionCancelled { ... }

// app/Events/GracePeriodStarted.php
class GracePeriodStarted { ... }</div>
        </div>

        <!-- Listener Ã–rnekleri -->
        <div class="section">
            <h2>ğŸ§ Listener Ã–rnekleri</h2>

            <h3>Tek Event â†’ Ã‡oklu Listener</h3>
            <div class="code-block">// app/Providers/EventServiceProvider.php
protected $listen = [
    TrialExpired::class =&gt; [
        SendTrialExpiredEmail::class,        // Email gÃ¶nder
        SendTrialExpiredNotification::class, // Push bildirim
        LogTrialExpired::class,              // Log tut
        TrackTrialExpiredAnalytics::class,   // Analytics
        SendTrialExpiredWebhook::class,      // Webhook (opsiyonel)
    ],
    
    DeviceLimitExceeded::class =&gt; [
        LogoutOldestDevice::class,           // En eski cihazÄ± Ã§Ä±kar
        SendDeviceLimitNotification::class,  // Bildirim gÃ¶nder
        LogDeviceLimit::class,               // Log
    ],
    
    SubscriptionExpired::class =&gt; [
        SendSubscriptionExpiredEmail::class,
        UpdateUserPremiumStatus::class,      // Cache temizle
        LogSubscriptionExpired::class,
    ],
];</div>

            <div class="info-box">
                <strong style="color: #60a5fa; display: block; margin-bottom: 10px;">ğŸ’¡ Avantaj:</strong>
                <p>Yeni bir listener eklemek istersen? Sadece array'e ekle! Kod deÄŸiÅŸtirmeden.</p>
                <div class="code-block" style="margin-top: 15px;">// Yeni listener ekle
TrialExpired::class =&gt; [
    SendTrialExpiredEmail::class,
    SendTrialExpiredNotification::class,
    SendTrialExpiredSMS::class,  // ğŸ†• Yeni! SMS gÃ¶nder
];</div>
            </div>
        </div>

        <!-- Son Karar -->
        <div class="section">
            <h2>âœ… SON KARAR - Ortak Sistem</h2>

            <div class="winner">
                <h3>ğŸ¯ Event-Based System FTW!</h3>
                <div style="text-align: left; max-width: 800px; margin: 20px auto 0;">
                    <h4 style="color: #fbbf24; margin-bottom: 15px;">ğŸ“œ Prensip:</h4>
                    <ol style="padding-left: 25px;">
                        <li style="margin: 10px 0;"><strong>Lazy Check:</strong> TÃ¼m kontroller kullanÄ±lÄ±rken (isPremium, checkDeviceLimit)</li>
                        <li style="margin: 10px 0;"><strong>Event Dispatch:</strong> Durum deÄŸiÅŸince event fÄ±rlat</li>
                        <li style="margin: 10px 0;"><strong>Listeners:</strong> Email, bildirim, log, analytics</li>
                        <li style="margin: 10px 0;"><strong>Cron (Yedek):</strong> Siteye girmeyen kullanÄ±cÄ±lar iÃ§in toplu temizlik</li>
                    </ol>

                    <h4 style="color: #fbbf24; margin: 25px 0 15px;">ğŸ SonuÃ§:</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;">âœ… Ortak dil (tÃ¼m olaylar aynÄ± mantÄ±k)</li>
                        <li style="margin: 10px 0;">âœ… Cron baÄŸÄ±msÄ±z (Ã§alÄ±ÅŸmasa da sorun yok)</li>
                        <li style="margin: 10px 0;">âœ… Kolay geniÅŸletme (yeni listener ekle)</li>
                        <li style="margin: 10px 0;">âœ… Test edilebilir (event mock'la)</li>
                        <li style="margin: 10px 0;">âœ… Merkezi log (tek yerden izle)</li>
                        <li style="margin: 10px 0;">âœ… Async iÅŸlem (queue kullan)</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer>
            ğŸ¤– Claude AI | ğŸ“… 2025-12-04 | ğŸ¯ Subscription Event System - Ortak Dil
        </footer>
    </div>
</body>
</html>
