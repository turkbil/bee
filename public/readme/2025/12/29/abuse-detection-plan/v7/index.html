<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abuse Detection - Visual Timeline (v7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e1b4b 100%); }
        .card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); }

        /* Timeline Container */
        .timeline-container {
            position: relative;
            overflow-x: auto;
            padding: 20px 0;
        }

        /* Time ruler */
        .time-ruler {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 10;
        }
        .time-mark {
            flex-shrink: 0;
            text-align: center;
            color: #64748b;
            font-size: 11px;
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 5px 0;
        }

        /* Device lanes */
        .device-lane {
            position: relative;
            height: 50px;
            margin: 5px 0;
            border-radius: 8px;
        }
        .lane-desktop { background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; }
        .lane-mobile { background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; }

        .lane-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
            z-index: 5;
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Song bars */
        .song-bar {
            position: absolute;
            height: 36px;
            top: 7px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .song-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 20 !important;
        }
        .song-bar.desktop { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .song-bar.mobile { background: linear-gradient(135deg, #10b981, #059669); }
        .song-bar.overlap {
            animation: pulse-overlap 1s infinite;
            border: 2px solid #ef4444;
        }

        @keyframes pulse-overlap {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        /* Overlap indicator */
        .overlap-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.15);
            border-left: 2px dashed #ef4444;
            border-right: 2px dashed #ef4444;
            z-index: 1;
        }

        /* Tooltip */
        .song-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .song-bar:hover .song-tooltip { display: block; }

        /* Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Header -->
    <header class="border-b border-white/10 py-6">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <span class="px-3 py-1 bg-red-500/20 text-red-400 text-xs font-bold rounded-full border border-red-500/30">
                        <i class="fas fa-chart-line mr-1"></i> VISUAL TIMELINE v7
                    </span>
                    <h1 class="text-3xl font-bold mt-3 bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">
                        User #1 - Gorsel Zaman Cizelgesi
                    </h1>
                    <p class="text-gray-400 mt-1">22-29 Aralik 2025 | Cakismalari Gorsel Olarak Incele</p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                        <span class="text-sm">Desktop</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: linear-gradient(135deg, #10b981, #059669);"></div>
                        <span class="text-sm">Mobile</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ef4444; animation: pulse-overlap 1s infinite;"></div>
                        <span class="text-sm">Cakisma!</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Summary -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-summary"></div>
    </div>

    <!-- Day Selector -->
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex gap-2 flex-wrap" id="day-selector"></div>
    </div>

    <!-- Visual Timeline -->
    <div class="max-w-7xl mx-auto px-4 py-6" id="timeline-view"></div>

    <!-- Overlap Details -->
    <div class="max-w-7xl mx-auto px-4 py-6" id="overlap-details"></div>

    <!-- Footer -->
    <footer class="border-t border-white/10 py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>Muzibu B2B - Abuse Detection Visual Timeline | v7.0</p>
        </div>
    </footer>

    <script>
    // =================================================================
    // RAW DATA
    // =================================================================
    const rawPlayData = [
        {"id":368,"song_id":344,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 20:46:59"},
        {"id":369,"song_id":351,"title":"Don't You Worry","duration":190,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 20:48:27"},
        {"id":370,"song_id":460,"title":"Bulk Upload Test 3","duration":175,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 20:51:35"},
        {"id":371,"song_id":459,"title":"Bulk Upload Test 2","duration":175,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 21:50:05"},
        {"id":372,"song_id":348,"title":"DAYDREAMING","duration":148,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 21:52:52"},
        {"id":373,"song_id":457,"title":"Test Upload","duration":175,"ip":"92.44.171.31","device":"desktop","time":"2025-12-22 23:15:52"},
        {"id":402,"song_id":479,"title":"Go","duration":189,"ip":"92.44.171.31","device":"desktop","time":"2025-12-25 02:02:35"},
        {"id":403,"song_id":464,"title":"Yalniz Kurt","duration":175,"ip":"92.44.171.31","device":"desktop","time":"2025-12-25 02:03:10"},
        {"id":412,"song_id":314,"title":"A Bar Song","duration":210,"ip":"92.44.171.31","device":"desktop","time":"2025-12-25 04:35:33"},
        {"id":413,"song_id":479,"title":"Go","duration":189,"ip":"92.44.171.31","device":"desktop","time":"2025-12-25 04:37:41"},
        {"id":430,"song_id":314,"title":"A Bar Song","duration":210,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 00:24:32"},
        {"id":431,"song_id":369,"title":"GOD","duration":142,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 00:25:43"},
        {"id":432,"song_id":314,"title":"A Bar Song","duration":210,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 00:26:08"},
        {"id":433,"song_id":314,"title":"A Bar Song","duration":210,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 00:27:07"},
        {"id":434,"song_id":320,"title":"All Night Long","duration":120,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 00:27:57"},
        {"id":445,"song_id":401,"title":"Punchin Bag","duration":200,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:40:55"},
        {"id":446,"song_id":401,"title":"Punchin Bag","duration":200,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:41:26"},
        {"id":448,"song_id":395,"title":"Off We Go","duration":132,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:46:39"},
        {"id":449,"song_id":395,"title":"Off We Go","duration":132,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:47:10"},
        {"id":450,"song_id":471,"title":"ALMA","duration":124,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:48:46"},
        {"id":451,"song_id":374,"title":"How Will I Know","duration":159,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:49:03"},
        {"id":452,"song_id":479,"title":"Go","duration":189,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:49:40"},
        {"id":453,"song_id":479,"title":"Go","duration":189,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 04:50:11"},
        {"id":494,"song_id":401,"title":"Punchin Bag","duration":200,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 15:12:10"},
        {"id":495,"song_id":347,"title":"Dark Days","duration":138,"ip":"92.44.171.31","device":"desktop","time":"2025-12-26 15:12:18"},
        {"id":523,"song_id":476,"title":"Gestures","duration":179,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 03:41:30"},
        {"id":524,"song_id":476,"title":"Gestures","duration":179,"ip":"92.44.171.31","device":"mobile","time":"2025-12-27 04:16:28"},
        {"id":525,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"mobile","time":"2025-12-27 04:18:22"},
        {"id":531,"song_id":468,"title":"All Again","duration":146,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:42:27"},
        {"id":532,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:43:09"},
        {"id":533,"song_id":463,"title":"Saksidaki Cicekler","duration":157,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:43:53"},
        {"id":534,"song_id":465,"title":"Kar Tanesi","duration":146,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:46:24"},
        {"id":535,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:47:23"},
        {"id":536,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-27 05:49:28"},
        {"id":571,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:43:27"},
        {"id":572,"song_id":466,"title":"After Hours","duration":167,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:44:08"},
        {"id":573,"song_id":479,"title":"Go","duration":189,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:45:42"},
        {"id":574,"song_id":465,"title":"Kar Tanesi","duration":146,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:53:48"},
        {"id":575,"song_id":466,"title":"After Hours","duration":167,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:54:16"},
        {"id":576,"song_id":466,"title":"After Hours","duration":167,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:55:02"},
        {"id":577,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:55:24"},
        {"id":578,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"desktop","time":"2025-12-28 00:56:56"},
        {"id":581,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"mobile","time":"2025-12-28 02:36:14"},
        {"id":582,"song_id":463,"title":"Saksidaki Cicekler","duration":157,"ip":"92.44.171.31","device":"mobile","time":"2025-12-28 02:36:58"},
        {"id":607,"song_id":469,"title":"All Night Long","duration":120,"ip":"92.44.171.31","device":"mobile","time":"2025-12-28 04:45:42"},
        {"id":608,"song_id":466,"title":"After Hours","duration":167,"ip":"92.44.171.31","device":"mobile","time":"2025-12-28 04:45:53"},
        {"id":609,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"mobile","time":"2025-12-28 04:46:43"},
        {"id":640,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 15:52:42"},
        {"id":641,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 15:55:49"},
        {"id":642,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 15:56:53"},
        {"id":643,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 15:58:59"},
        {"id":644,"song_id":463,"title":"Saksidaki Cicekler","duration":157,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:01:02"},
        {"id":645,"song_id":463,"title":"Saksidaki Cicekler","duration":157,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:03:54"},
        {"id":646,"song_id":465,"title":"Kar Tanesi","duration":146,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:04:27"},
        {"id":653,"song_id":464,"title":"Yalniz Kurt","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:17:26"},
        {"id":654,"song_id":464,"title":"Yalniz Kurt","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:19:27"},
        {"id":655,"song_id":464,"title":"Yalniz Kurt","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:21:13"},
        {"id":656,"song_id":465,"title":"Kar Tanesi","duration":146,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 16:21:35"},
        {"id":657,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 16:22:04"},
        {"id":671,"song_id":470,"title":"You Are Not a Soldier","duration":203,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:00:57"},
        {"id":672,"song_id":472,"title":"ALONE","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:02:41"},
        {"id":673,"song_id":473,"title":"Amen","duration":157,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:05:36"},
        {"id":674,"song_id":474,"title":"Angels","duration":148,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:08:14"},
        {"id":675,"song_id":475,"title":"ASHES & BLOOM","duration":160,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:10:11"},
        {"id":676,"song_id":476,"title":"Gestures","duration":179,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:12:43"},
        {"id":677,"song_id":477,"title":"Give Me the Power","duration":156,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:15:41"},
        {"id":678,"song_id":477,"title":"Give Me the Power","duration":156,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 17:18:09"},
        {"id":679,"song_id":478,"title":"Give the People","duration":131,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:18:20"},
        {"id":680,"song_id":462,"title":"Cold Love","duration":123,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:20:28"},
        {"id":681,"song_id":464,"title":"Yalniz Kurt","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:22:31"},
        {"id":682,"song_id":466,"title":"After Hours","duration":167,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:25:26"},
        {"id":683,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:28:14"},
        {"id":684,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 17:34:21"},
        {"id":685,"song_id":468,"title":"All Again","duration":146,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:43:18"},
        {"id":686,"song_id":469,"title":"All Night Long","duration":120,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:45:45"},
        {"id":687,"song_id":470,"title":"You Are Not a Soldier","duration":203,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:47:46"},
        {"id":688,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 17:49:18"},
        {"id":689,"song_id":471,"title":"ALMA","duration":124,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:51:08"},
        {"id":690,"song_id":472,"title":"ALONE","duration":175,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 17:53:13"},
        {"id":691,"song_id":467,"title":"Afterimage","duration":192,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 17:54:12"},
        {"id":692,"song_id":319,"title":"All Again","duration":146,"ip":"92.44.171.31","device":"desktop","time":"2025-12-29 18:04:44"},
        {"id":693,"song_id":474,"title":"Angels","duration":148,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 18:07:26"},
        {"id":694,"song_id":475,"title":"ASHES & BLOOM","duration":160,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 18:08:31"},
        {"id":695,"song_id":476,"title":"Gestures","duration":179,"ip":"92.44.171.31","device":"mobile","time":"2025-12-29 18:11:13"}
    ];

    // =================================================================
    // HELPER FUNCTIONS
    // =================================================================
    function parseTime(timeStr) {
        return new Date(timeStr.replace(' ', 'T'));
    }

    function getDate(timeStr) {
        return timeStr.split(' ')[0];
    }

    function getTimeSeconds(timeStr) {
        const timePart = timeStr.split(' ')[1];
        const [h, m, s] = timePart.split(':').map(Number);
        return h * 3600 + m * 60 + s;
    }

    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    function formatDuration(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // Group plays by date
    function groupByDate(plays) {
        const groups = {};
        plays.forEach(p => {
            const date = getDate(p.time);
            if (!groups[date]) groups[date] = [];
            groups[date].push(p);
        });
        return groups;
    }

    // Detect overlaps
    function detectOverlaps(plays) {
        const overlaps = [];
        for (let i = 0; i < plays.length - 1; i++) {
            const p1 = plays[i];
            const p2 = plays[i + 1];

            const p1Start = parseTime(p1.time);
            const p1End = new Date(p1Start.getTime() + p1.duration * 1000);
            const p2Start = parseTime(p2.time);

            if (p1End > p2Start && p1.device !== p2.device) {
                const overlapSec = Math.floor((p1End - p2Start) / 1000);
                overlaps.push({
                    play1: p1,
                    play2: p2,
                    seconds: overlapSec,
                    severity: overlapSec > 60 ? 'high' : overlapSec > 30 ? 'medium' : 'low'
                });
            }
        }
        return overlaps;
    }

    // =================================================================
    // RENDER FUNCTIONS
    // =================================================================
    let selectedDate = null;
    const groupedPlays = groupByDate(rawPlayData);
    const allOverlaps = detectOverlaps(rawPlayData);

    function renderStats() {
        const totalPlays = rawPlayData.length;
        const concurrentOverlaps = allOverlaps.length;
        const totalAbuseScore = allOverlaps.reduce((s, o) => s + o.seconds, 0);
        const uniqueDays = Object.keys(groupedPlays).length;

        document.getElementById('stats-summary').innerHTML = `
            <div class="card rounded-xl p-4 border border-white/10 text-center">
                <div class="text-3xl font-bold text-blue-400">${totalPlays}</div>
                <div class="text-sm text-gray-400">Toplam Play</div>
            </div>
            <div class="card rounded-xl p-4 border border-white/10 text-center">
                <div class="text-3xl font-bold text-purple-400">${uniqueDays}</div>
                <div class="text-sm text-gray-400">Aktif Gun</div>
            </div>
            <div class="card rounded-xl p-4 border border-white/10 text-center">
                <div class="text-3xl font-bold text-yellow-400">${concurrentOverlaps}</div>
                <div class="text-sm text-gray-400">Es Zamanli Cakisma</div>
            </div>
            <div class="card rounded-xl p-4 border border-red-500/30 text-center ${totalAbuseScore > 100 ? 'bg-red-500/10' : ''}">
                <div class="text-3xl font-bold text-red-400">${totalAbuseScore}s</div>
                <div class="text-sm text-gray-400">Abuse Score</div>
            </div>
        `;
    }

    function renderDaySelector() {
        const dates = Object.keys(groupedPlays).sort().reverse();
        selectedDate = dates[0]; // Default to most recent

        let html = '';
        dates.forEach(date => {
            const dayOverlaps = allOverlaps.filter(o => getDate(o.play1.time) === date);
            const hasOverlap = dayOverlaps.length > 0;

            html += `
                <button onclick="selectDate('${date}')"
                    class="day-btn px-4 py-2 rounded-lg text-sm font-medium transition-all
                    ${hasOverlap ? 'border-red-500/50' : 'border-white/10'} border
                    hover:bg-white/10"
                    data-date="${date}">
                    ${date.split('-').slice(1).join('/')}
                    ${hasOverlap ? '<span class="ml-1 text-red-400"><i class="fas fa-exclamation-circle"></i></span>' : ''}
                </button>
            `;
        });
        document.getElementById('day-selector').innerHTML = html;
        updateDayButtons();
    }

    function selectDate(date) {
        selectedDate = date;
        updateDayButtons();
        renderTimeline();
        renderOverlapDetails();
    }

    function updateDayButtons() {
        document.querySelectorAll('.day-btn').forEach(btn => {
            if (btn.dataset.date === selectedDate) {
                btn.classList.add('bg-blue-500/30', 'border-blue-500');
                btn.classList.remove('bg-transparent');
            } else {
                btn.classList.remove('bg-blue-500/30', 'border-blue-500');
                btn.classList.add('bg-transparent');
            }
        });
    }

    function renderTimeline() {
        const plays = groupedPlays[selectedDate] || [];
        if (plays.length === 0) {
            document.getElementById('timeline-view').innerHTML = '<p class="text-gray-500">Bu gun icin veri yok.</p>';
            return;
        }

        // Find time range
        const times = plays.map(p => getTimeSeconds(p.time));
        const endTimes = plays.map(p => getTimeSeconds(p.time) + p.duration);
        const minTime = Math.floor(Math.min(...times) / 3600) * 3600; // Round to hour
        const maxTime = Math.ceil(Math.max(...endTimes) / 3600) * 3600;
        const totalSeconds = maxTime - minTime;

        // Pixel per second (timeline width)
        const timelineWidth = Math.max(1200, totalSeconds / 2); // At least 1200px, or 2px per second
        const pxPerSecond = timelineWidth / totalSeconds;

        // Get overlaps for this day
        const dayOverlaps = allOverlaps.filter(o => getDate(o.play1.time) === selectedDate);
        const overlapPlayIds = new Set();
        dayOverlaps.forEach(o => {
            overlapPlayIds.add(o.play1.id);
            overlapPlayIds.add(o.play2.id);
        });

        // Separate by device
        const desktopPlays = plays.filter(p => p.device === 'desktop');
        const mobilePlays = plays.filter(p => p.device === 'mobile');

        // Build time ruler
        let rulerHtml = '';
        for (let t = minTime; t <= maxTime; t += 1800) { // Every 30 min
            const left = (t - minTime) * pxPerSecond;
            rulerHtml += `<div class="time-mark" style="width: ${1800 * pxPerSecond}px;">${formatTime(t)}</div>`;
        }

        // Build overlap zones
        let overlapZonesHtml = '';
        dayOverlaps.forEach(o => {
            const p1Start = getTimeSeconds(o.play1.time);
            const p2Start = getTimeSeconds(o.play2.time);
            const p1End = p1Start + o.play1.duration;

            const left = (p2Start - minTime) * pxPerSecond;
            const width = o.seconds * pxPerSecond;

            overlapZonesHtml += `<div class="overlap-zone" style="left: ${left + 80}px; width: ${width}px;" title="Cakisma: ${o.seconds}s"></div>`;
        });

        // Build song bars
        function buildBars(playsArr, device) {
            let html = '';
            playsArr.forEach((p, idx) => {
                const startSec = getTimeSeconds(p.time);
                const left = (startSec - minTime) * pxPerSecond + 80; // 80px for label
                const width = Math.max(p.duration * pxPerSecond, 60); // Min 60px width
                const isOverlap = overlapPlayIds.has(p.id);
                const zIndex = isOverlap ? 15 : 10 - idx;

                html += `
                    <div class="song-bar ${device} ${isOverlap ? 'overlap' : ''}"
                         style="left: ${left}px; width: ${width}px; z-index: ${zIndex};">
                        <span class="truncate">${p.title}</span>
                        <div class="song-tooltip">
                            <div class="font-bold">${p.title}</div>
                            <div class="text-gray-400">#${p.id} | ${formatDuration(p.duration)}</div>
                            <div class="text-gray-400">${p.time.split(' ')[1]}</div>
                            ${isOverlap ? '<div class="text-red-400 font-bold mt-1"><i class="fas fa-exclamation-triangle"></i> CAKISMA!</div>' : ''}
                        </div>
                    </div>
                `;
            });
            return html;
        }

        const html = `
            <div class="card rounded-xl border border-white/10 overflow-hidden">
                <div class="p-4 border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-purple-500/10">
                    <h3 class="text-xl font-bold"><i class="fas fa-calendar-day mr-2"></i>${selectedDate}</h3>
                    <p class="text-gray-400 text-sm">${plays.length} play | Desktop: ${desktopPlays.length} | Mobile: ${mobilePlays.length}</p>
                </div>
                <div class="timeline-container p-4" style="min-height: 200px;">
                    <div style="width: ${timelineWidth + 100}px; position: relative;">
                        <!-- Time Ruler -->
                        <div class="time-ruler" style="margin-left: 80px;">
                            ${rulerHtml}
                        </div>

                        <!-- Overlap Zones (background) -->
                        <div style="position: relative; height: 120px;">
                            ${overlapZonesHtml}

                            <!-- Desktop Lane -->
                            <div class="device-lane lane-desktop">
                                <span class="lane-label bg-blue-500/30 text-blue-400"><i class="fas fa-desktop mr-1"></i>Desktop</span>
                                ${buildBars(desktopPlays, 'desktop')}
                            </div>

                            <!-- Mobile Lane -->
                            <div class="device-lane lane-mobile" style="margin-top: 10px;">
                                <span class="lane-label bg-green-500/30 text-green-400"><i class="fas fa-mobile-alt mr-1"></i>Mobile</span>
                                ${buildBars(mobilePlays, 'mobile')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('timeline-view').innerHTML = html;
    }

    function renderOverlapDetails() {
        const dayOverlaps = allOverlaps.filter(o => getDate(o.play1.time) === selectedDate);

        if (dayOverlaps.length === 0) {
            document.getElementById('overlap-details').innerHTML = `
                <div class="card rounded-xl p-6 border border-green-500/30 bg-green-500/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-check-circle text-3xl text-green-400"></i>
                        <div>
                            <h3 class="text-lg font-bold text-green-400">Bu Gunde Cakisma Yok</h3>
                            <p class="text-gray-400">Farkli cihazlarda es zamanli dinleme tespit edilmedi.</p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        let html = `
            <div class="card rounded-xl border border-red-500/30 overflow-hidden">
                <div class="p-4 bg-red-500/10 border-b border-red-500/30">
                    <h3 class="text-lg font-bold text-red-400">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ${dayOverlaps.length} Es Zamanli Cakisma Tespit Edildi
                    </h3>
                </div>
                <div class="p-4 space-y-4">
        `;

        dayOverlaps.forEach((o, idx) => {
            const severityColor = o.severity === 'high' ? 'red' : o.severity === 'medium' ? 'yellow' : 'green';
            const p1Time = o.play1.time.split(' ')[1];
            const p2Time = o.play2.time.split(' ')[1];

            html += `
                <div class="bg-slate-800/50 rounded-xl p-4 border-l-4 border-${severityColor}-500">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-3 py-1 bg-${severityColor}-500/20 text-${severityColor}-400 rounded-full text-sm font-bold">
                            Cakisma #${idx + 1} - ${o.seconds} saniye
                        </span>
                        <span class="text-gray-500 text-sm">${o.severity.toUpperCase()} SEVERITY</span>
                    </div>

                    <!-- Visual overlap bar -->
                    <div class="relative h-16 bg-slate-900/50 rounded-lg overflow-hidden mb-3">
                        <div class="absolute top-2 left-0 right-0 h-5 bg-blue-500/30 rounded"
                             style="left: 0; width: ${(o.play1.duration / (o.play1.duration + 30)) * 100}%;">
                            <span class="absolute left-2 text-xs text-blue-400 truncate" style="max-width: 90%;">
                                <i class="fas fa-desktop mr-1"></i>${o.play1.title}
                            </span>
                        </div>
                        <div class="absolute top-9 h-5 bg-green-500/30 rounded"
                             style="left: ${((o.play1.duration - o.seconds) / (o.play1.duration + 30)) * 100}%; width: ${(o.play2.duration / (o.play1.duration + 30)) * 100}%;">
                            <span class="absolute left-2 text-xs text-green-400 truncate" style="max-width: 90%;">
                                <i class="fas fa-mobile-alt mr-1"></i>${o.play2.title}
                            </span>
                        </div>
                        <!-- Overlap highlight -->
                        <div class="absolute top-0 bottom-0 bg-red-500/20 border-l-2 border-r-2 border-red-500"
                             style="left: ${((o.play1.duration - o.seconds) / (o.play1.duration + 30)) * 100}%; width: ${(o.seconds / (o.play1.duration + 30)) * 100}%;">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-blue-500/10 rounded-lg p-3">
                            <div class="text-blue-400 font-bold mb-1"><i class="fas fa-desktop mr-1"></i>Desktop</div>
                            <div class="text-white">${o.play1.title}</div>
                            <div class="text-gray-400 text-xs">${p1Time} | ${formatDuration(o.play1.duration)}</div>
                        </div>
                        <div class="bg-green-500/10 rounded-lg p-3">
                            <div class="text-green-400 font-bold mb-1"><i class="fas fa-mobile-alt mr-1"></i>Mobile</div>
                            <div class="text-white">${o.play2.title}</div>
                            <div class="text-gray-400 text-xs">${p2Time} | ${formatDuration(o.play2.duration)}</div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div></div>';
        document.getElementById('overlap-details').innerHTML = html;
    }

    // =================================================================
    // INIT
    // =================================================================
    document.addEventListener('DOMContentLoaded', () => {
        renderStats();
        renderDaySelector();
        renderTimeline();
        renderOverlapDetails();
    });
    </script>
</body>
</html>
