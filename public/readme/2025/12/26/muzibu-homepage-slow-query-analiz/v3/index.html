<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muzibu Performans Optimizasyonu - KapsamlÄ± Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold">PLAN v3</span>
                <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">KapsamlÄ± Optimizasyon</span>
            </div>
            <h1 class="text-3xl font-bold mb-2">Muzibu Ana Sayfa Performans Optimizasyonu</h1>
            <p class="text-slate-400">2864ms â†’ ~400ms hedefi</p>
            <p class="text-slate-500 text-sm">26 AralÄ±k 2025 - v3 (Dinamik gÃ¼ncellemeler dahil)</p>
        </header>

        <!-- Ã–zet -->
        <div class="bg-purple-900/20 border border-purple-700 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-purple-400 mb-4">ğŸ“Š Optimizasyon Ã–zeti</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-800 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-400">284</div>
                    <div class="text-slate-400 text-sm">Mevcut Query</div>
                </div>
                <div class="bg-slate-800 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-400">~30</div>
                    <div class="text-slate-400 text-sm">Hedef Query</div>
                </div>
                <div class="bg-slate-800 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-400">2864ms</div>
                    <div class="text-slate-400 text-sm">Mevcut SÃ¼re</div>
                </div>
                <div class="bg-slate-800 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-400">~400ms</div>
                    <div class="text-slate-400 text-sm">Hedef SÃ¼re</div>
                </div>
            </div>
        </div>

        <!-- BÃ–LÃœM 1: Favorites N+1 -->
        <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-6 mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">P1</span>
                <h2 class="text-xl font-bold text-blue-400">Favorites N+1 Ã‡Ã¶zÃ¼mÃ¼</h2>
                <span class="text-slate-500 text-sm">(174 query â†’ 1 query)</span>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-4">
                <div class="bg-green-900/20 border border-green-800 rounded p-4">
                    <h3 class="font-semibold text-green-400 mb-2">ğŸ“ Basit AnlatÄ±m</h3>
                    <p class="text-slate-300 text-sm">
                        Åu anda her ÅŸarkÄ± kartÄ± iÃ§in "Bu favorilerde mi?" diye ayrÄ± ayrÄ±
                        soruyoruz. Bunun yerine sayfa aÃ§Ä±lÄ±rken tÃ¼m favorileri tek seferde
                        Ã§ekip JavaScript'e vereceÄŸiz. KullanÄ±cÄ± favori eklerse anÄ±nda
                        gÃ¼ncellenir, sayfa yenilemeye gerek kalmaz.
                    </p>
                </div>
                <div class="bg-slate-800 rounded p-4">
                    <h3 class="font-semibold text-white mb-2">ğŸ”§ Teknik Ã–zet</h3>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <li>â€¢ FavoriteService: Tek query ile tÃ¼m favorite ID'ler</li>
                        <li>â€¢ Layout'ta window.userFavorites inject</li>
                        <li>â€¢ favorites.js: Server data ile init (API call yok)</li>
                        <li>â€¢ Blade'deki isFavoritedBy() kaldÄ±rÄ±lacak</li>
                    </ul>
                </div>
            </div>

            <div class="text-slate-400 text-sm">
                <strong>KazanÃ§:</strong> ~80ms, 173 query azalma
            </div>
        </div>

        <!-- BÃ–LÃœM 2: songs_count + total_duration Cache -->
        <div class="bg-orange-900/20 border border-orange-800 rounded-lg p-6 mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-orange-600 text-white px-2 py-1 rounded text-xs font-bold">P2</span>
                <h2 class="text-xl font-bold text-orange-400">songs_count + total_duration Cache</h2>
                <span class="text-slate-500 text-sm">(Subquery â†’ Cached Field)</span>
            </div>

            <!-- Basit AnlatÄ±m -->
            <div class="bg-green-900/20 border border-green-800 rounded p-4 mb-6">
                <h3 class="font-semibold text-green-400 mb-2">ğŸ“ Basit AnlatÄ±m (Herkes Ä°Ã§in)</h3>
                <p class="text-slate-300 text-sm mb-3">
                    Åu anda her playlist/albÃ¼m iÃ§in "KaÃ§ ÅŸarkÄ± var? Toplam sÃ¼re ne?" diye
                    ayrÄ± ayrÄ± hesaplÄ±yoruz. Bu Ã§ok yavaÅŸ. Bunun yerine bu bilgiyi
                    <strong>Ã¶nceden hesaplayÄ±p saklayacaÄŸÄ±z</strong>.
                </p>
                <div class="bg-slate-800 rounded p-3 text-sm">
                    <p class="text-slate-300">
                        <strong>Ã–rnek:</strong> Bir playlist'te 50 ÅŸarkÄ± var. Her seferinde
                        saymak yerine, tabloya "songs_count: 50, total_duration: 10800" yazacaÄŸÄ±z.
                        Yeni ÅŸarkÄ± eklenince bu sayÄ±larÄ± otomatik gÃ¼ncelleyeceÄŸiz.
                    </p>
                </div>
            </div>

            <!-- Teknik Plan -->
            <div class="bg-slate-800 rounded p-4 mb-6">
                <h3 class="font-semibold text-white mb-3">ğŸ”§ Teknik Plan</h3>

                <!-- AdÄ±m 1: Migration -->
                <div class="border-l-4 border-orange-500 pl-4 mb-4">
                    <h4 class="font-semibold text-orange-400 mb-2">1. Migration (Tenant Only)</h4>
                    <p class="text-slate-400 text-sm mb-2">database/migrations/tenant/</p>
                    <div class="bg-slate-900 rounded p-3 text-sm font-mono">
                        <p class="text-yellow-300">// muzibu_playlists tablosu</p>
                        <p class="text-slate-300">$table->unsignedInteger('songs_count')->nullable();</p>
                        <p class="text-slate-300">$table->unsignedInteger('total_duration')->nullable();</p>
                        <p class="text-slate-500 mt-2">// NULL = henÃ¼z hesaplanmamÄ±ÅŸ (eski veri)</p>
                        <p class="text-slate-500">// 0 = hesaplandÄ±, gerÃ§ekten 0</p>
                    </div>
                    <p class="text-slate-400 text-sm mt-2">
                        <strong>Not:</strong> Central'a eklemeye gerek yok Ã§Ã¼nkÃ¼
                        muzibu_playlists/albums sadece tenant DB'de.
                    </p>
                </div>

                <!-- AdÄ±m 2: Model Accessor -->
                <div class="border-l-4 border-orange-500 pl-4 mb-4">
                    <h4 class="font-semibold text-orange-400 mb-2">2. Model Accessor (Lazy Calculation)</h4>
                    <p class="text-slate-400 text-sm mb-2">Playlist.php, Album.php</p>
                    <div class="bg-slate-900 rounded p-3 text-sm font-mono">
                        <p class="text-green-300">// getSongsCountAttribute()</p>
                        <p class="text-slate-300">if ($this->attributes['songs_count'] === null) {</p>
                        <p class="text-slate-300 pl-4">$count = $this->songs()->count();</p>
                        <p class="text-slate-300 pl-4">$this->updateQuietly(['songs_count' => $count]);</p>
                        <p class="text-slate-300 pl-4">return $count;</p>
                        <p class="text-slate-300">}</p>
                        <p class="text-slate-300">return $this->attributes['songs_count'];</p>
                    </div>
                    <p class="text-slate-400 text-sm mt-2">
                        <strong>NasÄ±l Ã§alÄ±ÅŸÄ±r:</strong> Ä°lk Ã§ekildiÄŸinde null ise hesaplar ve DB'ye yazar.
                        Sonraki isteklerde direkt DB'den okur (query yok).
                    </p>
                </div>

                <!-- AdÄ±m 3: Observer -->
                <div class="border-l-4 border-orange-500 pl-4 mb-4">
                    <h4 class="font-semibold text-orange-400 mb-2">3. Song Observer (Otomatik GÃ¼ncelleme)</h4>
                    <p class="text-slate-400 text-sm mb-2">Modules/Muzibu/app/Observers/SongObserver.php</p>
                    <div class="bg-slate-900 rounded p-3 text-sm">
                        <table class="w-full text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="py-1 text-yellow-300">created()</td>
                                <td class="py-1">â†’ Album songs_count++, total_duration += duration</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-1 text-yellow-300">deleted()</td>
                                <td class="py-1">â†’ Album songs_count--, total_duration -= duration</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-1 text-yellow-300">updated()</td>
                                <td class="py-1">â†’ duration deÄŸiÅŸtiyse total_duration gÃ¼ncelle</td>
                            </tr>
                            <tr>
                                <td class="py-1 text-yellow-300">restored()</td>
                                <td class="py-1">â†’ Soft delete'den geri gelirse ekle</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- AdÄ±m 4: Pivot Observer -->
                <div class="border-l-4 border-orange-500 pl-4 mb-4">
                    <h4 class="font-semibold text-orange-400 mb-2">4. Playlist Pivot Observer</h4>
                    <p class="text-slate-400 text-sm mb-2">Playlist-Song pivot tablosu iÃ§in</p>
                    <div class="bg-slate-900 rounded p-3 text-sm">
                        <table class="w-full text-slate-300">
                            <tr class="border-b border-slate-700">
                                <td class="py-1 text-yellow-300">attach()</td>
                                <td class="py-1">â†’ Playlist songs_count++, total_duration += song.duration</td>
                            </tr>
                            <tr>
                                <td class="py-1 text-yellow-300">detach()</td>
                                <td class="py-1">â†’ Playlist songs_count--, total_duration -= song.duration</td>
                            </tr>
                        </table>
                    </div>
                    <p class="text-slate-400 text-sm mt-2">
                        <strong>Not:</strong> Playlist many-to-many iliÅŸkisi olduÄŸu iÃ§in
                        pivot event'lerini yakalamalÄ±yÄ±z.
                    </p>
                </div>

                <!-- AdÄ±m 5: Artisan Command -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h4 class="font-semibold text-green-400 mb-2">5. Artisan Recalculate Command</h4>
                    <p class="text-slate-400 text-sm mb-2">Ä°lk Ã§alÄ±ÅŸtÄ±rma + eski veri fix</p>
                    <div class="bg-slate-900 rounded p-3 text-sm font-mono">
                        <p class="text-green-300">php artisan muzibu:recalculate-counts</p>
                        <p class="text-slate-500 mt-2">// TÃ¼m playlist ve album'leri tarar</p>
                        <p class="text-slate-500">// songs_count ve total_duration hesaplar</p>
                        <p class="text-slate-500">// Progress bar ile gÃ¶sterir</p>
                    </div>
                    <p class="text-slate-400 text-sm mt-2">
                        <strong>Ne zaman kullanÄ±lÄ±r:</strong>
                        <br>â€¢ Eski DB'den veri import edilince
                        <br>â€¢ Manuel dÃ¼zeltme gerekince
                        <br>â€¢ TutarsÄ±zlÄ±k tespit edilince
                    </p>
                </div>
            </div>

            <!-- Dinamik Senaryo -->
            <div class="bg-purple-900/20 border border-purple-800 rounded p-4 mb-4">
                <h3 class="font-semibold text-purple-400 mb-3">ğŸ”„ Dinamik GÃ¼ncellemeler (Senin SorduÄŸun)</h3>

                <div class="space-y-4">
                    <div class="bg-slate-800 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">Senaryo 1: Yeni ÅŸarkÄ± yÃ¼kleniyor</h4>
                        <ol class="text-slate-300 text-sm space-y-1">
                            <li>1. Admin panelden ÅŸarkÄ± yÃ¼klenir â†’ Song::create()</li>
                            <li>2. SongObserver::created() tetiklenir</li>
                            <li>3. Album->increment('songs_count')</li>
                            <li>4. Album->increment('total_duration', $song->duration)</li>
                            <li class="text-green-400">5. âœ… AnÄ±nda gÃ¼ncellendi!</li>
                        </ol>
                    </div>

                    <div class="bg-slate-800 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">Senaryo 2: Playlist'e ÅŸarkÄ± ekleniyor</h4>
                        <ol class="text-slate-300 text-sm space-y-1">
                            <li>1. KullanÄ±cÄ± "Playlist'e ekle" tÄ±klar</li>
                            <li>2. $playlist->songs()->attach($songId)</li>
                            <li>3. Playlist model event tetiklenir</li>
                            <li>4. songs_count ve total_duration gÃ¼ncellenir</li>
                            <li class="text-green-400">5. âœ… AnÄ±nda gÃ¼ncellendi!</li>
                        </ol>
                    </div>

                    <div class="bg-slate-800 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">Senaryo 3: Eski DB'den veri geldi (NULL)</h4>
                        <ol class="text-slate-300 text-sm space-y-1">
                            <li>1. Import sonrasÄ± songs_count = NULL</li>
                            <li>2. Ä°lk sayfa yÃ¼klemesinde getSongsCountAttribute() Ã§aÄŸrÄ±lÄ±r</li>
                            <li>3. NULL gÃ¶rÃ¼nce â†’ $this->songs()->count() hesaplar</li>
                            <li>4. updateQuietly() ile DB'ye yazar</li>
                            <li class="text-green-400">5. âœ… Sonraki isteklerde query yok!</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="text-slate-400 text-sm">
                <strong>KazanÃ§:</strong> ~100ms, subquery'ler kaldÄ±rÄ±lÄ±yor
            </div>
        </div>

        <!-- BÃ–LÃœM 3: DiÄŸer Optimizasyonlar -->
        <div class="bg-yellow-900/20 border border-yellow-800 rounded-lg p-6 mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs font-bold">P3</span>
                <h2 class="text-xl font-bold text-yellow-400">DiÄŸer Optimizasyonlar</h2>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-slate-800 rounded p-4">
                    <h3 class="font-semibold text-white mb-2">Subscription Session Cache</h3>
                    <p class="text-slate-400 text-sm">3 query â†’ Session</p>
                    <p class="text-slate-300 text-sm mt-2">
                        AynÄ± kullanÄ±cÄ±nÄ±n subscription'Ä± 3 kez sorgulanÄ±yor.
                        Session'a cache'le.
                    </p>
                </div>
                <div class="bg-slate-800 rounded p-4">
                    <h3 class="font-semibold text-white mb-2">Corporate Account Check</h3>
                    <p class="text-slate-400 text-sm">27ms â†’ Session</p>
                    <p class="text-slate-300 text-sm mt-2">
                        Kurumsal hesap kontrolÃ¼ de session'a alÄ±nabilir.
                    </p>
                </div>
            </div>
        </div>

        <!-- Uygulama SÄ±rasÄ± -->
        <div class="bg-slate-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">ğŸ“‹ Uygulama SÄ±rasÄ±</h2>
            <ol class="space-y-3">
                <li class="flex items-start gap-3">
                    <span class="bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
                    <div>
                        <p class="font-semibold text-white">P1: Favorites N+1 Ã‡Ã¶zÃ¼mÃ¼</p>
                        <p class="text-slate-400 text-sm">En kolay, en bÃ¼yÃ¼k kazanÃ§ (174 query â†’ 1)</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-orange-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
                    <div>
                        <p class="font-semibold text-white">P2: Migration oluÅŸtur ve Ã§alÄ±ÅŸtÄ±r</p>
                        <p class="text-slate-400 text-sm">songs_count + total_duration nullable field'lar</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-orange-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
                    <div>
                        <p class="font-semibold text-white">P2: Model accessor'larÄ± ekle</p>
                        <p class="text-slate-400 text-sm">Lazy calculation - null ise hesapla</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-orange-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</span>
                    <div>
                        <p class="font-semibold text-white">P2: Observer'larÄ± oluÅŸtur</p>
                        <p class="text-slate-400 text-sm">Song + Playlist pivot event'leri</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-orange-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">5</span>
                    <div>
                        <p class="font-semibold text-white">P2: Recalculate command</p>
                        <p class="text-slate-400 text-sm">Mevcut verileri hesapla</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="bg-green-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">6</span>
                    <div>
                        <p class="font-semibold text-white">Test & KarÅŸÄ±laÅŸtÄ±rma</p>
                        <p class="text-slate-400 text-sm">Telescope'da query sayÄ±sÄ± kontrolÃ¼</p>
                    </div>
                </li>
            </ol>
        </div>

        <!-- Dosya Listesi -->
        <div class="bg-slate-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">ğŸ“ OluÅŸturulacak/GÃ¼ncellenecek Dosyalar</h2>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h3 class="text-green-400 font-semibold mb-2">Yeni OluÅŸturulacak:</h3>
                    <ul class="space-y-1 text-slate-300 font-mono">
                        <li>â€¢ Modules/Favorite/app/Services/FavoriteService.php</li>
                        <li>â€¢ database/migrations/tenant/xxx_add_cache_fields.php</li>
                        <li>â€¢ Modules/Muzibu/app/Observers/SongObserver.php</li>
                        <li>â€¢ Modules/Muzibu/app/Console/RecalculateCounts.php</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-yellow-400 font-semibold mb-2">GÃ¼ncellenecek:</h3>
                    <ul class="space-y-1 text-slate-300 font-mono">
                        <li>â€¢ Modules/Muzibu/app/Models/Playlist.php</li>
                        <li>â€¢ Modules/Muzibu/app/Models/Album.php</li>
                        <li>â€¢ resources/views/themes/muzibu/layouts/app.blade.php</li>
                        <li>â€¢ public/themes/muzibu/js/player/features/favorites.js</li>
                        <li>â€¢ ~15 blade component (isFavoritedBy kaldÄ±r)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Onay -->
        <div class="bg-green-900/20 border border-green-700 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-green-400 mb-4">âœ… Onay Bekleniyor</h2>
            <p class="text-slate-300 mb-4">
                Bu plan onaylanÄ±rsa P1'den baÅŸlayarak uygulamaya geÃ§eceÄŸim.
            </p>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-white font-semibold mb-2">Garantiler:</h3>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <li>âœ“ Mevcut sistem Ã§alÄ±ÅŸmaya devam edecek</li>
                        <li>âœ“ Geriye dÃ¶nÃ¼k uyumluluk korunacak</li>
                        <li>âœ“ NULL deÄŸerler otomatik hesaplanacak</li>
                        <li>âœ“ Dinamik gÃ¼ncellemeler Ã§alÄ±ÅŸacak</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-white font-semibold mb-2">Beklenen SonuÃ§:</h3>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <li>â€¢ 284 query â†’ ~30 query</li>
                        <li>â€¢ 2864ms â†’ ~400ms</li>
                        <li>â€¢ ~7x performans artÄ±ÅŸÄ±</li>
                        <li>â€¢ Daha iyi kullanÄ±cÄ± deneyimi</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-slate-500 text-sm border-t border-slate-700 pt-6">
            <p>Claude AI - KapsamlÄ± Performans Optimizasyon PlanÄ±</p>
            <p>26 AralÄ±k 2025 - v3</p>
        </footer>
    </div>
</body>
</html>
