<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Otomasyon Eksiklikleri - Kritik Sorunlar</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-12">
        <!-- Header -->
        <header class="mb-16 pb-8 border-b border-slate-700">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                ğŸš¨ Tenant Otomasyon Eksiklikleri - Kritik!
            </h1>
            <div class="text-slate-400 text-lg mb-4">
                Admin panel'den tenant oluÅŸturulduÄŸunda eksik kalan kritik iÅŸlemler ve Plesk otomasyon Ã¶nerileri
            </div>
            <div class="flex gap-4 text-sm text-slate-500">
                <span>ğŸ“… 13 AralÄ±k 2025</span>
                <span>ğŸ¯ Plesk + Laravel Otomasyon</span>
                <span>ğŸ‘¤ Sistem Eksiklikleri</span>
            </div>
        </header>

        <!-- Mevcut Durum -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-red-400">âŒ Åu Anki Durum (Admin Panel'den Tenant OluÅŸturma)</h2>

            <div class="bg-red-900/30 border-l-4 border-red-500 rounded-lg p-6 mb-6">
                <h3 class="text-2xl font-bold text-red-300 mb-4">ğŸ”´ TenantComponent::saveTenant() - Eksik Ä°ÅŸlemler</h3>

                <div class="space-y-4">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">âŒ</span>
                        <div>
                            <p class="font-bold text-red-300">Domain Eklemiyor</p>
                            <p class="text-slate-300 text-sm">Tenant oluÅŸturuluyor ama <code class="bg-slate-800 px-2 py-1 rounded">domains</code> tablosuna kayÄ±t yok!</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <span class="text-2xl">âŒ</span>
                        <div>
                            <p class="font-bold text-red-300">Plesk Alias OluÅŸturmuyor</p>
                            <p class="text-slate-300 text-sm">Plesk Panel'e domain alias manuel eklenmeli (otomatik deÄŸil!)</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <span class="text-2xl">âŒ</span>
                        <div>
                            <p class="font-bold text-red-300">SSL Sertifika Talep Etmiyor</p>
                            <p class="text-slate-300 text-sm">Let's Encrypt sertifikasÄ± manuel oluÅŸturulmalÄ± (HTTPS Ã§alÄ±ÅŸmaz!)</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <span class="text-2xl">âŒ</span>
                        <div>
                            <p class="font-bold text-red-300">Nginx Reload YapmÄ±yor</p>
                            <p class="text-slate-300 text-sm">Nginx config yenilenmediÄŸi iÃ§in domain eriÅŸilemez (421 Misdirected Request)</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <span class="text-2xl">âŒ</span>
                        <div>
                            <p class="font-bold text-red-300">Database Seeder Ã‡alÄ±ÅŸtÄ±rmÄ±yor</p>
                            <p class="text-slate-300 text-sm">Tinker Ã¶rneÄŸinde var, admin panel'de yok â†’ Tenant database boÅŸ!</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-orange-900/30 border border-orange-700 rounded-lg p-6">
                <h3 class="text-xl font-bold text-orange-300 mb-3">âš ï¸ SonuÃ§:</h3>
                <p class="text-slate-300 leading-relaxed">
                    Admin panel'den tenant oluÅŸturulsa bile:
                </p>
                <ul class="list-disc list-inside text-slate-300 mt-2 space-y-1">
                    <li>Domain yok â†’ Site eriÅŸilemez!</li>
                    <li>Plesk alias yok â†’ Nginx tanÄ±mÄ±yor!</li>
                    <li>SSL yok â†’ HTTPS Ã§alÄ±ÅŸmaz!</li>
                    <li>Database boÅŸ â†’ Seedsiz baÅŸlatÄ±lamaz!</li>
                </ul>
            </div>
        </section>

        <!-- Ã–nerilen Ã‡Ã¶zÃ¼m -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-green-400">âœ… Ã–nerilen Otomasyon - Plesk CLI Entegrasyonu</h2>

            <!-- Ã‡Ã¶zÃ¼m 1: Domain Otomatik Ekleme -->
            <div class="bg-green-900/30 border-l-4 border-green-500 rounded-lg p-6 mb-6">
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">1</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-green-300 mb-3">Domain Otomatik Ekleme</h3>

                        <p class="text-slate-300 mb-4">Tenant oluÅŸturulurken otomatik olarak domain kayÄ±t edilmeli:</p>

                        <div class="bg-slate-900 p-4 rounded-lg mb-4">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ“‹ MantÄ±k:</p>
                            <pre class="text-sm text-green-300 overflow-x-auto">// TenantComponent::saveTenant() iÃ§inde
$tenant = Tenant::create([...]);

// âœ… Domain otomatik ekle
$primaryDomain = strtolower(str_replace(' ', '', $this->name)) . '.com';

$tenant->domains()->create([
    'domain' => $primaryDomain,
    'is_primary' => 1
]);

// www versiyonu da ekle
$tenant->domains()->create([
    'domain' => 'www.' . $primaryDomain,
    'is_primary' => 0
]);</pre>
                        </div>

                        <div class="bg-yellow-900/30 rounded-lg p-4">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ’¡ Alternatif:</p>
                            <p class="text-slate-300 text-sm">KullanÄ±cÄ±dan domain input al (tenant oluÅŸturma formuna domain field ekle)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 2: Plesk Alias Otomasyon -->
            <div class="bg-green-900/30 border-l-4 border-green-500 rounded-lg p-6 mb-6">
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">2</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-green-300 mb-3">Plesk Alias Otomatik OluÅŸturma</h3>

                        <p class="text-slate-300 mb-4">Plesk CLI ile otomatik alias ekle:</p>

                        <div class="bg-slate-900 p-4 rounded-lg mb-4">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ“‹ Komut:</p>
                            <pre class="text-sm text-green-300 overflow-x-auto">// Domain eklendikten sonra
$domain = $tenant->domains()->where('is_primary', 1)->first();

if ($domain) {
    // Plesk alias oluÅŸtur
    exec("plesk bin subdomain --create {$domain->domain} -domain tuufi.com -www true");

    // SEO redirect'i kapat (Ã–NEMLÄ°!)
    $escapedDomain = escapeshellarg($domain->domain);
    exec("plesk db \"UPDATE domain_aliases SET seoRedirect = 'false' WHERE name = {$escapedDomain}\"");
}</pre>
                        </div>

                        <div class="bg-red-900/30 rounded-lg p-4">
                            <p class="text-red-300 font-semibold mb-2">âš ï¸ Dikkat:</p>
                            <p class="text-slate-300 text-sm">SEO redirect mutlaka kapatÄ±lmalÄ±! Aksi halde domain tuufi.com'a yÃ¶nlendirilir.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 3: SSL Sertifika Otomasyon -->
            <div class="bg-green-900/30 border-l-4 border-green-500 rounded-lg p-6 mb-6">
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">3</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-green-300 mb-3">SSL Sertifika Otomatik Talep</h3>

                        <p class="text-slate-300 mb-4">Let's Encrypt ile otomatik SSL sertifika:</p>

                        <div class="bg-slate-900 p-4 rounded-lg mb-4">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ“‹ Komut:</p>
                            <pre class="text-sm text-green-300 overflow-x-auto">// Plesk alias oluÅŸturulduktan sonra
$escapedDomain = escapeshellarg($domain->domain);
$escapedEmail = escapeshellarg('admin@tuufi.com');

// Let's Encrypt SSL talep et
exec("plesk bin certificate --issue -domain {$escapedDomain} -admin-email {$escapedEmail}");

// DNS kontrol et (SSL iÃ§in domain'in tuufi.com IP'sine point etmesi gerekli)
$dnsCheck = exec("dig +short {$domain->domain}");
if (trim($dnsCheck) !== '159.253.45.94') {
    \Log::warning("DNS not configured for {$domain->domain}");
}</pre>
                        </div>

                        <div class="bg-orange-900/30 rounded-lg p-4">
                            <p class="text-orange-300 font-semibold mb-2">âš ï¸ Gereklilik:</p>
                            <p class="text-slate-300 text-sm">SSL talep edilmeden Ã¶nce domain DNS'i tuufi.com IP'sine point etmeli (manuel yapÄ±lmalÄ±)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 4: Nginx Reload -->
            <div class="bg-green-900/30 border-l-4 border-green-500 rounded-lg p-6 mb-6">
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">4</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-green-300 mb-3">Nginx Config Refresh & Reload</h3>

                        <p class="text-slate-300 mb-4">Plesk web server config'i yeniden oluÅŸtur ve reload:</p>

                        <div class="bg-slate-900 p-4 rounded-lg">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ“‹ Komut:</p>
                            <pre class="text-sm text-green-300 overflow-x-auto">// TÃ¼m iÅŸlemler bittikten sonra
exec("plesk repair web tuufi.com -y");
exec("systemctl reload nginx");

// Test et
$testUrl = "https://{$domain->domain}/";
$statusCode = exec("curl -s -o /dev/null -w '%{http_code}' -k {$testUrl}");

if ($statusCode === '200') {
    \Log::info("Tenant {$tenant->id} domain baÅŸarÄ±yla eriÅŸilebilir: {$testUrl}");
} else {
    \Log::error("Tenant {$tenant->id} domain eriÅŸilemiyor: {$testUrl} (HTTP {$statusCode})");
}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ã‡Ã¶zÃ¼m 5: Database Seeder -->
            <div class="bg-green-900/30 border-l-4 border-green-500 rounded-lg p-6 mb-6">
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">5</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-green-300 mb-3">Database Seeder Otomatik Ã‡alÄ±ÅŸtÄ±rma</h3>

                        <p class="text-slate-300 mb-4">Tenant database'ini otomatik seed et:</p>

                        <div class="bg-slate-900 p-4 rounded-lg">
                            <p class="text-yellow-300 font-semibold mb-2">ğŸ“‹ Kod:</p>
                            <pre class="text-sm text-green-300 overflow-x-auto">// Tenant oluÅŸturulduktan sonra
$tenant->run(function () {
    Artisan::call('db:seed', [
        '--class' => 'TenantDatabaseSeeder',
        '--force' => true
    ]);

    \Log::info("Tenant {$this->id} seeded successfully");
});</pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tam Otomasyon Kodu -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-purple-400">ğŸ’» Tam Otomasyon - Kod Ã–rneÄŸi</h2>

            <div class="bg-slate-800/50 rounded-lg p-6">
                <p class="text-yellow-300 font-semibold mb-4">ğŸ“‹ TenantComponent::saveTenant() iÃ§ine eklenecek kod:</p>
                <pre class="bg-slate-900 p-4 rounded text-sm text-green-300 overflow-x-auto leading-relaxed">// Yeni tenant oluÅŸturulduysa otomasyonlarÄ± Ã§alÄ±ÅŸtÄ±r
if ($wasRecentlyCreated && $tenant) {
    try {
        // 1. Domain otomatik ekle (kullanÄ±cÄ±dan form input alÄ±nabilir)
        $primaryDomain = strtolower(str_replace(' ', '', $this->name)) . '.com';

        $domain = $tenant->domains()->create([
            'domain' => $primaryDomain,
            'is_primary' => 1
        ]);

        // www versiyonu
        $tenant->domains()->create([
            'domain' => 'www.' . $primaryDomain,
            'is_primary' => 0
        ]);

        // 2. Plesk alias oluÅŸtur
        $escapedDomain = escapeshellarg($primaryDomain);
        exec("plesk bin subdomain --create {$escapedDomain} -domain tuufi.com -www true");

        // SEO redirect kapat
        exec("plesk db \"UPDATE domain_aliases SET seoRedirect = 'false' WHERE name = {$escapedDomain}\"");

        // 3. SSL sertifika talep et (DNS hazÄ±rsa)
        $escapedEmail = escapeshellarg('admin@tuufi.com');
        exec("plesk bin certificate --issue -domain {$escapedDomain} -admin-email {$escapedEmail} 2>&1", $output, $returnCode);

        if ($returnCode !== 0) {
            \Log::warning("SSL certificate request failed for {$primaryDomain}");
        }

        // 4. Nginx reload
        exec("plesk repair web tuufi.com -y");
        exec("systemctl reload nginx");

        // 5. Database seed
        $tenant->run(function () {
            Artisan::call('db:seed', [
                '--class' => 'TenantDatabaseSeeder',
                '--force' => true
            ]);
        });

        // 6. Test et
        sleep(2); // Nginx reload iÃ§in bekle
        $testUrl = "https://{$primaryDomain}/";
        $statusCode = exec("curl -s -o /dev/null -w '%{http_code}' -k {$testUrl}");

        \Log::info("Tenant {$tenant->id} automation completed. HTTP Status: {$statusCode}");

    } catch (\Exception $e) {
        \Log::error("Tenant automation failed: " . $e->getMessage());
        // Hata olsa bile tenant oluÅŸturuldu, sadece log tut
    }
}</pre>
            </div>
        </section>

        <!-- Dikkat Edilecekler -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-orange-400">âš ï¸ Dikkat Edilecek Noktalar</h2>

            <div class="space-y-4">
                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4">
                    <p class="font-bold text-orange-300 mb-2">1. DNS YÃ¶netimi</p>
                    <p class="text-slate-300 text-sm">Domain DNS'i manuel olarak tuufi.com IP'sine point edilmeli (159.253.45.94). Aksi halde SSL sertifika baÅŸarÄ±sÄ±z olur.</p>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4">
                    <p class="font-bold text-orange-300 mb-2">2. Plesk Yetkileri</p>
                    <p class="text-slate-300 text-sm">PHP-FPM user'Ä±nÄ±n <code class="bg-slate-800 px-2 py-1 rounded">plesk</code> komutunu Ã§alÄ±ÅŸtÄ±rma yetkisi olmalÄ± (sudoers)</p>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4">
                    <p class="font-bold text-orange-300 mb-2">3. Domain Ã‡akÄ±ÅŸmasÄ±</p>
                    <p class="text-slate-300 text-sm">Domain unique olmalÄ±. Ekleme Ã¶ncesi kontrol et: <code class="bg-slate-800 px-2 py-1 rounded">Domain::where('domain', $primaryDomain)->exists()</code></p>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4">
                    <p class="font-bold text-orange-300 mb-2">4. Timeout</p>
                    <p class="text-slate-300 text-sm">SSL sertifika talebi zaman alabilir. Async queue job kullanÄ±lmalÄ± veya timeout arttÄ±rÄ±lmalÄ±.</p>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4">
                    <p class="font-bold text-orange-300 mb-2">5. Hata YÃ¶netimi</p>
                    <p class="text-slate-300 text-sm">Plesk komutlarÄ± baÅŸarÄ±sÄ±z olsa bile tenant oluÅŸturulmalÄ±. Otomasyonlar try-catch ile korunmalÄ±.</p>
                </div>
            </div>
        </section>

        <!-- Ã–ncelik SÄ±ralamasÄ± -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-blue-400">ğŸ¯ Uygulama Ã–nceliÄŸi</h2>

            <div class="space-y-4">
                <div class="bg-red-900/30 border-l-4 border-red-500 rounded-lg p-4 flex items-center gap-4">
                    <div class="bg-red-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">1</div>
                    <div>
                        <p class="font-bold text-red-300">Domain Otomatik Ekleme - KRÄ°TÄ°K</p>
                        <p class="text-sm text-slate-400">Domain yoksa tenant eriÅŸilemez!</p>
                    </div>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4 flex items-center gap-4">
                    <div class="bg-orange-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">2</div>
                    <div>
                        <p class="font-bold text-orange-300">Plesk Alias Otomasyon - YÃ¼ksek Ã–ncelik</p>
                        <p class="text-sm text-slate-400">Nginx tanÄ±mazsa 421 Misdirected Request</p>
                    </div>
                </div>

                <div class="bg-orange-900/30 border-l-4 border-orange-500 rounded-lg p-4 flex items-center gap-4">
                    <div class="bg-orange-500 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">3</div>
                    <div>
                        <p class="font-bold text-orange-300">Nginx Reload - YÃ¼ksek Ã–ncelik</p>
                        <p class="text-sm text-slate-400">Config yenilenmezse domain Ã§alÄ±ÅŸmaz</p>
                    </div>
                </div>

                <div class="bg-yellow-900/30 border-l-4 border-yellow-500 rounded-lg p-4 flex items-center gap-4">
                    <div class="bg-yellow-500 text-slate-900 font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">4</div>
                    <div>
                        <p class="font-bold text-yellow-300">Database Seeder - Orta Ã–ncelik</p>
                        <p class="text-sm text-slate-400">BoÅŸ database'le de baÅŸlatÄ±labilir</p>
                    </div>
                </div>

                <div class="bg-yellow-900/30 border-l-4 border-yellow-500 rounded-lg p-4 flex items-center gap-4">
                    <div class="bg-yellow-500 text-slate-900 font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">5</div>
                    <div>
                        <p class="font-bold text-yellow-300">SSL Sertifika - DÃ¼ÅŸÃ¼k Ã–ncelik</p>
                        <p class="text-sm text-slate-400">HTTP ile baÅŸlatÄ±labilir, sonra SSL eklenebilir</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-20 pt-8 border-t border-slate-700 text-center text-slate-500 text-sm">
            <p>ğŸ¤– Claude AI tarafÄ±ndan oluÅŸturuldu - 13 AralÄ±k 2025</p>
            <p class="mt-2">Tenant Otomasyon Eksiklikleri Analiz Raporu v1</p>
        </footer>
    </div>
</body>
</html>