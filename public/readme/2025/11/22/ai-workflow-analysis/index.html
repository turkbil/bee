<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Sistem Analizi - Tenant 2 (iXTÄ°F)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #334155;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        section {
            margin-bottom: 50px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.3rem;
            margin-top: 25px;
            margin-bottom: 15px;
            color: #a5f3fc;
        }

        .subsection {
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            backdrop-filter: blur(10px);
        }

        .subsection.critical {
            border-left-color: #ef4444;
            background: rgba(127, 29, 29, 0.2);
        }

        .subsection.success {
            border-left-color: #10b981;
            background: rgba(5, 46, 22, 0.2);
        }

        .subsection.warning {
            border-left-color: #f59e0b;
            background: rgba(120, 53, 15, 0.2);
        }

        .flow-diagram {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            overflow-x: auto;
        }

        .node {
            display: inline-block;
            background: #1e293b;
            padding: 15px 20px;
            margin: 10px 5px;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            font-weight: 500;
        }

        .node.critical {
            border-color: #ef4444;
        }

        .node.success {
            border-color: #10b981;
        }

        .arrow {
            display: inline-block;
            color: #60a5fa;
            font-weight: bold;
            margin: 0 5px;
        }

        .code-block {
            background: rgba(15, 23, 42, 0.8);
            border-left: 4px solid #60a5fa;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 6px;
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            line-height: 1.5;
        }

        .list-item {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .decision-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .tenant-info {
            background: rgba(6, 78, 59, 0.2);
            border: 2px solid #10b981;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: rgba(59, 130, 246, 0.2);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #334155;
            color: #60a5fa;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .highlight {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .pill.critical {
            background: #dc2626;
            color: white;
        }

        .pill.success {
            background: #10b981;
            color: white;
        }

        .pill.warning {
            background: #f59e0b;
            color: white;
        }

        .pill.info {
            background: #3b82f6;
            color: white;
        }

        .gap-issue {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .gap-issue h4 {
            color: #fca5a5;
            margin-bottom: 10px;
        }

        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
        }

        .toc {
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            margin-bottom: 40px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .toc h3 {
            margin-top: 0;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            margin: 8px 0;
            padding-left: 20px;
        }

        .toc a {
            color: #60a5fa;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– AI Workflow Sistem Analizi - Tenant 2 (iXTÄ°F)</h1>
            <div class="meta">
                ğŸ“… Tarih: 2025-11-22 | ğŸ¯ Konu: FlowExecutor, Node Sistemi, Tenant-Specific Logic | ğŸ‘¤ Sistem: EndÃ¼striyel Ekipman (Forklift/Transpalet)
            </div>
        </header>

        <div class="toc">
            <h3>ğŸ“‹ Ä°Ã§indekiler</h3>
            <ul>
                <li><a href="#workflow-flow">1. Workflow AkÄ±ÅŸ Sistemi</a></li>
                <li><a href="#node-types">2. Node TÃ¼rleri ve FonksiyonlarÄ±</a></li>
                <li><a href="#tenant-logic">3. Tenant 2 Ã–zel MantÄ±ÄŸÄ±</a></li>
                <li><a href="#search-system">4. Arama Sistemi (HybridSearch)</a></li>
                <li><a href="#context-building">5. BaÄŸlam Ä°nÅŸasÄ± (Context Building)</a></li>
                <li><a href="#key-decisions">6. Kritik Karar NoktalarÄ±</a></li>
                <li><a href="#issues-gaps">7. Bulunun Sorunlar ve BoÅŸluklar</a></li>
            </ul>
        </div>

        <!-- SECTION 1: WORKFLOW FLOW -->
        <section id="workflow-flow">
            <h2>1. Workflow AkÄ±ÅŸ Sistemi</h2>

            <div class="subsection success">
                <h3>AkÄ±ÅŸ Mimarisi</h3>
                <p><strong>FlowExecutor</strong> (Modules/AI/app/Services/Workflow/FlowExecutor.php) ana orchestrator'dÄ±r. AkÄ±ÅŸ, JSON tabanlÄ± flow tanÄ±mÄ± ile Ã§alÄ±ÅŸÄ±r.</p>
                <div class="flow-diagram">
START (Welcome Node)
    â†“
CATEGORY DETECTION
    â†“
PRODUCT SEARCH (HybridSearch)
    â†“
STOCK SORTER
    â†“
CONTEXT BUILDER
    â†“
AI RESPONSE (Claude/OpenAI)
    â†“
MESSAGE SAVER
    â†“
END
                </div>
            </div>

            <div class="subsection">
                <h3>AkÄ±ÅŸ Ã–zellikleri</h3>
                <div class="list-item">
                    <span class="pill info">Tenant-Aware</span>
                    <span class="pill info">Paralel Execution</span>
                    <span class="pill info">Cache-Enabled</span>
                    <span class="pill info">JSON-Based</span>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Ã–zellik</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Tenant Awareness</strong></td>
                            <td>Her node, tenancy() konteksti iÃ§inde Ã§alÄ±ÅŸÄ±r. Tenant-specific node'lar otomatik yÃ¼klenir.</td>
                        </tr>
                        <tr>
                            <td><strong>Node Chaining</strong></td>
                            <td>Edge tanÄ±mlarÄ± Ã¼zerinden, node'dan node'a sÄ±rayla geÃ§iÅŸ. Conditional branching destekli.</td>
                        </tr>
                        <tr>
                            <td><strong>Context Passing</strong></td>
                            <td>Her node, context array'i alÄ±r ve extend eder. Sonraki node'a ek bilgiler aktarÄ±lÄ±r.</td>
                        </tr>
                        <tr>
                            <td><strong>Parallel Groups</strong></td>
                            <td>Birden fazla node paralel Ã§alÄ±ÅŸabilir (ParallelNodeExecutor). SonuÃ§lar merge edilir.</td>
                        </tr>
                        <tr>
                            <td><strong>Caching</strong></td>
                            <td>Category detection ve history loading cache'lenir. ai_response ve product_search cache'lenmez.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="subsection warning">
                <h3>Flow TanÄ±mÄ± (JSON)</h3>
                <div class="code-block">
{
  "id": "ixtif-main-flow",
  "tenant_id": 2,
  "name": "iXTÄ°F EndÃ¼striyel ÃœrÃ¼n SatÄ±ÅŸ AkÄ±ÅŸÄ±",
  "start_node": "welcome",
  "nodes": [
    {
      "id": "welcome",
      "type": "welcome",
      "config": {}
    },
    {
      "id": "category_detection",
      "type": "category_detection",
      "config": {}
    },
    {
      "id": "product_search",
      "type": "product_search",
      "config": {
        "search_limit": 50,
        "use_meilisearch": true
      }
    },
    {
      "id": "stock_sorter",
      "type": "stock_sorter",
      "config": {
        "exclude_out_of_stock": false
      }
    },
    {
      "id": "context_builder",
      "type": "context_builder",
      "config": {}
    },
    {
      "id": "ai_response",
      "type": "ai_response",
      "config": {
        "stream": false,
        "provider": "anthropic",
        "max_tokens": 500,
        "temperature": 0.7
      }
    },
    {
      "id": "message_saver",
      "type": "message_saver",
      "config": {}
    },
    {
      "id": "end",
      "type": "end",
      "config": {}
    }
  ],
  "edges": [
    { "from": "welcome", "to": "category_detection" },
    { "from": "category_detection", "to": "product_search" },
    { "from": "product_search", "to": "stock_sorter" },
    { "from": "stock_sorter", "to": "context_builder" },
    { "from": "context_builder", "to": "ai_response" },
    { "from": "ai_response", "to": "message_saver" },
    { "from": "message_saver", "to": "end" }
  ]
}
                </div>
            </div>

            <div class="subsection">
                <h3>AkÄ±ÅŸ YÃ¼rÃ¼tme AdÄ±mlarÄ±</h3>
                <ol>
                    <li><strong>FlowExecutor::execute()</strong> Ã§aÄŸrÄ±lÄ±r - flow tanÄ±mÄ± ve initial context geÃ§ilir</li>
                    <li><strong>Parallel Groups keÅŸfedilir</strong> - eÄŸer varsa paralel node'lar tespit edilir</li>
                    <li><strong>Node'lar sÄ±rayla Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r:</strong>
                        <ul>
                            <li>NodeExecutor::execute() Ã§aÄŸrÄ±lÄ±r</li>
                            <li>NodeFactory node instance'Ä± oluÅŸturur</li>
                            <li>Node::execute() Ã§alÄ±ÅŸÄ±r ve sonucu dÃ¶ndÃ¼rÃ¼r</li>
                            <li>SonuÃ§ context'e merge edilir</li>
                        </ul>
                    </li>
                    <li><strong>Sonraki node bulunur</strong> - edges'teki from/to iliÅŸkisinden</li>
                    <li><strong>End node'a ulaÅŸÄ±lÄ±r</strong> - akÄ±ÅŸ tamamlanÄ±r</li>
                </ol>
            </div>
        </section>

        <!-- SECTION 2: NODE TYPES -->
        <section id="node-types">
            <h2>2. Node TÃ¼rleri ve FonksiyonlarÄ±</h2>

            <div class="subsection">
                <h3>WelcomeNode (BaÅŸlangÄ±Ã§)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/WelcomeNode.php</p>
                <p>Basit pass-through node. Flow baÅŸlatma iÅŸlevi gÃ¶rÃ¼r.</p>
                <div class="code-block">
GiriÅŸ: Initial context
Ã‡Ä±kÄ±ÅŸ: Context (deÄŸiÅŸiklik yok)
                </div>
            </div>

            <div class="subsection">
                <h3>CategoryDetectionNode (Kategori Tespiti)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/CategoryDetectionNode.php</p>
                <p>Global olarak generic kategori tespiti yapÄ±lÄ±r, ama Tenant 2 iÃ§in Ã¶zel mantÄ±k yok. Tenant2ProductSearchService iÃ§inde real kategori tespiti yapÄ±lÄ±r.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Girdi</th>
                            <th>Ä°ÅŸlev</th>
                            <th>Ã‡Ä±ktÄ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>user_message</td>
                            <td>Fallback: Generic kategori tespiti (mostly null)</td>
                            <td>detected_category: null (Tenant2 servisi override eder)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="subsection success">
                <h3>ProductSearchNode (ÃœrÃ¼n Arama)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/ProductSearchNode.php</p>
                <p>Tenant-specific arama servisi kullanÄ±r. Tenant 2 iÃ§in Tenant2ProductSearchService otomatik yÃ¼klenir.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Girdi</th>
                            <th>Ä°ÅŸlev</th>
                            <th>Ã‡Ä±ktÄ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>user_message</td>
                            <td>
                                1. Tenant2ProductSearchService::search() Ã§aÄŸrÄ±lÄ±r<br>
                                2. HybridSearchService (Meilisearch + Vector) kullanÄ±lÄ±r<br>
                                3. Yedek parÃ§a filtresi uygulanÄ±r (isSparePartRequest)<br>
                                4. ÃœrÃ¼n listesi dÃ¶ndÃ¼rÃ¼lÃ¼r
                            </td>
                            <td>
                                products: Collection&lt;ShopProduct&gt;<br>
                                products_found: int<br>
                                detected_category: int|null
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="decision-box">
                    <strong>Ã–nemli MantÄ±k: Yedek ParÃ§a Filtreleme</strong>
                    <p>Arama sonuÃ§larÄ±ndan yedek parÃ§a Ã¼rÃ¼nleri filtreler. Temizleme kriterleri:</p>
                    <ul>
                        <li>devirdaim, ÅŸamandÄ±ra, Ã§atal, rulman, tekerlek, direksiyon...</li>
                        <li>geri ikaz, silindir, piston, pompa, filtre, balata, fren...</li>
                        <li>kablo, sensÃ¶r, conta, kayÄ±ÅŸ, zincir, mil, yatak, kaplin...</li>
                        <li>motor yedek, yedek parÃ§a, spare, aksesuar</li>
                    </ul>
                    <p><span class="highlight">Fakat:</span> isSparePartRequest = true ise, yedek parÃ§a tekrar gÃ¶sterilir.</p>
                </div>
            </div>

            <div class="subsection">
                <h3>StockSorterNode (ÃœrÃ¼n SÄ±ralama)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/StockSorterNode.php</p>
                <p>Professionel 6-katmanlÄ± sÄ±ralama sistemi.</p>
                <table>
                    <thead>
                        <tr>
                            <th>SÄ±ra</th>
                            <th>Kriter</th>
                            <th>YÃ¶n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ğŸ¥‡ 1.</td>
                            <td>Vitrin ÃœrÃ¼nleri (show_on_homepage = 1)</td>
                            <td>DESC (1 Ã¶nce)</td>
                        </tr>
                        <tr>
                            <td>ğŸ¥ˆ 2.</td>
                            <td>Stok Durumu (current_stock > 0)</td>
                            <td>DESC (stoklu Ã¶nce)</td>
                        </tr>
                        <tr>
                            <td>ğŸ¥‰ 3.</td>
                            <td>Kategori SÄ±ramasÄ± (sort_order)</td>
                            <td>ASC (kÃ¼Ã§Ã¼k Ã¶nce)</td>
                        </tr>
                        <tr>
                            <td>4.</td>
                            <td>Fiyat Durumu (base_price > 0)</td>
                            <td>DESC (fiyatlÄ± Ã¶nce)</td>
                        </tr>
                        <tr>
                            <td>5.</td>
                            <td>Fiyat DeÄŸeri (base_price)</td>
                            <td>ASC (ucuz Ã¶nce)</td>
                        </tr>
                    </tbody>
                </table>

                <div class="code-block">
Girdi: products (unsorted collection)
Ã‡Ä±kÄ±ÅŸ: products (sorted), high_stock_count, in_stock_count, with_price_count
                </div>
            </div>

            <div class="subsection success">
                <h3>ContextBuilderNode (BaÄŸlam Ä°nÅŸasÄ±)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/ContextBuilderNode.php</p>
                <p>ÃœrÃ¼nleri Markdown formatÄ±nda, AI'nin anlayacaÄŸÄ± ÅŸekilde hazÄ±rlar.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Girdi</th>
                            <th>Ä°ÅŸlev</th>
                            <th>Ã‡Ä±ktÄ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>products: Collection</td>
                            <td>
                                1. USD â†’ TRY conversion<br>
                                2. ÃœrÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± temizle (2. Ton â†’ 2 Ton)<br>
                                3. Markdown formatÄ±nda Ã¼rÃ¼n listesi oluÅŸtur<br>
                                4. Kategori etiketi ekle (&lt;[KATEGORI]&gt;)<br>
                                5. Fiyat gÃ¶sterimi (KDV hariÃ§, sembol korumasÄ±)
                            </td>
                            <td>
                                product_context: Markdown string<br>
                                products_found: int
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="code-block">
## ğŸ“¦ Mevcut ÃœrÃ¼nler:

### Ä°XTÄ°F EPT20-2T Li-Ion Forklift
- ğŸ“· GÃ¶rsel: https://...
- **52.948 TL** â‰ˆ $1.250
- [ÃœrÃ¼nÃ¼ Ä°ncele](/shop/ixtif-ept20-2t)

(DiÄŸer Ã¼rÃ¼nler...)
                </div>

                <div class="decision-box">
                    <strong>Kritik Kurallar:</strong>
                    <ul>
                        <li>FiyatsÄ±z Ã¼rÃ¼nlerde FÄ°YAT SATIRI GÃ–STERILMEZ (duplicate prevention)</li>
                        <li>Stok bilgisi ASLA verilmez (istek gelmedi)</li>
                        <li>BaÅŸlÄ±k temizliÄŸi: "2. Ton" â†’ "2 Ton"</li>
                        <li>USD fiyatlarÄ± TRY'ye Ã§evrilir (exchange_rate: 42.0 fallback)</li>
                    </ul>
                </div>
            </div>

            <div class="subsection critical">
                <h3>AIResponseNode (AI YanÄ±tÄ± Ãœretme)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/AIResponseNode.php (341 satÄ±r!)</p>
                <p>En karmaÅŸÄ±k node. Sistem prompt'u dinamik olarak oluÅŸturur.</p>

                <h4>Sistem Prompt OluÅŸturma AÅŸamalarÄ±:</h4>
                <ol>
                    <li><strong>Directive'den temel system prompt yÃ¼kle</strong> (chatbot_system_prompt)</li>
                    <li><strong>Tenant2PromptService kurallarÄ±nÄ± ekle</strong> (Tenant 2 iÃ§in Ã¶zel)</li>
                    <li><strong>Universal Rules ekle</strong> (TÃœM TENANTLAR iÃ§in)</li>
                    <li><strong>Tenant 2 iXTÄ°F Rules ekle</strong> (EndÃ¼striyel ekipman spesifik)</li>
                    <li><strong>ÃœrÃ¼n BaÄŸlamÄ± ekle</strong> (product_context - Markdown)</li>
                    <li><strong>YapÄ± kurallarÄ± ekle</strong> (format, markdown, emoji)</li>
                </ol>

                <h4>ÃœrÃ¼n Varsa vs. ÃœrÃ¼n Yoksa:</h4>
                <div class="decision-box">
                    <strong>products_found > 0:</strong>
                    <ul>
                        <li>Belirsiz istek kontrol kurallarÄ± ekle</li>
                        <li>ÃœrÃ¼n listeleri dÃ¶ndÃ¼r</li>
                        <li>Format kurallarÄ± (markdown liste, emoji, link)</li>
                    </ul>

                    <strong>products_found = 0:</strong>
                    <ul>
                        <li>Welcome variations (random) kullan</li>
                        <li>MÃ¼ÅŸteri temsilcisi yÃ¶nlendirmesi yap</li>
                        <li>Ä°letiÅŸim bilgilerini ver (setting'den)</li>
                        <li>HiÃ§ Ã¼rÃ¼n uydurma!</li>
                    </ul>
                </div>

                <div class="code-block">
// Tenant 2 prompt'u sistemine ekle
if (in_array($tenantId, [2, 3])) {
    $tenant2Service = new Tenant2PromptService();
    $tenantPrompt = implode("\n", $tenant2Service->buildPrompt());
    $systemPrompt = $tenantPrompt . "\n\n" . $systemPrompt;
}
                </div>

                <h4>AI Ã‡aÄŸrÄ±sÄ±</h4>
                <p><span class="highlight">OpenAI</span> (gpt-4.1-mini model kullanÄ±lÄ±yor)</p>
                <table>
                    <thead>
                        <tr>
                            <th>Parametre</th>
                            <th>DeÄŸer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>model</td>
                            <td>gpt-4.1-mini</td>
                        </tr>
                        <tr>
                            <td>max_tokens</td>
                            <td>500 (directive'den deÄŸiÅŸebilir)</td>
                        </tr>
                        <tr>
                            <td>temperature</td>
                            <td>0.7</td>
                        </tr>
                        <tr>
                            <td>streaming</td>
                            <td>false (default)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="subsection">
                <h3>MessageSaverNode (Mesaj Kaydedici)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Workflow/Nodes/MessageSaverNode.php</p>
                <p>Placeholder node. GerÃ§ek kaydetme, controller tarafÄ±ndan yapÄ±lÄ±r.</p>
            </div>

            <div class="subsection">
                <h3>EndNode (BitiÅŸ)</h3>
                <p>Flow sonu iÅŸareti.</p>
            </div>
        </section>

        <!-- SECTION 3: TENANT LOGIC -->
        <section id="tenant-logic">
            <h2>3. Tenant 2 Ã–zel MantÄ±ÄŸÄ±</h2>

            <div class="tenant-info">
                <h3>Tenant 2 Ã–zellikleri</h3>
                <ul>
                    <li><strong>Domain:</strong> ixtif.com & ixtif.com.tr (ID: 2 & 3)</li>
                    <li><strong>SektÃ¶r:</strong> EndÃ¼striyel ekipman (forklift, transpalet, reach truck, vb.)</li>
                    <li><strong>Database:</strong> tenant_2_db (baÄŸÄ±msÄ±z)</li>
                    <li><strong>ÃœrÃ¼n Kategorileri:</strong> 6 ana kategori</li>
                </ul>
            </div>

            <div class="subsection">
                <h3>Tenant2ProductSearchService (ÃœrÃ¼n Arama)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Tenant/Tenant2ProductSearchService.php (837 satÄ±r!)</p>

                <h4>Ana Fonksiyon: search()</h4>
                <div class="code-block">
public function search(
    string $userMessage,
    int $limit = 50,
    ?int $categoryId = null
): array
                </div>

                <h4>Kategori HaritalanmasÄ±:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Kategori ID</th>
                            <th>AdÄ±</th>
                            <th>Anahtar Kelimeler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Forklift</td>
                            <td>forklift, fork lift, portif, akÃ¼lÃ¼ forklift, elektrikli forklift</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Transpalet</td>
                            <td>transpalet, trans palet, palet jack, pallet truck</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Ä°stif Makinesi</td>
                            <td>istif makinesi, istif, stacker</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>SipariÅŸ Toplama</td>
                            <td>sipariÅŸ toplama, order picker, picking</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Otonom Sistemler</td>
                            <td>otonom, autonomous, agv, otomatik, robot</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Reach Truck</td>
                            <td>reach truck, reach, dar koridor</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Yedek ParÃ§a Filtresi</h4>
                <p>Åu Ã¼rÃ¼n adÄ± anahtar kelimeler iÃ§eriyorsa yedek parÃ§a olarak iÅŸaretlenir:</p>
                <div class="code-block">
devirdaim, ÅŸamandÄ±ra, Ã§atal, rulman, tekerlek, direksiyon,
geri ikaz, silindir, piston, pompa, filtre, balata, fren,
kablo, sensÃ¶r, conta, kayÄ±ÅŸ, zincir, mil, yatak, kaplin,
motor yedek, yedek parÃ§a, spare, aksesuar
                </div>

                <p><span class="highlight">Fakat:</span> isSparePartRequest() = true ise, yedek parÃ§a gÃ¶sterilir.</p>
            </div>

            <div class="subsection critical">
                <h3>Tenant2PromptService (Ã–zel Kurallar)</h3>
                <p><strong>Dosya:</strong> Modules/AI/app/Services/Tenant/Tenant2PromptService.php (822 satÄ±r!)</p>
                <p>Tenant 2 (iXTÄ°F) iÃ§in tÃ¼m AI davranÄ±ÅŸ kurallarÄ±nÄ± iÃ§erir.</p>

                <h4>Ana Kurallar (buildPrompt() dizi)</h4>
                <ol>
                    <li><span class="pill critical">MEGA KRÄ°TÄ°K</span> <strong>BELÄ°RSÄ°Z Ä°STEKTE SORU SOR!</strong>
                        <ul>
                            <li>"Transpalet istiyorum" â†’ BELÄ°RSÄ°Z (tonnaj/tip yok)</li>
                            <li>"1.5 ton elektrikli transpalet" â†’ BELÄ°RLÄ° (tonnaj + tip var)</li>
                            <li>Belirsiz istekte: "KaÃ§ ton?" + "Elektrikli mi tercih edersiniz?" sor</li>
                            <li><strong>BÃ¼tÃ§e SORMA!</strong></li>
                        </ul>
                    </li>

                    <li><span class="pill critical">MEGA KRÄ°TÄ°K</span> <strong>CONTEXT'TEKÄ° FÄ°YATLARI KULLAN!</strong>
                        <ul>
                            <li>Context'te "52.948 TL" yazÄ±yorsa â†’ cevabÄ±nda "52.948 TL" yaz (AYNEN!)</li>
                            <li>Asla fiyat uydurma!</li>
                            <li>Asla "Fiyat bilgisi iÃ§in iletiÅŸime geÃ§in" yazma (context'te fiyat varsa)</li>
                        </ul>
                    </li>

                    <li><span class="pill critical">ULTRA KRÄ°TÄ°K</span> <strong>Ã–NCEKÄ° KONUÅMAYA ATIF YAPMA!</strong>
                        <ul>
                            <li>"Ã–nceki konuÅŸmamÄ±zda..." â†’ YASAK!</li>
                            <li>"Daha Ã¶nce ... arÄ±yordunuz" â†’ YASAK!</li>
                            <li>"HatÄ±rlÄ±yorum..." â†’ YASAK!</li>
                            <li>Her mesaj YENÄ° BAÅLANGIÃ‡! History sadece context iÃ§in.</li>
                        </ul>
                    </li>

                    <li><strong>SATIÅ TONU - DoÄŸal ve Profesyonel</strong>
                        <ul>
                            <li>Ä°NSAN gibi konuÅŸ, robot gibi deÄŸil!</li>
                            <li>"harika", "mÃ¼kemmel" kullanmayÄ± abartma</li>
                            <li>DoÄŸal ifadeler: "Ä°yi bir seÃ§enek", "PopÃ¼ler model", "Ã‡ok tercih ediliyor"</li>
                            <li>DAIMA "SÄ°Z" kullan (asla "sen")</li>
                        </ul>
                    </li>

                    <li><strong>HÄ°TAP - SAMÄ°MÄ° VE SICAK</strong>
                        <ul>
                            <li>Emoji AZALT (mesaj baÅŸÄ±na 1-2 yeterli)</li>
                            <li>Profesyonel ama samimi</li>
                        </ul>
                    </li>

                    <li><strong>KATEGORÄ° HAFIZASI</strong>
                        <ul>
                            <li>KullanÄ±cÄ± "transpalet" dedi â†’ konuÅŸma boyunca transpalet kategorisinde kal</li>
                            <li>"BaÅŸka ne var?" â†’ AYNI kategoriden diÄŸer Ã¼rÃ¼nler gÃ¶ster</li>
                            <li>Kategori ASLA karÄ±ÅŸma! (transpalet â‰  forklift)</li>
                        </ul>
                    </li>

                    <li><strong>ÃœRÃœN Ã–NCELÄ°KLENDÄ°RME</strong>
                        <ul>
                            <li><span class="pill critical">YEDEK PARÃ‡A GÃ–STERME!</span> (Ã§atal, tekerlek, rulman vb.)</li>
                            <li>Homepage Ã¼rÃ¼nleri (show_on_homepage=1) Ã¶nce</li>
                            <li>Stok durumuna gÃ¶re</li>
                            <li>Kategori sort_order'a gÃ¶re</li>
                        </ul>
                    </li>

                    <li><strong>FÄ°YAT VE STOK POLÄ°TÄ°KASI</strong>
                        <ul>
                            <li><strong>FiyatsÄ±z Ã¼rÃ¼n (base_price=0):</strong> ÃœrÃ¼nÃ¼ gÃ¶ster ama "MÃ¼ÅŸteri temsilcilerimizle iletiÅŸime geÃ§erek teklif alabilirsiniz"</li>
                            <li><strong>Stoksuz Ã¼rÃ¼n (current_stock=0):</strong> ÃœrÃ¼nÃ¼ gÃ¶ster ama "Tedarik sÃ¼resi iÃ§in iletiÅŸime geÃ§in"</li>
                            <li><strong>HiÃ§bir Ã¼rÃ¼n gizleme!</strong></li>
                            <li>"Stokta yok", "TÃ¼kendi" ASLA DEME!</li>
                        </ul>
                    </li>

                    <li><strong>TELEFON TOPLAMA STRATEJÄ°SÄ°</strong>
                        <ul>
                            <li>Ä°letiÅŸim sorusu gelirse â†’ DÄ°REKT numara ver</li>
                            <li>ÃœrÃ¼n sorusu gelirse â†’ Ã–nce Ã¼rÃ¼n gÃ¶ster, sonra telefon iste</li>
                            <li>PazarlÄ±k varsa â†’ MÃ¼ÅŸteri temsilcisi yÃ¶nlendir</li>
                        </ul>
                    </li>

                    <li><strong>MARKDOWN FORMAT - ZORUNLU!</strong>
                        <ul>
                            <li>Soru sorarken Markdown liste (`-`) kullan</li>
                            <li>Her soru AYRI SATIRDA</li>
                            <li>ÃœrÃ¼n baÅŸlÄ±klarÄ± (###) Ã¶ncesi/sonrasÄ± BOÅ SATIR</li>
                            <li>Fiyat ASLA Ã¶zellik listesinde (AYRI PARAGRAF)</li>
                        </ul>
                    </li>
                </ol>

                <h4>Bilgi BankasÄ± ve Ã–ÄŸrenme</h4>
                <p>FileLearningService.buildLearningContext() kullanÄ±cÄ± tercihlerini ekledi.</p>
                <p>Ã–rneÄŸin: "F4 1.5 Ton transpalet" en Ã§ok satÄ±lan Ã¼rÃ¼n ise, arama sonuÃ§larÄ±nda ilk sÄ±raya koyul.</p>
            </div>
        </section>

        <!-- SECTION 4: SEARCH SYSTEM -->
        <section id="search-system">
            <h2>4. Arama Sistemi (HybridSearch)</h2>

            <div class="subsection success">
                <h3>HybridSearchService Mimarisi</h3>
                <p><strong>Dosya:</strong> app/Services/AI/HybridSearchService.php</p>
                <p>Ä°ki arama tekniÄŸini birleÅŸtirerek en iyi sonuÃ§lar sunar.</p>

                <h4>Ä°ki Tabaka Arama:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Arama Tipi</th>
                            <th>Motor</th>
                            <th>AÄŸÄ±rlÄ±k</th>
                            <th>Ã–zellikleri</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Keyword Search</strong></td>
                            <td>Meilisearch</td>
                            <td>70%</td>
                            <td>HÄ±zlÄ±, typo-tolerant, exact match, stemming</td>
                        </tr>
                        <tr>
                            <td><strong>Semantic Search</strong></td>
                            <td>Vector DB (embeddings)</td>
                            <td>30%</td>
                            <td>Anlamsal eÅŸleÅŸme, benzer Ã¼rÃ¼nler bulma</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Arama AdÄ±mlarÄ±:</h4>
                <div class="code-block">
1. Query'yi synonym'larla geniÅŸlet
   "elektrikli" â†’ "elektrikli li-ion akÃ¼lÃ¼ lityum bataryalÄ±"

2. Meilisearch (keyword) â†’ top 50 sonuÃ§
   - is_active = true filtresi
   - Kategori filtresi (opsiyonel)

3. Vector search (semantic) â†’ top 50 sonuÃ§
   - Embeddings'ten benzer Ã¼rÃ¼nler

4. Hybrid Score Hesapla
   - Keyword score: position-based (first=1.0, last=0)
   - Semantic score: position-based
   - Hybrid = (keyword*0.7) + (semantic*0.3)

5. SÄ±ralama KurallarÄ± (Ã–nem SÄ±rasÄ±na GÃ¶re)
   1. show_on_homepage = 1 (vitrin Ã¼rÃ¼nleri)
   2. sort_order (kategori iÃ§i sÄ±ra)
   3. current_stock > 0 (stok durumu)
   4. base_price > 0 (fiyat durumu)
   5. Hybrid score (arama uygunluÄŸu)

6. Kategori Filtresi
   - Kategori belirtilmiÅŸse, sadece o kategorideki Ã¼rÃ¼nler

7. Limit UygulanmasÄ±
   - VarsayÄ±lan: 50, ProductSearchNode'dan geÃ§irilen deÄŸer
                </div>

                <h4>Meilisearch KonfigÃ¼rasyonu</h4>
                <div class="code-block">
Index Name: shop_products_tenant_2 (Tenant 2 iÃ§in)

Filter: is_active = true AND category_id = {categoryId}

Limit: 50 (initial search)

Typo Tolerance: Otomatik
- "transpalet", "trans palet", "transpalat" hepsi bulunur

Stemming: TÃ¼rkÃ§e desteÄŸi
- "elektrikli" â†’ "elektrik" bulur
                </div>
            </div>

            <div class="subsection warning">
                <h3>Arama AkÄ±ÅŸÄ± (ProductSearchNode'dan)</h3>
                <div class="flow-diagram">
ProductSearchNode::execute()
    â†“
Tenant2ProductSearchService::search()
    â†“
detectCategoryId($userMessage)
    â†“
HybridSearchService::search()
    â†“
isSparePartRequest() KONTROL
    â†“
Yedek ParÃ§a Filtreleme
    â†“
ÃœrÃ¼nleri DÃ¶ndÃ¼r
                </div>

                <h4>Ã–rnek Senaryo</h4>
                <div class="code-block">
KullanÄ±cÄ±: "1.5 ton elektrikli transpalet istiyorum"

1. Category Detection:
   - "transpalet" bulundu â†’ Category ID = 2

2. HybridSearchService::search():
   - Query: "1.5 ton elektrikli transpalet"
   - Synonym geniÅŸletme: "... li-ion akÃ¼lÃ¼ lityum ..."
   - Meilisearch: category_id=2 ile ara
   - Vector: Semantik ara
   - Hybrid score ile sÄ±rala

3. Spare Part Filter:
   - isSparePartRequest() = false (yedek parÃ§a sÃ¶ylenmedi)
   - Yedek parÃ§a Ã¼rÃ¼nleri filtrele

4. SonuÃ§:
   [
     EPL153 1.5T Li-Ion Transpalet,
     F4 1.5T Li-Ion Transpalet,
     TX1500 1.5T Elektrikli Transpalet,
     ...
   ]
                </div>
            </div>
        </section>

        <!-- SECTION 5: CONTEXT BUILDING -->
        <section id="context-building">
            <h2>5. BaÄŸlam Ä°nÅŸasÄ± (Context Building)</h2>

            <div class="subsection">
                <h3>Context Flow</h3>
                <div class="flow-diagram">
ProductSearchNode
    â†“ (products: Collection)
StockSorterNode
    â†“ (products: sorted Collection)
ContextBuilderNode
    â†“ (product_context: Markdown)
AIResponseNode
    â†“ (AI reads product_context)
Output: AI Response
                </div>

                <h4>ContextBuilderNode Ä°ÅŸlemi</h4>
                <table>
                    <thead>
                        <tr>
                            <th>AdÄ±m</th>
                            <th>Ä°ÅŸlem</th>
                            <th>Ã‡Ä±ktÄ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1. HazÄ±rlÄ±k</td>
                            <td>ÃœrÃ¼nleri Collection'a dÃ¶nÃ¼ÅŸtÃ¼r</td>
                            <td>$products = collect(...)</td>
                        </tr>
                        <tr>
                            <td>2. Currency</td>
                            <td>USD â†’ TRY Ã§eviri (exchange_rate: 42.0)</td>
                            <td>$priceInTRY = $basePrice * 42</td>
                        </tr>
                        <tr>
                            <td>3. BaÅŸlÄ±k TemizliÄŸi</td>
                            <td>"2. Ton" â†’ "2 Ton"</td>
                            <td>preg_replace('/(\d+)\.\s+(Ton)/u', '$1 $2', $title)</td>
                        </tr>
                        <tr>
                            <td>4. Markdown OluÅŸturma</td>
                            <td>Her Ã¼rÃ¼n iÃ§in Markdown format</td>
                            <td>### ÃœrÃ¼n AdÄ±\n- Ã–zellik\n- Fiyat\n[Link]</td>
                        </tr>
                        <tr>
                            <td>5. GÃ¶rsel Ekleme</td>
                            <td>Spatie Media Library'den first image</td>
                            <td>ğŸ“· GÃ¶rsel: {URL}</td>
                        </tr>
                        <tr>
                            <td>6. Fiyat GÃ¶sterimi</td>
                            <td>FiyatlÄ± Ã¼rÃ¼nlerde format: "52.948 TL â‰ˆ $1.250"</td>
                            <td>- **{price} {currency}** â‰ˆ {original}</td>
                        </tr>
                        <tr>
                            <td>7. Link Ekleme</td>
                            <td>ÃœrÃ¼n slug'Ä±ndan shop link</td>
                            <td>- [ÃœrÃ¼nÃ¼ Ä°ncele](/shop/{slug})</td>
                        </tr>
                    </tbody>
                </table>

                <div class="code-block">
## ğŸ“¦ Mevcut ÃœrÃ¼nler:

### Ä°XTÄ°F EPT20 - 2 Ton Li-Ion Forklift
- ğŸ“· GÃ¶rsel: https://...
- **52.948 TL** â‰ˆ $1.250
- [ÃœrÃ¼nÃ¼ Ä°ncele](/shop/ixtif-ept20-2t)

### Ä°XTÄ°F F4 - 1.5 Ton Li-Ion Transpalet
- ğŸ“· GÃ¶rsel: https://...
- **38.200 TL** â‰ˆ $909
- [ÃœrÃ¼nÃ¼ Ä°ncele](/shop/ixtif-f4-15t)

(FiyatsÄ±z Ã¼rÃ¼n - fiyat satÄ±rÄ± YOK!)

### Ä°XTÄ°F Reach Truck - 2.5 Ton
- ğŸ“· GÃ¶rsel: https://...
- [ÃœrÃ¼nÃ¼ Ä°ncele](/shop/ixtif-reach-truck-25t)
                </div>

                <h4>Kritik Kurallar</h4>
                <div class="decision-box">
                    <strong>FiyatsÄ±z ÃœrÃ¼nler:</strong>
                    <p>ÃœrÃ¼n gÃ¶sterilir, fiyat SATIRI ATLANIR. Nedeni: Context'te hiÃ§ fiyat satÄ±rÄ± yoksa AI "Fiyat bilgisi iÃ§in iletiÅŸime geÃ§in" mesajÄ± verir.</p>

                    <strong>Stok Bilgisi:</strong>
                    <p>ASLA verilmez. Stok durumu AI'nin belirsiz talep kontrolÃ¼ne yardÄ±mcÄ± olmamasÄ± iÃ§in gizlenir.</p>

                    <strong>Kategori Etiketi:</strong>
                    <p>Meilisearch'ten gelen Ã¼rÃ¼nlerin kategorisine gÃ¶re [TRANSPALET], [FORKLIFT] vb. etiketi eklenir.</p>
                </div>
            </div>
        </section>

        <!-- SECTION 6: KEY DECISIONS -->
        <section id="key-decisions">
            <h2>6. Kritik Karar NoktalarÄ±</h2>

            <div class="subsection critical">
                <h3>1. Belirsiz Ä°steklerde Soru Sorma</h3>
                <div class="decision-box">
                    <strong>Tetikleyiciler (BELÄ°RSÄ°Z):</strong>
                    <ul>
                        <li>"Transpalet istiyorum" (sadece kategori)</li>
                        <li>"Forklift var mÄ±?" (sadece kategori)</li>
                        <li>"Reach truck modelleri hakkÄ±nda bilgi" (sadece kategori)</li>
                    </ul>

                    <strong>SonuÃ§:</strong>
                    <p>AI 1-2 temel soru sorar (Tonnaj + Elektrikli mi?). HiÃ§ Ã¼rÃ¼n gÃ¶stermez.</p>

                    <strong>Tetikleyiciler (BELÄ°RLÄ°):</strong>
                    <ul>
                        <li>"1.5 ton elektrikli transpalet" (tonnaj + tip)</li>
                        <li>"2 ton Li-Ion forklift" (tonnaj + tip)</li>
                        <li>"En ucuz transpalet" (fiyat kriteri)</li>
                    </ul>

                    <strong>SonuÃ§:</strong>
                    <p>AI hemen Ã¼rÃ¼n listesi gÃ¶sterir. Soru ASLA sormasÄ±.</p>
                </div>

                <p><span class="highlight">UyarÄ±:</span> Bu kontrol <strong>AIResponseNode</strong>'da yapÄ±lÄ±r. Context'te Ã¼rÃ¼nler varsa bile, belirsiz istekte soru sorma kuralÄ± devreye girer!</p>
            </div>

            <div class="subsection critical">
                <h3>2. Yedek ParÃ§a Filtreleme</h3>
                <div class="decision-box">
                    <strong>Kural:</strong> VarsayÄ±lan olarak yedek parÃ§a gÃ¶sterilmez.

                    <strong>Åu durumlarda gÃ¶sterilir:</strong>
                    <ul>
                        <li>KullanÄ±cÄ± "yedek parÃ§a" sÃ¶yledi</li>
                        <li>KullanÄ±cÄ± "Ã§atal", "tekerlek", "rulman" vb. parÃ§a adÄ± sÃ¶yledi</li>
                    </ul>

                    <strong>Filtreleme Yeri:</strong>
                    <ul>
                        <li>Tenant2ProductSearchService::search() iÃ§inde</li>
                        <li>HybridSearchService'den gelen sonuÃ§lara filtre uygulanÄ±r</li>
                    </ul>

                    <strong>Neden?</strong>
                    <p>MÃ¼ÅŸteri "forklift istiyorum" dediÄŸinde, Ã§atal, rulman gibi parÃ§alar gÃ¶sterilmemeli. Confusing!</p>
                </div>
            </div>

            <div class="subsection critical">
                <h3>3. Fiyat GÃ¶sterimi KurallarÄ±</h3>
                <div class="decision-box">
                    <strong>Normal ÃœrÃ¼n (base_price > 0):</strong>
                    <p>Fiyat MUTLAKA gÃ¶sterilir. Format: "- **52.948 TL** â‰ˆ $1.250"</p>

                    <strong>FiyatsÄ±z ÃœrÃ¼n (base_price = 0):</strong>
                    <p>Context'te FÄ°YAT SATIRI YOK. AI "MÃ¼ÅŸteri temsilcilerimizle iletiÅŸime geÃ§erek teklif alabilirsiniz" der.</p>

                    <strong>Stoksuz ÃœrÃ¼n (current_stock = 0):</strong>
                    <p>Context'te Ã¼rÃ¼n gÃ¶sterilir ama stok bilgisi YOK. AI "Tedarik sÃ¼resi iÃ§in iletiÅŸime geÃ§in" der.</p>

                    <strong>KDV Notasyonu:</strong>
                    <p>ASLA "(KDV dahil)" yazÄ±lmaz. TÃ¼m fiyatlar KDV HARÄ°Ã‡.</p>
                </div>

                <p><span class="highlight">Ã–nemli:</span> Tenant2PromptService::buildPrompt() iÃ§inde tekrar vurgulanÄ±yor: "Context'teki fiyatlarÄ± BÄ°REBÄ°R AYNEN kullan!"</p>
            </div>

            <div class="subsection critical">
                <h3>4. Kategori Bellekleme</h3>
                <div class="decision-box">
                    <strong>Kural:</strong> KonuÅŸma boyunca kategori bellenmesi gerekir.

                    <strong>Senaryo:</strong>
                    <ul>
                        <li>KullanÄ±cÄ±: "Transpalet istiyorum"</li>
                        <li>AI: [Transpalet Ã¼rÃ¼nleri gÃ¶sterir]</li>
                        <li>KullanÄ±cÄ±: "BaÅŸka ne var?"</li>
                        <li>âœ… Beklenen: TRANSPALET kategorisinden baÅŸka Ã¼rÃ¼n gÃ¶stermek</li>
                        <li>âŒ ASLA: Forklift gÃ¶stermek</li>
                    </ul>

                    <strong>NasÄ±l SaÄŸlanÄ±r?</strong>
                    <p>Conversation history'deki mesajlar AIResponseNode'a geÃ§ilir. AI, Ã¶nceki mesajlardan konteksti anlar ve AYNI kategoride kal.</p>
                </div>

                <p><span class="highlight">Not:</span> Bu Tenant2PromptService'de "KATEGORÄ° HAFIZASI - KRÄ°TÄ°K!" baÅŸlÄ±ÄŸÄ± altÄ±nda yazÄ±lÄ±yor.</p>
            </div>

            <div class="subsection warning">
                <h3>5. Telefon Toplama Stratejisi</h3>
                <div class="decision-box">
                    <strong>Kural 1: Ä°letiÅŸim Sorusu Gelirse</strong>
                    <p>KullanÄ±cÄ± "WhatsApp", "telefon", "numara", "iletiÅŸim" yazarsa â†’ DÄ°REKT numara ver! ÃœrÃ¼n sorusu SORMA!</p>

                    <strong>Kural 2: ÃœrÃ¼n Sorusu Gelirse</strong>
                    <p>KullanÄ±cÄ± Ã¼rÃ¼n arÄ±yorsa â†’ Ã–nce Ã¼rÃ¼n gÃ¶ster (MUTLAKA linkle!), sonra ilgilendiyse "Telefon numaranÄ±z?" sor.</p>

                    <strong>Kural 3: PazarlÄ±k Durumu</strong>
                    <p>KullanÄ±cÄ± "Ä°ndirim var mÄ±?" derse â†’ MÃ¼ÅŸteri temsilcisine yÃ¶nlendir. "Size Ã¶zel fiyat iÃ§in telefon numaranÄ±zÄ± alabilir miyim?"</p>

                    <strong>Fallback:</strong>
                    <p>Numara alamazsan â†’ Bizim WhatsApp linkini ver: wa.me/{cleanWhatsapp}</p>
                </div>

                <p><span class="highlight">Kritik:</span> Telefon/WhatsApp numaralarÄ± <strong>settings</strong>'den gelir (hardcode yok!). AISettingsHelper::getContactInfo()</p>
            </div>

            <div class="subsection">
                <h3>6. Conversation History KullanÄ±mÄ±</h3>
                <div class="decision-box">
                    <strong>History Nereye GeÃ§er?</strong>
                    <p>AIResponseNode::prepareMessages() iÃ§inde, system prompt'tan sonra, user message'dan Ã¶nce.</p>

                    <strong>History NasÄ±l Filtreler?</strong>
                    <p>EÄŸer ÅŸu anki aramalda Ã¼rÃ¼n yoksa, eski Ã¼rÃ¼n Ã¶nerileri history'den Ã§Ä±karÄ±lÄ±r (clean up).</p>

                    <strong>KRITIK KURAL: AtÄ±f Yapma!</strong>
                    <ul>
                        <li>âŒ "Ã–nceki konuÅŸmamÄ±zda ... arÄ±yordunuz"</li>
                        <li>âŒ "Daha Ã¶nce ..."</li>
                        <li>âŒ "HatÄ±rlÄ±yorum ..."</li>
                        <li>âœ… "Her mesaj YENÄ° BAÅLANGIÃ‡"</li>
                    </ul>

                    <strong>Neden?</strong>
                    <p>KullanÄ±cÄ±, Ã¶nceki konuÅŸmayÄ± hatÄ±rlamayabilir. KarÄ±ÅŸÄ±klÄ±k yaratÄ±r.</p>
                </div>
            </div>
        </section>

        <!-- SECTION 7: ISSUES & GAPS -->
        <section id="issues-gaps">
            <h2>7. Bulunun Sorunlar ve BoÅŸluklar</h2>

            <div class="gap-issue">
                <h4>ğŸ”´ ISSUE 1: API Key YÃ¶netimi (Debug Code)</h4>
                <p><strong>Dosya:</strong> AIResponseNode.php (satÄ±r 239-245)</p>
                <p><strong>Sorun:</strong> API key'in environment'tan yÃ¼klenmesine dair debug logging var.</p>
                <div class="code-block">
\Log::emergency('ğŸ”‘ Loading API Key - FIXED', [
    'key_exists' => !empty($apiKey),
    'key_length' => strlen($apiKey ?? ''),
    'key_preview' => $apiKey ? substr($apiKey, 0, 15) . '...' : 'EMPTY',
    ...
]);
                </div>
                <p><strong>Etki:</strong> Production'da log spam. Security risk (API key preview).</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Debug logging'i kaldÄ±r. Setting'den alÄ±nan API key kullanÄ±lmalÄ±.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸ”´ ISSUE 2: Temp Debug DosyalarÄ±</h4>
                <p><strong>Dosya:</strong> AIResponseNode.php (satÄ±r 279-284)</p>
                <p><strong>Sorun:</strong> AI messages'Ä± /tmp/ai_messages_debug.txt'ye yazÄ±lÄ±yor.</p>
                <div class="code-block">
file_put_contents('/tmp/ai_messages_debug.txt',
    date('Y-m-d H:i:s') . " - Total: " . count($fullMessages) . "\n" ...
    FILE_APPEND
);
                </div>
                <p><strong>Etki:</strong> Production'da /tmp spam. Gizlilik riski.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Debug dosya yazÄ±mÄ±nÄ± kaldÄ±r. Log::info() kullan.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 3: Parallal Execution (KullanÄ±lmÄ±yor)</h4>
                <p><strong>Dosya:</strong> FlowExecutor.php (satÄ±r 57, 88-100)</p>
                <p><strong>Sorun:</strong> ParallelNodeExecutor var ama aktif deÄŸil. Flow'da parallel groups tanÄ±mlanmÄ±yor.</p>
                <p><strong>Etki:</strong> Potansiyel performans artÄ±ÅŸÄ± kaybediliyor. (ProductSearch + History loading paralel Ã§alÄ±ÅŸabilir)</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Flow JSON'da paralel node gruplarÄ± tanÄ±mla.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 4: Context BaÄŸlamÄ± EksikliÄŸi</h4>
                <p><strong>Dosya:</strong> ProductSearchNode.php, ContextBuilderNode.php</p>
                <p><strong>Sorun:</strong> Category label eklenmesine raÄŸmen (satÄ±r 61-64, ContextBuilder), Ã¼rÃ¼nlerin kategorisi AI'ye aÃ§Ä±k ÅŸekilde sÃ¶ylenmiyor.</p>
                <p><strong>Etki:</strong> AI, "TRANSPALET" + "FORKLIFT" kategorisinde Ã¼rÃ¼nler mix'lediyse, Ã¶nerileri optimize edemez.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> AI prompt'una kategori context'i ekle. "[TRANSPALET] EPL153 transpalet" gibi.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 5: HybridSearchService - Kategori Filtresi After Sorting</h4>
                <p><strong>Dosya:</strong> HybridSearchService.php (satÄ±r 260-264)</p>
                <p><strong>Sorun:</strong> Semantic search, farklÄ± kategoriden Ã¼rÃ¼nler getiriyor olabilir. Kategori filtresi SONRADAN uygulanÄ±yor.</p>
                <div class="code-block">
// Kategori filtresi - SONRA uygulanÄ±yor!
if ($categoryId) {
    $topProducts = $topProducts->filter(
        function ($product) use ($categoryId) {
            return $product->category_id == $categoryId;
        }
    )->values();
}
                </div>
                <p><strong>Etki:</strong> Ä°yi skorlanan Ã¼rÃ¼nler silinebilir. SonuÃ§ sayÄ±sÄ± azalabilir.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Kategori filtresi BAÅTAN (Meilisearch AND clause) uygulanmalÄ±, sonradan deÄŸil.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 6: Tenant2PromptService - Ã‡ok Uzun (822 satÄ±r)</h4>
                <p><strong>Dosya:</strong> Tenant2PromptService.php (ALL)</p>
                <p><strong>Sorun:</strong> TÃ¼m kurallar bir dosyada. BakÄ±m ve test zorlaÅŸÄ±yor.</p>
                <p><strong>Etki:</strong> Maintenance burden. Tekrar eden kurallar.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> KurallarÄ± kategorilere bÃ¶l:
                    <ul>
                        <li>BelirsizIstek.php</li>
                        <li>FiyatStokPolitikasi.php</li>
                        <li>TelefonToplama.php</li>
                        <li>MarkdownFormat.php</li>
                    </ul>
                </p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 7: Cache Stratejisi Eksik</h4>
                <p><strong>Dosya:</strong> NodeExecutor.php (satÄ±r 132-167)</p>
                <p><strong>Sorun:</strong> ProductSearchNode cache'lenmesi DISABLED (satÄ±r 139). "Cache was causing wrong products" yorum var.</p>
                <p><strong>Etki:</strong> Performans kaybÄ±. HybridSearch Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor her saat.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Cache key'i gÃ¶zden geÃ§ir. user_message + tenant_id + timestamp(hour) olmalÄ±.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 8: Error Handling EksikliÄŸi</h4>
                <p><strong>Dosya:</strong> TÃ¼m Node'lar</p>
                <p><strong>Sorun:</strong> Hata kontrolÃ¼ minimal. Exception'lar throw edilmiyor, fallback'e geÃ§iliyor.</p>
                <p><strong>Etki:</strong> Hata debugging zor. Silent failures.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Try-catch ile proper error handling ekle. User-friendly fallback mesajlarÄ± sun.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 9: Streaming Support (Aktif DeÄŸil)</h4>
                <p><strong>Dosya:</strong> AIResponseNode.php (satÄ±r 164-178)</p>
                <p><strong>Sorun:</strong> Streaming konfigÃ¼rasyonu var (stream: true), ama default false. Streaming logic'i test edilmemiÅŸ.</p>
                <p><strong>Etki:</strong> Real-time responses kullanÄ±lmÄ±yor. UX gecikmiÅŸ hissediliyor.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Streaming'i test et ve default true yap.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¡ ISSUE 10: Conversation History Cleanup Ä°mperfect</h4>
                <p><strong>Dosya:</strong> AIResponseNode.php (satÄ±r 620-633)</p>
                <p><strong>Sorun:</strong> Eski Ã¼rÃ¼n Ã¶nerileri "###" ve "**Fiyat:**" aranarak temizleniyor. YanlÄ±ÅŸ positive olabilir.</p>
                <p><strong>Etki:</strong> MeÅŸru mesajlar silinebilir.</p>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> History'ye metadata flag ekle. "is_product_recommendation: true" gibi.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¢ IMPROVEMENT 1: Learning System Integration</h4>
                <p><strong>Dosya:</strong> Tenant2PromptService.php (satÄ±r 738-756)</p>
                <p><strong>Durum:</strong> FileLearningService.buildLearningContext() tercih edilen Ã¼rÃ¼nleri AI'ye sÃ¶ylÃ¼yor.</p>
                <p><strong>Mevcut:</strong> System prompt'a ekleniyor (line 742-743)</p>
                <p><strong>Suggestion:</strong> Bu Ã¶zelliÄŸi geniÅŸlet. Daha sophisticated ranking yapÄ±labilir.</p>
            </div>

            <div class="gap-issue">
                <h4>ğŸŸ¢ IMPROVEMENT 2: Knowledge Base Support</h4>
                <p><strong>Dosya:</strong> Tenant2PromptService.php (satÄ±r 729)</p>
                <p><strong>Durum:</strong> AISettingsHelper::buildKnowledgeBasePrompt() sistema ekleniyor.</p>
                <p><strong>Potential:</strong> FAQ, teknik bilgiler sistem prompt'a eklenebilir.</p>
            </div>
        </section>

        <footer>
            ğŸ¤– AI Workflow Sistem Analizi - Tenant 2 (iXTÄ°F)<br>
            ğŸ“Š Derinlemesine Ä°nceleme: FlowExecutor, Node Sistemi, HybridSearch, Tenant-Specific Logic<br>
            âœ… Sistem tamamen multi-tenant ve modÃ¼ler mimaride tasarlanmÄ±ÅŸtÄ±r.
        </footer>
    </div>
</body>
</html>
